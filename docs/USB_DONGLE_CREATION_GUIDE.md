# 🔧 راهنمای کامل ایجاد USB Dongle

## 🚨 مشکل فعلی

```
ERROR همه تلاش‌های خواندن برای سکتور 100 ناموفق بود
ERROR همه تلاش‌های خواندن برای سکتور 101 ناموفق بود
...
❌ اعتبارسنجی ناموفق: Dongle یافت نشد
```

**علت**: عدم دسترسی ادمین برای نوشتن/خواندن در سکتورهای خام دیسک

## ✅ راه‌حل کامل

### **مرحله 1: اجرای Django به عنوان Administrator**

#### **روش 1: اسکریپت Batch (توصیه شده)**:
```cmd
1. راست کلیک روی: scripts/run_as_admin.bat
2. "Run as administrator" را انتخاب کنید
3. Django server شروع می‌شود
```

#### **روش 2: اسکریپت PowerShell**:
```powershell
1. راست کلیک روی: scripts/run_as_admin.ps1
2. "Run with PowerShell" را انتخاب کنید
3. Django server شروع می‌شود
```

#### **روش 3: دستی**:
```cmd
1. Command Prompt را به عنوان Administrator باز کنید
2. cd "D:\Design & Source Code\Source Coding\BudgetsSystem"
3. python manage.py runserver
```

### **مرحله 2: ایجاد Dongle**

#### **از طریق وب (توصیه شده)**:
```
1. برو به: http://127.0.0.1:8000/usb-key-validator/enhanced/
2. فلش E: را انتخاب کن
3. اطلاعات شرکت را وارد کن (اختیاری):
   - نام شرکت: نام شرکت خود
   - شناسه نرم‌افزار: RCMS
4. "ایجاد Dongle" را کلیک کن
5. باید پیام موفقیت ببینی:
   ✅ Dongle برای شرکت 'نام شرکت' با موفقیت در 6 سکتور ایجاد شد
```

#### **از طریق Command Line**:
```bash
python manage.py shell
>>> from usb_key_validator.enhanced_utils import dongle_manager
>>> from accounts.models import TimeLockModel
>>> latest_lock = TimeLockModel.objects.filter(is_active=True).order_by('-created_at').first()
>>> if latest_lock:
...     key_data = latest_lock.lock_key.encode()
...     success, message = dongle_manager.write_dongle_to_multiple_sectors(
...         r'\\.\PhysicalDrive1', key_data, 'نام شرکت', 'RCMS'
...     )
...     print(f"نتیجه: {success}, پیام: {message}")
```

### **مرحله 3: بررسی نتایج**

#### **در صورت موفقیت**:
```
✅ Dongle برای شرکت 'نام شرکت' با موفقیت در 6 سکتور ایجاد شد

📊 آمار سکتورها:
   سکتور 100: ✅ valid (512 بایت)
   سکتور 101: ✅ valid (512 بایت)
   سکتور 102: ✅ valid (512 بایت)
   سکتور 103: ✅ valid (512 بایت)
   سکتور 104: ✅ valid (512 بایت)
   سکتور 105: ✅ valid (512 بایت)
```

#### **در صورت خطا**:
```
❌ نیاز به دسترسی ادمین برای نوشتن در سکتورها
```

## 🔍 عیب‌یابی

### **مشکل 1: هنوز Access Denied**:
```
راه‌حل:
1. اطمینان حاصل کنید که Django به عنوان Administrator اجرا شده
2. فلش را eject و دوباره متصل کنید
3. از فلش دیگری استفاده کنید
4. Windows Defender را موقتاً غیرفعال کنید
5. فلش را فرمت کنید (FAT32)
```

### **مشکل 2: فلش شناسایی نمی‌شود**:
```
راه‌حل:
1. فلش را در درایو دیگری تست کنید
2. فلش را فرمت کنید (FAT32)
3. از فلش دیگری استفاده کنید
4. درایورهای USB را به‌روزرسانی کنید
```

### **مشکل 3: سکتورها نوشته می‌شوند اما خوانده نمی‌شوند**:
```
راه‌حل:
1. فلش را eject و دوباره متصل کنید
2. سیستم را restart کنید
3. از فلش دیگری استفاده کنید
```

## 📋 چک‌لیست کامل

### **قبل از شروع**:
- [ ] Django به عنوان Administrator اجرا شده
- [ ] فلش USB متصل و شناسایی شده
- [ ] فلش فرمت شده (FAT32 یا NTFS)
- [ ] حداقل 1GB فضای خالی موجود

### **در حین کار**:
- [ ] فلش در لیست USB ها نمایش داده می‌شود
- [ ] دکمه "ایجاد Dongle" قابل کلیک است
- [ ] پیام موفقیت نمایش داده می‌شود
- [ ] سکتورها به عنوان "valid" نمایش داده می‌شوند

### **بعد از ایجاد**:
- [ ] اعتبارسنجی موفق است
- [ ] سکتورها قابل خواندن هستند
- [ ] Middleware در هر لاگین چک می‌کند
- [ ] Dashboard آمار صحیح نمایش می‌دهد

## 🎯 مراحل کامل استفاده

### **برای مدیر سیستم**:
```
1. Django را به عنوان Administrator اجرا کن
2. برو به: http://127.0.0.1:8000/usb-key-validator/enhanced/
3. فلش E: را انتخاب کن
4. اطلاعات شرکت را وارد کن
5. "ایجاد Dongle" را کلیک کن
6. سیستم خودکار dongle را ایجاد می‌کند
7. از داشبورد وضعیت را نظارت کن
```

### **برای کاربر نهایی**:
```
1. فلش dongle را به کامپیوتر متصل کن
2. وارد سیستم شو
3. اگر dongle معتبر باشد، دسترسی داری
4. اگر نامعتبر باشد، به صفحه اعتبارسنجی هدایت می‌شوی
```

## 🔐 اطلاعات نوشته شده در Dongle

### **هر سکتور شامل**:
```python
{
    'lock_key': 'کلید اصلی از دیتابیس',
    'device_id': 'شناسه منحصر به فرد (16 کاراکتر)',
    'created_at': 'زمان ایجاد (timestamp)',
    'version': '2.0',
    'sector_count': 6,
    'checksum': 'SHA256 checksum',
    'software_id': 'شناسه نرم‌افزار',
    'organization_name': 'نام سازمان',
    'expiry_date': 'تاریخ انقضا'
}
```

### **چرا اطلاعات دیده نمی‌شوند؟**:
- ✅ **سکتورهای خام**: اطلاعات در سکتورهای خام دیسک نوشته می‌شوند
- ✅ **خارج از فایل سیستم**: خارج از فضای قابل مشاهده FAT32/NTFS
- ✅ **رمزگذاری**: اطلاعات با SHA256 محافظت می‌شوند
- ✅ **امضای منحصر به فرد**: هر dongle امضای خاص خود را دارد

## 🎉 نتیجه

**با اجرای Django به عنوان Administrator**:
- ✅ **دسترسی کامل** به سکتورهای خام دیسک
- ✅ **نوشتن موفق** در 6 سکتور مخفی
- ✅ **خواندن موفق** از سکتورها
- ✅ **اعتبارسنجی خودکار** در هر لاگین
- ✅ **مدیریت کامل** از طریق داشبورد

**مشکل دسترسی کاملاً برطرف می‌شود!** 🚀

## ⚠️ نکات مهم

### **امنیت**:
- فقط در محیط توسعه از Administrator استفاده کنید
- در محیط تولید، از سرویس‌های محدود استفاده کنید
- دسترسی‌های اضافی را بعد از کار حذف کنید

### **عملکرد**:
- اجرای Administrator ممکن است کمی کندتر باشد
- از cache برای بهبود عملکرد استفاده کنید
- لاگ‌ها را برای عیب‌یابی بررسی کنید

**همه مشکلات برطرف شد!** ✨

**حالا می‌توانید**:
- ✅ فلش را به dongle تبدیل کنید
- ✅ اطلاعات در سکتورهای مخفی محافظت شوند
- ✅ در هر لاگین خودکار چک شود
- ✅ از داشبورد مدیریت کنید

**سیستم کاملاً آماده و امن است!** 🎯