# راهنمای کاربر گردش کار (Workflow)

این راهنما به‌صورت خلاصه و کاربردی توضیح می‌دهد چطور گردش کار فاکتور/تنخواه در سیستم کار می‌کند و شما در هر صفحه چه کاری انجام دهید.

## مفاهیم اصلی
- **وضعیت (Status)**: مرحله‌ای از فرآیند مثل «پیش‌نویس»، «در انتظار تأیید»، «تأیید نهایی»، «رد شده».
  - وضعیت‌ها می‌توانند یکی از این ویژگی‌ها را داشته باشند:
    - شروع فرآیند: is_initial=True (مثل DRAFT)
    - پایان تأیید: is_final_approve=True (مثل APPROVED)
    - پایان رد: is_final_reject=True (مثل REJECTED)

- **اقدام (Action)**: عملی که باعث تغییر وضعیت می‌شود (SUBMIT/APPROVE/REJECT).

- **گذار (Transition)**: مسیر «از وضعیت X با اقدام Y به وضعیت Z» که می‌تواند برای سازمان و نوع موجودیت متفاوت باشد. هر Transition می‌تواند «پست‌های مجاز» داشته باشد.

- **تأییدکننده مرحله (StageApprover)**: برای هر مرحله و نوع موجودیت، مشخص می‌کند کدام پست‌ها مجاز به انجام اقدام (تأیید/رد/نیمه‌تأیید) هستند. هر ترکیب (مرحله، پست، نوع‌موجودیت) فقط یک‌بار تعریف می‌شود.

## نقش وضعیت‌های نهایی
- اگر Transition به وضعیتی با is_final_approve=True برسد، فرآیند تأیید «نهایی» می‌شود.
- اگر Transition به وضعیتی با is_final_reject=True برسد، فرآیند «رد نهایی» می‌شود.

## مسیرهای کاربردی
- داشبورد گردش کار: `Workflow →` مشاهده وضعیت‌ها، اقدامات و لینک گزارش‌ها
- گزارش اقدامات مجاز: `Workflow → گزارش اقدامات مجاز (FACTOR)`
- گزارش دسترسی سطح‌به‌سطح: `Workflow → گزارش دسترسی سطح به سطح`
- فهرست اقدامات: `Workflow Management → Actions`
- گزارش ترنزیشن‌های یک اقدام: از فهرست اقدامات روی «گزارش» کلیک کنید
- تأییدکنندگان مرحله: `Workflow Management → Stage Approvers`

## صفحه Stage Approver (تعریف تأییدکننده مرحله)
1) سازمان را انتخاب کنید تا «مراحل» و «پست‌ها» متناسب با سازمان فیلتر شوند.
2) مرحله، پست، نوع موجودیت و اقدام را انتخاب و ذخیره کنید.
3) اگر ترکیب مرحله/پست/نوع موجودیت از قبل وجود داشته باشد، پیام خطا در بالای فرم نمایش داده می‌شود.

نکته: نمایش «پیش‌نمایش تنظیمات» در پایین فرم به شما کمک می‌کند قبل از ذخیره از صحت انتخاب‌ها مطمئن شوید.

## صفحه گزارش مسیر تأیید فاکتور (Approval Path)
آدرس نمونه: `/workflow-management/factor/<factor_id>/approval-path/`
- مسیر کامل از وضعیت فعلی تا نهایی را نشان می‌دهد.
- پست‌ها و کاربران مجاز در هر مرحله را نمایش می‌دهد.
- تاریخچه تأیید/رد و اقدامات ثبت‌شده قابل مشاهده است.

## خطای رایج و راه‌حل
- تکراری بودن تأییدکننده مرحله: «این ترکیب مرحله/پست/نوع موجودیت از قبل وجود دارد.»
  - راه‌حل: رکورد موجود را پیدا و ویرایش کنید یا پست/مرحله/نوع موجودیت دیگری انتخاب کنید.

## پاک‌سازی قوانین بودجه
برای حذف قوانین مربوط به «تخصیص بودجه» (BUDGET_ALLOCATION) می‌توانید از دستور مدیریت زیر استفاده کنید:

```bash
python manage.py clear_budget_rules --yes
```

این دستور موارد زیر را حذف می‌کند:
- StageApprover های مرتبط با entity_type=BUDGET_ALLOCATION
- PostRuleAssignment های مرتبط با entity_type=BUDGET_ALLOCATION

در صورت نیاز می‌توانید محدوده حذف را با سوییچ‌ها محدودتر کنید (راهنما: `python manage.py clear_budget_rules --help`).

---
سوال یا مشکلی دارید؟ با مدیر سیستم یا تیم توسعه تماس بگیرید.


