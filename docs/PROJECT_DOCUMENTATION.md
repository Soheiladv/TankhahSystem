# مستندات فنی پروژه سیستم بودجه و تنخواه (BudgetsSystem)

این سند یک نمای کلی از معماری داده (مدل‌ها) و ساختار کلی پروژه ارائه می‌دهد. هدف آن، فراهم کردن یک مرجع سریع و جامع برای توسعه‌دهندگان فعلی و آینده است.

---

## بخش ۱: معماری کلی پروژه

این پروژه یک سیستم جامع و پیشرفته برای مدیریت بودجه، تخصیص اعتبار، و فرآیندهای تنخواه‌گردانی در یک ساختار سازمانی سلسله مراتبی است. معماری پروژه به صورت **ماژولار** و مبتنی بر اپلیکیشن‌های مستقل جنگو طراحی شده است که هر کدام مسئولیت مشخصی دارند.

### اصول کلیدی طراحی:

- **موتور گردش کار داینامیک:** فرآیندهای تأیید و رد اسناد (مانند فاکتور و تنخواه) به صورت ثابت در کد نوشته نشده‌اند، بلکه از طریق یک موتور گردش کار قدرتمند و قابل تنظیم در پنل ادمین مدیریت می‌شوند.
- **سیستم دسترسی مبتنی بر نقش (RBAC):** دسترسی کاربران به بخش‌های مختلف سیستم بر اساس پست سازمانی، نقش‌ها و گروه‌هایی که در آن عضو هستند، به دقت کنترل می‌شود.
- **یکپارچگی داده:** تمام اپلیکیشن‌ها به صورت یکپارچه با هم کار می‌کنند و از یک پایگاه داده مشترک برای تضمین صحت و سازگاری اطلاعات استفاده می‌کنند.
- **اتوماسیون فرآیندها:** بسیاری از وظایف تکراری مانند تولید شماره اسناد، ثبت تاریخچه تغییرات، و کنترل سقف بودجه به صورت خودکار انجام می‌شود.

---

## بخش ۲: بررسی اپلیکیشن‌ها (Apps)

در ادامه، مسئولیت و مدل‌های کلیدی هر اپلیکیشن به تفکیک شرح داده می‌شود.

### ۱. اپلیکیشن `core` (هسته اصلی)

این اپلیکیشن، ستون فقرات و شالوده اصلی کل پروژه است.

- **مسئولیت:** تعریف ساختار سازمانی (دفتر مرکزی، شعبات)، پست‌های سازمانی، و از همه مهم‌تر، پیاده‌سازی **موتور گردش کار داینامیک**.
- **مدل‌های کلیدی:**
    - `Organization`: برای تعریف سازمان‌ها، شرکت‌ها و شعبات به صورت سلسله مراتبی.
    - `Post`: برای تعریف پست‌های سازمانی (مانند مدیرعامل، مدیر مالی) در هر سازمان.
    - `UserPost`: برای اتصال یک کاربر (`CustomUser`) به یک پست (`Post`) خاص در یک بازه زمانی مشخص.
    - **موتور گردش کار:**
        - `EntityType`: تعریف انواع موجودیت‌های دارای گردش کار (فاکتور، تنخواه).
        - `Status`: تعریف وضعیت‌های ممکن (پیش‌نویس، تأیید نهایی، رد شده).
        - `Action`: تعریف اقدامات قابل انجام توسط کاربر (ارسال، تأیید، رد).
        - `Transition`: **قلب تپنده سیستم.** این مدل قوانین گذار را تعریف می‌کند؛ یعنی یک موجودیت از یک وضعیت، با یک اقدام خاص، توسط چه پست‌هایی می‌تواند به وضعیت دیگر برود.

### ۲. اپلیکیشن `accounts` (مدیریت کاربران و دسترسی)

این اپلیکیشن مسئولیت همه‌چیز مربوط به کاربران، احراز هویت و کنترل دسترسی را بر عهده دارد.

- **مسئولیت:** مدیریت کاربران، نقش‌ها، گروه‌ها، دسترسی‌ها، و همچنین پیاده‌سازی سیستم قفل نرم‌افزاری و لاگ فعالیت‌ها.
- **مدل‌های کلیدی:**
    - `CustomUser`: مدل کاربری سفارشی که جایگزین مدل پیش‌فرض جنگو شده است.
    - `Role` و `MyGroup`: برای پیاده‌سازی سیستم دسترسی مبتنی بر نقش (RBAC).
    - `AuditLog`: یک مدل بسیار مهم برای ثبت تمام فعالیت‌های کاربران در سیستم جهت حسابرسی.
    - `ActiveUser` و `TimeLockModel`: این دو مدل با هم یک سیستم قفل نرم‌افزاری برای کنترل تعداد کاربران همزمان و تاریخ انقضای لایسنس نرم‌افزار را پیاده‌سازی می‌کنند.

### ۳. اپلیکیشن `budgets` (مدیریت بودجه)

این اپلیکیشن، قلب سیستم بودجه‌ریزی پروژه است.

- **مسئولیت:** مدیریت کامل چرخه عمر بودجه، از تعریف دوره‌های کلان تا تخصیص به پروژه‌ها و سازمان‌ها و ردیابی تمام تراکنش‌ها.
- **مدل‌های کلیدی:**
    - `BudgetPeriod`: تعریف دوره‌های بودجه کلان (مثلاً بودجه سال ۱۴۰۳).
    - `BudgetAllocation`: تخصیص بخشی از بودجه یک دوره به یک سازمان، پروژه یا زیرپروژه خاص.
    - `BudgetItem`: تعریف ردیف‌های بودجه.
    - `BudgetTransaction`: ثبت تمام تراکنش‌های مالی مربوط به بودجه (مصرف، افزایش، کاهش، برگشت) برای ردیابی دقیق هزینه‌ها.

### ۴. اپلیکیشن `tankhah` (تنخواه‌گردانی و فاکتورها)

این اپلیکیشن، بخش عملیاتی سیستم است که در آن بودجه تخصیص‌یافته، مصرف می‌شود.

- **مسئولیت:** مدیریت فرآیندهای مربوط به درخواست تنخواه، ثبت فاکتورهای هزینه، و طی کردن مراحل تأیید تا پرداخت نهایی.
- **مدل‌های کلیدی:**
    - `Tankhah`: مدل اصلی برای یک درخواست تنخواه (درخواست وجه برای هزینه‌ها).
    - `Factor`: مدل فاکتور که زیرمجموعه یک تنخواه است و هزینه‌های انجام‌شده را ثبت می‌کند.
    - `FactorItem`: ردیف‌های هر فاکتور (اقلام خریداری‌شده یا خدمات دریافت‌شده).
    - `ApprovalLog`: ثبت تاریخچه کامل تمام اقدامات (تأیید، رد، تغییر مرحله) که روی یک فاکتور یا تنخواه توسط کاربران مختلف انجام می‌شود.

### ۵. اپلیکیشن `notificationApp` (سیستم اعلان‌ها)

این اپلیکیشن یک سیستم اعلان پویا و انعطاف‌پذیر را فراهم می‌کند.

- **مسئولیت:** ارسال اعلان‌های درون‌برنامه‌ای، ایمیل یا پیامک به کاربران بر اساس رویدادهای مختلف سیستم.
- **مدل‌های کلیدی:**
    - `NotificationRule`: به ادمین اجازه می‌دهد تا قوانین ارسال اعلان را تعریف کند (مثلاً: اگر فاکتور تأیید شد، به مدیر مالی اعلان بفرست).
    - `Notification`: هر اعلان ارسال‌شده برای یک کاربر را به همراه جزئیات آن ذخیره می‌کند. این مدل از `GenericForeignKey` برای اتصال به هر آبجکتی در سیستم استفاده می‌کند.

### ۶. اپلیکیشن `reports` (گزارش‌گیری)

- **مسئولیت:** ایجاد گزارش‌های تجمیعی و خلاصه‌شده از داده‌های مالی و همچنین مدیریت دسترسی‌های مربوط به گزارش‌گیری.
- **مدل‌های کلیدی:**
    - `FinancialReport`: یک مدل Denormalized که خلاصه‌ای از وضعیت مالی یک تنخواه (جمع مبالغ، تعداد فاکتورها و...) را برای گزارش‌گیری سریع‌تر ذخیره می‌کند.

### ۷. اپلیکیشن `version_tracker` (ردیابی نسخه نرم‌افزار)

این یک اپلیکیشن بسیار پیشرفته و خلاقانه برای کنترل نسخه خودکار نرم‌افزار است.

- **مسئولیت:** رصد خودکار تغییرات در فایل‌های کد پروژه، ایجاد شماره نسخه جدید بر اساس نوع تغییرات (Major, Minor, Patch)، و ثبت دقیق تفاوت کد قدیم و جدید برای هر فایل.
- **مدل‌های کلیدی:**
    - `AppVersion`: نسخه هر اپلیکیشن را به همراه لیست فایل‌های تغییریافته ذخیره می‌کند.
    - `CodeChangeLog`: تفاوت بین کد قدیم و جدید را برای هر فایل تغییریافته ذخیره می‌کند و یک تاریخچه کامل از تغییرات کد را در دیتابیس نگهداری می‌کند.

### ۸. اپلیکیشن `usb_key_validator`

- **وضعیت:** در حال حاضر فایل `models.py` این اپلیکیشن خالی است و هیچ مدلی در آن تعریف نشده است.

---

## بخش ۳: منسوخ شدن سیستم گردش کار قدیمی

**نکته بسیار مهم:** در گذشته، گردش کار از طریق مدل‌های `core.WorkflowStage` و `core.AccessRule` مدیریت می‌شد. این دو مدل **منسوخ شده‌اند** و سیستم جدید و پویای مبتنی بر `Transition` (که در بخش اپلیکیشن `core` توضیح داده شد) جایگزین آن‌ها شده است. برای هرگونه توسعه جدید، باید **فقط** از سیستم جدید استفاده شود.

---

## بخش ۴: جمع‌بندی نهایی

پروژه `BudgetsSystem` یک نمونه عالی از یک نرم‌افزار سازمانی استاندارد، قدرتمند و با معماری صحیح است. طراحی ماژولار، موتور گردش کار داینامیک، و ابزارهای هوشمندی مانند ردیاب نسخه، آن را به یک پروژه قابل اتکا و قابل توسعه در بلندمدت تبدیل کرده است.
