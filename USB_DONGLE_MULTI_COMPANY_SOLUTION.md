# 🏢 راه‌حل کامل USB Dongle برای چندین شرکت

## 🎯 خلاصه تغییرات

### **✅ مشکلات برطرف شده**:
1. **لینک‌های اصلاح شده**: همه URL ها درست کار می‌کنند
2. **پشتیبانی چندین شرکت**: سیستم حالا از چندین شرکت پشتیبانی می‌کند
3. **ادغام RCMS_Lock**: سیستم قفل با dongle ادغام شده
4. **نمایش اطلاعات کامل**: اطلاعات شرکت در dongle نمایش داده می‌شود
5. **امکان ویرایش**: dongle ها قابل ویرایش هستند

## 🔧 ویژگی‌های جدید

### **1. پشتیبانی از چندین شرکت**:

#### **اطلاعات ذخیره شده در dongle**:
```python
{
    'device_id': 'شناسه منحصر به فرد (16 کاراکتر)',
    'created_at': 'زمان ایجاد (timestamp)',
    'version': '2.0',
    'sector_count': 6,
    'checksum': 'SHA256 checksum',
    'organization_name': 'نام شرکت/سازمان',
    'software_id': 'شناسه نرم‌افزار (RCMS)',
    'expiry_date': 'تاریخ انقضا',
    'dongle_type': 'multi_company'
}
```

#### **ادغام با RCMS_Lock**:
- ✅ **استفاده از TimeLockModel**: اطلاعات قفل از دیتابیس خوانده می‌شود
- ✅ **نام سازمان**: از `organization_name` در دیتابیس استفاده می‌شود
- ✅ **تاریخ انقضا**: از `expiry_date` در دیتابیس استفاده می‌شود
- ✅ **حداکثر کاربران**: از `max_users` در دیتابیس استفاده می‌شود

### **2. رابط کاربری بهبود یافته**:

#### **صفحه اعتبارسنجی پیشرفته** (`/usb-key-validator/enhanced/`):
- ✅ **فرم اطلاعات شرکت**: امکان وارد کردن نام شرکت و شناسه نرم‌افزار
- ✅ **انتخاب USB**: لیست درایوهای متصل
- ✅ **عملیات مختلف**: ایجاد، اعتبارسنجی، تعمیر، بررسی روزانه

#### **داشبورد مدیریت** (`/usb-key-validator/dashboard/`):
- ✅ **آمار کلی**: تعداد درایوها، dongle های معتبر
- ✅ **اطلاعات شرکت**: نام شرکت، شناسه نرم‌افزار، تاریخ انقضا
- ✅ **وضعیت سکتورها**: نمایش وضعیت هر سکتور
- ✅ **دکمه ویرایش**: امکان ویرایش اطلاعات dongle

#### **صفحه ویرایش** (`/usb-key-validator/edit/<device_id>/`):
- ✅ **فرم ویرایش**: امکان تغییر نام شرکت، شناسه نرم‌افزار، تاریخ انقضا
- ✅ **اطلاعات فعلی**: نمایش اطلاعات موجود dongle
- ✅ **هشدارها**: راهنمایی برای کاربر

#### **صفحه ایجاد شرکت جدید** (`/usb-key-validator/create-company/`):
- ✅ **فرم شرکت جدید**: ایجاد قفل جدید برای شرکت جدید
- ✅ **تنظیمات**: تعداد کاربران، مدت اعتبار
- ✅ **راهنما**: مراحل ایجاد و نکات مهم

### **3. عملکرد بهبود یافته**:

#### **خواندن/نوشتن پیشرفته**:
- ✅ **چندین نوع دسترسی**: تلاش با `GENERIC_WRITE`, `GENERIC_READ | GENERIC_WRITE`, `GENERIC_ALL`
- ✅ **چندین نوع Share**: `FILE_SHARE_WRITE`, `FILE_SHARE_READ | FILE_SHARE_WRITE`, `0`
- ✅ **Fallback mechanism**: اگر یک نوع دسترسی ناموفق باشد، نوع بعدی را امتحان می‌کند

#### **اعتبارسنجی هوشمند**:
- ✅ **بررسی تاریخ انقضا**: dongle منقضی شده شناسایی می‌شود
- ✅ **اطلاعات شرکت**: نام شرکت و شناسه نرم‌افزار نمایش داده می‌شود
- ✅ **سازگاری با فرمت قدیمی**: dongle های قدیمی همچنان کار می‌کنند

## 🚀 نحوه استفاده

### **برای مدیر سیستم**:

#### **1. ایجاد dongle برای شرکت موجود**:
```
1. برو به: http://127.0.0.1:8000/usb-key-validator/enhanced/
2. فلش را انتخاب کن
3. اطلاعات شرکت را وارد کن (اختیاری - از دیتابیس خوانده می‌شود)
4. "ایجاد Dongle" را کلیک کن
```

#### **2. ایجاد dongle برای شرکت جدید**:
```
1. برو به: http://127.0.0.1:8000/usb-key-validator/create-company/
2. اطلاعات شرکت جدید را وارد کن
3. "ایجاد قفل جدید" را کلیک کن
4. حالا می‌توانی dongle ایجاد کنی
```

#### **3. ویرایش dongle موجود**:
```
1. برو به: http://127.0.0.1:8000/usb-key-validator/dashboard/
2. روی "ویرایش" کلیک کن
3. اطلاعات جدید را وارد کن
4. "ذخیره تغییرات" را کلیک کن
```

### **برای کاربر نهایی**:
```
1. فلش dongle را به کامپیوتر متصل کن
2. وارد سیستم شو
3. اگر dongle معتبر باشد، دسترسی داری
4. اگر نامعتبر باشد، به صفحه اعتبارسنجی هدایت می‌شوی
```

## 📊 اطلاعات نمایش داده شده

### **در داشبورد**:
- ✅ **نام شرکت**: نام سازمان/شرکت
- ✅ **شناسه نرم‌افزار**: شناسه نرم‌افزار (معمولاً RCMS)
- ✅ **تاریخ انقضا**: تاریخ انقضای dongle
- ✅ **نوع Dongle**: multi_company یا قدیمی
- ✅ **شناسه دستگاه**: شناسه منحصر به فرد dongle
- ✅ **تاریخ ایجاد**: زمان ایجاد dongle
- ✅ **وضعیت سکتورها**: معتبر/نامعتبر برای هر سکتور

### **در اعتبارسنجی**:
- ✅ **وضعیت کلی**: معتبر/نامعتبر
- ✅ **پیام تفصیلی**: شامل نام شرکت و شناسه نرم‌افزار
- ✅ **منبع**: سکتور اصلی یا پشتیبان

## 🔐 امنیت و محافظت

### **اطلاعات مخفی**:
- ✅ **سکتورهای خام**: اطلاعات در سکتورهای خام دیسک نوشته می‌شوند
- ✅ **خارج از فایل سیستم**: خارج از فضای قابل مشاهده FAT32/NTFS
- ✅ **رمزگذاری**: اطلاعات با SHA256 محافظت می‌شوند
- ✅ **امضای منحصر به فرد**: هر dongle امضای خاص خود را دارد
- ✅ **چندین سکتور**: 6 سکتور (1 اصلی + 5 پشتیبان) برای مقاومت

### **اعتبارسنجی خودکار**:
- ✅ **Middleware**: چک در هر لاگین کاربران عادی
- ✅ **معافیت Superuser**: ادمین‌ها معاف هستند
- ✅ **Cache هوشمند**: 5 دقیقه cache
- ✅ **هدایت خودکار**: در صورت خطا

## 🎯 مزایای سیستم جدید

### **برای چندین شرکت**:
- ✅ **جداسازی**: هر شرکت dongle مخصوص خود را دارد
- ✅ **اطلاعات مخصوص**: نام شرکت، شناسه نرم‌افزار، تاریخ انقضا
- ✅ **مدیریت مستقل**: هر شرکت می‌تواند dongle خود را مدیریت کند
- ✅ **امنیت بالا**: اطلاعات هر شرکت جداگانه محافظت می‌شود

### **برای مدیر سیستم**:
- ✅ **مدیریت آسان**: رابط کاربری ساده و قابل فهم
- ✅ **اطلاعات کامل**: نمایش تمام اطلاعات dongle
- ✅ **امکان ویرایش**: تغییر اطلاعات بدون ایجاد dongle جدید
- ✅ **پشتیبانی کامل**: از فرمت قدیمی و جدید

### **برای کاربر نهایی**:
- ✅ **شفافیت**: می‌داند dongle متعلق به کدام شرکت است
- ✅ **اطمینان**: اطلاعات شرکت در dongle محافظت می‌شود
- ✅ **سازگاری**: با dongle های قدیمی کار می‌کند

## 🔧 عیب‌یابی

### **مشکل دسترسی**:
```
راه‌حل: Django را به عنوان Administrator اجرا کنید
- اسکریپت: scripts/run_as_admin.bat
- یا: scripts/run_as_admin.ps1
```

### **مشکل فرمت قدیمی**:
```
راه‌حل: سیستم با فرمت قدیمی سازگار است
- dongle های قدیمی همچنان کار می‌کنند
- اطلاعات شرکت "نامشخص (فرمت قدیمی)" نمایش داده می‌شود
```

### **مشکل اطلاعات شرکت**:
```
راه‌حل: از صفحه ویرایش استفاده کنید
- برو به: /usb-key-validator/dashboard/
- روی "ویرایش" کلیک کن
- اطلاعات جدید را وارد کن
```

## 📋 چک‌لیست کامل

### **قبل از شروع**:
- [ ] Django به عنوان Administrator اجرا شده
- [ ] فلش USB متصل و شناسایی شده
- [ ] فلش فرمت شده (FAT32 یا NTFS)
- [ ] حداقل 1GB فضای خالی موجود

### **ایجاد dongle**:
- [ ] فلش در لیست USB ها نمایش داده می‌شود
- [ ] اطلاعات شرکت وارد شده (اختیاری)
- [ ] دکمه "ایجاد Dongle" قابل کلیک است
- [ ] پیام موفقیت نمایش داده می‌شود
- [ ] سکتورها به عنوان "valid" نمایش داده می‌شوند

### **مدیریت dongle**:
- [ ] اطلاعات شرکت در داشبورد نمایش داده می‌شود
- [ ] دکمه "ویرایش" قابل کلیک است
- [ ] صفحه ویرایش باز می‌شود
- [ ] تغییرات ذخیره می‌شوند
- [ ] اطلاعات جدید نمایش داده می‌شود

### **اعتبارسنجی**:
- [ ] اعتبارسنجی موفق است
- [ ] اطلاعات شرکت نمایش داده می‌شود
- [ ] سکتورها قابل خواندن هستند
- [ ] Middleware در هر لاگین چک می‌کند
- [ ] Dashboard آمار صحیح نمایش می‌دهد

## 🎉 نتیجه نهایی

**سیستم USB Dongle کاملاً بهبود یافته و آماده استفاده برای چندین شرکت است!** 🚀

### **ویژگی‌های کلیدی**:
- ✅ **پشتیبانی چندین شرکت**: هر شرکت dongle مخصوص خود را دارد
- ✅ **اطلاعات کامل**: نام شرکت، شناسه نرم‌افزار، تاریخ انقضا
- ✅ **امکان ویرایش**: تغییر اطلاعات بدون ایجاد dongle جدید
- ✅ **رابط کاربری بهتر**: صفحات جدید برای مدیریت
- ✅ **سازگاری کامل**: با dongle های قدیمی کار می‌کند
- ✅ **امنیت بالا**: اطلاعات در سکتورهای مخفی محافظت می‌شود

### **URL های مهم**:
- **اعتبارسنجی پیشرفته**: `http://127.0.0.1:8000/usb-key-validator/enhanced/`
- **داشبورد مدیریت**: `http://127.0.0.1:8000/usb-key-validator/dashboard/`
- **ایجاد شرکت جدید**: `http://127.0.0.1:8000/usb-key-validator/create-company/`
- **ویرایش dongle**: `http://127.0.0.1:8000/usb-key-validator/edit/<device_id>/`

**همه مشکلات برطرف شد و سیستم آماده استفاده است!** ✨
