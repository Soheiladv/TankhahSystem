<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
</head>
<body>
برای بررسی نحوه ارتباط یک پست سازمانی به کاربر و ارتباط آن پست با گردش کار سازمان، باید مدل‌های تعریف‌شده و روابط بین آن‌ها را تحلیل کنیم. در ادامه، این ارتباطات را به‌صورت گام‌به‌گام توضیح می‌دهم:
1. ارتباط پست سازمانی با کاربر
مدل‌های مرتبط: Post, UserPost, CustomUser
مدل Post:
این مدل یک پست سازمانی (مثل مدیر، حسابدار) را تعریف می‌کند.
ویژگی‌های مهم:
organization: به مدل Organization مرتبط است (هر پست متعلق به یک سازمان است).
parent: برای تعریف سلسله‌مراتب پست‌ها (پست والد).
level: سطح پست در سلسله‌مراتب.
is_payment_order_signer: مشخص می‌کند آیا پست مجاز به امضای دستور پرداخت است یا خیر.
مدل UserPost:
این مدل برای اتصال یک کاربر به یک پست استفاده می‌شود.
ویژگی‌های مهم:
user: به مدل CustomUser (کاربر) مرتبط است.
post: به مدل Post (پست سازمانی) مرتبط است.
start_date و end_date: بازه زمانی که کاربر در این پست فعال است.
is_active: وضعیت فعال بودن این اتصال.
unique_together = ('user', 'post'): تضمین می‌کند که یک کاربر نمی‌تواند همزمان دو بار به یک پست متصل شود.
نحوه ارتباط:
مدل UserPost به‌عنوان یک جدول واسطه عمل می‌کند که کاربر (CustomUser) را به پست سازمانی (Post) متصل می‌کند.
مثلاً، اگر کاربری به نام "علی" به پست "مدیر مالی" متصل شود، یک رکورد در UserPost ایجاد می‌شود که user=علی و post=مدیر مالی را مشخص می‌کند.
این مدل امکان ردیابی تاریخچه (با start_date و end_date) و مدیریت تغییرات پست‌های کاربر را فراهم می‌کند.
چگونه کار می‌کند؟
وقتی یک کاربر به یک پست متصل می‌شود، از طریق مدل UserPost مشخص می‌شود که این کاربر چه نقشی (پست) در سازمان دارد.
مثلاً، اگر بخواهید ببینید کدام کاربر در پست "حسابدار" است، می‌توانید کوئری زیر را اجرا کنید:
python
UserPost.objects.filter(post__name="حسابدار", is_active=True)
این کوئری تمام کاربرانی که در حال حاضر به پست "حسابدار" متصل هستند را برمی‌گرداند.
2. ارتباط پست سازمانی با گردش کار سازمان
مدل‌های مرتبط: Post, WorkflowStage, PostAction
مدل WorkflowStage:
این مدل مراحل مختلف یک گردش کار (Workflow) را تعریف می‌کند.
ویژگی‌های مهم:
name: نام مرحله (مثل "بررسی اولیه" یا "تأیید نهایی").
order: ترتیب مرحله در گردش کار.
is_final_stage: مشخص می‌کند آیا این مرحله، مرحله نهایی است.
هر مرحله نشان‌دهنده یک گام در فرآیند گردش کار است (مثلاً تأیید، رد، یا صدور دستور پرداخت).
مدل PostAction:
این مدل مشخص می‌کند که یک پست خاص در یک مرحله خاص از گردش کار چه اقداماتی می‌تواند انجام دهد.
ویژگی‌های مهم:
post: به مدل Post مرتبط است (مشخص می‌کند کدام پست می‌تواند اقدام کند).
stage: به مدل WorkflowStage مرتبط است (مشخص می‌کند این اقدام در کدام مرحله انجام می‌شود).
action_type: نوع اقدام (مثل APPROVE, REJECT, ISSUE_PAYMENT_ORDER).
unique_together = ('post', 'stage', 'action_type'): تضمین می‌کند که یک پست نمی‌تواند در یک مرحله، یک نوع اقدام را چند بار داشته باشد.
نحوه ارتباط:
مدل PostAction به‌عنوان یک جدول واسطه عمل می‌کند که مشخص می‌کند کدام پست‌ها در کدام مراحل گردش کار می‌توانند چه اقداماتی انجام دهند.
مثلاً، اگر پست "مدیر مالی" در مرحله "تأیید نهایی" بتواند اقدام APPROVE را انجام دهد، یک رکورد در PostAction ایجاد می‌شود که:
post=مدیر مالی
stage=تأیید نهایی
action_type=APPROVE
چگونه کار می‌کند؟
وقتی یک فرآیند (مثل درخواست بودجه یا تنخواه) در سیستم ثبت می‌شود، این فرآیند از مراحل مختلف گردش کار (WorkflowStage) عبور می‌کند.
در هر مرحله، سیستم بررسی می‌کند که کدام پست‌ها می‌توانند اقدام کنند (از طریق PostAction).
سپس، از طریق UserPost مشخص می‌شود که کدام کاربران به این پست‌ها متصل هستند و بنابراین می‌توانند اقدام موردنظر را انجام دهند.
مثلاً، اگر بخواهید ببینید کدام پست‌ها می‌توانند در مرحله "تأیید نهایی" اقدام APPROVE را انجام دهند:
python
PostAction.objects.filter(stage__name="تأیید نهایی", action_type="APPROVE", is_active=True)
سپس، برای یافتن کاربران مرتبط:
python
users = UserPost.objects.filter(post__in=PostAction.objects.filter(stage__name="تأیید نهایی", action_type="APPROVE").values('post'), is_active=True).select_related('user')
3. جمع‌بندی ارتباطات
کاربر به پست:
از طریق مدل UserPost، یک کاربر به یک یا چند پست سازمانی متصل می‌شود.
این اتصال مشخص می‌کند که کاربر چه نقشی در سازمان دارد.
پست به گردش کار:
از طریق مدل PostAction، یک پست به یک مرحله خاص از گردش کار (WorkflowStage) و نوع اقدام (action_type) متصل می‌شود.
این مدل مشخص می‌کند که پست در کدام مرحله چه کاری می‌تواند انجام دهد.
کاربر به گردش کار (به‌صورت غیرمستقیم):
کاربر از طریق UserPost به پست متصل است.
پست از طریق PostAction به مراحل گردش کار و اقدامات مجاز متصل است.
بنابراین، کاربر می‌تواند در مراحل خاصی از گردش کار (که پستش اجازه می‌دهد) اقدام کند.
4. مثال عملی
فرض کنید یک فرآیند درخواست بودجه در سازمان وجود دارد:
کاربر "علی" به پست "حسابدار" متصل است (UserPost).
پست "حسابدار" در مرحله "بررسی اولیه" می‌تواند اقدام "تأیید" را انجام دهد (PostAction).
وقتی درخواست بودجه به مرحله "بررسی اولیه" می‌رسد، سیستم به "علی" اجازه می‌دهد که درخواست را تأیید کند، چون او به پست "حسابدار" متصل است.
5. نکات اضافی
اعتبارسنجی‌ها:
مدل WorkflowStage تضمین می‌کند که ترتیب مراحل (order) تکراری نباشد.
مدل PostAction با unique_together از تعریف اقدامات تکراری برای یک پست در یک مرحله جلوگیری می‌کند.
مدیریت سلسله‌مراتب:
مدل Post از parent و level برای تعریف سلسله‌مراتب استفاده می‌کند، که می‌تواند برای تعیین دسترسی‌های پیچیده‌تر (مثل ارجاع به پست‌های بالاتر) استفاده شود.
ردیابی تغییرات:
مدل PostHistory تغییرات اعمال‌شده روی پست‌ها را ثبت می‌کند، که برای حسابرسی و ردیابی مفید است.
اگر نیاز به توضیحات بیشتر یا یک کوئری خاص برای پیاده‌سازی این ارتباطات دارید، بگویید تا کمک کنم!
</body>
</html>