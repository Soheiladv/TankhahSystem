{% extends 'base.html' %}
{% load static rcms_custom_filters jformat %}

{% block title %}داشبورد گزارشات - آمار بودجه{% endblock %}

{% block extra_css %}
<!-- AOS Animation Library -->
<link href="{% static 'admin/css/aos.css' %}" rel="stylesheet">
<!-- Chart Fixes CSS -->
<link href="{% static 'admin/css/chart-fixes.css' %}" rel="stylesheet">
<!-- Custom Dashboard CSS -->
<!-- <link href="{% static 'reports/css/dashboard.css' %}" rel="stylesheet"> -->
<style>
    /* Dashboard Color Scheme - Clean & Professional */
    .dashboard-container {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }
    
    .dashboard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-header p {
        font-size: 1.1rem;
        margin: 10px 0 0 0;
        opacity: 0.9;
    }
    
    /* Statistics Cards */
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stats-card .card-title {
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }
    
    .stats-card .card-value {
        color: #1e293b;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    .stats-card .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-bottom: 15px;
    }
    
    /* Color variants for different stat types */
    .stats-card.budget .card-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stats-card.tankhah .card-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stats-card.factor .card-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stats-card.payment .card-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .stats-card.project .card-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .stats-card.return .card-icon { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    
    /* Chart Containers */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
    
    .chart-container h5 {
        color: #1e293b;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .chart-wrapper {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    .chart-wrapper canvas {
        max-height: 400px !important;
    }
    
    /* Loading state for charts */
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: #64748b;
        font-size: 1.1rem;
    }
    
    .chart-loading::before {
        content: '📊';
        margin-left: 8px;
        animation: pulse 2s infinite;
    }
    
    /* Progress rings */
    .progress-ring-circle {
        stroke-dasharray: 251.2;
        stroke-dashoffset: 251.2;
        transition: stroke-dashoffset 0.5s ease-in-out;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 10px;
        }
        
        .dashboard-header {
            padding: 20px;
        }
        
        .dashboard-header h1 {
            font-size: 2rem;
        }
        
        .stats-card .card-value {
            font-size: 2rem;
        }
        
        .chart-wrapper {
            height: 300px;
        }
    }
    
    /* Animation keyframes */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slide-up {
        animation: slideInUp 0.6s ease-out;
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in-left {
        animation: slideInLeft 0.6s ease-out;
    }
    
    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-50px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .bounce-in {
        animation: bounceIn 0.8s ease-out;
    }
    
    @keyframes bounceIn {
        0% { opacity: 0; transform: scale(0.3); }
        50% { opacity: 1; transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { opacity: 1; transform: scale(1); }
    }

    /* Tabs */
    .dash-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .dash-tab { border: 1px solid #e2e8f0; background: #fff; padding: 8px 14px; border-radius: 10px; cursor: pointer; }
    .dash-tab.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .dash-pane { display: none; }
    .dash-pane.active { display: block; }
    .stats-card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e2e8f0; }
    .stats-card .card-title { color: #64748b; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .stats-card .card-value { color: #1e293b; font-size: 2rem; font-weight: 700; margin: 0; }
    /* Revert to pre-tabs look: hide tabs, show content panes as normal blocks */
    #dashTabs { display: none !important; }
    .dash-pane { display: block !important; margin-bottom: 1.25rem; }
    .dash-tab { display: none !important; }
    .chart-container { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e2e8f0; }
    .chart-wrapper { position: relative; height: 380px; }
</style>
{% endblock %}

{% block content %}

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header" data-aos="fade-down">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>
                    <i class="fas fa-chart-line me-3"></i>
                    داشبورد گزارشات بودجه
                </h1>
                <p>آمار کامل و تحلیل‌های پیشرفته سیستم بودجه‌بندی</p>
            </div>
            <div class="col-md-4 text-end">
                <i class="fas fa-chart-pie fa-5x" style="opacity: 0.2;"></i>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="dash-tabs" id="dashTabs">
        {% if can_view_overview %}<div class="dash-tab" data-tab="overview">نمای کلی</div>{% endif %}
        {% if can_view_budget %}<div class="dash-tab" data-tab="budget">بودجه</div>{% endif %}
        {% if can_view_tankhah %}<div class="dash-tab" data-tab="tankhah">تنخواه</div>{% endif %}
        {% if can_view_factors %}<div class="dash-tab" data-tab="factors">فاکتورها</div>{% endif %}
        {% if can_view_risk %}<div class="dash-tab" data-tab="risk">ریسک و مقایسه</div>{% endif %}
    </div>

    <!-- Filters Section -->
    <div class="row mb-4" data-aos="fade-up">
        <div class="col-12">
            <div class="filter-section">
                <h4 class="filter-title" style="color: var(--gray-700);">
                    فیلترهای پیشرفته
                </h4>
                <form method="GET" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">تاریخ شروع</label>
                            <input type="text" class="form-control" data-jdp name="start_date" id="start_date" value="{{ request.GET.start_date }}" placeholder="YYYY/MM/DD">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">تاریخ پایان</label>
                            <input type="text" class="form-control" data-jdp name="end_date" id="end_date" value="{{ request.GET.end_date }}" placeholder="YYYY/MM/DD">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">سازمان</label>
                            <select class="form-select" name="organization" id="organization">
                                <option value="">همه سازمان‌ها</option>
                                {% if organizations %}
                                {% for org in organizations %}
                                <option value="{{ org.id }}" {% if request.GET.organization == org.id|stringformat:'s' %}selected{% endif %}>{{ org.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">پروژه</label>
                            <select class="form-select" name="project" id="project">
                                <option value="">همه پروژه‌ها</option>
                                {% if projects %}
                                {% for p in projects %}
                                <option value="{{ p.id }}" {% if request.GET.project == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-2"></i>
                                اعمال فیلتر
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo me-2"></i>
                                پاک کردن
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Overview Pane: keep existing overview cards/charts here -->
    <div class="dash-pane" id="pane-overview">
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">کل بودجه</div>
                    <div class="card-value">{{ budget_stats.total_budget|format_negative }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">کل تخصیص</div>
                    <div class="card-value">{{ budget_stats.total_allocated|format_negative }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">کل مصرف</div>
                    <div class="card-value">{{ budget_stats.total_consumed|format_negative }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">کل برگشت</div>
                    <div class="card-value">{{ budget_stats.total_returned|format_negative }}</div>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">تعداد تنخواه</div>
                    <div class="card-value">{{ tankhah_stats.total_count|default:"0" }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">مبلغ تنخواه</div>
                    <div class="card-value">{{ tankhah_stats.total_amount|format_negative }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">تعداد فاکتور</div>
                    <div class="card-value">{{ factor_stats.total_count|default:"0" }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">مبلغ فاکتورها</div>
                    <div class="card-value">{{ factor_stats.total_amount|format_negative }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Pane -->
    <div class="dash-pane" id="pane-budget">
        <!-- Advanced Budget KPIs -->
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">نرخ جذب بودجه</div>
                    <div class="card-value" id="kpiAbsorption">0%</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">تخصیص</div>
                    <div class="card-value" id="kpiAllocated">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">مصرف</div>
                    <div class="card-value" id="kpiConsumed">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">باقی‌مانده</div>
                    <div class="card-value" id="kpiRemaining">0</div>
                </div>
            </div>
        </div>

        <!-- Advanced Budget Charts -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-sliders-h me-2" style="color:#0ea5e9;"></i>
                        برنامه‌ریزی‌شده در برابر واقعی (ماهانه)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="plannedActualChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-area me-2" style="color:#22c55e;"></i>
                        پیش‌بینی مانده (۳ ماه آینده)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="forecastRemainingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-bullseye me-2" style="color:#f59e0b;"></i>
                        تمرکز بودجه (Top 5)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="concentrationChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-hourglass-half me-2" style="color:#8b5cf6;"></i>
                        سن تخصیص‌ها (Aging)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="agingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Charts Section -->
        <div class="row mb-4">
            <!-- Budget Distribution Chart -->
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-pie me-2" style="color: #3b82f6;"></i>
                        توزیع بودجه بر اساس سازمان
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="budgetDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Consumption Chart -->
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-line me-2" style="color: #10b981;"></i>
                        روند مصرف بودجه (ماهانه)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="monthlyConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- Detailed Statistics Tables -->
        <div class="row mb-4">
            <!-- Budget Returns by Organization -->
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="fas fa-building me-2" style="color: #ef4444;"></i>
                        برگشت بودجه بر اساس سازمان
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>سازمان</th>
                                    <th>تعداد</th>
                                    <th>مبلغ (ریال)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for org in return_stats.org_returns %}
                                <tr>
                                    <td>{{ org.allocation__organization__name|default:"نامشخص" }}</td>
                                    <td><span class="badge bg-primary">{{ org.count }}</span></td>
                                    <td>{{ org.total_amount|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">داده‌ای یافت نشد</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Budget Returns by Project -->
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="fas fa-project-diagram me-2 text-success"></i>
                        برگشت بودجه بر اساس پروژه
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>پروژه</th>
                                    <th>تعداد</th>
                                    <th>مبلغ (ریال)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in return_stats.project_returns %}
                                <tr>
                                    <td>{{ project.allocation__project__name|default:"نامشخص" }}</td>
                                    <td><span class="badge bg-success">{{ project.count }}</span></td>
                                    <td>{{ project.total_amount|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">داده‌ای یافت نشد</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


    <!-- Tankhah Pane -->
    <div class="dash-pane" id="pane-tankhah">
        <!-- Charts Section -->
        <div class="row mb-4">
            <!-- Tankhah Status Chart -->
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-bar me-2" style="color: #f59e0b;"></i>
                        وضعیت تنخواه‌ها
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="tankhahStatusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Factor Category Chart -->
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-doughnut me-2" style="color: #8b5cf6;"></i>
                        دسته‌بندی فاکتورها
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="factorCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

      


    <!-- Factors Pane -->
    <div class="dash-pane" id="pane-factors">
        <div class="chart-container">
            <h5><i class="fas fa-list me-2"></i>پراکندگی دسته‌بندی فاکتورها</h5>
            <div class="chart-wrapper"><canvas id="factorCategoryChart"></canvas></div>
        </div>
    </div>

    <!-- Risk & Comparatives Pane -->
    <div class="dash-pane" id="pane-risk">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>نشانگرهای ریسک</h5>
                    <ul class="mb-0">
                        <li>درصد برگشت به کل تخصیص (سازمان/پروژه‌های با ریسک بالا)</li>
                        <li>Aging تسویه تنخواه (۳۰/۶۰/۹۰+ روز)</li>
                        <li>مصرف نزدیک سقف تخصیص</li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-balance-scale me-2"></i>مقایسه سازمان/پروژه</h5>
                    <div class="chart-wrapper"><canvas id="orgProjectCompareChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

        <!-- Action Buttons -->
        <div class="row mb-4" data-aos="fade-up">
            <div class="col-12 text-center">
                <a href="{% url 'reports_dashboard:analytics_redesigned' %}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-chart-line me-2"></i>
                    تحلیل‌های پیشرفته
                </a>
                <a href="{% url 'reports_dashboard:export_reports' %}" class="btn btn-success btn-lg me-3">
                    <i class="fas fa-download me-2"></i>
                    صادرات گزارشات
                </a>
                <button class="btn btn-info btn-lg" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-2"></i>
                    به‌روزرسانی
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js UMD from local -->
<script src="/static/admin/js/chart.umd.min.js"></script>
<!-- Chart Utilities -->
<script src="{% static 'admin/js/chart-utils.js' %}"></script>
<!-- Debug Charts -->
<script src="{% static 'admin/js/debug-charts.js' %}"></script>
<!-- AOS Animation Library -->
<script src="{% static 'admin/js/aos.js' %}"></script>
<!-- Persian Datepicker (guarded) -->
<script src="{% static 'admin/js/persian-datepicker.min.js' %}"></script>
<script src="{% static 'admin/js/persian_datepicker_init.js' %}"></script>

<script>
// Chart data from Django context
var chartData = {{ chart_data|default:"{}"|safe }};
var advancedBudget = {{ advanced_budget|default:"{}"|safe }};

console.log('Chart data received:', chartData);

// Parse JSON string if it's a string
try {
    if (typeof chartData === 'string') {
        chartData = JSON.parse(chartData);
    }
} catch (e) {
    console.error('Error parsing chart data JSON:', e);
}

// Fallback data if chartData is not available
if (!chartData || typeof chartData !== 'object' || Object.keys(chartData).length === 0) {
    console.log('Using fallback chart data');
    chartData = {
        org_budget: [ 
        ],
        monthly_consumption: [ 
        ],
        tankhah_status: [ 
        ],
        factor_category: [ 
        ]
    };
}

// Initialize AOS
AOS.init({
    duration: 800,
    easing: 'ease-in-out',
    once: true
});

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Initializing Dashboard');
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        return;
    }
    
    // Initialize AOS animations
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 1000,
            once: true
        });
        console.log('AOS initialized');
    } else {
        console.warn('AOS not loaded');
    }
    
    // Debug: Check chart data
    console.log('Chart data from Django:', chartData);
    console.log('Chart data type:', typeof chartData);
    
    // Load filter options
    loadFilterOptions();
    
    // Write advanced KPIs
    try {
        if (typeof advancedBudget === 'string') { advancedBudget = JSON.parse(advancedBudget); }
        var ab = advancedBudget || {};
        var fmt = function(n){ try { return Number(n||0).toLocaleString('fa-IR'); } catch(e){ return n||0; } };
        var byId = function(id){ return document.getElementById(id); };
        if (byId('kpiAbsorption')) byId('kpiAbsorption').textContent = ((ab.absorption_rate||0).toFixed ? ab.absorption_rate.toFixed(1) : Number(ab.absorption_rate||0).toFixed(1)) + '%';
        if (byId('kpiAllocated')) byId('kpiAllocated').textContent = fmt((ab.totals||{}).allocated);
        if (byId('kpiConsumed')) byId('kpiConsumed').textContent = fmt((ab.totals||{}).consumed);
        if (byId('kpiRemaining')) byId('kpiRemaining').textContent = fmt((ab.totals||{}).remaining);
    } catch(e) { console.warn('advanced KPIs error', e); }

    // Initialize charts with delay to ensure DOM is ready
    setTimeout(function() {
        console.log('Initializing charts...');
        initializeCharts();
    }, 500);
    
    // Animate counters
    animateCounters();
});

// Initialize all charts
function initializeCharts() {
    console.log('Starting chart initialization...');
    
    try {
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        console.log('Chart.js is available');
        
        // Check if chart data is available
        if (!chartData || typeof chartData !== 'object') {
            console.error('Chart data is not available');
            return;
        }
        console.log('Chart data is available:', chartData);
        
        // Budget Distribution Chart
        var budgetCtx = document.getElementById('budgetDistributionChart');
        if (!budgetCtx) {
            console.error('Budget distribution chart canvas not found');
            return;
        }
        
        var orgBudgetData = chartData.org_budget || [];
        console.log('Organization budget data:', orgBudgetData);
        
        if (orgBudgetData.length === 0) {
            // Show empty state
            budgetCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">داده‌ای برای نمایش وجود ندارد</div>';
            return;
        }
        
        const budgetChartData = {
            labels: orgBudgetData.map(function(item) { return item.organization__name || 'نامشخص'; }),
            datasets: [{
                data: orgBudgetData.map(function(item) { return item.total || 0; }),
                backgroundColor: ChartUtils.COLOR_PALETTES.primary,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };

        const budgetChartOptions = {
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + ChartUtils.formatCurrency(context.parsed);
                        }
                    }
                }
            },
            animation: {
                animateRotate: true
            }
        };

        ChartUtils.createDoughnutChart('budgetDistributionChart', budgetChartData, budgetChartOptions);

    // Monthly Consumption Chart
    var consumptionCtx = document.getElementById('monthlyConsumptionChart');
    if (!consumptionCtx) {
        console.error('Monthly consumption chart canvas not found');
        return;
    }
    
    var monthlyData = chartData.monthly_consumption || [];
    console.log('Monthly consumption data:', monthlyData);
    
    if (monthlyData.length === 0) {
        // Show empty state
        consumptionCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">داده‌ای برای نمایش وجود ندارد</div>';
        return;
    }
    
        const consumptionChartData = {
            labels: monthlyData.map(function(item) {
                var date = new Date(item.month);
                return date.toLocaleDateString('fa-IR');
            }),
            datasets: [{
                label: 'مصرف بودجه',
                data: monthlyData.map(function(item) { return item.total || 0; }),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        };

        const consumptionChartOptions = {
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'مصرف: ' + ChartUtils.formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return ChartUtils.formatCurrency(value);
                        }
                    }
                }
            }
        };

        ChartUtils.createLineChart('monthlyConsumptionChart', consumptionChartData, consumptionChartOptions);

    // Tankhah Status Chart
    var tankhahCtx = document.getElementById('tankhahStatusChart');
    if (!tankhahCtx) {
        console.error('Tankhah status chart canvas not found');
        return;
    }
    
    var tankhahData = chartData.tankhah_status || [];
    console.log('Tankhah status data:', tankhahData);
    
    if (tankhahData.length === 0) {
        // Show empty state
        tankhahCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">داده‌ای برای نمایش وجود ندارد</div>';
        return;
    }
    
        const tankhahChartData = {
            labels: tankhahData.map(function(item) { return item.status__name || 'نامشخص'; }),
            datasets: [{
                label: 'تعداد تنخواه‌ها',
                data: tankhahData.map(function(item) { return item.count || 0; }),
                backgroundColor: '#3b82f6',
                borderColor: '#1d4ed8',
                borderWidth: 1
            }]
        };

        const tankhahChartOptions = {
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            animation: {
                easing: 'easeInOutBounce'
            }
        };

        ChartUtils.createBarChart('tankhahStatusChart', tankhahChartData, tankhahChartOptions);

    // Factor Category Chart
    var factorCtx = document.getElementById('factorCategoryChart');
    if (!factorCtx) {
        console.error('Factor category chart canvas not found');
        return;
    }
    
    var factorData = chartData.factor_category || [];
    console.log('Factor category data:', factorData);
    
    if (factorData.length === 0) {
        // Show empty state
        factorCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">داده‌ای برای نمایش وجود ندارد</div>';
        return;
    }
    
        const factorChartData = {
            labels: factorData.map(function(item) { return item.category__name || 'نامشخص'; }),
            datasets: [{
                data: factorData.map(function(item) { return item.total || 0; }),
                backgroundColor: ChartUtils.COLOR_PALETTES.primary,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };

        const factorChartOptions = {
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + ChartUtils.formatCurrency(context.parsed);
                        }
                    }
                }
            },
            animation: {
                animateRotate: true
            }
        };

        ChartUtils.createPieChart('factorCategoryChart', factorChartData, factorChartOptions);
    
    console.log('All charts initialized successfully');
    } catch (error) {
        console.error('Error initializing charts:', error);
        console.error('Error details:', error.message, error.stack);
    }
}

// Advanced charts drawing (planned vs actual, forecast, concentration, aging)
(function(){
    document.addEventListener('DOMContentLoaded', function(){
        try {
            if (typeof advancedBudget === 'string') { advancedBudget = JSON.parse(advancedBudget); }
            if (typeof Chart === 'undefined') return;
            var ab = advancedBudget || {};

            // Planned vs Actual
            var p = (ab.planned_vs_actual||{}).planned || [];
            var a = (ab.planned_vs_actual||{}).actual || [];
            var labels = (p.length ? p : a).map(function(x){ return new Date(x.month).toLocaleDateString('fa-IR'); });
            var plannedDataMap = {}; p.forEach(function(x){ plannedDataMap[x.month] = x.total||0; });
            var actualDataMap = {}; a.forEach(function(x){ actualDataMap[x.month] = x.total||0; });
            var plannedSeries = labels.map(function(lbl){
                // reconstruct month key from label not reliable; use original arrays if lengths match
                return p.length ? (p[labels.indexOf(lbl)]?.total||0) : 0;
            });
            var actualSeries = labels.map(function(lbl){
                return a.length ? (a[labels.indexOf(lbl)]?.total||0) : 0;
            });
            var ctxPA = document.getElementById('plannedActualChart');
            if (ctxPA && (p.length || a.length)) {
                new Chart(ctxPA, {
                    type: 'line',
                    data: { labels: labels, datasets: [
                        { label: 'برنامه', data: plannedSeries, borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.12)', fill:true, tension:0.35 },
                        { label: 'واقعی', data: actualSeries, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.12)', fill:true, tension:0.35 }
                    ]},
                    options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Forecast remaining
            var f = ab.forecast_remaining || [];
            var ctxF = document.getElementById('forecastRemainingChart');
            if (ctxF && f.length) {
                new Chart(ctxF, {
                    type: 'line',
                    data: {
                        labels: f.map(function(x){ return new Date(x.month).toLocaleDateString('fa-IR'); }),
                        datasets: [{ label:'باقی‌مانده پیش‌بینی‌شده', data: f.map(function(x){ return x.remaining||0; }), borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.12)', fill:true, tension:0.35 }]
                    },
                    options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Concentration (stack org + project side-by-side as grouped bar)
            var orgs = ((ab.concentration||{}).organizations)||[];
            var projs = ((ab.concentration||{}).projects)||[];
            var labelsC = (orgs.map(function(x){return x.name;}).concat(projs.map(function(x){return x.name;}))).slice(0,5);
            var ctxC = document.getElementById('concentrationChart');
            if (ctxC && (orgs.length || projs.length)) {
                new Chart(ctxC, {
                    type: 'bar',
                    data: {
                        labels: labelsC,
                        datasets: [
                            { label:'سازمان', data: orgs.map(function(x){return x.total||0;}), backgroundColor:'#3b82f6' },
                            { label:'پروژه', data: projs.map(function(x){return x.total||0;}), backgroundColor:'#8b5cf6' }
                        ]
                    },
                    options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Aging
            var ag = ab.aging || {};
            var ctxAg = document.getElementById('agingChart');
            if (ctxAg) {
                new Chart(ctxAg, {
                    type: 'bar',
                    data: {
                        labels: ['0-30','31-60','61-90','90+'],
                        datasets: [{ label:'تعداد', data: [ag.d_0_30||0, ag.d_31_60||0, ag.d_61_90||0, ag.d_90_plus||0], backgroundColor:'#f59e0b' }]
                    },
                    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, precision:0 } } }
                });
            }
        } catch(e){ console.warn('advanced budget charts error', e); }
    });
})();

// Load filter options with static data
function loadFilterOptions() {
    console.log('Loading filter options with static data...');
    
    // Static organizations data
    var organizations = [    ];
    
    // Static projects data
    var projects = [ ];
    
    // Load organizations
    var orgSelect = document.getElementById('organization');
    if (orgSelect) {
        organizations.forEach(function(org) {
            var option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name;
            orgSelect.appendChild(option);
        });
        console.log('Organizations loaded:', organizations.length);
    }
    
    // Load projects
    var projectSelect = document.getElementById('project');
    if (projectSelect) {
        projects.forEach(function(project) {
            var option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
        });
        console.log('Projects loaded:', projects.length);
    }
}

// Animate counters
function animateCounters() {
    var counters = document.querySelectorAll('.stat-value');
    
    counters.forEach(function(counter) {
        var target = parseInt(counter.textContent.replace(/,/g, ''));
        var duration = 2000;
        var increment = target / (duration / 16);
        var current = 0;
        
        var timer = setInterval(function() {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            counter.textContent = Math.floor(current).toLocaleString();
        }, 16);
    });
}

// Reset filters
function resetFilters() {
    document.getElementById('filterForm').reset();
}

// Refresh dashboard
function refreshDashboard() {
    location.reload();
}

// Progress ring animation
function animateProgressRing() {
    var circle = document.querySelector('.progress-ring-circle');
    if (!circle) return;
    
    var percentage = {{ budget_stats.return_percentage|default:"0"|floatformat:0 }};
    var circumference = 2 * Math.PI * 40;
    var offset = circumference - (percentage / 100) * circumference;
    
    circle.style.strokeDashoffset = offset;
}

// Initialize progress ring animation
setTimeout(animateProgressRing, 1000);

// Initialize date inputs (no pDatepicker needed)
$(document).ready(function() {
    console.log('Date inputs initialized with regular HTML5 date picker');
});

// Chart update function for theme changes
function updateChartsForTheme() {
    // Reinitialize charts with new theme colors
    if (typeof initializeCharts === 'function') {
        setTimeout(function() {
            initializeCharts();
        }, 100);
    }
}
</script>

</div> <!-- End dashboard-container -->
{% endblock %}
