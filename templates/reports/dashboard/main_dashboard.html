{% extends 'base.html' %}
{% load static rcms_custom_filters jformat %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª - Ø¢Ù…Ø§Ø± Ø¨ÙˆØ¯Ø¬Ù‡{% endblock %}

{% block extra_css %}
<!-- AOS Animation Library -->
<link href="{% static 'admin/css/aos.css' %}" rel="stylesheet">
<!-- Chart Fixes CSS -->
<link href="{% static 'admin/css/chart-fixes.css' %}" rel="stylesheet">
<style>
    /* Dashboard Color Scheme - Clean & Professional */
    .dashboard-container {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }
    
    .dashboard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-header p {
        font-size: 1.1rem;
        margin: 10px 0 0 0;
        opacity: 0.9;
    }
    
    /* Statistics Cards */
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stats-card .card-title {
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }
    
    .stats-card .card-value {
        color: #1e293b;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    .stats-card .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-bottom: 15px;
    }
    
    /* Color variants for different stat types */
    .stats-card.budget .card-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stats-card.tankhah .card-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stats-card.factor .card-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stats-card.payment .card-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .stats-card.project .card-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .stats-card.return .card-icon { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    
    /* Chart Containers */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
    
    .chart-container h5 {
        color: #1e293b;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .chart-wrapper {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    .chart-wrapper canvas {
        max-height: 400px !important;
    }
    
    /* Loading state for charts */
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: #64748b;
        font-size: 1.1rem;
    }
    
    .chart-loading::before {
        content: 'ğŸ“Š';
        margin-left: 8px;
        animation: pulse 2s infinite;
    }

    /* Accent help style for table help blocks */
    .help-accent {
        color: #ef4444; /* bright accent */
        font-weight: 700;
        font-size: 1.25rem; /* ~3 steps larger than small */
    }
    
    /* Tabs */
    .dash-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
        align-items: center;
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
    
    .dash-tab {
        border: 1px solid #e2e8f0;
        background: #fff;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .dash-tab:hover {
        background: #f1f5f9;
        border-color: #3b82f6;
    }
    
    .dash-tab.active {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }
    
    .dash-pane {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }
    
    .dash-pane.active {
        display: block;
    }
    
    .tab-toolbar {
        margin-inline-start: auto;
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .font-size-btn {
        border: 1px solid #e2e8f0;
        background: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .font-size-btn:hover {
        background: #f1f5f9;
    }
    
    .chart-mode-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 6px 10px;
        background: #fff;
    }
    
    .chart-3d-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 10px;
        }
        
        .dashboard-header {
            padding: 20px;
        }
        
        .dashboard-header h1 {
            font-size: 2rem;
        }
        
        .stats-card .card-value {
            font-size: 2rem;
        }
        
        .chart-wrapper {
            height: 300px;
        }
        
        .dash-tabs {
            flex-direction: column;
            align-items: stretch;
        }
        
        .tab-toolbar {
            margin-inline-start: 0;
            justify-content: center;
            margin-top: 10px;
        }
    }
    
    /* Animation keyframes */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header" data-aos="fade-down">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>
                    <i class="fas fa-chart-line me-3"></i>
                    Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¨ÙˆØ¯Ø¬Ù‡
                </h1>
                <p>Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ùˆ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø³ÛŒØ³ØªÙ… Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ</p>
            </div>
            <div class="col-md-4 text-end">
                <i class="fas fa-chart-pie fa-5x" style="opacity: 0.2;"></i>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="dash-tabs" id="dashTabs">
        <div class="dash-tab active" data-tab="overview">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ</div>
        {% if can_view_budget %}<div class="dash-tab" data-tab="budget">Ø¨ÙˆØ¯Ø¬Ù‡</div>{% endif %}
        {% if can_view_tankhah %}<div class="dash-tab" data-tab="tankhah">ØªÙ†Ø®ÙˆØ§Ù‡</div>{% endif %}
        {% if can_view_factors %}<div class="dash-tab" data-tab="factors">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</div>{% endif %}
        <div class="dash-tab" data-tab="risk">Ø±ÛŒØ³Ú© Ùˆ ØªØ­Ù„ÛŒÙ„</div>
        
        <div class="tab-toolbar">
            <select id="chartMode" class="chart-mode-select">
                <option value="bar">Ø³ØªÙˆÙ†ÛŒ</option>
                <option value="line">Ø®Ø·ÛŒ</option>
                <option value="pie">Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ</option>
                <option value="doughnut">Ø­Ù„Ù‚Ù‡â€ŒØ§ÛŒ</option>
            </select>
            <label class="chart-3d-toggle">
                <input type="checkbox" id="enable3D" />
                <span>Ù†Ù…Ø§ÛŒ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ</span>
            </label>
            <button id="fontSmaller" class="font-size-btn" title="Ú©ÙˆÚ†Ú©â€ŒØªØ±">Aâˆ’</button>
            <button id="fontBigger" class="font-size-btn" title="Ø¨Ø²Ø±Ú¯â€ŒØªØ±">A+</button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="row mb-4" data-aos="fade-up">
        <div class="col-12">
            <div class="filter-section">
                <h4 class="filter-title" style="color: var(--gray-700);">
                    ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
                </h4>
                <form method="GET" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                            <input type="text" class="form-control" data-jdp name="start_date" id="start_date" value="{{ request.GET.start_date }}" placeholder="YYYY/MM/DD">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
                            <input type="text" class="form-control" data-jdp name="end_date" id="end_date" value="{{ request.GET.end_date }}" placeholder="YYYY/MM/DD">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ø³Ø§Ø²Ù…Ø§Ù†</label>
                            <select class="form-select" name="organization" id="organization">
                                <option value="">Ù‡Ù…Ù‡ Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§</option>
                                {% if organizations %}
                                {% for org in organizations %}
                                <option value="{{ org.id }}" {% if request.GET.organization == org.id|stringformat:'s' %}selected{% endif %}>{{ org.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ù¾Ø±ÙˆÚ˜Ù‡</label>
                            <select class="form-select" name="project" id="project">
                                <option value="">Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</option>
                                {% if projects %}
                                {% for p in projects %}
                                <option value="{{ p.id }}" {% if request.GET.project == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-2"></i>
                                Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo me-2"></i>
                                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Overview Pane -->
    <div class="dash-pane active" id="pane-overview">
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                <div class="card-title">Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡</div>
                    <div class="card-value">{{ budget_stats.total_budget|format_negative }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ú©Ù„ ØªØ®ØµÛŒØµ</div>
                    <div class="card-value">{{ budget_stats.total_allocated|format_negative }}</div>
        </div>
                </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ú©Ù„ Ù…ØµØ±Ù</div>
                    <div class="card-value">{{ budget_stats.total_consumed|format_negative }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ú©Ù„ Ø¨Ø±Ú¯Ø´Øª</div>
                    <div class="card-value">{{ budget_stats.total_returned|format_negative }}</div>
        </div>
                </div>
                </div>
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">ØªØ¹Ø¯Ø§Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡</div>
                    <div class="card-value">{{ tankhah_stats.total_count|default:"0" }}</div>
            </div>
        </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…Ø¨Ù„Øº ØªÙ†Ø®ÙˆØ§Ù‡</div>
                    <div class="card-value">{{ tankhah_stats.total_amount|format_negative }}</div>
                </div>
                </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</div>
                    <div class="card-value">{{ factor_stats.total_count|default:"0" }}</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</div>
                    <div class="card-value">{{ factor_stats.total_amount|format_negative }}</div>
            </div>
        </div>
    </div>

        <!-- Key Charts in Overview -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-pie me-2" style="color: #3b82f6;"></i>
                        ØªÙˆØ²ÛŒØ¹ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø²Ù…Ø§Ù†
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="budgetDistributionChart"></canvas>
                                </div>
                            </div>
                                </div>
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-line me-2" style="color: #10b981;"></i>
                        Ø±ÙˆÙ†Ø¯ Ù…ØµØ±Ù Ø¨ÙˆØ¯Ø¬Ù‡ (Ù…Ø§Ù‡Ø§Ù†Ù‡)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="monthlyConsumptionChart"></canvas>
                            </div>
                                </div>
                            </div>
                        </div>
                    </div>

    <!-- Budget Pane -->
    <div class="dash-pane" id="pane-budget">
        <!-- Advanced Budget KPIs -->
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù†Ø±Ø® Ø¬Ø°Ø¨ Ø¨ÙˆØ¯Ø¬Ù‡</div>
                    <div class="card-value" id="kpiAbsorption">0%</div>
                            </div>
                        </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">ØªØ®ØµÛŒØµ</div>
                    <div class="card-value" id="kpiAllocated">0</div>
                    </div>
                </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…ØµØ±Ù</div>
                    <div class="card-value" id="kpiConsumed">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</div>
                    <div class="card-value" id="kpiRemaining">0</div>
            </div>
        </div>
    </div>

        <!-- Advanced Budget Charts -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4" data-aos="fade-right">
            <div class="chart-container">
                <h5>
                        <i class="fas fa-sliders-h me-2" style="color:#0ea5e9;"></i>
                        Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒâ€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± ÙˆØ§Ù‚Ø¹ÛŒ (Ù…Ø§Ù‡Ø§Ù†Ù‡)
                </h5>
                <div class="chart-wrapper">
                        <canvas id="plannedActualChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4" data-aos="fade-left">
            <div class="chart-container">
                <h5>
                        <i class="fas fa-chart-area me-2" style="color:#22c55e;"></i>
                        Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù…Ø§Ù†Ø¯Ù‡ (Û³ Ù…Ø§Ù‡ Ø¢ÛŒÙ†Ø¯Ù‡)
                </h5>
                <div class="chart-wrapper">
                        <canvas id="forecastRemainingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-up">
            <div class="chart-container">
                <h5>
                        <i class="fas fa-bullseye me-2" style="color:#f59e0b;"></i>
                        ØªÙ…Ø±Ú©Ø² Ø¨ÙˆØ¯Ø¬Ù‡ (Top 5)
                </h5>
                <div class="chart-wrapper">
                        <canvas id="concentrationChart"></canvas>
                </div>
            </div>
        </div>
            <div class="col-lg-6 mb-4" data-aos="fade-up">
            <div class="chart-container">
                <h5>
                        <i class="fas fa-hourglass-half me-2" style="color:#8b5cf6;"></i>
                        Ø³Ù† ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ (Aging)
                </h5>
                <div class="chart-wrapper">
                        <canvas id="agingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Statistics Tables -->
    <div class="row mb-4">
        <!-- Budget Returns by Organization -->
        <div class="col-lg-6 mb-4" data-aos="fade-up">
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="fas fa-building me-2" style="color: #ef4444;"></i>
                    Ø¨Ø±Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø²Ù…Ø§Ù†
                </h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ø³Ø§Ø²Ù…Ø§Ù†</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for org in return_stats.org_returns %}
                            <tr>
                                <td>{{ org.allocation__organization__name|default:"Ù†Ø§Ù…Ø´Ø®Øµ" }}</td>
                                <td><span class="badge bg-primary">{{ org.count }}</span></td>
                                <td>{{ org.total_amount|floatformat:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Budget Returns by Project -->
        <div class="col-lg-6 mb-4" data-aos="fade-up">
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="fas fa-project-diagram me-2 text-success"></i>
                    Ø¨Ø±Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø±ÙˆÚ˜Ù‡
                </h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ù¾Ø±ÙˆÚ˜Ù‡</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in return_stats.project_returns %}
                            <tr>
                                <td>{{ project.allocation__project__name|default:"Ù†Ø§Ù…Ø´Ø®Øµ" }}</td>
                                <td><span class="badge bg-success">{{ project.count }}</span></td>
                                <td>{{ project.total_amount|floatformat:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            {% include 'reports/dashboard/dashboard_help.html' %}
        </div>
    </div>

    <!-- Tankhah Pane -->
    <div class="dash-pane" id="pane-tankhah">
        <!-- Tankhah KPIs -->
        <div class="row mb-3">
            <div class="col-lg-4 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† ØªØ³ÙˆÛŒÙ‡</div>
                    <div class="card-value" id="kpiAvgSettlement">0 Ø±ÙˆØ²</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù†Ø±Ø® ØªÙ†Ø®ÙˆØ§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚</div>
                    <div class="card-value" id="kpiOverdueRate">0%</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ù‚Ù</div>
                    <div class="card-value" id="kpiAvgCeilingUsage">0%</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <!-- Tankhah Status Chart -->
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-chart-bar me-2" style="color: #f59e0b;"></i>
                        ÙˆØ¶Ø¹ÛŒØª ØªÙ†Ø®ÙˆØ§Ù‡â€ŒÙ‡Ø§
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="tankhahStatusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Distribution by Org/Project and Settlement Aging -->
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-sitemap me-2" style="color:#0ea5e9;"></i>
                        ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø³Ø§Ø²Ù…Ø§Ù†
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="tankhahStatusByOrgChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-project-diagram me-2" style="color:#22c55e;"></i>
                        ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù¾Ø±ÙˆÚ˜Ù‡
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="tankhahStatusByProjectChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5>
                        <i class="fas fa-hourglass-end me-2" style="color:#f97316;"></i>
                        Aging ØªØ³ÙˆÛŒÙ‡â€ŒÙ‡Ø§
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="tankhahSettlementAgingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            {% include 'reports/dashboard/dashboard_help.html' %}
        </div>
    </div>

    <!-- Factors Pane -->
    <div class="dash-pane" id="pane-factors">
        <!-- Factor KPIs -->
        <div class="row mb-3">
            <div class="col-lg-6 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ú†Ø±Ø®Ù‡ ÙØ§Ú©ØªÙˆØ±</div>
                    <div class="card-value" id="kpiFactorAvgCycle">0 Ø±ÙˆØ²</div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù†Ø±Ø® Ø±Ø¯/Ø¨Ø§Ø²Ú¯Ø´Øª</div>
                    <div class="card-value" id="kpiFactorRejection">0%</div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5><i class="fas fa-list me-2"></i>Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h5>
                    <div class="chart-wrapper"><canvas id="factorCategoryChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5><i class="fas fa-bug me-2"></i>ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù¾Ø±Ø±ÛŒØ³Ú© (Top Ù…Ø¨Ù„Øº)</h5>
                    <div class="chart-wrapper"><canvas id="factorHighRiskTopAmount"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5><i class="fas fa-users me-2"></i>ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† Ù¾Ø±ØªÚ©Ø±Ø§Ø±</h5>
                    <div class="chart-wrapper"><canvas id="factorRepeatedVendors"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5><i class="fas fa-triangle-exclamation me-2"></i>Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡</h5>
                    <div class="chart-wrapper"><canvas id="factorOutsideBudget"></canvas></div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            {% include 'reports/dashboard/dashboard_help.html' %}
        </div>
    </div>

    <!-- Risk & Comparatives Pane -->
    <div class="dash-pane" id="pane-risk">
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ù…Ø§Ù‡ Ø¨Ù‡ Ù…Ø§Ù‡ Ù…ØµØ±Ù</div>
                    <div class="card-value" id="kpiMoMCons">0%</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">YoY Ù…ØµØ±Ù</div>
                    <div class="card-value" id="kpiYoYCons">0%</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">MoM Ø¨Ø±Ú¯Ø´Øª</div>
                    <div class="card-value" id="kpiMoMRet">0%</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">YoY Ø¨Ø±Ú¯Ø´Øª</div>
                    <div class="card-value" id="kpiYoYRet">0%</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4" data-aos="fade-right">
                <div class="chart-container">
                    <h5><i class="fas fa-arrow-trend-up me-2"></i>Ø±ÙˆÙ†Ø¯ Ù…ØµØ±Ù (Ù…Ø§Ù‡Ø§Ù†Ù‡)</h5>
                    <div class="chart-wrapper"><canvas id="compMonthlyConsumption"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-left">
                <div class="chart-container">
                    <h5><i class="fas fa-rotate-left me-2"></i>Ø±ÙˆÙ†Ø¯ Ø¨Ø±Ú¯Ø´Øª (Ù…Ø§Ù‡Ø§Ù†Ù‡)</h5>
                    <div class="chart-wrapper"><canvas id="compMonthlyReturns"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ø±ÛŒØ³Ú© Ø§Ø¶Ø§ÙÙ‡â€ŒÙ…ØµØ±Ù</div>
                    <div class="card-value" id="riskOverconsumptionCount">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ø±ÛŒØ³Ú© Ø¨Ø±Ú¯Ø´Øª Ø¨Ø§Ù„Ø§</div>
                    <div class="card-value" id="riskHighReturnCount">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ø±ÛŒØ³Ú© ØªØ£Ø®ÛŒØ±</div>
                    <div class="card-value" id="riskDelayCount">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="card-title">Ø±ÛŒØ³Ú© ØªÙ…Ø±Ú©Ø²</div>
                    <div class="card-value" id="riskConcentrationCount">0</div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5><i class="fas fa-building me-2"></i>Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§</h5>
                    <div class="chart-wrapper"><canvas id="rankOrganizations"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6 mb-4" data-aos="fade-up">
                <div class="chart-container">
                    <h5><i class="fas fa-project-diagram me-2"></i>Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h5>
                    <div class="chart-wrapper"><canvas id="rankProjects"></canvas></div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            {% include 'reports/dashboard/dashboard_help.html' %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4" data-aos="fade-up">
        <div class="col-12 text-center">
            <a href="{% url 'reports_dashboard:analytics_redesigned' %}" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-chart-line me-2"></i>
                ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            </a>
            <a href="{% url 'reports_dashboard:export_reports' %}" class="btn btn-success btn-lg me-3">
                <i class="fas fa-download me-2"></i>
                ØµØ§Ø¯Ø±Ø§Øª Ú¯Ø²Ø§Ø±Ø´Ø§Øª
            </a>
            <button class="btn btn-info btn-lg" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-2"></i>
                Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js UMD from local -->
<script src="/static/admin/js/chart.umd.min.js"></script>
<!-- Chart Utilities -->
<script src="{% static 'admin/js/chart-utils.js' %}"></script>
<!-- Debug Charts -->
<script src="{% static 'admin/js/debug-charts.js' %}"></script>
<!-- AOS Animation Library -->
<script src="{% static 'admin/js/aos.js' %}"></script>
<!-- Persian Datepicker (guarded) -->
<script src="{% static 'admin/js/persian-datepicker.min.js' %}"></script>
<script src="{% static 'admin/js/persian_datepicker_init.js' %}"></script>

<script>
// Chart data from Django context
var chartData = {{ chart_data|default:"{}"|safe }};
var advancedBudget = {{ advanced_budget|default:"{}"|safe }};
var advancedTankhah = {{ advanced_tankhah|default:"{}"|safe }};
var advancedFactor = {{ advanced_factor|default:"{}"|safe }};
var advancedComparatives = {{ advanced_comparatives|default:"{}"|safe }};
var advancedRisk = {{ advanced_risk|default:"{}"|safe }};

console.log('Chart data received:', chartData);

// Parse JSON string if it's a string
try {
    if (typeof chartData === 'string') {
        chartData = JSON.parse(chartData);
    }
} catch (e) {
    console.error('Error parsing chart data JSON:', e);
}

// Fallback data if chartData is not available
if (!chartData || typeof chartData !== 'object' || Object.keys(chartData).length === 0) {
    console.log('Using fallback chart data');
    chartData = {
        org_budget: [
        ],
        monthly_consumption: [
        ],
        tankhah_status: [
        ],
        factor_category: [
        ]
    };
}

// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
// Initialize AOS
AOS.init({
    duration: 800,
    easing: 'ease-in-out',
    once: true
});

    // Tab switching logic
    const tabs = document.querySelectorAll('.dash-tab');
    const panes = document.querySelectorAll('.dash-pane');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding pane
            this.classList.add('active');
            document.getElementById(`pane-${tabName}`).classList.add('active');
            
            // Reinitialize charts for the active tab
            setTimeout(initializeCharts, 100);
        });
    });
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        return;
    }
    
    // Debug: Check chart data
    console.log('Chart data from Django:', chartData);
    console.log('Chart data type:', typeof chartData);
    
    // Load filter options
    loadFilterOptions();
    
    // Write advanced KPIs
    try {
        if (typeof advancedBudget === 'string') { advancedBudget = JSON.parse(advancedBudget); }
        var ab = advancedBudget || {};
        var fmt = function(n){ try { return Number(n||0).toLocaleString('fa-IR'); } catch(e){ return n||0; } };
        var byId = function(id){ return document.getElementById(id); };
        if (byId('kpiAbsorption')) byId('kpiAbsorption').textContent = ((ab.absorption_rate||0).toFixed ? ab.absorption_rate.toFixed(1) : Number(ab.absorption_rate||0).toFixed(1)) + '%';
        if (byId('kpiAllocated')) byId('kpiAllocated').textContent = fmt((ab.totals||{}).allocated);
        if (byId('kpiConsumed')) byId('kpiConsumed').textContent = fmt((ab.totals||{}).consumed);
        if (byId('kpiRemaining')) byId('kpiRemaining').textContent = fmt((ab.totals||{}).remaining);
        // Tankhah KPIs
        if (typeof advancedTankhah === 'string') { advancedTankhah = JSON.parse(advancedTankhah); }
        var at = advancedTankhah || {};
        if (byId('kpiAvgSettlement')) byId('kpiAvgSettlement').textContent = ((at.avg_settlement_days||0).toFixed ? at.avg_settlement_days.toFixed(1) : Number(at.avg_settlement_days||0).toFixed(1)) + ' Ø±ÙˆØ²';
        if (byId('kpiOverdueRate')) byId('kpiOverdueRate').textContent = ((at.overdue_rate_pct||0).toFixed ? at.overdue_rate_pct.toFixed(1) : Number(at.overdue_rate_pct||0).toFixed(1)) + '%';
        if (byId('kpiAvgCeilingUsage')) byId('kpiAvgCeilingUsage').textContent = ((at.avg_ceiling_usage_pct||0).toFixed ? at.avg_ceiling_usage_pct.toFixed(1) : Number(at.avg_ceiling_usage_pct||0).toFixed(1)) + '%';

        // Factor KPIs
        if (typeof advancedFactor === 'string') { advancedFactor = JSON.parse(advancedFactor); }
        var af = advancedFactor || {};
        if (byId('kpiFactorAvgCycle')) byId('kpiFactorAvgCycle').textContent = ((af.totals?.avg_cycle_days||0).toFixed ? af.totals.avg_cycle_days.toFixed(1) : Number(af.totals?.avg_cycle_days||0).toFixed(1)) + ' Ø±ÙˆØ²';
        if (byId('kpiFactorRejection')) byId('kpiFactorRejection').textContent = ((af.totals?.rejection_rate_pct||0).toFixed ? af.totals.rejection_rate_pct.toFixed(1) : Number(af.totals?.rejection_rate_pct||0).toFixed(1)) + '%';
        // Comparative KPIs (changes)
        if (typeof advancedComparatives === 'string') { advancedComparatives = JSON.parse(advancedComparatives); }
        var ac = advancedComparatives || {};
        var ch = ac.changes || {};
        if (byId('kpiMoMCons')) byId('kpiMoMCons').textContent = ((ch.consumption?.mom_pct||0).toFixed ? ch.consumption.mom_pct.toFixed(1) : Number(ch.consumption?.mom_pct||0).toFixed(1)) + '%';
        if (byId('kpiYoYCons')) byId('kpiYoYCons').textContent = ((ch.consumption?.yoy_pct||0).toFixed ? ch.consumption.yoy_pct.toFixed(1) : Number(ch.consumption?.yoy_pct||0).toFixed(1)) + '%';
        if (byId('kpiMoMRet')) byId('kpiMoMRet').textContent = ((ch.returns?.mom_pct||0).toFixed ? ch.returns.mom_pct.toFixed(1) : Number(ch.returns?.mom_pct||0).toFixed(1)) + '%';
        if (byId('kpiYoYRet')) byId('kpiYoYRet').textContent = ((ch.returns?.yoy_pct||0).toFixed ? ch.returns.yoy_pct.toFixed(1) : Number(ch.returns?.yoy_pct||0).toFixed(1)) + '%';

        // Risk summary badges (optional hook)
        try {
            if (typeof advancedRisk === 'string') { advancedRisk = JSON.parse(advancedRisk); }
            var rs = advancedRisk || {};
            console.log('Risk summary:', rs.summary);
        } catch(e) {}
    } catch(e) { console.warn('advanced KPIs error', e); }
    
    // Initialize charts with delay to ensure DOM is ready
    setTimeout(function() {
        console.log('Initializing charts...');
        initializeCharts();
        setTimeout(injectPerChartHelp, 300);
        setTimeout(injectPerKPIHelp, 350);
    }, 500);
    
    // Animate counters
    animateCounters();
});

// Initialize all charts
function initializeCharts() {
    console.log('Starting chart initialization...');
    
    try {
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        console.log('Chart.js is available');
        
        // Check if chart data is available
        if (!chartData || typeof chartData !== 'object') {
            console.error('Chart data is not available');
            return;
        }
        console.log('Chart data is available:', chartData);
        
        // Budget Distribution Chart
        var budgetCtx = document.getElementById('budgetDistributionChart');
        if (!budgetCtx) {
            console.error('Budget distribution chart canvas not found');
            return;
        }
        
        var orgBudgetData = chartData.org_budget || [];
        console.log('Organization budget data:', orgBudgetData);
        
        if (orgBudgetData.length === 0) {
            // Show empty state
            budgetCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
            return;
        }
        
        const budgetChartData = {
            labels: orgBudgetData.map(function(item) { return item.organization__name || 'Ù†Ø§Ù…Ø´Ø®Øµ'; }),
            datasets: [{
                data: orgBudgetData.map(function(item) { return item.total || 0; }),
                backgroundColor: ChartUtils.COLOR_PALETTES.primary,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };

        const budgetChartOptions = {
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + ChartUtils.formatCurrency(context.parsed);
                        }
                    }
                }
            },
            animation: {
                animateRotate: true
            }
        };

        var typeSel = document.getElementById('chartMode');
        var enable3D = document.getElementById('enable3D');
        var mode = (typeSel && typeSel.value) || 'doughnut';
        ChartUtils.createAdaptiveChart('budgetDistributionChart', mode, budgetChartData, budgetChartOptions, !!(enable3D && enable3D.checked));

    // Monthly Consumption Chart
    var consumptionCtx = document.getElementById('monthlyConsumptionChart');
    if (!consumptionCtx) {
        console.error('Monthly consumption chart canvas not found');
        return;
    }
    
    var monthlyData = chartData.monthly_consumption || [];
    console.log('Monthly consumption data:', monthlyData);
    
    if (monthlyData.length === 0) {
        // Show empty state
        consumptionCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
        return;
    }
    
        const consumptionChartData = {
            labels: monthlyData.map(function(item) {
                var date = new Date(item.month);
                return date.toLocaleDateString('fa-IR');
            }),
            datasets: [{
                label: 'Ù…ØµØ±Ù Ø¨ÙˆØ¯Ø¬Ù‡',
                data: monthlyData.map(function(item) { return item.total || 0; }),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        };

        const consumptionChartOptions = {
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Ù…ØµØ±Ù: ' + ChartUtils.formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return ChartUtils.formatCurrency(value);
                        }
                    }
                }
            }
        };

        var mode2 = (typeSel && typeSel.value) || 'line';
        ChartUtils.createAdaptiveChart('monthlyConsumptionChart', mode2, consumptionChartData, consumptionChartOptions, !!(enable3D && enable3D.checked));

    // Tankhah Status Chart
    var tankhahCtx = document.getElementById('tankhahStatusChart');
    if (!tankhahCtx) {
        console.error('Tankhah status chart canvas not found');
        return;
    }
    
    var tankhahData = chartData.tankhah_status || [];
    console.log('Tankhah status data:', tankhahData);
    
    if (tankhahData.length === 0) {
        // Show empty state
        tankhahCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
        return;
    }
    
        const tankhahChartData = {
            labels: tankhahData.map(function(item) { return item.status__name || 'Ù†Ø§Ù…Ø´Ø®Øµ'; }),
            datasets: [{
                label: 'ØªØ¹Ø¯Ø§Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡â€ŒÙ‡Ø§',
                data: tankhahData.map(function(item) { return item.count || 0; }),
                backgroundColor: '#3b82f6',
                borderColor: '#1d4ed8',
                borderWidth: 1
            }]
        };

        const tankhahChartOptions = {
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            animation: {
                easing: 'easeInOutBounce'
            }
        };

        var mode3 = (typeSel && typeSel.value) || 'bar';
        ChartUtils.createAdaptiveChart('tankhahStatusChart', mode3, tankhahChartData, tankhahChartOptions, !!(enable3D && enable3D.checked));

    // Factor Category Chart
    var factorCtx = document.getElementById('factorCategoryChart');
    if (!factorCtx) {
        console.error('Factor category chart canvas not found');
            } else {
    var factorData = chartData.factor_category || [];
    console.log('Factor category data:', factorData);
    if (factorData.length === 0) {
        factorCtx.parentElement.innerHTML = '<div class="text-center text-muted p-4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                } else {
                    const factorChartData = {
            labels: factorData.map(function(item) { return item.category__name || 'Ù†Ø§Ù…Ø´Ø®Øµ'; }),
            datasets: [{
                            data: factorData.map(function(item) { return item.total || item.total_amount || 0; }),
                            backgroundColor: ChartUtils.COLOR_PALETTES.primary,
                borderWidth: 2,
                borderColor: '#fff'
            }]
                    };
                    const factorChartOptions = {
                        plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context){ return context.label + ': ' + ChartUtils.formatCurrency(context.parsed); } } } }
                    };
                    var mode4 = (typeSel && typeSel.value) || 'pie';
                    ChartUtils.createAdaptiveChart('factorCategoryChart', mode4, factorChartData, factorChartOptions, !!(enable3D && enable3D.checked));
                }
    }
            
    
    console.log('All charts initialized successfully');
    } catch (error) {
        console.error('Error initializing charts:', error);
        console.error('Error details:', error.message, error.stack);
    }
}

// Advanced charts drawing (planned vs actual, forecast, concentration, aging)
(function(){
    document.addEventListener('DOMContentLoaded', function(){
            // font size controls for charts
            var fontSmaller = document.getElementById('fontSmaller');
            var fontBigger = document.getElementById('fontBigger');
            var baseSize = (Chart.defaults.font && Chart.defaults.font.size) ? Chart.defaults.font.size : 12;
            function applyFont(size){
                if (!Chart || !Chart.defaults) return;
                Chart.defaults.font = Chart.defaults.font || {};
                Chart.defaults.font.size = size;
                initializeCharts();
            }
            if (fontSmaller) fontSmaller.addEventListener('click', function(){ baseSize = Math.max(8, baseSize - 1); applyFont(baseSize); });
            if (fontBigger) fontBigger.addEventListener('click', function(){ baseSize = Math.min(24, baseSize + 1); applyFont(baseSize); });

            var typeSel = document.getElementById('chartMode');
            var enable3D = document.getElementById('enable3D');
            if (typeSel) typeSel.addEventListener('change', function(){ initializeCharts(); });
            if (enable3D) enable3D.addEventListener('change', function(){ initializeCharts(); });
        try {
            if (typeof advancedBudget === 'string') { advancedBudget = JSON.parse(advancedBudget); }
            if (typeof Chart === 'undefined') return;
            var ab = advancedBudget || {};

            // Planned vs Actual
            var p = (ab.planned_vs_actual||{}).planned || [];
            var a = (ab.planned_vs_actual||{}).actual || [];
            var labels = (p.length ? p : a).map(function(x){ return new Date(x.month).toLocaleDateString('fa-IR'); });
            var plannedDataMap = {}; p.forEach(function(x){ plannedDataMap[x.month] = x.total||0; });
            var actualDataMap = {}; a.forEach(function(x){ actualDataMap[x.month] = x.total||0; });
            var plannedSeries = labels.map(function(lbl){
                // reconstruct month key from label not reliable; use original arrays if lengths match
                return p.length ? (p[labels.indexOf(lbl)]?.total||0) : 0;
            });
            var actualSeries = labels.map(function(lbl){
                return a.length ? (a[labels.indexOf(lbl)]?.total||0) : 0;
            });
            var ctxPA = document.getElementById('plannedActualChart');
            if (ctxPA && (p.length || a.length)) {
                new Chart(ctxPA, {
                    type: 'line',
                    data: { labels: labels, datasets: [
                        { label: 'Ø¨Ø±Ù†Ø§Ù…Ù‡', data: plannedSeries, borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.12)', fill:true, tension:0.35 },
                        { label: 'ÙˆØ§Ù‚Ø¹ÛŒ', data: actualSeries, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.12)', fill:true, tension:0.35 }
                    ]},
                    options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Forecast remaining
            var f = ab.forecast_remaining || [];
            var ctxF = document.getElementById('forecastRemainingChart');
            if (ctxF && f.length) {
                new Chart(ctxF, {
                    type: 'line',
                    data: {
                        labels: f.map(function(x){ return new Date(x.month).toLocaleDateString('fa-IR'); }),
                        datasets: [{ label:'Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒâ€ŒØ´Ø¯Ù‡', data: f.map(function(x){ return x.remaining||0; }), borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.12)', fill:true, tension:0.35 }]
                    },
                    options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Concentration (stack org + project side-by-side as grouped bar)
            var orgs = ((ab.concentration||{}).organizations)||[];
            var projs = ((ab.concentration||{}).projects)||[];
            var labelsC = (orgs.map(function(x){return x.name;}).concat(projs.map(function(x){return x.name;}))).slice(0,5);
            var ctxC = document.getElementById('concentrationChart');
            if (ctxC && (orgs.length || projs.length)) {
                new Chart(ctxC, {
                    type: 'bar',
                    data: {
                        labels: labelsC,
                        datasets: [
                            { label:'Ø³Ø§Ø²Ù…Ø§Ù†', data: orgs.map(function(x){return x.total||0;}), backgroundColor:'#3b82f6' },
                            { label:'Ù¾Ø±ÙˆÚ˜Ù‡', data: projs.map(function(x){return x.total||0;}), backgroundColor:'#8b5cf6' }
                        ]
                    },
                    options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Aging
            var ag = ab.aging || {};
            var ctxAg = document.getElementById('agingChart');
            if (ctxAg) {
                new Chart(ctxAg, {
                    type: 'bar',
                    data: {
                        labels: ['0-30','31-60','61-90','90+'],
                        datasets: [{ label:'ØªØ¹Ø¯Ø§Ø¯', data: [ag.d_0_30||0, ag.d_31_60||0, ag.d_61_90||0, ag.d_90_plus||0], backgroundColor:'#f59e0b' }]
                    },
                    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, precision:0 } } }
                });
            }

            // Advanced Tankhah charts
            if (typeof advancedTankhah === 'string') { advancedTankhah = JSON.parse(advancedTankhah); }
            var at = advancedTankhah || {};
            // Status by organization
            var sbo = (at.status_by_org||[]);
            if (sbo.length) {
                var orgGroups = {};
                sbo.forEach(function(x){
                    var org = x.organization__name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    orgGroups[org] = orgGroups[org] || {};
                    orgGroups[org][x.status__name || 'Ù†Ø§Ù…Ø´Ø®Øµ'] = x.count || 0;
                });
                var orgLabels = Object.keys(orgGroups);
                var statusLabels = Array.from(new Set([].concat.apply([], Object.values(orgGroups).map(function(m){return Object.keys(m);}))))
                var datasets = statusLabels.map(function(st, idx){
                    return { label: st, data: orgLabels.map(function(org){ return orgGroups[org][st]||0; }), backgroundColor: ChartUtils.COLOR_PALETTES.primary[idx % ChartUtils.COLOR_PALETTES.primary.length] };
                });
                var ctxSBO = document.getElementById('tankhahStatusByOrgChart');
                if (ctxSBO) {
                    new Chart(ctxSBO, { type:'bar', data:{ labels: orgLabels, datasets: datasets }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } } });
                }
            }

            // Status by project
            var sbp = (at.status_by_project||[]);
            if (sbp.length) {
                var projGroups = {};
                sbp.forEach(function(x){
                    var pr = x.project__name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    projGroups[pr] = projGroups[pr] || {};
                    projGroups[pr][x.status__name || 'Ù†Ø§Ù…Ø´Ø®Øµ'] = x.count || 0;
                });
                var projLabels = Object.keys(projGroups);
                var statusLabelsP = Array.from(new Set([].concat.apply([], Object.values(projGroups).map(function(m){return Object.keys(m);}))))
                var datasetsP = statusLabelsP.map(function(st, idx){
                    return { label: st, data: projLabels.map(function(pr){ return projGroups[pr][st]||0; }), backgroundColor: ChartUtils.COLOR_PALETTES.primary[idx % ChartUtils.COLOR_PALETTES.primary.length] };
                });
                var ctxSBP = document.getElementById('tankhahStatusByProjectChart');
                if (ctxSBP) {
                    new Chart(ctxSBP, { type:'bar', data:{ labels: projLabels, datasets: datasetsP }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } } });
                }
            }

            // Settlement aging
            var sag = (at.settlement_aging||{});
            var ctxSA = document.getElementById('tankhahSettlementAgingChart');
            if (ctxSA) {
                new Chart(ctxSA, {
                    type:'bar',
                    data:{ labels:['0-30','31-60','61-90','90+'], datasets:[{ label:'ØªØ¹Ø¯Ø§Ø¯', data:[sag.d_0_30||0, sag.d_31_60||0, sag.d_61_90||0, sag.d_90_plus||0], backgroundColor:'#f97316' }] },
                    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Ceiling usage top 5
            var top = (at.top_ceiling_usage||[]);
            var ctxTop = document.getElementById('tankhahCeilingTopChart');
            if (ctxTop && top.length) {
                new Chart(ctxTop, {
                    type:'bar',
                    data:{ labels: top.map(function(x){ return x.number; }), datasets:[{ label:'Ø¯Ø±ØµØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡', data: top.map(function(x){ return x.usage_pct||0; }), backgroundColor:'#ef4444' }] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true, max:100 } } }
                });
            }

            // Factor charts from advancedFactor
            if (typeof advancedFactor === 'string') { advancedFactor = JSON.parse(advancedFactor); }
            var af = advancedFactor || {};
            // High risk top amount
            var ta = af.high_risk?.top_amount || [];
            var ctxTA = document.getElementById('factorHighRiskTopAmount');
            if (ctxTA && ta.length) {
                new Chart(ctxTA, {
                    type:'bar',
                    data:{ labels: ta.map(function(x){ return x.number || ('#'+x.id); }), datasets:[{ label:'Ù…Ø¨Ù„Øº', data: ta.map(function(x){ return Number(x.amount||0); }), backgroundColor:'#ef4444' }] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:function(ctx){ return ChartUtils.formatCurrency(ctx.parsed.y); } } } }, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Repeated vendors
            var rv = af.high_risk?.repeated_vendors || [];
            var ctxRV = document.getElementById('factorRepeatedVendors');
            if (ctxRV && rv.length) {
                new Chart(ctxRV, {
                    type:'bar',
                    data:{ labels: rv.map(function(x){ return x.payee__legal_name || x.payee__name || ('#'+x.payee__id); }), datasets:[{ label:'ØªØ¹Ø¯Ø§Ø¯', data: rv.map(function(x){ return x.count||0; }), backgroundColor:'#3b82f6' }] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true, precision:0 } } }
                });
            }

            // Outside budget
            var ob = af.high_risk?.outside_budget || [];
            var ctxOB = document.getElementById('factorOutsideBudget');
            if (ctxOB && ob.length) {
                new Chart(ctxOB, {
                    type:'bar',
                    data:{ labels: ob.map(function(x){ return x.number || ('#'+x.id); }), datasets:[{ label:'Ù…Ø¨Ù„Øº', data: ob.map(function(x){ return Number(x.amount||0); }), backgroundColor:'#f59e0b' }] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Comparatives charts
            if (typeof advancedComparatives === 'string') { advancedComparatives = JSON.parse(advancedComparatives); }
            var ac = advancedComparatives || {};
            var mcons = ac.monthly?.consumption || [];
            var mret  = ac.monthly?.returns || [];
            var ctxMC = document.getElementById('compMonthlyConsumption');
            if (ctxMC && mcons.length) {
                new Chart(ctxMC, {
                    type:'line',
                    data:{ labels: mcons.map(function(x){ return new Date(x.month).toLocaleDateString('fa-IR'); }), datasets:[{ label:'Ù…ØµØ±Ù', data: mcons.map(function(x){ return Number(x.total||0); }), borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.12)', fill:true, tension:0.35 }] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
                });
            }
            var ctxMR = document.getElementById('compMonthlyReturns');
            if (ctxMR && mret.length) {
                new Chart(ctxMR, {
                    type:'line',
                    data:{ labels: mret.map(function(x){ return new Date(x.month).toLocaleDateString('fa-IR'); }), datasets:[{ label:'Ø¨Ø±Ú¯Ø´Øª', data: mret.map(function(x){ return Number(x.total||0); }), borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.12)', fill:true, tension:0.35 }] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
                });
            }

            // Rankings
            var orgs = ac.rankings?.organizations || [];
            var ctxRO = document.getElementById('rankOrganizations');
            if (ctxRO && orgs.length) {
                new Chart(ctxRO, {
                    type:'bar',
                    data:{ labels: orgs.map(function(x){ return x.name; }), datasets:[
                        { label:'Ù…ØµØ±Ù', data: orgs.map(function(x){ return x.consumption||0; }), backgroundColor:'#3b82f6' },
                        { label:'Ø¨Ø±Ú¯Ø´Øª', data: orgs.map(function(x){ return x.returns||0; }), backgroundColor:'#22c55e' },
                        { label:'Ú©Ø§Ø±Ø§ÛŒÛŒ (%)', data: orgs.map(function(x){ return x.efficiency_pct||0; }), backgroundColor:'#f59e0b', yAxisID:'y1' }
                    ] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true }, y1:{ beginAtZero:true, position:'right', ticks:{ callback:function(v){ return v+'%'; } } } } }
                });
            }

            var projs = ac.rankings?.projects || [];
            var ctxRP = document.getElementById('rankProjects');
            if (ctxRP && projs.length) {
                new Chart(ctxRP, {
                    type:'bar',
                    data:{ labels: projs.map(function(x){ return x.name; }), datasets:[
                        { label:'Ù…ØµØ±Ù', data: projs.map(function(x){ return x.consumption||0; }), backgroundColor:'#3b82f6' },
                        { label:'Ø¨Ø±Ú¯Ø´Øª', data: projs.map(function(x){ return x.returns||0; }), backgroundColor:'#22c55e' },
                        { label:'Ú©Ø§Ø±Ø§ÛŒÛŒ (%)', data: projs.map(function(x){ return x.efficiency_pct||0; }), backgroundColor:'#f59e0b', yAxisID:'y1' }
                    ] },
                    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true }, y1:{ beginAtZero:true, position:'right', ticks:{ callback:function(v){ return v+'%'; } } } } }
                });
            }

            // Populate risk summary counts
            try {
                if (typeof advancedRisk === 'string') { advancedRisk = JSON.parse(advancedRisk); }
                var rs = advancedRisk || {};
                var byId = function(id){ return document.getElementById(id); };
                if (byId('riskOverconsumptionCount')) byId('riskOverconsumptionCount').textContent = rs.summary?.overconsumption_count || 0;
                if (byId('riskHighReturnCount')) byId('riskHighReturnCount').textContent = (Math.max(rs.summary?.high_return_org_count||0, rs.summary?.high_return_project_count||0));
                if (byId('riskDelayCount')) byId('riskDelayCount').textContent = rs.summary?.long_cycles_count || 0;
                if (byId('riskConcentrationCount')) byId('riskConcentrationCount').textContent = rs.summary?.payee_concentration_count || 0;
            } catch(e) { console.warn('risk summary fill error', e); }
        } catch(e){ console.warn('advanced budget charts error', e); }
    });
})();

// Load filter options with static data
function loadFilterOptions() {
    console.log('Loading filter options with static data...');
    
    // Static organizations data
    var organizations = [    ];
    
    // Static projects data
    var projects = [ ];
    
    // Load organizations
    var orgSelect = document.getElementById('organization');
    if (orgSelect) {
        organizations.forEach(function(org) {
            var option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name;
            orgSelect.appendChild(option);
        });
        console.log('Organizations loaded:', organizations.length);
    }
    
    // Load projects
    var projectSelect = document.getElementById('project');
    if (projectSelect) {
        projects.forEach(function(project) {
            var option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
        });
        console.log('Projects loaded:', projects.length);
    }
}

// Animate counters
function animateCounters() {
    var counters = document.querySelectorAll('.stat-value');
    
    counters.forEach(function(counter) {
        var target = parseInt(counter.textContent.replace(/,/g, ''));
        var duration = 2000;
        var increment = target / (duration / 16);
        var current = 0;
        
        var timer = setInterval(function() {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            counter.textContent = Math.floor(current).toLocaleString();
        }, 16);
    });
}

// Reset filters
function resetFilters() {
    document.getElementById('filterForm').reset();
}

// Refresh dashboard
function refreshDashboard() {
    location.reload();
}

// Progress ring animation
function animateProgressRing() {
    var circle = document.querySelector('.progress-ring-circle');
    if (!circle) return;
    
    var percentage = {{ budget_stats.return_percentage|default:"0"|floatformat:0 }};
    var circumference = 2 * Math.PI * 40;
    var offset = circumference - (percentage / 100) * circumference;
    
    circle.style.strokeDashoffset = offset;
}

// Initialize progress ring animation
setTimeout(animateProgressRing, 1000);

// Initialize date inputs (no pDatepicker needed)
$(document).ready(function() {
    console.log('Date inputs initialized with regular HTML5 date picker');
});

// Chart update function for theme changes
function updateChartsForTheme() {
    // Reinitialize charts with new theme colors
    if (typeof initializeCharts === 'function') {
        setTimeout(function() {
            initializeCharts();
            setTimeout(injectPerChartHelp, 200);
            setTimeout(injectPerKPIHelp, 220);
        }, 100);
    }
}

// Inject collapsible per-chart help blocks
function injectPerChartHelp() {
    var definitions = [
        { id:'budgetDistributionChart', text:'Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… Ù‡Ø± Ø³Ø§Ø²Ù…Ø§Ù† = Ù…Ø¨Ù„Øº Ø³Ø§Ø²Ù…Ø§Ù† Ã· Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ù„Øº Ã— Û±Û°Û°' },
        { id:'monthlyConsumptionChart', text:'Ø±ÙˆÙ†Ø¯ Ù…ØµØ±Ù = Ø¬Ù…Ø¹ Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡Ø› Ø¨Ø±Ú†Ø³Ø¨ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ.' },
        { id:'plannedActualChart', text:'Ø¯Ø±ØµØ¯ Ø§Ù†Ø­Ø±Ø§Ù = (ÙˆØ§Ù‚Ø¹ÛŒ âˆ’ Ø¨Ø±Ù†Ø§Ù…Ù‡) Ã· Ø¨Ø±Ù†Ø§Ù…Ù‡ Ã— Û±Û°Û°' },
        { id:'forecastRemainingChart', text:'Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒâ€ŒØ´Ø¯Ù‡ Ø¨Ø± Ù…Ø¨Ù†Ø§ÛŒ Ø±ÙˆÙ†Ø¯ Ù…ØµØ±Ù Ø§Ø®ÛŒØ±.' },
        { id:'concentrationChart', text:'Ø³Ù‡Ù… Ù‡Ø± Ù…ÙˆØ±Ø¯ = Ù…Ù‚Ø¯Ø§Ø± Ã· Ù…Ø¬Ù…ÙˆØ¹ Ã— Û±Û°Û° (Top-N).' },
        { id:'agingChart', text:'ØªØ¹Ø¯Ø§Ø¯ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ 0-30/31-60/61-90/90+ Ø±ÙˆØ².' },
        { id:'tankhahStatusChart', text:'ØªØ¹Ø¯Ø§Ø¯ Ù‡Ø± ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø¨Ø§Ø²Ù‡ ÙÛŒÙ„ØªØ±Ø› Ù…Ù‚ÛŒØ§Ø³â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø² ØµÙØ±.' },
        { id:'tankhahStatusByOrgChart', text:'ØªØ¹Ø¯Ø§Ø¯ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø³Ø§Ø²Ù…Ø§Ù†Ø› Ù†Ù…Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡ÛŒ.' },
        { id:'tankhahStatusByProjectChart', text:'ØªØ¹Ø¯Ø§Ø¯ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù¾Ø±ÙˆÚ˜Ù‡Ø› Ù†Ù…Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡ÛŒ.' },
        { id:'tankhahSettlementAgingChart', text:'ØªØ¹Ø¯Ø§Ø¯ ØªØ³ÙˆÛŒÙ‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ 0-30/31-60/61-90/90+ Ø±ÙˆØ².' },
        { id:'factorCategoryChart', text:'Ø³Ù‡Ù… Ù‡Ø± Ø¯Ø³ØªÙ‡ = Ù…Ø¨Ù„Øº/ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø³ØªÙ‡ Ã· Ù…Ø¬Ù…ÙˆØ¹ Ã— Û±Û°Û°' },
        { id:'factorHighRiskTopAmount', text:'Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Top Ù…Ø¨Ù„Øºâ€ŒÙ‡Ø§Ø› Ù†Ù…Ø§ÛŒØ´ Ø¨Ø± Ø­Ø³Ø¨ Ù…Ø¨Ù„Øº Ø±ÛŒØ§Ù„ÛŒ.' },
        { id:'factorRepeatedVendors', text:'Ø´Ù…Ø§Ø±Ø´ ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù¾Ø±ØªÚ©Ø±Ø§Ø±Ù‡Ø§.' },
        { id:'factorOutsideBudget', text:'Ù…ÙˆØ§Ø±Ø¯ Ø¹Ø¨ÙˆØ± Ø§Ø² Ø³Ù‚Ù Ø¨ÙˆØ¯Ø¬Ù‡ ÛŒØ§ ÙØ§Ù‚Ø¯ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø±ØªØ¨Ø·.' },
        { id:'compMonthlyConsumption', text:'Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ±Ø§Øª MoM/YoY Ø§Ø² Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ù…ØµØ±Ù.' },
        { id:'compMonthlyReturns', text:'Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ±Ø§Øª MoM/YoY Ø§Ø² Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ú¯Ø´Øª.' },
        { id:'rankOrganizations', text:'Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØµØ±ÙØŒ Ø¨Ø±Ú¯Ø´Øª Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ (Ù…ØµØ±Ù Ã· ØªØ®ØµÛŒØµ Ã— Û±Û°Û°).' },
        { id:'rankProjects', text:'Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØµØ±ÙØŒ Ø¨Ø±Ú¯Ø´Øª Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ.' }
    ];
    definitions.forEach(function(d) {
        var canvas = document.getElementById(d.id);
        if (!canvas) return;
        var container = canvas.closest('.chart-container');
        if (!container) return;
        var anchorId = 'help-' + d.id;
        if (container.querySelector('#' + anchorId)) return;
        var wrapper = document.createElement('div');
        wrapper.className = 'mt-2';
        wrapper.innerHTML = '<a class="text-decoration-none" data-bs-toggle="collapse" href="#' + anchorId + '" role="button" aria-expanded="false" aria-controls="' + anchorId + '">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</a>' +
            '<div class="collapse" id="' + anchorId + '"><div class="mt-2 small text-muted">' + d.text + '</div></div>';
        container.appendChild(wrapper);
    });

    // Tables help: returns by organization
    try {
        var orgTitle = Array.from(document.querySelectorAll('.chart-container h5')).find(function(h){ return h.textContent.indexOf('Ø¨Ø±Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø²Ù…Ø§Ù†') !== -1; });
        if (orgTitle) {
            var orgContainer = orgTitle.closest('.chart-container');
            if (orgContainer && !orgContainer.querySelector('#help-returnsByOrg')) {
                var div = document.createElement('div');
                div.className = 'mt-2';
                div.innerHTML = '<a class="text-decoration-none" data-bs-toggle="collapse" href="#help-returnsByOrg">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</a>' +
                    '<div class="collapse" id="help-returnsByOrg"><div class="mt-2 help-accent">Ù†Ø³Ø¨Øª Ø¨Ø±Ú¯Ø´Øª Ø³Ø§Ø²Ù…Ø§Ù† = Ù…Ø¨Ù„Øº Ø¨Ø±Ú¯Ø´Øª Ã· Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ‡Ø§ Ã— Û±Û°Û°</div></div>';
                orgContainer.appendChild(div);
            }
        }
        var prjTitle = Array.from(document.querySelectorAll('.chart-container h5')).find(function(h){ return h.textContent.indexOf('Ø¨Ø±Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø±ÙˆÚ˜Ù‡') !== -1; });
        if (prjTitle) {
            var prjContainer = prjTitle.closest('.chart-container');
            if (prjContainer && !prjContainer.querySelector('#help-returnsByProject')) {
                var div2 = document.createElement('div');
                div2.className = 'mt-2';
                div2.innerHTML = '<a class="text-decoration-none" data-bs-toggle="collapse" href="#help-returnsByProject">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</a>' +
                    '<div class="collapse" id="help-returnsByProject"><div class="mt-2 help-accent">Ù†Ø³Ø¨Øª Ø¨Ø±Ú¯Ø´Øª Ù¾Ø±ÙˆÚ˜Ù‡ = Ù…Ø¨Ù„Øº Ø¨Ø±Ú¯Ø´Øª Ã· Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ‡Ø§ Ã— Û±Û°Û°</div></div>';
                prjContainer.appendChild(div2);
            }
        }
    } catch(e) { console.warn('table help injection error', e); }
}

// Inject collapsible help blocks for KPI cards
function injectPerKPIHelp() {
    // Budget KPIs
    var kpiMap = [
        { id:'kpiAbsorption', text:'Ù†Ø±Ø® Ø¬Ø°Ø¨ Ø¨ÙˆØ¯Ø¬Ù‡ = Ù…ØµØ±Ù Ã· ØªØ®ØµÛŒØµ Ã— Û±Û°Û°' },
        { id:'kpiAllocated', text:'Ú©Ù„ ØªØ®ØµÛŒØµ = Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ù„Øº ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡/ÙÛŒÙ„ØªØ±' },
        { id:'kpiConsumed', text:'Ú©Ù„ Ù…ØµØ±Ù = Ù…Ø¬Ù…ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ù (CONSUMPTION)' },
        { id:'kpiRemaining', text:'Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ = ØªØ®ØµÛŒØµ âˆ’ Ù…ØµØ±Ù + Ø¨Ø±Ú¯Ø´Øª' },

        // Tankhah KPIs
        { id:'kpiAvgSettlement', text:'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† ØªØ³ÙˆÛŒÙ‡ = Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†(ØªØ§Ø±ÛŒØ® ØªØ³ÙˆÛŒÙ‡ âˆ’ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯) Ø¨Ù‡ Ø±ÙˆØ²' },
        { id:'kpiOverdueRate', text:'Ù†Ø±Ø® Ù…Ø¹ÙˆÙ‚ = (ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²Ù‡Ø§ÛŒ > N Ø±ÙˆØ² Ã· Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²) Ã— Û±Û°Û°' },
        { id:'kpiAvgCeilingUsage', text:'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ù‚Ù = Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†(Ù…Ø¨Ù„Øº Ø§Ø³ØªÙØ§Ø¯Ù‡ Ã· Ø³Ù‚Ù) Ã— Û±Û°Û°' },

        // Factor KPIs
        { id:'kpiFactorAvgCycle', text:'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú†Ø±Ø®Ù‡ ÙØ§Ú©ØªÙˆØ± = Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†(ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª/ØªØ§ÛŒÛŒØ¯ âˆ’ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª) Ø¨Ù‡ Ø±ÙˆØ²' },
        { id:'kpiFactorRejection', text:'Ù†Ø±Ø® Ø±Ø¯/Ø¨Ø§Ø²Ú¯Ø´Øª = (ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ ÛŒØ§ Ø¨Ø§Ø²Ú¯Ø´Øª Ã· Ú©Ù„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§) Ã— Û±Û°Û°' },

        // Comparative KPIs
        { id:'kpiMoMCons', text:'MoM Ù…ØµØ±Ù = ((Ù…ØµØ±Ù Ø§ÛŒÙ† Ù…Ø§Ù‡ âˆ’ Ù…Ø§Ù‡ Ù‚Ø¨Ù„) Ã· Ù…Ø§Ù‡ Ù‚Ø¨Ù„) Ã— Û±Û°Û°' },
        { id:'kpiYoYCons', text:'YoY Ù…ØµØ±Ù = ((Ù…ØµØ±Ù Ø§ÛŒÙ† Ù…Ø§Ù‡ âˆ’ Ù‡Ù…Ø§Ù† Ù…Ø§Ù‡ Ø³Ø§Ù„ Ù‚Ø¨Ù„) Ã· Ø³Ø§Ù„ Ù‚Ø¨Ù„) Ã— Û±Û°Û°' },
        { id:'kpiMoMRet', text:'MoM Ø¨Ø±Ú¯Ø´Øª = ((Ø¨Ø±Ú¯Ø´Øª Ø§ÛŒÙ† Ù…Ø§Ù‡ âˆ’ Ù…Ø§Ù‡ Ù‚Ø¨Ù„) Ã· Ù…Ø§Ù‡ Ù‚Ø¨Ù„) Ã— Û±Û°Û°' },
        { id:'kpiYoYRet', text:'YoY Ø¨Ø±Ú¯Ø´Øª = ((Ø¨Ø±Ú¯Ø´Øª Ø§ÛŒÙ† Ù…Ø§Ù‡ âˆ’ Ù‡Ù…Ø§Ù† Ù…Ø§Ù‡ Ø³Ø§Ù„ Ù‚Ø¨Ù„) Ã· Ø³Ø§Ù„ Ù‚Ø¨Ù„) Ã— Û±Û°Û°' },

        // Risk summary badges
        { id:'riskOverconsumptionCount', text:'Ø§Ø¶Ø§ÙÙ‡â€ŒÙ…ØµØ±Ù: Ù…ÙˆØ§Ø±Ø¯ÛŒ Ú©Ù‡ Ù…ØµØ±Ù Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ ØªØ¹ÛŒÛŒÙ†â€ŒØ´Ø¯Ù‡ Ø§Ø² ØªØ®ØµÛŒØµ Ø±Ø³ÛŒØ¯Ù‡/Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡' },
        { id:'riskHighReturnCount', text:'Ø¨Ø±Ú¯Ø´Øª Ø¨Ø§Ù„Ø§: Ø³Ø§Ø²Ù…Ø§Ù†/Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ Ù†Ø³Ø¨Øª Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØªØ®ØµÛŒØµ Ø¨ÛŒØ´ Ø§Ø² Ø¢Ø³ØªØ§Ù†Ù‡' },
        { id:'riskDelayCount', text:'ØªØ£Ø®ÛŒØ±: Ú†Ø±Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ± Ø§Ø² N Ø±ÙˆØ² Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª/ØªØ³ÙˆÛŒÙ‡' },
        { id:'riskConcentrationCount', text:'ØªÙ…Ø±Ú©Ø²: Ø³Ù‡Ù… Ø²ÛŒØ§Ø¯ Ú†Ù†Ø¯ Ø°ÛŒâ€ŒÙ†ÙØ¹/Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø² Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§' }
    ];

    kpiMap.forEach(function(item) {
        var el = document.getElementById(item.id);
        if (!el) return;
        var card = el.closest('.stats-card');
        if (!card) return;
        var anchorId = 'help-' + item.id;
        if (card.querySelector('#' + anchorId)) return;
        var wrapper = document.createElement('div');
        wrapper.className = 'mt-2';
        wrapper.innerHTML = '<a class="text-decoration-none" data-bs-toggle="collapse" href="#' + anchorId + '" role="button" aria-expanded="false" aria-controls="' + anchorId + '">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</a>' +
            '<div class="collapse" id="' + anchorId + '"><div class="mt-2 small text-muted">' + item.text + '</div></div>';
        card.appendChild(wrapper);
    });

    // Overview 4 top cards by title text (if IDs Ù†Ø¨ÙˆØ¯)
    var titleMap = {
        'Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡':'Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ = Ù…Ø¬Ù…ÙˆØ¹ BudgetPeriod.total_amount',
        'Ú©Ù„ ØªØ®ØµÛŒØµ':'Ú©Ù„ ØªØ®ØµÛŒØµ = Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ Ø¨Ø§ Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±',
        'Ú©Ù„ Ù…ØµØ±Ù':'Ú©Ù„ Ù…ØµØ±Ù = Ù…Ø¬Ù…ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ CONSUMPTION',
        'Ú©Ù„ Ø¨Ø±Ú¯Ø´Øª':'Ú©Ù„ Ø¨Ø±Ú¯Ø´Øª = Ù…Ø¬Ù…ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ RETURN'
    };
    var cards = document.querySelectorAll('.dash-pane.active #pane-overview .stats-card, #pane-overview .stats-card');
    cards.forEach(function(c){
        var title = c.querySelector('.card-title');
        if (!title) return;
        var hint = titleMap[title.textContent && title.textContent.trim()];
        if (!hint) return;
        if (c.querySelector('.collapse[data-overview-help="1"]')) return;
        var div = document.createElement('div');
        div.className = 'mt-2';
        var id = 'help-overview-' + (title.textContent || '').replace(/\s+/g,'-');
        div.innerHTML = '<a class="text-decoration-none" data-bs-toggle="collapse" href="#' + id + '">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</a>' +
            '<div class="collapse" id="' + id + '" data-overview-help="1"><div class="mt-2 small text-muted">' + hint + '</div></div>';
        c.appendChild(div);
    });
}
</script>
{% endblock %}
