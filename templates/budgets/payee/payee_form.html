{% extends "base.html" %}
{% load static %}
{% load rcms_custom_filters jformat  %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- کارت فرم -->
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-plus fa-2x me-3"></i>
                        <div>
                            <h4 class="mb-0">ایجاد دریافت‌کننده جدید</h4>
                            <p class="mb-0 opacity-75">فرم ثبت اطلاعات دریافت‌کننده پرداخت</p>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- نمایش خطاهای کلی فرم -->
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" novalidate id="payee-form">
                        {% csrf_token %}
                        
                        <!-- بخش نوع شخص -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-user-tag me-2"></i>
                                    اطلاعات هویتی
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.entity_type.label }} *</label>
                                {{ form.entity_type }}
                                {% if form.entity_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.entity_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.payee_type.label }}</label>
                                {{ form.payee_type }}
                                {% if form.payee_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.payee_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- اطلاعات حقیقی (مشروط) -->
                        <div id="individual-fields" class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-secondary mb-3">
                                    <i class="fas fa-user me-2"></i>
                                    اطلاعات شخص حقیقی
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.name.label }} *</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.family.label }} *</label>
                                {{ form.family }}
                                {% if form.family.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.family.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- اطلاعات حقوقی (مشروط) -->
                        <div id="legal-fields" class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-secondary mb-3">
                                    <i class="fas fa-building me-2"></i>
                                    اطلاعات شخص حقوقی
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.legal_name.label }} *</label>
                                {{ form.legal_name }}
                                {% if form.legal_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.legal_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.brand_name.label }}</label>
                                {{ form.brand_name }}
                                {% if form.brand_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.brand_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- اطلاعات شناسایی -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-id-card me-2"></i>
                                    اطلاعات شناسایی
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.national_id.label }} *</label>
                                {{ form.national_id }}
                                <div class="form-text" id="national-id-help">کد ملی برای اشخاص حقیقی، شناسه ملی برای اشخاص حقوقی</div>
                                {% if form.national_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.national_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.tax_id.label }}</label>
                                {{ form.tax_id }}
                                {% if form.tax_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tax_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- اطلاعات بانکی -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-university me-2"></i>
                                    اطلاعات بانکی
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.account_number.label }}</label>
                                {{ form.account_number }}
                                <div class="form-text">فقط اعداد مجاز هستند</div>
                                {% if form.account_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.account_number.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.iban.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">IR</span>
                                    {{ form.iban }}
                                </div>
                                <div class="form-text">24 رقم بعد از IR</div>
                                {% if form.iban.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.iban.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- اطلاعات تماس -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-address-book me-2"></i>
                                    اطلاعات تماس
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.phone.label }}</label>
                                {{ form.phone }}
                                <div class="form-text">فرمت: 09xxxxxxxxx</div>
                                {% if form.phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.email.label }}</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-12 mb-3">
                                <label class="form-label">{{ form.address.label }}</label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- وضعیت فعال -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        {{ form.is_active.label }}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- دکمه‌های اقدام -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'payee_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        بازگشت به لیست
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>
                                        ایجاد دریافت‌کننده
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // عناصر DOM
    const entityTypeSelect = document.getElementById('{{ form.entity_type.id_for_label }}');
    const individualFields = document.getElementById('individual-fields');
    const legalFields = document.getElementById('legal-fields');
    const nationalIdHelp = document.getElementById('national-id-help');
    const nationalIdInput = document.getElementById('{{ form.national_id.id_for_label }}');
    const ibanInput = document.getElementById('{{ form.iban.id_for_label }}');
    const phoneInput = document.getElementById('{{ form.phone.id_for_label }}');
    const accountInput = document.getElementById('{{ form.account_number.id_for_label }}');
    
    // تابع برای نمایش/مخفی کردن فیلدها بر اساس نوع شخص
    function toggleEntityFields() {
        const entityType = entityTypeSelect.value;
        
        if (entityType === 'INDIVIDUAL') {
            individualFields.style.display = 'block';
            legalFields.style.display = 'none';
            nationalIdHelp.textContent = 'کد ملی 10 رقمی';
            
            // علامت‌گذاری فیلدهای اجباری
            document.querySelector('label[for="{{ form.name.id_for_label }}"]').classList.add('required');
            document.querySelector('label[for="{{ form.family.id_for_label }}"]').classList.add('required');
            
        } else if (entityType === 'LEGAL') {
            individualFields.style.display = 'none';
            legalFields.style.display = 'block';
            nationalIdHelp.textContent = 'شناسه حقوقی 11 رقمی';
            
            // علامت‌گذاری فیلدهای اجباری
            document.querySelector('label[for="{{ form.legal_name.id_for_label }}"]').classList.add('required');
            
        } else {
            individualFields.style.display = 'none';
            legalFields.style.display = 'none';
            nationalIdHelp.textContent = 'کد ملی برای اشخاص حقیقی، شناسه ملی برای اشخاص حقوقی';
        }
    }
    
    // فرمت کردن شبا
    function formatIBAN(input) {
    let value = input.value.replace(/[^0-9IR]/gi, '').toUpperCase();
    if (!value.startsWith('IR')) {
        value = 'IR' + value.replace(/^IR/, '');
    }
    // فقط برای نمایش
    let numbers = value.substring(2);
    numbers = numbers.substring(0, 24);
    let formatted = 'IR ' + numbers.match(/.{1,4}/g).join(' ');
    input.value = formatted;
}
    
    // فرمت کردن شماره تلفن
    function formatPhone(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        
        // حذف پیش‌شماره بین‌المللی
        if (value.startsWith('98')) {
            value = '0' + value.substring(2);
        } else if (value.startsWith('+98')) {
            value = '0' + value.substring(3);
        }
        
        // محدود کردن به 11 رقم
        value = value.substring(0, 11);
        
        // فرمت کردن
        if (value.length > 0) {
            let formatted = value;
            if (value.length > 4) {
                formatted = value.substring(0, 4) + ' ' + value.substring(4);
            }
            if (value.length > 7) {
                formatted = formatted.substring(0, 8) + ' ' + formatted.substring(8);
            }
            if (value.length > 9) {
                formatted = formatted.substring(0, 11) + ' ' + formatted.substring(11);
            }
            input.value = formatted;
        }
    }
    
    // رویداد تغییر نوع شخص
    entityTypeSelect.addEventListener('change', toggleEntityFields);
    
    // رویدادهای فرمت کردن
    ibanInput.addEventListener('input', function() {
        formatIBAN(this);
    });
    
    phoneInput.addEventListener('input', function() {
        formatPhone(this);
    });
    
    // فقط اعداد برای شماره حساب
    accountInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
    
    // اجرای اولیه
    toggleEntityFields();
    
    // فرمت کردن مقادیر اولیه اگر وجود دارند
    if (ibanInput.value) {
        formatIBAN(ibanInput);
    }
    if (phoneInput.value) {
        formatPhone(phoneInput);
    }
    
    // اعتبارسنجی فرم
    const form = document.getElementById('payee-form');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        const entityType = entityTypeSelect.value;
        
        // اعتبارسنجی نوع شخص
        if (entityType === 'INDIVIDUAL') {
            const name = document.getElementById('{{ form.name.id_for_label }}').value;
            const family = document.getElementById('{{ form.family.id_for_label }}').value;
            
            if (!name || !family) {
                isValid = false;
                alert('لطفاً نام و نام خانوادگی را برای شخص حقیقی وارد کنید.');
            }
            
        } else if (entityType === 'LEGAL') {
            const legalName = document.getElementById('{{ form.legal_name.id_for_label }}').value;
            
            if (!legalName) {
                isValid = false;
                alert('لطفاً نام حقوقی را برای شخص حقوقی وارد کنید.');
            }
        }
        
        // اعتبارسنجی شبا
        const ibanValue = ibanInput.value.replace(/ /g, '');
        if (ibanValue && ibanValue.length !== 26) {
            isValid = false;
            alert('شماره شبا باید 24 رقم به همراه IR باشد.');
        }
        
        // اعتبارسنجی تلفن
        const phoneValue = phoneInput.value.replace(/ /g, '');
        if (phoneValue && (phoneValue.length !== 11 || !phoneValue.startsWith('09'))) {
            isValid = false;
            alert('شماره تلفن باید 11 رقمی و با 09 شروع شود.');
        }
        
        if (!isValid) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}