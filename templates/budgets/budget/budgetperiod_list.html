{% extends "base.html" %}
{% load i18n rcms_custom_filters jformat static %}

{% block title %}{% trans "فهرست بودجه کلان" %}{% endblock %}
 

{% block content %}
    <div class="container-fluid budget-list-page">
        <style>
            .status-badge { display: inline-block; padding: .25rem .5rem; border-radius: .5rem; font-size: .85rem; font-weight: 600; }
            .status-active { background: #e6f4ea; color: #137333; border: 1px solid #c6e7cf; }
            .status-inactive { background: #f1f3f4; color: #5f6368; border: 1px solid #e0e0e0; }
            .status-locked { background: #fff4e5; color: #a15b00; border: 1px solid #ffe2b5; }
            .status-completed { background: #e8f0fe; color: #1967d2; border: 1px solid #c6dafc; }
            .status-archived { background: #f3e8fd; color: #7b1fa2; border: 1px solid #e5c7fb; }
            .status-upcoming { background: #e6fffa; color: #0d9488; border: 1px solid #c7fff5; }
            .status-expired { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
            tr.row-expired { background-color: #fff7f7 !important; }
            tr.row-expired td { border-top: 1px solid #ffe1e1 !important; }
            .text-numeric { white-space: nowrap; }
            .table thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
            .table-wrapper { overflow-x: auto; }
        </style>
        <div class="card shadow-sm">
            <div class="card-header text-numeric d-flex justify-content-between align-items-center no-print">
            <h4 class="mb-0 d-flex align-items-center gap-2">
                <i class="fas fa-landmark fa-fw"></i>
                {% trans "فهرست بودجه کلان" %}
            </h4>
            <div class="no-print">
                <a href="{% url 'budgetperiod_create' %}" class="btn btn-light btn-sm">
                    <i class="fas fa-plus me-1"></i>
                    {% trans "ثبت بودجه کلان جدید" %} <i class="fas fa-dollar me-1"></i>
                </a>
            </div>
                  <div class="no-print">
                                <a href="{% url 'budgets_dashboard' %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-dashboard me-1"></i> {% trans "داشبورد بودجه" %}
                                </a>
                            </div>
                <div class="no-print">
                    <a href="{% url 'budget_Help' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-user-graduate me-1"></i> {% trans "راهنمای کار بودجه کلان" %}
                    </a>
                </div>
            </div>
            <!-- خلاصه وضعیت‌ها و تعداد نتایج -->
            <div class="card-body no-print">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>
                    {% trans "تعداد کل دوره‌ها" %}: {{ status_summary.total|to_persian_number }} |
                    {% trans "فعال" %}: {{ status_summary.active|to_persian_number }} |
                    {% trans "قفل‌شده" %}: {{ status_summary.locked|to_persian_number }} |
                    {% trans "تمام‌شده" %}: {{ status_summary.completed|to_persian_number }}
                </span>
                    <span>
                    {% trans "نتایج یافت‌شده" %}: {{ result_count|to_persian_number }}
                </span>
                </div>
            </div>

            <!-- فرم جستجو -->
            <div class="card-body no-print search-form">
                <form method="GET" action="{% url 'budgetperiod_list' %}" class="row g-3" id="searchForm">
                    <div class="col-md-3">
                        <label for="q" class="form-label">{% trans "جستجو" %}</label>
                        <input type="text" name="q" id="q" value="{{ query|default:'' }}" class="form-control"
                               placeholder="{% trans 'نام دوره یا سازمان' %}">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">{% trans "وضعیت" %}</label>
                        <select name="status" id="status" class="form-select">
                            <option value="" {% if not status %}selected{% endif %}>{% trans "همه" %}</option>
                            <option value="active"
                                    {% if status == 'active' %}selected{% endif %}>{% trans "فعال" %}</option>
                            <option value="inactive"
                                    {% if status == 'inactive' %}selected{% endif %}>{% trans "غیرفعال" %}</option>
                            <option value="locked"
                                    {% if status == 'locked' %}selected{% endif %}>{% trans "قفل‌شده" %}</option>
                            <option value="completed"
                                    {% if status == 'completed' %}selected{% endif %}>{% trans "تمام‌شده" %}</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="date_from" class="form-label">{% trans "از تاریخ" %}</label>

                        <input type="text" name="date_from" id="start_date" value="{{ date_from|default:'' }}"
                               class="form-control  " placeholder="1404/01/01 مثلاً " data-jdp autocomplete="off">


                    </div>
                    <div class="col-md-2">
                        <label for="date_to" class="form-label">{% trans "تا تاریخ" %}</label>
                        <input type="text" name="date_to" id="end_date" data-jdp value="{{ date_to|default:'' }}"
                               class="form-control jalali-datepicker" placeholder="مثلاً 1404/12/29" autocomplete="off">
                    </div>


                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2"><i
                                class="fas fa-search me-1"></i> {% trans "جستجو" %}</button>
                        <a href="{% url 'budgetperiod_list' %}" class="btn btn-secondary"><i
                                class="fas fa-undo me-1"></i> {% trans "بازنشانی" %}</a>
                    </div>
                </form>
            </div>

            <div class="table-responsive table-wrapper">
                <table class="table table-striped table-hover table-bordered table-sm align-middle mb-0">
                    <thead class="text-center table-light">
                    <tr>
                        <th style="width: 5%;">{% trans "ردیف" %}</th>
                        <th>{% trans "نام دوره" %}</th>
                        <th>{% trans "دفتر مرکزی" %}</th>
                        <th class="text-end">{% trans "مبلغ کل" %} <small>({% trans "ریال" %})</small></th>
                        <th class="text-end">{% trans "باقی‌مانده" %} <small>({% trans "ریال" %})</small></th>
                        <th class="text-end">{% trans "مجموع برگشتی" %} <small>({% trans "ریال" %})</small></th>
                        <th class="text-end">{% trans "تعداد تخصیص" %}</th>
                        <th>{% trans "تاریخ شروع" %}</th>
                        <th>{% trans "تاریخ پایان" %}</th>
                        <th>{% trans "وضعیت" %}</th>
                        <th style="width: 25%;" class="no-print">{% trans "اقدامات" %}</th>
                    </tr>
                </thead>
                    <tbody class="text-center">
                    {% for budget_period in budget_periods %}
                        <tr style="--row-index: {{ forloop.counter0 }};" class="{% if budget_period.display_status == 'expired' %}row-expired{% else %}{% if budget_period.end_date and budget_period.end_date < today and not budget_period.is_completed %}row-expired{% endif %}{% endif %}">
                        <td>{{ forloop.counter|to_persian_number }}</td>
                            <td class="text-start">{{ budget_period.name|to_persian_number_with_comma }}</td>
                            <td class="text-start">{{ budget_period.organization.name|to_persian_number_with_comma }}</td>
                            <td class="text-numeric">{{ budget_period.total_amount|format_negative }}</td>
                        {% with ps=period_stats|dict_get:budget_period.id %}
                            <td class="text-numeric {% if ps and ps.remaining_amount and ps.remaining_amount < 0 %}text-danger fw-bold{% endif %}">
                                {% if ps %}
                                    {{ ps.remaining_amount|default_if_none:0|format_negative }}
                                {% else %}
                                    {{ budget_period.get_remaining_amount|format_negative }}
                                {% endif %}
                            </td>
                            <td class="text-numeric">
                                {% if ps %}
                                    {{ ps.returned_sum|default_if_none:0|format_negative }}
                                {% else %}
                                    {{ 0|format_negative }}
                                {% endif %}
                            </td>
                            <td class="text-numeric">
                                {% if ps %}
                                    {{ ps.alloc_count|default_if_none:0|to_persian_number }}
                                {% else %}
                                    {{ 0|to_persian_number }}
                                {% endif %}
                            </td>
                        {% endwith %}
                        <td class="font-monospace">{{ budget_period.start_date|jformat:'%Y/%m/%d'|to_persian_number }}</td>
                        <td class="font-monospace">{{ budget_period.end_date|jformat:'%Y/%m/%d'|to_persian_number }} {% if budget_period.display_status == 'expired' %}<span class="badge bg-danger-subtle text-danger ms-1">{% trans "منقضی" %}</span>{% else %}{% if budget_period.end_date and budget_period.end_date < today and not budget_period.is_completed %}<span class="badge bg-danger-subtle text-danger ms-1">{% trans "منقضی" %}</span>{% endif %}{% endif %}</td>
                        <td>
                            {# --- نمایش وضعیت جدید --- #}
                            <span class="status-badge {% if budget_period.status_css_class %}{{ budget_period.status_css_class }}{% else %}{% if budget_period.is_completed %}status-completed{% elif budget_period.end_date and budget_period.end_date < today %}status-expired{% elif budget_period.lock_condition == 'MANUAL' %}status-locked{% elif not budget_period.is_active %}status-inactive{% else %}status-active{% endif %}{% endif %}">
                            {% if budget_period.display_status == 'active' %}
                                {% trans "فعال" %}
                            {% elif budget_period.display_status == 'inactive' %}
                                {% trans "غیرفعال" %}
                            {% elif budget_period.display_status == 'locked' %}
                                {% trans "قفل‌شده" %}
                            {% elif budget_period.display_status == 'completed' %}
                                {% trans "تمام‌شده" %}
                            {% elif budget_period.display_status == 'archived' %}
                                {% trans "بایگانی" %}
                            {% elif budget_period.display_status == 'upcoming' %}
                                {% trans "آینده" %}
                            {% elif budget_period.display_status == 'expired' %}
                                {% trans "منقضی" %}
                            {% else %}
                                {% if budget_period.is_completed %}{% trans "تمام‌شده" %}
                                {% elif budget_period.end_date and budget_period.end_date < today %}{% trans "منقضی" %}
                                {% elif budget_period.lock_condition == 'MANUAL' %}{% trans "قفل‌شده" %}
                                {% elif not budget_period.is_active %}{% trans "غیرفعال" %}
                                {% else %}{% trans "فعال" %}{% endif %}
                            {% endif %}
                        </span>
                            {# نمایش بایگانی به صورت جداگانه دیگر لازم نیست #}
                            {# {% if budget_period.is_archived %} ... {% endif %} #}
                            {# --- پایان نمایش وضعیت جدید --- #}
                        </td>
                            <td class="action-buttons no-print">
                                <div class="btn-group btn-group-sm" role="group" aria-label="Budget Period Actions">
                                <a href="{% url 'budgetperiod_detail' budget_period.pk %}" class="btn btn-outline-primary" title="{% trans 'جزئیات' %}">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'budgetperiod_update' budget_period.pk %}" class="btn btn-outline-secondary" title="{% trans 'ویرایش' %}">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'budgetperiod_delete' budget_period.pk %}" class="btn btn-outline-danger" title="{% trans 'حذف' %}" onclick="return confirm('{% trans 'آیا از حذف این دوره بودجه و تمام تخصیص‌های مرتبط با آن مطمئن هستید؟' %}');">
                                    <i class="fas fa-trash"></i>
                                </a>
                                <a href="{% url 'budgetperiod_detail' budget_period.pk %}" 
                                   class="btn btn-outline-info" title="{% trans 'جزئیات دوره بودجه' %}" 
                                   >
                                    <i class="fas fa-info"></i>
                                </a>
                                </div>
                                <div class="btn-group btn-group-sm mt-1" role="group">
                                    <a href="{% url 'budgetallocation_create' %}?budget_period={{ budget_period.pk }}"
                                       class="btn btn-success" title="{% trans 'تخصیص جدید به شعب' %}">
                                    <i class="fas fa-plus"></i> {% trans "تخصیص" %}
                                </a>
                                <a href="{% url 'budgetallocation_list' %}?q={{ budget_period.name }}" class="btn btn-info" title="{% trans 'مشاهده تخصیص‌های این دوره' %}">
                                    <i class="fas fa-list-ul"></i> {% trans "لیست تخصیص‌ها" %}
                                </a>
                                </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-info-circle fa-lg text-muted me-2"></i>
                            {% trans "هیچ بودجه کلانی یافت نشد." %}
                            <a href="{% url 'budgetperiod_create' %}"
                               class="btn btn-sm btn-primary ms-2 no-print">{% trans "ثبت بودجه جدید" %}</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                    {# --- بخش جدید: جمع کل --- #}
                    <tfoot>
                    <tr class="table-light fw-bold"> {# استایل برای ردیف جمع کل #}
                        <td colspan="3" class="text-center">{% trans "جمع کل نتایج" %}</td>
                        {# ادغام 3 ستون اول #}
                        <td class="text-numeric">{{ total_sum|format_negative }}</td>
                        {# نمایش جمع مبلغ کل #}
                        <td class="text-numeric {% if total_remaining < 0 %}text-danger{% endif %}">{{ total_remaining|format_negative }}</td>
                        {# نمایش جمع باقی‌مانده #}
                        <td colspan="6"></td>
                        {# ادغام ستون‌های باقیمانده تا هم‌تراز با 11 ستون #}
                    </tr>
                    </tfoot>
                    {# --- پایان بخش جمع کل --- #}
                </table>
            </div>


            {% if is_paginated %}
                <div class="card-footer bg-light no-print">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=

                                            {{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                       aria-label="{% trans 'Previous' %}">
                                        «
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">«</span></li>
                            {% endif %}

                            {% for num in paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active" aria-current="page"><span
                                            class="page-link">{{ num|to_persian_number }}</span></li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item"><a class="page-link" href="?page=

                                            {{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num|to_persian_number }}</a>
                                    </li>
                                {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=

                                            {{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                       aria-label="{% trans 'Next' %}">
                                        »
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">»</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // فعال‌سازی دیتاپیکر
            jalaliDatepicker.startWatch();

            function convertToNumber(dateStr) {
                return parseInt(dateStr.replace(/\//g, ''), 10);  // تبدیل "1403/01/15" به 14030115
            }

            // اعتبارسنجی و محدود کردن تاریخ
            $('#start_date').on('change', function () {
                const startVal = $(this).val();
                $('#end_date').val(''); // پاک کردن تاریخ پایان برای جلوگیری از حالت نامعتبر
                $('#date-error').addClass('d-none');

                // محدود کردن تاریخ پایان به بعد از تاریخ شروع
                jalaliDatepicker.updateOptions('#end_date', {
                    minDate: startVal
                });
            });

            function updateDateTime() {
                const now = new Date().toLocaleDateString('fa-IR', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                $('#datetime').text(now);
            }

            updateDateTime();
            setInterval(updateDateTime, 1000);

            const sidebar = $('#sidebar');
            const toggleBtn = $('#sidebarToggle');
            const content = $('#mainContent');
            toggleBtn.on('click', function () {
                sidebar.toggleClass('active animate__animated animate__slideInRight');
                sidebar.removeClass('animate__slideOutRight');
                content.toggleClass('shifted');
                if (!sidebar.hasClass('active')) {
                    sidebar.addClass('animate__animated animate__slideOutRight');
                }
            });

            jalaliDatepicker.startWatch();

        });
    </script>


    <link rel="stylesheet" href="{% static 'admin/css/jalalidatepicker.min.css' %}">

    <script src="{% static 'admin/js/jalalidatepicker.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            $('#date_from').persianDatepicker({
                format: 'YYYY/MM/DD',
                altFormat: 'YYYY/MM/DD',
                calendarType: 'persian'
            });
            $('#date_to').persianDatepicker({
                format: 'YYYY/MM/DD',
                altFormat: 'YYYY/MM/DD',
                calendarType: 'persian'
            });
        });
    </script>





{% endblock %}