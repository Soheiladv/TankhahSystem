{% extends "base.html" %}
{% load i18n static %}
{% load rcms_custom_filters jformat %} {# اضافه کردن فیلترهای humanize برای نمایش بهتر اعداد #}

{% block title %}{% trans "ایجاد/ویرایش دوره بودجه" %}{% endblock %}



{% block content %}
    <div class="container-lg budget-form-page py-4">
        <div class="card shadow-sm border-0">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #6a11cb, #2575fc); color:#fff;">
                <h4 class="mb-0 d-flex align-items-center">
                    <i class="fas fa-landmark me-2"></i>
                    {% if form.instance.pk %}
                        {% blocktrans with name=form.instance.name %}ویرایش دوره بودجه: {{ name }}{% endblocktrans %}
                    {% else %}
                        {% trans "ایجاد دوره بودجه جدید" %}
                    {% endif %}
                </h4>
                <a href="{% url 'budgetperiod_list' %}" class="btn btn-light btn-sm"><i class="fas fa-arrow-left me-1"></i>{% trans "بازگشت" %}</a>
            </div>
        <div class="card-body">
            {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <h5 class="alert-heading">{% trans "خطا در فرم:" %}</h5>
                    <ul class="mb-0">
                        {# خطاهای کلی فرم #}
                        {% if form.non_field_errors %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endif %}
                        {# خطاهای فیلدها با برچسب صحیح #}
                        {% for field in form %}
                            {% if field.errors %}
                                <li><strong>{{ field.label }}</strong>: {{ field.errors|striptags }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endif %}

            <div class="row g-4">
            <form method="post" id="budgetPeriodForm" class="col-lg-8">
                {% csrf_token %}
                <div class="row g-3 mb-3"> {# بخش اطلاعات اصلی #}
                    <div class="col-md-6">
                        <label for="{{ form.organization.id_for_label }}"
                               class="form-label">{{ form.organization.label }} <span
                                class="text-danger">*</span></label>
                        {{ form.organization }}
                        {% if form.organization.errors %}
                            <div class="invalid-feedback d-block">{{ form.organization.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }} <span
                                class="text-danger">*</span></label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">{{ form.name.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.start_date.id_for_label }}" class="form-label">{{ form.start_date.label }}
                            <span class="text-danger">*</span></label>
                        {{ form.start_date }}
                        <div class="form-text text-muted mt-1">{% trans "تاریخ به فارسی" %}: <span id="start-date-fa">—</span></div>
                        {% if form.start_date.errors %}
                            <div class="invalid-feedback d-block">{{ form.start_date.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.end_date.id_for_label }}" class="form-label">{{ form.end_date.label }} <span
                                class="text-danger">*</span></label>
                        {{ form.end_date }}
                        <div class="form-text text-muted mt-1">{% trans "تاریخ به فارسی" %}: <span id="end-date-fa">—</span></div>
                        {% if form.end_date.errors %}
                            <div class="invalid-feedback d-block">{{ form.end_date.errors|striptags }}</div>{% endif %}
                    </div>
                </div>

                <hr/>

                <div class="row g-3 mb-3"> {# بخش مبالغ #}
                    <div class="col-md-6">
                        <label for="{{ form.total_amount.id_for_label }}" class="form-label">
                            <i class="fas fa-coins fa-fw me-1 text-muted"></i> {{ form.total_amount.label }} <span
                                class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            {{ form.total_amount }}
                            <span class="input-group-text">{% trans "ریال" %}</span>
                        </div>
                        {% if form.total_amount.errors %}
                            <div class="invalid-feedback d-block">{{ form.total_amount.errors|striptags }}</div>
                        {% endif %}
                        {# نمایش مقدار به حروف #}
                        <div class="small text-muted mt-1">{% trans "مبلغ به فارسی" %}: <strong id="total_amount_persian">۰</strong> {% trans "ریال" %}</div>
                        <div id="total_amount_words_display" class="amount-words">
                            {% if form.total_amount_words %}{% trans "به حروف" %}:
                                {{ form.total_amount_words }}{% endif %}
                        </div>
                    </div>

                    {# --- نمایش فیلدهای محاسباتی (فقط در حالت ویرایش) --- #}
                    {% if form.instance.pk %}
                        <div class="col-md-6">
                            <label class="info-label d-block mb-1">
                                <i class="fas fa-chart-pie fa-fw me-1 text-muted"></i> {% trans "مبلغ کل تخصیص یافته" %}
                            </label>
                            <span class="info-value">{{ form.instance.total_allocated|default:"0"|to_persian_number }} {% trans "ریال" %}</span>
                            {# نمایش درصد تخصیص یافته #}
                            {% if form.instance.total_amount and form.instance.total_amount > 0 %}
                                <small class="text-muted d-block">(%{{ form.instance.get_allocated_percentage|floatformat:2 }})</small>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="info-label d-block mb-1">
                                <i class="fas fa-undo fa-fw me-1 text-muted"></i> {% trans "مبلغ کل برگشتی" %}
                            </label>
                            <span class="info-value">{{ form.instance.returned_amount|default:"0"|to_persian_number }} {% trans "ریال" %}</span>
                            {# نمایش درصد برگشتی #}
                            {% if form.instance.total_allocated and form.instance.total_allocated > 0 %}
                                <small class="text-muted d-block">(%{{ form.instance.get_returned_percentage|floatformat:2 }} {% trans "از تخصیص یافته" %})</small>
                            {% elif form.instance.total_amount and form.instance.total_amount > 0 %}
                                <small class="text-muted d-block">(%{{ form.instance.get_returned_percentage_from_total|floatformat:2 }} {% trans "از کل بودجه" %})</small>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="info-label d-block mb-1">
                                <i class="fas fa-tasks fa-fw me-1 text-muted"></i> {% trans "فاز تخصیص" %}
                            </label>
                            {# فرض می‌کنیم مدلی برای فازها دارید یا از choices استفاده می‌کنید #}
                            <span class="info-value">{{ form.instance.get_allocation_phase_display|default:"-" }}</span>
                        </div>
                    {% endif %}
                    {# --- پایان نمایش فیلدهای محاسباتی --- #}
                </div>

                <hr/>

                <div class="row g-3 mb-3"> {# بخش تنظیمات #}
                    <div class="col-md-6 col-lg-3">
                        <label for="{{ form.lock_condition.id_for_label }}"
                               class="form-label">{{ form.lock_condition.label }}</label>
                        {{ form.lock_condition }}
                        <div class="mt-1">
                            <span id="badge-lock-condition" class="badge bg-secondary">—</span>
                        </div>
                        {% if form.lock_condition.errors %}
                            <div class="invalid-feedback d-block">{{ form.lock_condition.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="{{ form.locked_percentage.id_for_label }}"
                               class="form-label">{{ form.locked_percentage.label }}</label>
                        <div class="input-group">
                            {{ form.locked_percentage }}
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="mt-1">
                            <span id="badge-locked-percentage" class="badge bg-secondary">0%</span>
                        </div>
                        {% if form.locked_percentage.errors %}
                            <div class="invalid-feedback d-block">{{ form.locked_percentage.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="{{ form.warning_threshold.id_for_label }}"
                               class="form-label">{{ form.warning_threshold.label }}</label>
                        <div class="input-group">
                            {{ form.warning_threshold }}
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="mt-1">
                            <span id="badge-warning-threshold" class="badge bg-secondary">0%</span>
                        </div>
                        {% if form.warning_threshold.errors %}
                            <div class="invalid-feedback d-block">{{ form.warning_threshold.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="{{ form.warning_action.id_for_label }}"
                               class="form-label">{{ form.warning_action.label }}</label>
                        {{ form.warning_action }}
                        <div class="mt-1">
                            <span id="badge-warning-action" class="badge bg-secondary">—</span>
                        </div>
                        {% if form.warning_action.errors %}
                            <div class="invalid-feedback d-block">{{ form.warning_action.errors|striptags }}</div>{% endif %}
                    </div>
                </div>

                <div class="row g-3 mb-3"> {# بخش توضیحات و وضعیت‌ها #}
                    <div class="col-12">
                        <label for="{{ form.description.id_for_label }}"
                               class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">{{ form.description.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch mt-2"> {# استفاده از form-switch برای ظاهر بهتر #}
                            {{ form.is_active }}
                            <label class="form-check-label"
                                   for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
                            {% if form.is_active.errors %}
                                <div class="invalid-feedback d-block">{{ form.is_active.errors|striptags }}</div>{% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch mt-2">
                            {{ form.is_archived }}
                            <label class="form-check-label"
                                   for="{{ form.is_archived.id_for_label }}">{{ form.is_archived.label }}</label>
                            {% if form.is_archived.errors %}
                                <div class="invalid-feedback d-block">{{ form.is_archived.errors|striptags }}</div>{% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch mt-2">
                            {{ form.is_completed }}
                            <label class="form-check-label"
                                   for="{{ form.is_completed.id_for_label }}">{{ form.is_completed.label }}</label>
                            {% if form.is_completed.errors %}
                                <div class="invalid-feedback d-block">{{ form.is_completed.errors|striptags }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-top d-flex gap-2">
                    <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i> {% trans "ذخیره تغییرات" %}</button>
                    <a href="{% url 'budgetperiod_list' %}" class="btn btn-outline-secondary"><i class="fas fa-times me-1"></i> {% trans "انصراف" %}</a>
                    {% if form.instance.pk %}
                        <button type="button" class="btn btn-outline-danger ms-auto" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal"><i class="fas fa-trash-alt me-1"></i> {% trans "حذف دوره" %}</button>
                    {% endif %}
                </div>
            </form>
            <aside class="col-lg-4 d-none d-lg-block">
                <div class="card sticky-top" style="top: 90px;">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-info-circle me-1"></i>{% trans "خلاصه" %}</span>
                        <span class="badge bg-light text-dark">{% trans "لحظه‌ای" %}</span>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between"><span>{% trans "نام دوره" %}</span><span id="bp-name-summary">—</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span>{% trans "سازمان" %}</span><span id="bp-org-summary">—</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span>{% trans "تاریخ شروع" %}</span><span id="bp-start-summary">—</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span>{% trans "تاریخ پایان" %}</span><span id="bp-end-summary">—</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span>{% trans "مبلغ کل" %}</span><span id="bp-total-summary">۰</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span>{% trans "به حروف" %}</span><span id="bp-total-words-summary">{% trans "صفر" %}</span></li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <span class="small text-muted">{% trans "قفل" %}:</span><span id="badge-lock-condition" class="badge bg-secondary">—</span>
                                    <span class="small text-muted">{% trans "درصد قفل" %}:</span><span id="badge-locked-percentage" class="badge bg-secondary">0%</span>
                                    <span class="small text-muted">{% trans "آستانه اخطار" %}:</span><span id="badge-warning-threshold" class="badge bg-secondary">0%</span>
                                    <span class="small text-muted">{% trans "اقدام" %}:</span><span id="badge-warning-action" class="badge bg-secondary">—</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </aside>
            </div>
        </div>
    </div>
</div>

    {% if form.instance.pk %}
        {# Modal تأیید حذف #}
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel"><i
                                class="fas fa-exclamation-triangle me-2"></i> {% trans "تأیید حذف" %}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% blocktrans %}آیا از حذف دوره بودجه "{{ form.instance.name }}" مطمئن هستید؟ این عمل غیرقابل
                            بازگشت است.{% endblocktrans %}
                        <p class="text-muted small mt-2">{% trans "توجه: حذف دوره ممکن است بر تخصیص‌ها و تراکنش‌های مرتبط تأثیر بگذارد." %}</p>
                    </div>
                    <div class="modal-footer">
                        {# فرم حذف باید جداگانه ارسال شود #}
                        <form method="post" action="{% url 'budgetperiod_delete' pk=form.instance.pk %}">
                            {# فرض وجود url delete #}
                            {% csrf_token %}
                            <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">{% trans "انصراف" %}</button>
                            <button type="submit" class="btn btn-danger">{% trans "بله، حذف کن" %}</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
    {# اسکریپت‌های پایه (jQuery/Bootstrap/jalaliDatepicker) از base.html لود شده‌اند #}
    {# بارگذاری افزونه‌های تاریخ‌نگار تکراری یا مسیرهای اشتباه حذف شد تا تداخل ایجاد نشود #}
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- کمکی‌ها: تبدیل اعداد ---
        function toLatinDigits(str){
            return String(str ?? '').replace(/[۰-۹]/g, d => '0123456789'[d.charCodeAt(0)-1776])
                                     .replace(/[٠-٩]/g, d => '0123456789'[d.charCodeAt(0)-1632]);
        }
        function toPersianDigits(str){
            return String(str ?? '').replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        }
        function formatFaNumber(n){
            const num = Number(toLatinDigits(String(n)).replace(/,/g,'')) || 0;
            return toPersianDigits(num.toLocaleString('en-US'));
        }
        function yyyymmddNumber(jalaliStr){
            // jalaliStr: 'YYYY/MM/DD' with possible Persian digits
            const s = toLatinDigits(jalaliStr || '').trim();
            const m = s.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
            if (!m) return null;
            const y = parseInt(m[1], 10), mo = parseInt(m[2], 10), d = parseInt(m[3], 10);
            if (!y || !mo || !d) return null;
            return y * 10000 + mo * 100 + d; // برای مقایسه ساده
        }

        // نمایش اولیه تاریخ‌ها به فارسی
        try{
            document.getElementById('start-date-fa').textContent = toPersianDigits(document.getElementById('{{ form.start_date.id_for_label }}')?.value || '');
            document.getElementById('end-date-fa').textContent = toPersianDigits(document.getElementById('{{ form.end_date.id_for_label }}')?.value || '');
        }catch(_e){}
        // بروزرسانی بر اساس تغییر ورودی تاریخ‌ها
        const startDateInputEl = document.getElementById('{{ form.start_date.id_for_label }}');
        const endDateInputEl = document.getElementById('{{ form.end_date.id_for_label }}');
        function updateDateDisplays(){
            try{
                document.getElementById('start-date-fa').textContent = startDateInputEl?.value ? toPersianDigits(startDateInputEl.value) : '—';
                document.getElementById('end-date-fa').textContent = endDateInputEl?.value ? toPersianDigits(endDateInputEl.value) : '—';
            }catch(_e){}
        }
        function validateDateOrder(showAlert){
            const a = yyyymmddNumber(startDateInputEl?.value);
            const b = yyyymmddNumber(endDateInputEl?.value);
            if (a && b && a > b) {
                if (showAlert) alert('{% trans "تاریخ شروع نمی‌تواند بعد از تاریخ پایان باشد." %}');
                return false;
            }
            return true;
        }
        startDateInputEl?.addEventListener('change', function(){ updateDateDisplays(); validateDateOrder(true); });
        endDateInputEl?.addEventListener('change', function(){ updateDateDisplays(); validateDateOrder(true); });


        // --- اعتبارسنجی فرمت تاریخ قبل از ارسال ---
        const budgetForm = document.getElementById('budgetPeriodForm');
        if (budgetForm) {
            budgetForm.addEventListener('submit', function (e) {
                let formIsValid = true;
                const dateRegex = /^[1-4]\d{3}\/(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])$/;
                const dateFields = [
                    {
                        input: document.getElementById('{{ form.start_date.id_for_label }}'),
                        name: '{% trans "تاریخ شروع" %}'
                    },
                    {
                        input: document.getElementById('{{ form.end_date.id_for_label }}'),
                        name: '{% trans "تاریخ پایان" %}'
                    }
                ];

                dateFields.forEach(field => {
                    if (field.input && field.input.value && !dateRegex.test(field.input.value)) {
                        alert(`${field.name}: {% trans "فرمت تاریخ نامعتبر است. لطفا از YYYY/MM/DD استفاده کنید (مثال: 1404/01/01)." %}`);
                        field.input.focus();
                        formIsValid = false;
                        // جلوگیری از ادامه بررسی‌های دیگر
                        return;
                    }
                });

                // بررسی اضافی: تاریخ شروع قبل از پایان باشد
                if (!validateDateOrder(true)) {
                    const sEl = document.getElementById('{{ form.start_date.id_for_label }}');
                    sEl?.focus();
                    formIsValid = false;
                }


                if (!formIsValid) {
                    e.preventDefault(); // جلوگیری از ارسال فرم
                }
            });
        }

        // --- به‌روزرسانی مقدار به حروف به صورت پویا ---
        const totalAmountInput = document.getElementById('{{ form.total_amount.id_for_label }}');
        const totalAmountPersian = document.getElementById('total_amount_persian');
        const amountWordsDiv = document.getElementById('total_amount_words_display'); // استفاده از id جدید

        function numberToWordsFa(num){
            // ساده و کافی برای میلیاردها، بدون جزئیات اعشار
            num = Math.floor(Number(num) || 0);
            if (num === 0) return 'صفر';
            const ones = ['','یک','دو','سه','چهار','پنج','شش','هفت','هشت','نه'];
            const teens = ['ده','یازده','دوازده','سیزده','چهارده','پانزده','شانزده','هفده','هجده','نوزده'];
            const tens = ['','','بیست','سی','چهل','پنجاه','شصت','هفتاد','هشتاد','نود'];
            const hundreds = ['','صد','دویست','سیصد','چهارصد','پانصد','ششصد','هفتصد','هشتصد','نهصد'];
            const scales = ['','هزار','میلیون','میلیارد','هزار میلیارد'];
            function underThousand(n){
                let parts=[];
                const h = Math.floor(n/100); const t = Math.floor((n%100)/10); const o = n%10; const lastTwo = n%100;
                if (h) parts.push(hundreds[h]);
                if (lastTwo>=10 && lastTwo<20){ parts.push(teens[lastTwo-10]); }
                else{
                    if (t) parts.push(tens[t]);
                    if (o) parts.push(ones[o]);
                }
                return parts.join(' و ');
            }
            let parts=[]; let scaleIndex=0;
            while(num>0 && scaleIndex<scales.length){
                const chunk = num%1000;
                if (chunk){
                    const chunkWords = underThousand(chunk);
                    parts.unshift((chunkWords + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : '')).trim());
                }
                num = Math.floor(num/1000); scaleIndex++;
            }
            return parts.join(' و ');
        }

        async function updateAmountWords() {
            if (!totalAmountInput || !amountWordsDiv) return;

            // برای اعداد فارسی در ورودی، آن‌ها را به انگلیسی تبدیل می‌کنیم
            const englishValue = toLatinDigits(totalAmountInput.value).replace(/,/g, '');
            if (totalAmountPersian) totalAmountPersian.textContent = formatFaNumber(englishValue);

            // فقط اگر مقدار عددی معتبر و مثبت باشد
            if (englishValue && !isNaN(englishValue) && Number(englishValue) > 0) {
                const words = numberToWordsFa(englishValue);
                amountWordsDiv.textContent = '{% trans "به حروف" %}: ' + words + ' {% trans "ریال" %}';
                const wordsSummaryEl = document.getElementById('bp-total-words-summary');
                if (wordsSummaryEl) wordsSummaryEl.textContent = words;
            } else {
                amountWordsDiv.textContent = ''; // پاک کردن اگر ورودی نامعتبر است
                const wordsSummaryEl = document.getElementById('bp-total-words-summary');
                if (wordsSummaryEl) wordsSummaryEl.textContent = '{% trans "صفر" %}';
            }
        }

        // اجرای تابع در زمان تغییر ورودی و در بارگذاری اولیه
        if (totalAmountInput) {
            totalAmountInput.addEventListener('input', debounce(updateAmountWords, 400));
            updateAmountWords();
        }

        // --- خلاصه سمت راست: به‌روزرسانی لحظه‌ای ---
        function updateSummary(){
            const nameEl = document.getElementById('{{ form.name.id_for_label }}') || document.getElementById('id_name');
            const orgEl = document.getElementById('{{ form.organization.id_for_label }}') || document.getElementById('id_organization');
            const startEl = document.getElementById('{{ form.start_date.id_for_label }}') || document.getElementById('id_start_date');
            const endEl = document.getElementById('{{ form.end_date.id_for_label }}') || document.getElementById('id_end_date');
            const totalEl = document.getElementById('{{ form.total_amount.id_for_label }}') || document.getElementById('id_total_amount');

            const nameSummary = document.getElementById('bp-name-summary');
            const orgSummary = document.getElementById('bp-org-summary');
            const startSummary = document.getElementById('bp-start-summary');
            const endSummary = document.getElementById('bp-end-summary');
            const totalSummary = document.getElementById('bp-total-summary');

            if (nameSummary) nameSummary.textContent = nameEl?.value ? nameEl.value : '—';
            if (orgSummary) orgSummary.textContent = (orgEl && orgEl.options && orgEl.selectedIndex >= 0) ? (orgEl.options[orgEl.selectedIndex]?.text || '—') : '—';
            if (startSummary) startSummary.textContent = startEl?.value ? toPersianDigits(startEl.value) : '—';
            if (endSummary) endSummary.textContent = endEl?.value ? toPersianDigits(endEl.value) : '—';
            if (totalSummary) totalSummary.textContent = totalEl?.value ? formatFaNumber(totalEl.value) : '۰';
        }
        // اتصال رویدادها
        document.getElementById('{{ form.name.id_for_label }}')?.addEventListener('input', updateSummary);
        document.getElementById('{{ form.organization.id_for_label }}')?.addEventListener('change', updateSummary);
        document.getElementById('{{ form.start_date.id_for_label }}')?.addEventListener('input', updateSummary);
        document.getElementById('{{ form.end_date.id_for_label }}')?.addEventListener('input', updateSummary);
        document.getElementById('{{ form.total_amount.id_for_label }}')?.addEventListener('input', debounce(updateSummary, 200));
        // اجرای اولیه
        setTimeout(updateSummary, 200);
        // --- رنگ‌های متمایز برای تنظیمات قفل/هشدار ---
        const lockCondSel = document.getElementById('{{ form.lock_condition.id_for_label }}') || document.getElementById('id_lock_condition');
        const lockBadge = document.getElementById('badge-lock-condition');
        const lockPercInput = document.getElementById('{{ form.locked_percentage.id_for_label }}') || document.getElementById('id_locked_percentage');
        const lockPercBadge = document.getElementById('badge-locked-percentage');
        const warnThrInput = document.getElementById('{{ form.warning_threshold.id_for_label }}') || document.getElementById('id_warning_threshold');
        const warnThrBadge = document.getElementById('badge-warning-threshold');
        const warnActionSel = document.getElementById('{{ form.warning_action.id_for_label }}') || document.getElementById('id_warning_action');
        const warnActionBadge = document.getElementById('badge-warning-action');

        function updateBadges(){
            if (lockCondSel && lockBadge){
                const v = lockCondSel.value || '';
                lockBadge.textContent = lockCondSel.options[lockCondSel.selectedIndex]?.text || '—';
                lockBadge.className = 'badge ' + (v==='AFTER_DATE' ? 'bg-warning' : v==='MANUAL' ? 'bg-danger' : v==='ZERO_REMAINING' ? 'bg-info' : 'bg-secondary');
            }
            if (lockPercInput && lockPercBadge){
                const p = Number(toLatinDigits(lockPercInput.value)) || 0;
                lockPercBadge.textContent = `${p}%`;
                lockPercBadge.className = 'badge ' + (p>=50 ? 'bg-danger' : p>=20 ? 'bg-warning' : 'bg-success');
            }
            if (warnThrInput && warnThrBadge){
                const w = Number(toLatinDigits(warnThrInput.value)) || 0;
                warnThrBadge.textContent = `${w}%`;
                warnThrBadge.className = 'badge ' + (w>=50 ? 'bg-danger' : w>=20 ? 'bg-warning' : 'bg-success');
            }
            if (warnActionSel && warnActionBadge){
                const t = warnActionSel.options[warnActionSel.selectedIndex]?.text || '—';
                const v = warnActionSel.value || '';
                warnActionBadge.textContent = t;
                warnActionBadge.className = 'badge ' + (v==='LOCK' ? 'bg-danger' : v==='RESTRICT' ? 'bg-warning' : 'bg-secondary');
            }
        }
        lockCondSel?.addEventListener('change', updateBadges);
        lockPercInput?.addEventListener('input', updateBadges);
        warnThrInput?.addEventListener('input', updateBadges);
        warnActionSel?.addEventListener('change', updateBadges);
        setTimeout(updateBadges, 200);

        // --- توضیحات خودکار بر اساس اطلاعات ---
        let userEditedDesc = false;
        const descInput = document.getElementById('{{ form.description.id_for_label }}') || document.getElementById('id_description');
        if (descInput) descInput.addEventListener('input', ()=> userEditedDesc = true);
        function autoDescription(){
            if (!descInput || userEditedDesc) return;
            const org = document.getElementById('{{ form.organization.id_for_label }}') || document.getElementById('id_organization');
            const name = document.getElementById('{{ form.name.id_for_label }}') || document.getElementById('id_name');
            const s = document.getElementById('{{ form.start_date.id_for_label }}') || document.getElementById('id_start_date');
            const e = document.getElementById('{{ form.end_date.id_for_label }}') || document.getElementById('id_end_date');
            const lp = lockPercInput?.value || '';
            const wt = warnThrInput?.value || '';
            const wa = warnActionSel?.options[warnActionSel.selectedIndex]?.text || '';
            const parts = [];
            if (name?.value) parts.push(`نام دوره: ${name.value}`);
            if (org) parts.push(`سازمان: ${org.options[org.selectedIndex]?.text || ''}`);
            if (s?.value && e?.value) parts.push(`بازه: ${s.value} تا ${e.value}`);
            if (lp) parts.push(`درصد قفل: ${lp}%`);
            if (wt) parts.push(`آستانه اخطار: ${wt}%`);
            if (wa) parts.push(`اقدام هشدار: ${wa}`);
            descInput.value = parts.join(' | ');
        }
        document.getElementById('{{ form.organization.id_for_label }}')?.addEventListener('change', autoDescription);
        document.getElementById('{{ form.name.id_for_label }}')?.addEventListener('input', autoDescription);
        document.getElementById('{{ form.start_date.id_for_label }}')?.addEventListener('change', autoDescription);
        document.getElementById('{{ form.end_date.id_for_label }}')?.addEventListener('change', autoDescription);
        lockPercInput?.addEventListener('input', autoDescription);
        warnThrInput?.addEventListener('input', autoDescription);
        warnActionSel?.addEventListener('change', autoDescription);
        setTimeout(autoDescription, 400);

        // --- تابع Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- فعال کردن Tooltip های Bootstrap (اگر استفاده می‌کنید) ---
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

    });
</script>
{% endblock %}