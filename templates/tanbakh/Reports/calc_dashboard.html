{% extends 'base.html' %}
{% load i18n static tanbakh_tags %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4"><i class="fas fa-chart-line me-2"></i>{% trans "داشبورد مالی" %}</h1>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">{% trans "مبلغ کل تنخواه‌ها" %}</h5>
                    <p class="card-text fs-3">{{ total_tanbakh_amount|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">{% trans "تنخواه‌های آرشیو شده" %}</h5>
                    <p class="card-text fs-3">{{ archived_tanbakhs }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">{% trans "تنخواه‌های در انتظار" %}</h5>
                    <p class="card-text fs-3">
                        {% for stage in stages %}
                            {{ stage.name }}: {{ pending_by_stage|get_item:stage.name }}<br>
                        {% endfor %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">{% trans "مقایسه مالی مجتمع‌ها" %}</h5>
        </div>
        <div class="card-body">
            <canvas id="financialChart" height="100"></canvas>
        </div>
    </div>

    <div class="row">
        {% for org in org_data %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">{{ org.name }}</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">{% trans "مبلغ تنخواه‌ها" %}: <strong>{{ org.total_tanbakh_amount|floatformat:0 }}</strong></li>
                        <li class="list-group-item">{% trans "مبلغ فاکتورها (مرحله 1)" %}: <strong>{{ org.total_factor_amount_stage1|floatformat:0 }}</strong></li>
                        <li class="list-group-item">{% trans "جمع ردیف‌های تأییدشده" %}: <strong>{{ org.total_approved_items|floatformat:0 }}</strong></li>
                        <li class="list-group-item">
                            {% trans "تنخواه‌های در انتظار" %}:
                            <ul>
                                {% for stage_name, count in org.pending_counts.items %}
                                <li>{{ stage_name }}: {{ count }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12"><div class="alert alert-info text-center">{% trans "هیچ مجتمعی برای نمایش وجود ندارد." %}</div></div>
        {% endfor %}
    </div>
</div>

<style>
    .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    .card-header { font-weight: bold; }
    .fs-3 { font-size: 2rem; font-weight: bold; }
</style>

    <script src="{% static 'admin/js/chart.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var ctx = document.getElementById('financialChart').getContext('2d');
        var chartData = {{ chart_data|safe }};
        new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                animation: { duration: 1000, easing: 'easeInOutQuad' },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'مبلغ (تومان)' } },
                    x: { title: { display: true, text: 'مجتمع‌ها' } }
                },
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'گزارش مالی مجتمع‌ها' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toLocaleString()} تومان`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
