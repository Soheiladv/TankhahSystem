

{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header mb-4 text-center">
        <h1 class="display-5">
            <i class="fas fa-user-shield me-2 text-primary"></i>مدیریت نقش‌های سیستم
        </h1>
        <p class="lead text-muted">ایجاد، ویرایش و مدیریت دسترسی‌ها و مجوزهای کاربران</p>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-light border-bottom p-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                <form method="get" action="" class="d-flex align-items-center flex-grow-1 me-md-3 mb-3 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text border-end-0 bg-white">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text"
                               name="q"
                               class="form-control border-start-0"
                               placeholder="جستجوی نقش، توضیحات یا مجوز..."
                               value="{{ query }}"
                               autocomplete="off">
                        {% if show_inactive %}
                            <input type="hidden" name="show_inactive" value="true">
                        {% endif %}
                        <button class="btn btn-outline-secondary" type="submit">جستجو</button>
                    </div>
                </form>

                <div class="d-flex align-items-center">
                    <div class="btn-group me-3" role="group">
                        <a href="?q={{ query }}" class="btn btn-outline-success {% if not show_inactive %}active{% endif %}">
                            <i class="fas fa-check-circle me-1"></i>فعال
                        </a>
                        <a href="?show_inactive=true&q={{ query }}" class="btn btn-outline-warning {% if show_inactive %}active{% endif %}">
                            <i class="fas fa-ban me-1"></i>غیرفعال
                        </a>
                    </div>
                    <a href="{% url 'accounts:role_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i>ایجاد نقش جدید
                    </a>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="roles-table">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 px-4" width="25%">نام نقش</th>
                            <th class="py-3 px-4" width="50%">مجوزها</th>
                            <th class="py-3 px-4 text-center" width="10%">وضعیت</th>
                            <th class="py-3 px-4 text-center" width="15%">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for role in roles %}
                        <tr>
                            <td class="align-middle px-4">
                                <strong class="d-block">{{ role.name }}</strong>
                                {% if role.description %}
                                    <small class="text-muted">{{ role.description|truncatechars:70 }}</small>
                                {% endif %}
                            </td>
                            <td class="align-middle px-4">
                                {% with permissions=role.permissions.all %}
                                    {% for perm in permissions|slice:":4" %}
                                        <span class="badge bg-secondary fw-normal">{{ perm.name }}</span>
                                    {% endfor %}
                                    {% if permissions.count > 4 %}
                                        <span class="badge bg-info fw-normal"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="{% for perm in permissions %}{{ perm.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                                            +{{ permissions.count|add:"-4" }} بیشتر
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="align-middle text-center px-4">
                                {% if role.is_active %}
                                    <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle">فعال</span>
                                {% else %}
                                    <span class="badge rounded-pill bg-danger-subtle text-danger-emphasis border border-danger-subtle">غیرفعال</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center px-4">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
    <li>
        <a class="dropdown-item" href="{% url 'accounts:role_update' role.id %}">
            <i class="fas fa-edit me-2 text-primary"></i>ویرایش
        </a>
    </li>
    <li>
        <a class="dropdown-item" href="{% url 'accounts:role_print' role.id %}" target="_blank">
            <i class="fas fa-print me-2 text-secondary"></i>چاپ مجوزها
        </a>
    </li>
    {% if role.is_active %}
        <li><hr class="dropdown-divider"></li>
        <li>
            <form method="post" action="{% url 'accounts:deactivate_role' role.id %}" class="form-deactivate-role">
                {% csrf_token %}
                <button type="submit" class="dropdown-item text-danger">
                    <i class="fas fa-ban me-2"></i>غیرفعال کردن
                </button>
            </form>
        </li>
    {% endif %}
</ul>


                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h4 class="mb-2">هیچ نقشی یافت نشد.</h4>
                                <p class="text-muted">
                                    {% if query %}
                                        هیچ نقشی مطابق با جستجوی شما پیدا نشد.
                                    {% else %}
                                        شما هنوز هیچ نقشی ایجاد نکرده‌اید.
                                    {% endif %}
                                </p>
                                <a href="{% url 'accounts:role_create' %}" class="btn btn-primary mt-2">
                                    <i class="fas fa-plus-circle me-2"></i> اولین نقش را ایجاد کنید
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if is_paginated and roles %}
        <div class="card-footer bg-light border-top d-flex justify-content-center py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}{% if show_inactive %}&show_inactive=true{% endif %}">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ query }}{% if show_inactive %}&show_inactive=true{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}{% if show_inactive %}&show_inactive=true{% endif %}">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // فعال‌سازی Tooltip های Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // مدیریت تایید برای فرم غیرفعال‌سازی
    const deactivateForms = document.querySelectorAll('.form-deactivate-role');
    deactivateForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // جلوگیری از ارسال مستقیم فرم

            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: "این نقش غیرفعال خواهد شد و دسترسی‌های مرتبط با آن محدود می‌شود.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'بله، غیرفعال کن!',
                cancelButtonText: 'انصراف'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit(); // اگر کاربر تایید کرد، فرم ارسال شود
                }
            });
        });
    });
});
</script>
{% endblock %}


{#{% extends "base.html" %}#}
{#{% load static %}#}
{##}
{#{% block content %}#}
{#    <div class="role-management-container animate__animated animate__fadeIn">#}
{#        <!-- Header -->#}
{#        <div class="role-header animate__animated animate__fadeInDown">#}
{#            <h1 class="text-center">#}
{#                <i class="fas fa-user-tag"></i> مدیریت نقش‌های سیستم#}
{#            </h1>#}
{#            <p class="text-muted text-center">مدیریت دسترسی‌ها و مجوزهای کاربران سیستم</p>#}
{#        </div>#}
{##}
{#        <!-- Main Card -->#}
{#        <div class="card role-card shadow-lg animate__animated animate__zoomIn">#}
{#            <div class="card-header bg-gradient-primary">#}
{#                <div class="d-flex justify-content-between align-items-center">#}
{#                    <h3 class="card-title mb-0">#}
{#                        <i class="fas fa-list"></i> لیست نقش‌ها#}
{#                    </h3>#}
{#                    <div class="status-filter">#}
{#                        <a href="?show_inactive=false"#}
{#                           class="btn btn-sm btn-success custom-btn {% if not show_inactive %}active{% endif %}">#}
{#                            <i class="fas fa-check-circle"></i> فعال#}
{#                        </a>#}
{#                        <a href="?show_inactive=true"#}
{#                           class="btn btn-sm btn-warning custom-btn {% if show_inactive %}active{% endif %}">#}
{#                            <i class="fas fa-ban"></i> غیرفعال#}
{#                        </a>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{##}
{#            <div class="card-body">#}
{#                <!-- نوار ابزار جستجو و اقدامات -->#}
{#                <div class="role-toolbar mb-4 animate__animated animate__fadeIn">#}
{#                    <div class="row align-items-center g-3">#}
{#                        <!-- بخش جستجو -->#}
{#                        <div class="col-lg-8 col-md-7 mb-3 mb-md-0">#}
{#                            <div class="search-container input-group shadow-sm">#}
{#                                <span class="input-group-text bg-white border-end-0">#}
{#                                    <i class="fas fa-search text-primary"></i>#}
{#                                </span>#}
{#                                <input type="text"#}
{#                                       id="roleSearch"#}
{#                                       class="form-control border-start-0 ps-0"#}
{#                                       placeholder="جستجو بر اساس نام نقش، توضیحات یا مجوزها..."#}
{#                                       autocomplete="off">#}
{#                                <button class="btn btn-outline-secondary border-start-0"#}
{#                                        type="button"#}
{#                                        id="clearSearch">#}
{#                                    <i class="fas fa-times"></i>#}
{#                                </button>#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <!-- دکمه ایجاد نقش جدید -->#}
{#                        <div class="col-lg-4 col-md-5 text-md-end text-center">#}
{#                            <a href="{% url 'accounts:role_create' %}"#}
{#                               class="btn btn-primary btn-add-role shadow-sm">#}
{#                                <i class="fas fa-plus-circle me-2"></i>#}
{#                                <span class="d-none d-md-inline">ایجاد نقش جدید</span>#}
{#                            </a>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{##}
{#                <!-- Roles Table -->#}
{#                <div class="table-responsive">#}
{#                    <table class="table role-table table-hover">#}
{#                        <thead class="table-light">#}
{#                        <tr class="role-item"> <!-- اینجا role-item رو برداشتم -->#}
{#                            <th width="15%">نام نقش</th>#}
{#                            <th width="45%">مجوزها</th>#}
{#                            <th width="5%">وضعیت</th>#}
{#                            <th width="5%">عملیات</th>#}
{#                        </tr>#}
{#                        </thead>#}
{#                        <tbody>#}
{#                        {% for role in roles %}#}
{#                            <tr class="role-item animate__animated animate__fadeInUp"> <!-- اینجا role-item رو گذاشتم -->#}
{#                                <td>#}
{#                                    <strong>{{ role.name }}</strong>#}
{#                                    {% if role.description %}#}
{#                                        <small class="text-muted d-block">{{ role.description|truncatechars:50 }}</small>#}
{#                                    {% endif %}#}
{#                                </td>#}
{#                                <td>#}
{#                                    {% for perm in role.permissions.all %}#}
{#                                        <span class="badge bg-info animate__animated animate__zoomIn">{{ perm.name }}</span>#}
{#                                    {% endfor %}#}
{#                                </td>#}
{#                                <td>#}
{#                                    {% if role.is_active %}#}
{#                                        <span class="badge bg-success animate__animated animate__zoomIn">فعال</span>#}
{#                                    {% else %}#}
{#                                        <span class="badge bg-danger animate__animated animate__zoomIn">غیرفعال</span>#}
{#                                    {% endif %}#}
{#                                </td>#}
{#                                <td>#}
{#                                    <div class="role-actions">#}
{#                                        <a href="{% url 'accounts:role_update' role.id %}"#}
{#                                           class="btn-action edit animate__animated animate__tada"#}
{#                                           data-toggle="tooltip" title="ویرایش نقش">#}
{#                                            <i class="fas fa-edit"></i>#}
{#                                        </a>#}
{#                                        {% if role.is_active %}#}
{#                                            <form method="post" action="{% url 'accounts:deactivate_role' role.id %}"#}
{#                                                  class="d-inline">#}
{#                                                {% csrf_token %}#}
{#                                                <button type="submit"#}
{#                                                        class="btn-action deactivate animate__animated animate__shakeX"#}
{#                                                        data-toggle="tooltip" title="غیرفعال کردن">#}
{#                                                    <i class="fas fa-ban"></i>#}
{#                                                </button>#}
{#                                            </form>#}
{#                                        {% else %}#}
{#                                            <span class="text-muted">غیرفعال</span>#}
{#                                        {% endif %}#}
{#                                    </div>#}
{#                                </td>#}
{#                            </tr>#}
{#                        {% empty %}#}
{#                            <tr class="role-item"> <!-- اینجا هم role-item گذاشتم -->#}
{#                                <td colspan="4" class="text-center py-4">#}
{#                                    <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>#}
{#                                    <p>هیچ نقشی یافت نشد</p>#}
{#                                    <a href="{% url 'accounts:role_create' %}" class="btn btn-primary custom-btn">#}
{#                                        ایجاد نقش جدید#}
{#                                    </a>#}
{#                                </td>#}
{#                            </tr>#}
{#                        {% endfor %}#}
{#                        </tbody>#}
{#                    </table>#}
{#                </div>#}
{##}
{#                <!-- Pagination -->#}
{#                {% if is_paginated %}#}
{#                    <nav class="pagination-container mt-4">#}
{#                        <ul class="pagination justify-content-center">#}
{#                            {% if page_obj.has_previous %}#}
{#                                <li class="page-item">#}
{#                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">#}
{#                                        <i class="fas fa-chevron-right"></i>#}
{#                                    </a>#}
{#                                </li>#}
{#                            {% endif %}#}
{#                            {% for num in page_obj.paginator.page_range %}#}
{#                                {% if page_obj.number == num %}#}
{#                                    <li class="page-item active">#}
{#                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>#}
{#                                    </li>#}
{#                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}#}
{#                                    <li class="page-item">#}
{#                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>#}
{#                                    </li>#}
{#                                {% endif %}#}
{#                            {% endfor %}#}
{#                            {% if page_obj.has_next %}#}
{#                                <li class="page-item">#}
{#                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">#}
{#                                        <i class="fas fa-chevron-left"></i>#}
{#                                    </a>#}
{#                                </li>#}
{#                            {% endif %}#}
{#                        </ul>#}
{#                    </nav>#}
{#                {% endif %}#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#{% endblock %}#}
{##}
{#{% block extra_css %}#}
{#    <style>#}
{#        /* استایل‌های قبلی رو نگه می‌دارم، فقط اینا رو درست می‌کنم */#}
{#        .search-container.input-group {#}
{#            max-width: 500px;#}
{#            border-radius: 30px;#}
{#            overflow: hidden;#}
{#            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);#}
{#        }#}
{##}
{#        .search-container .form-control {#}
{#            padding: 12px 15px;#}
{#            border: none;#}
{#            background: #fff;#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .search-container .form-control:focus {#}
{#            box-shadow: none;#}
{#            background: #f8fafc;#}
{#        }#}
{##}
{#        .search-container .input-group-text {#}
{#            background: #fff;#}
{#            border: none;#}
{#            padding: 0.75rem 1rem;#}
{#        }#}
{##}
{#        .search-container .btn-outline-secondary {#}
{#            border: none;#}
{#            color: #e74c3c;#}
{#            padding: 0.75rem;#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .search-container .btn-outline-secondary:hover {#}
{#            color: #c0392b;#}
{#            background: #f8f9fa;#}
{#        }#}
{##}
{#        #clearSearch {#}
{#            visibility: hidden; /* اولش مخفیه */#}
{#        }#}
{##}
{##}
{#    </style>#}
{#{% endblock %}#}
{##}
{#{% block extra_js %}#}
{#<script>#}
{#$(document).ready(function() {#}
{#    // چک کن jQuery کار می‌کنه#}
{#    console.log('عشقم jQuery لود شد!');#}
{##}
{#    // وقتی تو جستجو چیزی تایپ می‌کنی#}
{#    $('#roleSearch').on('input', function() {#}
{#        let keyword = $(this).val().toLowerCase().trim();#}
{##}
{#        // دکمه × رو نشون بده یا مخفیش کن#}
{#        $('#clearSearch').css('visibility', keyword.length > 0 ? 'visible' : 'hidden');#}
{##}
{#        // بگرد بین نقش‌ها و هایلایت کن#}
{#        $('.role-item').each(function() {#}
{#            let $row = $(this);#}
{#            let roleText = $row.text().toLowerCase();#}
{##}
{#            // اول هایلایت‌های قبلی رو پاک کن#}
{#            $row.find('.highlight').contents().unwrap();#}
{##}
{#            if (keyword && roleText.includes(keyword)) {#}
{#                // اگه پیدا شد، نشون بده و هایلایت کن#}
{#                $row.slideDown(300);#}
{##}
{#                // متن داخل هر سلول رو چک کن و هایلایت کن#}
{#                $row.find('td').each(function() {#}
{#                    let $cell = $(this);#}
{#                    let cellText = $cell.text();#}
{#                    let lowerCellText = cellText.toLowerCase();#}
{##}
{#                    if (lowerCellText.includes(keyword)) {#}
{#                        let regex = new RegExp(`(${keyword})`, 'gi');#}
{#                        let newHtml = cellText.replace(regex, '<span class="highlight">$1</span>');#}
{#                        $cell.html(newHtml);#}
{#                    }#}
{#                });#}
{#            } else {#}
{#                // اگه پیدا نشد، غیبش بزن#}
{#                $row.slideUp(300);#}
{#            }#}
{#        });#}
{#    });#}
{##}
{#    // وقتی دکمه × رو می‌زنی#}
{#    $('#clearSearch').on('click', function() {#}
{#        $('#roleSearch').val('').trigger('input');#}
{#        $('.role-item').each(function() {#}
{#            $(this).slideDown(300);#}
{#            // هایلایت‌ها رو پاک کن#}
{#            $(this).find('.highlight').contents().unwrap();#}
{#        });#}
{#    });#}
{##}
{#    // انیمیشن برای دکمه "نقش جدید"#}
{#    $('.btn-add-role').hover(#}
{#        function() {#}
{#            $(this).addClass('animate__animated animate__pulse');#}
{#        },#}
{#        function() {#}
{#            $(this).removeClass('animate__animated animate__pulse');#}
{#        }#}
{#    );#}
{##}
{#    // تأیید برای غیرفعال کردن#}
{#    $('.deactivate').on('click', function(e) {#}
{#        if (!confirm('مطمئنی می‌خوای این نقش رو غیرفعال کنی عشقم؟')) {#}
{#            e.preventDefault();#}
{#        }#}
{#    });#}
{#});#}
{#</script>#}
{#{% endblock %}#}
