{% load static i18n humanize jformat rcms_custom_filters jalali_tags %}

<!DOCTYPE html>
 <html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "سیستم جامع نظارتی بودجه بندی سازمانی و تنخواه‌گردانی" %}{% endblock %}</title>
    <link rel="icon" href="{% static 'admin/img/favicon.ico' %}" type="image/x-icon">
    <!-- CSS های اصلی -->
    <link href="{% static 'admin/css/bootstrap.rtl.min.css' %}" rel="stylesheet">
    <link href="{% static 'admin/css/all.min.css' %}" rel="stylesheet">
    <link href="{% static 'admin/css/animate.min.css' %}" rel="stylesheet">
    <!-- CSS فارسی دیتاپیکر -->
    <link href="{% static 'admin/css/jalalidatepicker.min.css' %}" rel="stylesheet">
    <link href="{% static 'admin/css/custom.css' %}" rel="stylesheet">

    {# Select2 CSS #}
    <link href="{% static 'admin/css/select2.min.css' %}" rel="stylesheet"/>
    {# Select2 Bootstrap 5 Theme #}
    <link rel="stylesheet" href="{% static 'admin/css/select2-bootstrap-5-theme.min.css' %}"/>


    <!-- استایل‌های سفارشی -->
    <link rel="stylesheet" href="{% static 'admin/css/budgetsStyle.css' %}">
    <link rel="stylesheet" href="{% static 'css/notification-animations.css' %}">
    <!-- Dashboard Reports CSS -->
    <!-- <link rel="stylesheet" href="{% static 'reports/css/dashboard.css' %}"> -->
    <!-- Global Styles CSS -->
    <link rel="stylesheet" href="{% static 'css/global-styles.css' %}">

    {% block extra_css %}{% endblock %}

    <style>
        @font-face {
            font-family: 'Parastoo';
            src: url('{% static "admin/fonts/Parastoo.ttf" %}') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Parastoo', 'Yekan', 'IRANSans', sans-serif;
        }

        /* Global Theme Variables */
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #6b7280;
            --accent-color: #f59e0b;
            --background-color: #f9fafb;
            --surface-color: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #f9fafb 0%, #fefdf8 50%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --gradient-accent: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        /* Theme 1: Ocean - آبی و زرد */
        [data-theme="ocean"] {
            --primary-color: #0ea5e9;
            --secondary-color: #fbbf24;
            --accent-color: #f0f9ff;
            --background-color: #f0f9ff;
            --surface-color: #fefce8;
            --text-color: #0c4a6e;
            --text-muted: #0369a1;
            --border-color: #bae6fd;
            --shadow-color: rgba(14, 165, 233, 0.1);
            --gradient-primary: linear-gradient(135deg, #f0f9ff 0%, #fefce8 50%, #0ea5e9 100%);
            --gradient-secondary: linear-gradient(135deg, #e0f2fe 0%, #fef3c7 100%);
            --gradient-accent: linear-gradient(135deg, #0ea5e9 0%, #fbbf24 100%);
        }

        /* Theme 2: Sunset - نارنجی و قرمز */
        [data-theme="sunset"] {
            --primary-color: #f97316;
            --secondary-color: #ef4444;
            --accent-color: #fef7ed;
            --background-color: #fef7ed;
            --surface-color: #fefce8;
            --text-color: #9a3412;
            --text-muted: #c2410c;
            --border-color: #fed7aa;
            --shadow-color: rgba(249, 115, 22, 0.1);
            --gradient-primary: linear-gradient(135deg, #fef7ed 0%, #fefce8 50%, #f97316 100%);
            --gradient-secondary: linear-gradient(135deg, #fed7aa 0%, #fef3c7 100%);
            --gradient-accent: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
        }

        /* Theme 3: Forest - سبز */
        [data-theme="forest"] {
            --primary-color: #22c55e;
            --secondary-color: #16a34a;
            --accent-color: #f0fdf4;
            --background-color: #f0fdf4;
            --surface-color: #fefdf8;
            --text-color: #14532d;
            --text-muted: #15803d;
            --border-color: #bbf7d0;
            --shadow-color: rgba(34, 197, 94, 0.1);
            --gradient-primary: linear-gradient(135deg, #f0fdf4 0%, #fefdf8 50%, #22c55e 100%);
            --gradient-secondary: linear-gradient(135deg, #dcfce7 0%, #fef3c7 100%);
            --gradient-accent: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        /* Theme 4: Purple - بنفش و زرد */
        [data-theme="purple"] {
            --primary-color: #a855f7;
            --secondary-color: #eab308;
            --accent-color: #faf5ff;
            --background-color: #faf5ff;
            --surface-color: #fefce8;
            --text-color: #581c87;
            --text-muted: #7c3aed;
            --border-color: #e9d5ff;
            --shadow-color: rgba(168, 85, 247, 0.1);
            --gradient-primary: linear-gradient(135deg, #faf5ff 0%, #fefce8 50%, #a855f7 100%);
            --gradient-secondary: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
            --gradient-accent: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        }

        /* Theme 5: Midnight - خاکستری تیره */
        [data-theme="midnight"] {
            --primary-color: #334155;
            --secondary-color: #475569;
            --accent-color: #f8fafc;
            --background-color: #f8fafc;
            --surface-color: #f1f5f9;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow-color: rgba(51, 65, 85, 0.1);
            --gradient-primary: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --gradient-secondary: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            --gradient-accent: linear-gradient(135deg, #334155 0%, #1e293b 100%);
        }

        /* Theme 6: Mint - نعنایی */
        [data-theme="mint"] {
            --primary-color: #077a7d;
            --secondary-color: #7ae2cf;
            --accent-color: #f5eedd;
            --background-color: #f5eedd;
            --surface-color: #f0fdfa;
            --text-color: #06202b;
            --text-muted: #077a7d;
            --border-color: #7ae2cf;
            --shadow-color: rgba(7, 122, 125, 0.1);
            --gradient-primary: linear-gradient(135deg, #f5eedd 0%, #7ae2cf 50%, #077a7d 100%);
            --gradient-secondary: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            --gradient-accent: linear-gradient(135deg, #077a7d 0%, #7ae2cf 100%);
        }

        /* Theme 7: Warm - گرم */
        [data-theme="warm"] {
            --primary-color: #ffa725;
            --secondary-color: #6a9c89;
            --accent-color: #fff5e4;
            --background-color: #fff5e4;
            --surface-color: #fef7ed;
            --text-color: #2c7865;
            --text-muted: #6a9c89;
            --border-color: #c1d8c3;
            --shadow-color: rgba(255, 167, 37, 0.1);
            --gradient-primary: linear-gradient(135deg, #fff5e4 0%, #ffa725 50%, #6a9c89 100%);
            --gradient-secondary: linear-gradient(135deg, #fef7ed 0%, #fed7aa 100%);
            --gradient-accent: linear-gradient(135deg, #ffa725 0%, #6a9c89 100%);
        }

        /* Theme 8: Vibrant - زنده */
        [data-theme="vibrant"] {
            --primary-color: #ff9800;
            --secondary-color: #2c7865;
            --accent-color: #d9edbf;
            --background-color: #d9edbf;
            --surface-color: #f0fdf4;
            --text-color: #2c7865;
            --text-muted: #6a9c89;
            --border-color: #90d26d;
            --shadow-color: rgba(255, 152, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #d9edbf 0%, #ff9800 50%, #2c7865 100%);
            --gradient-secondary: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            --gradient-accent: linear-gradient(135deg, #ff9800 0%, #2c7865 100%);
        }

        /* Theme 9: Deep - عمیق */
        [data-theme="deep"] {
            --primary-color: #01204e;
            --secondary-color: #028391;
            --accent-color: #f6dcac;
            --background-color: #f6dcac;
            --surface-color: #fef3c7;
            --text-color: #01204e;
            --text-muted: #028391;
            --border-color: #feae6f;
            --shadow-color: rgba(1, 32, 78, 0.1);
            --gradient-primary: linear-gradient(135deg, #01204e 0%, #028391 50%, #f6dcac 100%);
            --gradient-secondary: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            --gradient-accent: linear-gradient(135deg, #01204e 0%, #028391 100%);
        }

        /* Theme 10: Tropical - استوایی */
        [data-theme="tropical"] {
            --primary-color: #219c90;
            --secondary-color: #ffc700;
            --accent-color: #fff455;
            --background-color: #fff455;
            --surface-color: #fef3c7;
            --text-color: #219c90;
            --text-muted: #6a9c89;
            --border-color: #ee4e4e;
            --shadow-color: rgba(33, 156, 144, 0.1);
            --gradient-primary: linear-gradient(135deg, #219c90 0%, #fff455 50%, #ffc700 100%);
            --gradient-secondary: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            --gradient-accent: linear-gradient(135deg, #219c90 0%, #ffc700 100%);
        }

        /* Theme 11: Dark - تاریک */
        [data-theme="dark"] {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #f59e0b;
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --gradient-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #6366f1 100%);
            --gradient-secondary: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --gradient-accent: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        /* Apply theme to body and main elements */
        body {
            background: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .main-content {
            background: var(--surface-color);
            border-color: var(--border-color);
        }

        .card {
            background: var(--surface-color);
            border-color: var(--border-color);
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .border {
            border-color: var(--border-color) !important;
        }

        /* Beautiful Theme Selector Styles */
        .sidebar-theme-selector {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .sidebar-theme-header h6 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .sidebar-theme-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .theme-row {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .sidebar-theme-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .sidebar-theme-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .sidebar-theme-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .sidebar-theme-option input[type="radio"]:checked + .theme-preview {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }

        .sidebar-theme-option input[type="radio"]:checked ~ .theme-name {
            color: #3b82f6;
            font-weight: bold;
        }

        .theme-preview {
            width: 35px;
            height: 25px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .theme-name {
            font-size: 10px;
            color: #ffffff;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .theme-form-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .theme-form-actions .btn {
            font-size: 12px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .theme-form-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* استایل برای اعلان‌ها */
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
            min-width: 300px;
        }

        .notification-item .dropdown-item {
            transition: background-color 0.3s ease;
        }

        .notification-item .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread .dropdown-item {
            background-color: #e9f7ff;
            font-weight: bold;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.75rem;
            padding: 2px 6px;
            animation: pulse 2s infinite;
        }

        .dropdown-divider {
            margin: 0.25rem 0;
        }

        .dropdown-header {
            font-weight: bold;
            color: #343a40;
        }

        /* انیمیشن لرزش برای زنگوله */
        .notification-bell {
            transition: transform 0.3s ease;
        }

        .notification-bell.shake {
            animation: shake 0.5s ease-in-out;
        }

        .notification-bell.pulse {
            animation: pulse 1s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* انیمیشن برای badge */
        .notification-badge.animate {
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="theme-{{ user.profile.theme|default:'light' }}">
{% if messages %}
    {% for message in messages %}
        <div class="alert {% if message.tags %}alert-
            
            {{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show animate__animated animate__fadeIn"
             role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}
<nav class="navbar navbar-expand-md navbar-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand animate__animated animate__fadeInLeft" href="{% url 'index' %}">
            <img src="{% static 'admin/img/RCMS2.svg' %}" alt="RCMS">
            <span class="ms-2 d-none d-md-inline">{% trans "داشبورد سیستم جامع نظارتی بر بودجه سازمانی و تنخواه گردان" %}</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link animate__animated animate__fadeInDown"
                       href="{% url 'index' %}">{% trans "خانه" %}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link animate__animated animate__fadeInDown" href="sms:+989xxxxxx?body=help ME!">
                        <i class="fas fa-headset me-2"></i>{% trans "پشتیبانی" %}
                    </a>
                </li>
                <li class="nav-item animate__animated animate__fadeInDown">
                            <span class="nav-link">
                                <i class="fas fa-calendar-day me-2"></i>
                                <span class="text-danger">{% trans "امروز:" %}</span>
                                <span id="datetime" class="text-warning fw-bold ms-2"></span>
                            </span>
                </li>
                {% if user.is_authenticated %}
                    <li class="nav-item ms-3 animate__animated animate__fadeInDown">
                                <span class="nav-link">
                                    <i class="fas fa-user me-2"></i>{{ user.first_name }} {{ user.last_name }}
                                </span>
                    </li>
                    <!-- بخش نوار بالایی (navbar) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell notification-bell" id="notificationBell"></i>
                            <span class="notification-badge badge bg-danger" id="notificationBadge" style="display: none;"></span>
                        </a>
                                <ul class="dropdown-menu dropdown-menu-end notification-list"
                                    aria-labelledby="notificationDropdown">
                                    <li class="dropdown-header">{% trans "اعلان‌ها" %}</li>
                                    <div id="notification-list"></div>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-center"
                                           href="{% url 'notifications:inbox' %}">
                                            {% trans "مشاهده همه اعلان‌ها" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-center" href="{% url 'notifications:unread' %}">
                                            {% trans "مشاهده اعلان‌های خوانده‌نشده" %}
                                        </a>
                                    </li>
                                </ul>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
<button class="navbar-toggle animate__animated animate__fadeInRight" id="sidebarToggle">
    <i class="fas fa-bars"></i>
</button>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header animate__animated animate__fadeInDown">
        <img src="{% static 'admin/img/rcms.jpg' %}" alt="لوگو" class="img-fluid rounded-circle mb-2"
             style="max-width: 80px;">
        <h5 class="text-white">{% trans "سیستم جامع بودجه بندی سازمانی و تنخواه‌گردانی" %}</h5>
    </div>
    <ul class="nav flex-column p-3">
        <li class="nav-item">
            <a href="{% url 'index' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-home"></i>{% trans "خانه" %}
            </a>
        </li>
        {% comment %} <li class="nav-item">
            <a href="{% url 'index' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-tachometer-alt"></i>{% trans "داشبورد" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'all_links' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-link"></i>{% trans "همه لینک‌ها" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'organization_list' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-building"></i>{% trans "سازمان‌ها" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'project_list' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-project-diagram"></i>{% trans "بودجه بندی " %}
            </a>
        </li>

        <li class="nav-item">
            <a href="{% url 'project_list' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-project-diagram"></i>{% trans "مرکز هزینه (پروژه)" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'dashboard_flows' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-file-invoice"></i>{% trans "تنخواه‌ها" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'dashboard_flows' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-file-invoice"></i>{% trans "فاکتور" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'reports_dashboard:main_dashboard' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-chart-line"></i>{% trans "گزارشات و آمار" %}
            </a>
        </li>
         {% endcomment %}
        <!-- Theme Selector in Sidebar -->
        <li class="nav-item">
            <div class="nav-link animate__animated animate__fadeInRight" style="cursor: pointer;" id="sidebarThemeToggle">
                <i class="fas fa-palette"></i>{% trans "انتخاب تم" %}
            </div>
        </li>
        
        <!-- Custom Theme Designer -->
        <li class="nav-item">
            <a class="nav-link animate__animated animate__fadeInRight" href="{% url 'accounts:custom_theme_designer' %}">
                <i class="fas fa-paint-brush"></i>{% trans "طراحی تم سفارشی" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'guide' %}" class="nav-link animate__animated animate__fadeInRight">
                <i class="fas fa-book-open"></i>{% trans "راهنما" %}
            </a>
        </li>
{#        {% if user.is_staff or user.is_superuser %}#}
{#        <li class="nav-item">#}
{#            <a href="{% url 'staff_api_documentation' %}" class="nav-link animate__animated animate__fadeInRight">#}
{#                <i class="fas fa-code"></i>{% trans "مستندات API" %}#}
{#            </a>#}
{#        </li>#}
{#        {% endif %}#}
    </ul>

    <!-- Beautiful Theme Selector in Sidebar -->
    <div class="sidebar-theme-selector" id="sidebarThemeSelector" style="display: none;">
        <div class="sidebar-theme-header">
            <h6 class="text-white mb-3 d-flex align-items-center">
                <i class="fas fa-palette me-2"></i>
                انتخاب تم رنگی
            </h6>
        </div>
        
        <!-- Beautiful Theme Form -->
        <form method="post" action="{% url 'accounts:set_theme' %}" class="theme-form">
            {% csrf_token %}
            <div class="sidebar-theme-options">
                {% for theme_value, theme_name in available_themes %}
                    {% if forloop.counter0|divisibleby:2 %}
                        <div class="theme-row">
                    {% endif %}
                    
                    <label class="sidebar-theme-option" data-theme="{{ theme_value }}">
                        <input type="radio" name="theme" value="{{ theme_value }}" {% if user_theme == theme_value or forloop.first and not user_theme %}checked{% endif %}>
                        <div class="theme-preview" style="background: {% if theme_value == 'custom' and custom_theme_data %}linear-gradient(135deg, {{ custom_theme_data.primary_color }} 0%, {{ custom_theme_data.secondary_color }} 50%, {{ custom_theme_data.background_color }} 100%){% else %}var(--gradient-primary){% endif %};"></div>
                        <span class="theme-name">{{ theme_name }}</span>
                    </label>
                    
                    {% if forloop.counter|divisibleby:2 or forloop.last %}
                        </div>
                    {% endif %}
                {% endfor %}
                
                {% if custom_theme_data %}
                <div class="theme-row">
                    <label class="sidebar-theme-option" data-theme="custom">
                        <input type="radio" name="theme" value="custom" {% if user_theme == 'custom' %}checked{% endif %}>
                        <div class="theme-preview" style="background: linear-gradient(135deg, {{ custom_theme_data.primary_color }} 0%, {{ custom_theme_data.secondary_color }} 50%, {{ custom_theme_data.background_color }} 100%);"></div>
                        <span class="theme-name">سفارشی</span>
                    </label>
                </div>
                {% endif %}
            </div>
            
            <div class="theme-form-actions mt-3">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-check me-1"></i>
                    اعمال تم
                </button>
            </div>
        </form>
    </div>

    <div class="p-3 mt-auto">
        {% if user.is_authenticated %}
            <p class="text-white text-center mb-2 animate__animated animate__fadeInUp">
                <i class="fas fa-user me-2"></i>{{ user.first_name }} {{ user.last_name }}
            </p>
            <form method="post" action="{% url 'accounts:set_theme' %}" class="mb-3">
                {% csrf_token %}
                <select name="theme" onchange="this.form.submit()" class="form-select bg-dark text-white border-0">
                    <option value="light" {% if user.profile.theme == 'light' %}selected{% endif %}>روشن</option>
                    <option value="dark" {% if user.profile.theme == 'dark' %}selected{% endif %}>تاریک</option>
                    <option value="blue" {% if user.profile.theme == 'blue' %}selected{% endif %}>آبی</option>
                    <option value="green" {% if user.profile.theme == 'green' %}selected{% endif %}>سبز</option>
                </select>
            </form>
            <form method="post" action="{% url 'accounts:logout' %}">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-outline-light w-100 rounded-pill animate__animated animate__fadeInUp">
                    <i class="fas fa-sign-out-alt me-2"></i>{% trans "خروج" %}
                </button>
            </form>
        {% else %}
            <a href="{% url 'accounts:login' %}"
               class="btn btn-outline-light w-100 rounded-pill animate__animated animate__fadeInUp">
                <i class="fas fa-sign-in-alt me-2"></i>{% trans "ورود" %}
            </a>
        {% endif %}
    </div>
</div>
 
    <main class="content" id="mainContent">
        <div class="container-fluid mt-5 pt-3">
            {% block content %}{% endblock %}
        </div>
    </main>
      
<footer class="footer animate__animated animate__fadeInUp">
    <div class="container">
        <p>© 1404 {% trans "سیستم جامع بودجه بندی سازمانی و تنخواه‌گردانی" %}. {% trans "همه حقوق محفوظ است." %}</p>
    </div>
</footer>
<!-- اسکریپت‌ها -->
<script src="{% static 'admin/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'admin/js/jquery-ui.min.js' %}"></script>
<script src="{% static 'admin/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'admin/js/jalalidatepicker.min.js' %}"></script>
<script src="{% static 'admin/js/select2.min.js' %}"></script>
<script src="{% static 'admin/js/numberFormatter.js' %}"></script>
<script src="{% static 'admin/js/persian_number_utils.js' %}" defer></script>
<script src="{% static 'admin/js/number_to_words_connect.js' %}"></script>
<script src="{% static 'admin/js/sweetalert2@11.js' %}"></script>
<script src="{% static 'admin/js/persian_datepicker_init.js' %}"></script>
<script src="{% static 'admin/js/lock_warning_badges.js' %}"></script>
<!-- Dashboard Reports JavaScript -->
<script src="{% static 'reports/js/dashboard.js' %}"></script>

<script>
    $(document).ready(function () {
        // تنظیمات اولیه
        function updateDateTime() {
            const now = new Date().toLocaleDateString('fa-IR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            $('#datetime').text(now);
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        const sidebar = $('#sidebar');
        const toggleBtn = $('#sidebarToggle');
        const content = $('#mainContent');
        toggleBtn.on('click', function () {
            sidebar.toggleClass('active animate__animated animate__slideInRight');
            sidebar.removeClass('animate__slideOutRight');
            content.toggleClass('shifted');
            if (!sidebar.hasClass('active')) {
                sidebar.addClass('animate__animated animate__slideOutRight');
            }
        });

        jalaliDatepicker.startWatch();

        // تنظیم دیتاپیکر جلالی
        if (typeof $.fn.pDatepicker !== 'undefined') {
            $('[data-jdp]').pDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValue: false,
            persianDigit: true
            });
        } else {
            console.log('Persian datepicker not available');
        }

        // فقط برای کاربران احراز هویت‌شده اعلان‌ها را بررسی کن
        {% if user.is_authenticated %}
            // تابع برای بارگذاری لیست اعلان‌ها
            function fetchNotifications() {
                $.ajax({
                    url: "{% url 'notifications:get_notifications' %}",
                    type: "GET",
                    success: function (data) {
                        console.log("Notifications data:", data); // Debug log
                        const notificationList = $('#notification-list');
                        notificationList.empty();
                        if (data.notifications && data.notifications.length > 0) {
                            data.notifications.forEach(notification => {
                                const unreadClass = notification.unread ? 'unread' : '';
                                const item = `
                                            <li class="notification-item ${unreadClass}">
                                                <a class="dropdown-item" href="{% url 'notifications:mark_as_read' 0 %}?next={% url 'notifications:inbox' %}".replace('0', notification.id)>
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-bell me-2 text-primary"></i>
                                                        <div class="flex-grow-1">
                                                            <p class="mb-1">
                                                                ${notification.actor} ${notification.verb}
                                                                ${notification.target ? `(${notification.target})` : ''}
                                                            </p>
                                                            ${notification.description ? `<small class="text-muted">${notification.description}</small><br>` : ''}
                                                            <small class="text-muted">${notification.timestamp}</small>
                                                        </div>
                                                    </div>
                                                </a>
                                            </li>`;
                                notificationList.append(item);
                            });
                        } else {
                            notificationList.append('<li class="dropdown-item text-muted">{% trans "اعلانی وجود ندارد" %}</li>');
                        }

                        // به‌روزرسانی تعداد اعلان‌ها
                        updateNotificationBadge(data.unread_count || 0);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching notifications:", error);
                        console.error("Response:", xhr.responseText);
                    }
                });
            }

            // تابع به‌روزرسانی badge اعلان‌ها
            function updateNotificationBadge(count) {
                const $badge = $('#notificationBadge');
                const $bell = $('#notificationBell');
                const previousCount = parseInt($badge.text()) || 0;
                
                if (count > 0) {
                    $badge.text(count).show();
                    
                    // انیمیشن لرزش برای زنگوله
                    if (count > previousCount) {
                        $bell.addClass('shake');
                        $badge.addClass('animate');
                        
                        // حذف کلاس‌های انیمیشن پس از اتمام
                        setTimeout(() => {
                            $bell.removeClass('shake');
                            $badge.removeClass('animate');
                        }, 500);
                    }
                    
                    // انیمیشن pulse برای زنگوله
                    $bell.addClass('pulse');
                } else {
                    $badge.hide();
                    $bell.removeClass('pulse');
                }
            }

            // بارگذاری اولیه اعلان‌ها
            fetchNotifications();

            // بررسی اعلان‌های جدید هر 30 ثانیه
            setInterval(fetchNotifications, 30000);

            // مدیریت حذف اعلان‌ها
            $(document).on('click', '.delete-notification', function () {
                const notificationId = $(this).data('id');
                const listItem = $(this).closest('.notification-item');
                if (confirm('{% trans "آیا از حذف این اعلان اطمینان دارید؟" %}')) {
                    $.ajax({
                        url: "{% url 'notifications:delete' 0 %}".replace('0', notificationId),
                        type: "POST",
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                listItem.remove();
                                fetchNotifications(); // به‌روزرسانی لیست اعلان‌ها
                            } else {
                                alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                            }
                        },
                        error: function (xhr) {
                            console.error("Error deleting notification:", xhr.responseJSON?.message || "Unknown error");
                            alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                        }
                    });
                }
            });
        {% endif %}
    });
</script>
<script>
    $(document).ready(function () {
        if (typeof $.fn.pDatepicker !== 'undefined') {
            $('[data-jdp]').pDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValue: false,
            persianDigit: true
            });
        } else {
            console.log('Persian datepicker not available');
        }
    });
</script>
<script>
    $(document).ready(function () {
        // تنظیمات اولیه
        function updateDateTime() {
            const now = new Date().toLocaleDateString('fa-IR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            $('#datetime').text(now);
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        const sidebar = $('#sidebar');
        const toggleBtn = $('#sidebarToggle');
        const content = $('#mainContent');
        toggleBtn.on('click', function () {
            sidebar.toggleClass('active animate__animated animate__slideInRight');
            sidebar.removeClass('animate__slideOutRight');
            content.toggleClass('shifted');
            if (!sidebar.hasClass('active')) {
                sidebar.addClass('animate__animated animate__slideOutRight');
            }
        });

        jalaliDatepicker.startWatch();

        // تنظیم دیتاپیکر جلالی
        if (typeof $.fn.pDatepicker !== 'undefined') {
            $('[data-jdp]').pDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValue: false,
            persianDigit: true
            });
        } else {
            console.log('Persian datepicker not available');
        }

        // فقط برای کاربران احراز هویت‌شده اعلان‌ها را بررسی کن
        {% if user.is_authenticated %}
            // تابع برای بارگذاری لیست اعلان‌ها
            // تابع برای بارگذاری لیست اعلان‌ها
            function fetchNotifications() {
                $.ajax({
                    url: "{% url 'notifications:get_notifications' %}",
                    type: "GET",
                    success: function (data) {
                        const notificationList = $('#get_notifications');
                        notificationList.empty();
                        if (data.notifications.length > 0) {
                            data.notifications.forEach(notification => {
                                const unreadClass = notification.unread ? 'unread' : '';
                                const item = `
                                            <li class="notification-item ${unreadClass}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    {#<a class="dropdown-item" href="{% url 'notifications:unread' 0 %}?next={% url 'notifications_inbox' %}".replace('0', notification.id)>#}
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-bell me-2 text-primary"></i>
                                                            <div>
                                                                <p class="mb-0">
                                                                    ${notification.actor} ${notification.verb}
                                                                    ${notification.target ? `(${notification.target})` : ''}
                                                                </p>
                                                                ${notification.description ? `<small class="text-muted">${notification.description}</small><br>` : ''}
                                                                <small class="text-muted">${notification.timestamp}</small>
                                                            </div>
                                                        </div>
                                                    {#</a>#}
                                                    <button class="btn btn-sm btn-outline-danger delete-notification"
                                                            data-id="${notification.id}">{% trans "حذف" %}</button>
                                                </div>
                                            </li>`;
                                notificationList.append(item);
                            });
                        } else {
                            notificationList.append('<li class="dropdown-item text-muted">{% trans "اعلانی وجود ندارد" %}</li>');
                        }

                        // به‌روزرسانی تعداد اعلان‌ها
                        updateNotificationBadge(data.unread_count);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching notifications:", error);
                    }
                });
            }

            // تابع به‌روزرسانی badge اعلان‌ها
            function updateNotificationBadge(count) {
                const $badge = $('#notificationBadge');
                const $bell = $('#notificationBell');
                const previousCount = parseInt($badge.text()) || 0;
                
                if (count > 0) {
                    $badge.text(count).show();
                    
                    // انیمیشن لرزش برای زنگوله
                    if (count > previousCount) {
                        $bell.addClass('shake');
                        $badge.addClass('animate');
                        
                        // حذف کلاس‌های انیمیشن پس از اتمام
                        setTimeout(() => {
                            $bell.removeClass('shake');
                            $badge.removeClass('animate');
                        }, 500);
                    }
                    
                    // انیمیشن pulse برای زنگوله
                    $bell.addClass('pulse');
                } else {
                    $badge.hide();
                    $bell.removeClass('pulse');
                }
            }

            // بارگذاری اولیه اعلان‌ها
            fetchNotifications();

            // بررسی اعلان‌های جدید هر 30 ثانیه
            setInterval(fetchNotifications, 30000);

            // مدیریت حذف اعلان‌ها
            $(document).on('click', '.delete-notification', function () {
                const notificationId = $(this).data('id');
                const listItem = $(this).closest('.notification-item');
                if (confirm('{% trans "آیا از حذف این اعلان اطمینان دارید؟" %}')) {
                    $.ajax({
                        url: "{% url 'notifications:delete' 0 %}".replace('0', notificationId),
                        type: "POST",
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                listItem.remove();
                                fetchNotifications(); // به‌روزرسانی لیست اعلان‌ها
                            } else {
                                alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                            }
                        },
                        error: function (xhr) {
                            console.error("Error deleting notification:", xhr.responseJSON?.message || "Unknown error");
                            alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                        }
                    });
                }
            });
        {% endif %}

        const unreadClass = notification.unread ? 'unread' : '';
        const item = `
                                        <li class="notification-item ${unreadClass}">
                                            <div class="d-flex justify-content-between align-items-center p-2">
                                                <a class="dropdown-item" href="${finalUrl}">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-bell me-2 text-primary"></i>
                                                        <div>
                                                            <p class="mb-0 small">
                                                                ${notification.actor} ${notification.verb}
                                                                ${notification.target ? `<strong>(${notification.target})</strong>` : ''}
                                                            </p>
                                                            ${notification.description ? `<small class="text-muted d-block">${notification.description}</small>` : ''}
                                                            <small class="text-muted">${notification.timestamp}</small>
                                                        </div>
                                                    </div>
                                                </a>
                                                <button class="btn btn-sm btn-icon text-danger delete-notification ms-2"
                                                        data-id="${notification.id}" data-bs-toggle="tooltip" title="{% trans 'حذف اعلان' %}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </li>`;
        notificationList.append(item);
    });
    } else
    {
        notificationList.append('<li class="dropdown-item text-muted text-center p-3">{% trans "اعلانی برای نمایش وجود ندارد." %}</li>');
    }

    // Re-initialize tooltips for new delete buttons
    $('[data-bs-toggle="tooltip"]').tooltip();

    // به‌روزرسانی تعداد اعلان‌ها
    updateNotificationBadge(data.unread_count);
    },
    error: function (xhr, status, error) {
        console.error("Error fetching notifications:", error);
    }
    })
    ;
    }
    })
    ;

</script>
<script>
    $(document).ready(function () {
        if (typeof $.fn.pDatepicker !== 'undefined') {
            $('[data-jdp]').pDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValue: false,
            persianDigit: true
            });
        } else {
            console.log('Persian datepicker not available');
        }
    });
</script>
{% block extra_js %}{% endblock %}

<script>
// Simple Sidebar Theme Management
document.addEventListener('DOMContentLoaded', function() {
    // Theme toggle
    document.getElementById('sidebarThemeToggle').addEventListener('click', function() {
        var themeSelector = document.getElementById('sidebarThemeSelector');
        if (themeSelector.style.display === 'none') {
            themeSelector.style.display = 'block';
        } else {
            themeSelector.style.display = 'none';
        }
    });
    
    // Auto-submit form when theme is selected
    document.querySelectorAll('input[name="theme"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            // Auto-submit form after a short delay
            setTimeout(function() {
                radio.closest('form').submit();
            }, 300);
        });
    });
    
    // Load theme from user profile
    var currentTheme = '{{ user_theme|default:"default" }}';
    var customThemeData = {{ custom_theme_data|default:"null"|safe }};
    
    if (currentTheme === 'custom' && customThemeData) {
        // Apply custom theme
        document.documentElement.style.setProperty('--primary-color', customThemeData.primary_color);
        document.documentElement.style.setProperty('--secondary-color', customThemeData.secondary_color);
        document.documentElement.style.setProperty('--background-color', customThemeData.background_color);
        document.documentElement.style.setProperty('--surface-color', customThemeData.surface_color);
        document.documentElement.style.setProperty('--text-color', customThemeData.text_color);
        document.documentElement.style.setProperty('--border-radius-md', customThemeData.border_radius + 'px');
        document.documentElement.style.setProperty('--font-size-base', customThemeData.font_size + 'px');
        document.documentElement.setAttribute('data-theme', 'custom');
    } else if (currentTheme && currentTheme !== 'default') {
        document.documentElement.setAttribute('data-theme', currentTheme);
    } else {
        document.documentElement.setAttribute('data-theme', 'default');
    }
});
</script>

</body>
</html>