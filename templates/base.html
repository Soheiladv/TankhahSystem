<<<<<<< HEAD
 {% load static i18n humanize jformat rcms_custom_filters jalali_tags   %}
=======
{% load static i18n humanize jformat rcms_custom_filters %}
{% load jalali_tags %}
>>>>>>> 171b55a74efe3adb976919af53d3bd582bb2266e

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< HEAD
    <title>{% block title %}{% trans "سیستم جامع نظارتی بودجه بندی سازمانی و تنخواه‌گردانی" %}{% endblock %}</title>
=======
    <title>{% block title %}{% trans "نرم‌افزار RCMS" %}{% endblock %}</title>
>>>>>>> 171b55a74efe3adb976919af53d3bd582bb2266e
    <link rel="icon" href="{% static 'admin/img/favicon.ico' %}" type="image/x-icon">
    <!-- CSS های اصلی -->
    <link href="{% static 'admin/css/bootstrap.rtl.min.css' %}" rel="stylesheet">
    <link href="{% static 'admin/css/all.min.css' %}" rel="stylesheet">
    <link href="{% static 'admin/css/animate.min.css' %}" rel="stylesheet">
<<<<<<< HEAD
    <!-- CSS فارسی دیتاپیکر -->
    <link href="{% static 'admin/css/jalalidatepicker.min.css' %}" rel="stylesheet">
    <link href="{% static 'admin/css/custom.css' %}" rel="stylesheet">

    {# Select2 CSS #}
    <link href="{% static 'admin/css/select2.min.css' %}" rel="stylesheet"/>
    {# Select2 Bootstrap 5 Theme #}
    <link rel="stylesheet" href="{% static 'admin/css/select2-bootstrap-5-theme.min.css' %}"/>

    <!-- استایل‌های سفارشی -->
=======
    <link href="{% static 'admin/css/custom.css' %}" rel="stylesheet">

    <!-- CSS فارسی دیتاپیکر -->
    <link href="{% static 'admin/css/jalalidatepicker.min.css' %}" rel="stylesheet">
>>>>>>> 171b55a74efe3adb976919af53d3bd582bb2266e
    <style>
        @font-face {
            font-family: 'Parastoo';
            src: url('{% static "admin/fonts/Parastoo.ttf" %}') format('truetype');
<<<<<<< HEAD
            font-weight: normal;
            font-style: normal;
=======
        }

        .persian-datepicker {
            direction: rtl;
        }

        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --navbar-bg: #343a40;
            --sidebar-bg: #343a40;
            --footer-bg: #2c3e50;
            --footer-text-color: #ecf0f1;
            --sidebar-hover-bg: #51a9ff;
            --sidebar-active-bg: #5a6268;
>>>>>>> 171b55a74efe3adb976919af53d3bd582bb2266e
        }

        body {
            font-family: 'Parastoo', 'Yekan', 'IRANSans', sans-serif;
<<<<<<< HEAD
        }

        /* استایل برای اعلان‌ها */
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
            min-width: 300px;
        }

        .notification-item .dropdown-item {
            transition: background-color 0.3s ease;
        }

        .notification-item .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread .dropdown-item {
            background-color: #e9f7ff;
            font-weight: bold;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.75rem;
            padding: 2px 6px;
        }

        .dropdown-divider {
            margin: 0.25rem 0;
        }

        .dropdown-header {
            font-weight: bold;
            color: #343a40;
        }
    </style>
</head>
<body class="theme-{{ user.profile.theme|default:'light' }}">
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show animate__animated animate__fadeIn"
=======
            direction: rtl;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* نوار ناوبری */
        .navbar {
            background-color: var(--navbar-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand img {
            width: 40px;
            margin-left: 10px;
        }

        .navbar-nav {
            justify-content: center;
            width: 100%;
        }

        .navbar-date {
            color: #fff;
            display: flex;
            align-items: center;
        }

        /* منوی کناری */
        .sidebar {
            position: fixed;
            top: 56px;
            right: -250px;
            width: 250px;
            height: calc(100vh - 56px);
            background-color: var(--sidebar-bg);
            color: #fff;
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1000;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar a {
            color: #fff;
            padding: 12px 15px;
            display: block;
            transition: background-color 0.3s ease;
        }

        .sidebar a:hover {
            background-color: var(--sidebar-hover-bg);
        }

        /* محتوای اصلی */
        .content {
            flex: 1;
            padding: 20px;
            transition: margin-right 0.3s ease;
        }

        .content.shifted {
            margin-right: 250px;
        }

        /* فوتر */
        .footer {
            background-color: var(--footer-bg);
            color: var(--footer-text-color);
            padding: 20px 0;
            text-align: center;
        }

        /* انیمیشن‌ها */
        .animate__fadeInUp {
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* واکنش‌گرایی */
        @media (max-width: 768px) {
            .sidebar {
                right: -250px;
            }

            .content.shifted {
                margin-right: 0;
            }

            .navbar-nav {
                flex-direction: column;
                text-align: right;
            }
        }
    </style>
    <!-- DataPicker CSS -->
    <link rel="stylesheet" href="{% static 'admin/css/custom_datepicker.css' %}">
</head>
<body>
<!-- لودر -->
<div class="loader" id="loader"></div>

<!-- نوار ناوبری -->
<nav class="navbar navbar-expand-md navbar-dark">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link text-light" href="{% url 'dashboard_flows' %}">
                        <img src="{% static 'admin/img/RCMS2.svg' %}" alt="RCMS"> {% trans "خانه" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" href="sms:+989xxxxxx ?body=help ME!">
                        <i class="fas fa-headset me-2"></i> {% trans "پشتیبانی" %}
                    </a>
                </li>
                <li class="nav-item navbar-date animate__animated animate__fadeInUp">
                    <i class="fas fa-calendar-day me-2"></i>
                    <span class="text-danger">{% trans "امروز:" %}</span>
                    <span id="datetime" class="text-warning fw-bold ms-2"></span>
                </li>
                <li class="nav-item">
                    <select id="themeSelector" class="form-select">
                        <option value="light">{% trans "روشن" %}</option>
                        <option value="dark">{% trans "تاریک" %}</option>
                        <option value="blue">{% trans "آبی" %}</option>
                        <option value="green">{% trans "سبز" %}</option>
                    </select>
                </li>

                <li class="nav-item navbar-date animate__animated animate__fadeInUp">
                     <strong><i class="fas fa-user"></i> کاربر فعال: {{ user.username }}</strong>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- دکمه باز کردن منو -->
<button class="navbar-toggle" id="sidebarToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- منوی کناری -->
<div class="sidebar" id="sidebar">
    <ul class="nav flex-column">
        <li class="nav-item">
            <a href="{% url 'dashboard' %}" class="nav-link">
                {#            <a href="{% url 'all_links' %}" class="nav-link">#}
                <i class="fas fa-home me-2"></i> {% trans "خانه" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'dashboard' %}" class="nav-link">
                <i class="fas fa-tachometer-alt me-2"></i> {% trans "داشبورد" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'all_links' %}" class="nav-link">
                <i class="fas fa-link me-2"></i> {% trans "همه لینک‌ها" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'organization_list' %}" class="nav-link">
                <i class="fas fa-building me-2"></i> {% trans "سازمان‌ها" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'project_list' %}" class="nav-link">
                <i class="fas fa-project-diagram me-2"></i> {% trans "پروژه‌ها" %}
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'tanbakh_list' %}" class="nav-link">
                <i class="fas fa-file-invoice me-2"></i> {% trans "تنخواه‌ها" %}
            </a>
        </li>
        <li class="nav-item">

            <form method="post" action="{% url 'accounts:logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-warning w-100 mb-2">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </form>
        </li>
    </ul>
</div>

<!-- محتوای اصلی -->
<main class="content" id="mainContent">
    <div class="container-fluid mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show animate__animated animate__fadeIn"
>>>>>>> 171b55a74efe3adb976919af53d3bd582bb2266e
                     role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
<<<<<<< HEAD
        <nav class="navbar navbar-expand-md navbar-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand animate__animated animate__fadeInLeft" href="{% url 'index' %}">
                    <img src="{% static 'admin/img/RCMS2.svg' %}" alt="RCMS">
                    <span class="ms-2 d-none d-md-inline">{% trans "داشبورد سیستم جامع نظارتی بر بودجه سازمانی و تنخواه گردان" %}</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item">
                            <a class="nav-link animate__animated animate__fadeInDown" href="{% url 'index' %}">{% trans "خانه" %}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link animate__animated animate__fadeInDown" href="sms:+989xxxxxx?body=help ME!">
                                <i class="fas fa-headset me-2"></i>{% trans "پشتیبانی" %}
                            </a>
                        </li>
                        <li class="nav-item animate__animated animate__fadeInDown">
                            <span class="nav-link">
                                <i class="fas fa-calendar-day me-2"></i>
                                <span class="text-danger">{% trans "امروز:" %}</span>
                                <span id="datetime" class="text-warning fw-bold ms-2"></span>
                            </span>
                        </li>
                        {% if user.is_authenticated %}
                            <li class="nav-item ms-3 animate__animated animate__fadeInDown">
                                <span class="nav-link">
                                    <i class="fas fa-user me-2"></i>{{ user.first_name }} {{ user.last_name }}
                                </span>
                            </li>
                            <!-- بخش نوار بالایی (navbar) -->
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown"
                                   role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-bell"></i>
                                    <span class="notification-badge badge bg-danger" style="display: none;"></span>
                                </a>
{#                                <ul class="dropdown-menu dropdown-menu-end notification-list"#}
{#                                    aria-labelledby="notificationDropdown">#}
{#                                    <li class="dropdown-header">{% trans "اعلان‌ها" %}</li>#}
{#                                    <div id="notification-list"></div>#}
{#                                    <li><hr class="dropdown-divider"></li>#}
{#                                    <li>#}
{#                                        <a class="dropdown-item text-center"#}
{#                                           href="{% url 'notifications:mark_all_as_read' %}?next={% url 'notifications_inbox' %}">#}
{#                                            {% trans "خواندن همه اعلان‌ها" %}#}
{#                                        </a>#}
{#                                    </li>#}
{#                                    <li>#}
{#                                        <a class="dropdown-item text-center" href="{% url 'notifications:unread' %}">#}
{#                                            {% trans "مشاهده اعلان‌های خوانده‌نشده" %}#}
{#                                        </a>#}
{#                                    </li>#}
{#                                    <li>#}
{#                                        <a class="dropdown-item text-center" href="{% url 'notifications_inbox' %}">#}
{#                                            {% trans "مشاهده همه اعلان‌ها" %}#}
{#                                        </a>#}
{#                                    </li>#}
{#                                </ul>#}
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
        <button class="navbar-toggle animate__animated animate__fadeInRight" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header animate__animated animate__fadeInDown">
                <img src="{% static 'admin/img/rcms.jpg' %}" alt="لوگو" class="img-fluid rounded-circle mb-2"
                     style="max-width: 80px;">
                <h5 class="text-white">{% trans "سیستم جامع بودجه بندی سازمانی و تنخواه‌گردانی" %}</h5>
            </div>
            <ul class="nav flex-column p-3">
                <li class="nav-item">
                    <a href="{% url 'index' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-home"></i>{% trans "خانه" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'index' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-tachometer-alt"></i>{% trans "داشبورد" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'all_links' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-link"></i>{% trans "همه لینک‌ها" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'organization_list' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-building"></i>{% trans "سازمان‌ها" %}
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="{% url 'project_list' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-project-diagram"></i>{% trans "بودجه بندی " %}
                    </a>
                </li>

                <li class="nav-item">
                    <a href="{% url 'project_list' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-project-diagram"></i>{% trans "مرکز هزینه (پروژه)" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'dashboard_flows' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-file-invoice"></i>{% trans "تنخواه‌ها" %}
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="{% url 'dashboard_flows' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-file-invoice"></i>{% trans "فاکتور" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'guide' %}" class="nav-link animate__animated animate__fadeInRight">
                        <i class="fas fa-book-open"></i>{% trans "راهنما" %}
                    </a>
                </li>
            </ul>

            <div class="p-3 mt-auto">
                {% if user.is_authenticated %}
                    <p class="text-white text-center mb-2 animate__animated animate__fadeInUp">
                        <i class="fas fa-user me-2"></i>{{ user.first_name }} {{ user.last_name }}
                    </p>
                    <form method="post" action="{% url 'accounts:set_theme' %}" class="mb-3">
                        {% csrf_token %}
                        <select name="theme" onchange="this.form.submit()" class="form-select bg-dark text-white border-0">
                            <option value="light" {% if user.profile.theme == 'light' %}selected{% endif %}>روشن</option>
                            <option value="dark" {% if user.profile.theme == 'dark' %}selected{% endif %}>تاریک</option>
                            <option value="blue" {% if user.profile.theme == 'blue' %}selected{% endif %}>آبی</option>
                            <option value="green" {% if user.profile.theme == 'green' %}selected{% endif %}>سبز</option>
                        </select>
                    </form>
                    <form method="post" action="{% url 'accounts:logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-light w-100 rounded-pill animate__animated animate__fadeInUp">
                            <i class="fas fa-sign-out-alt me-2"></i>{% trans "خروج" %}
                        </button>
                    </form>
                {% else %}
                    <a href="{% url 'accounts:login' %}" class="btn btn-outline-light w-100 rounded-pill animate__animated animate__fadeInUp">
                        <i class="fas fa-sign-in-alt me-2"></i>{% trans "ورود" %}
                    </a>
                {% endif %}
            </div>
        </div>
        <main class="content" id="mainContent">
            <div class="container-fluid mt-5 pt-3">
                {% block content %}{% endblock %}
            </div>
        </main>

        <footer class="footer animate__animated animate__fadeInUp">
            <div class="container">
                <p>© 1404 {% trans "سیستم جامع بودجه بندی سازمانی و تنخواه‌گردانی" %}. {% trans "همه حقوق محفوظ است." %}</p>
            </div>
        </footer>
        <!-- اسکریپت‌ها -->
        <script src="{% static 'admin/js/jquery-3.6.0.min.js' %}"></script>
        <script src="{% static 'admin/js/jquery-ui.min.js' %}"></script>
        <script src="{% static 'admin/js/bootstrap.bundle.min.js' %}"></script>
        <script src="{% static 'admin/js/jalalidatepicker.min.js' %}"></script>
        <script src="{% static 'admin/js/select2.min.js' %}"></script>
        <script src="{% static 'admin/js/numberFormatter.js' %}"></script>
        <script src="{% static 'admin/js/persian_number_utils.js' %}" defer></script>
        <script src="{% static 'admin/js/number_to_words_connect.js' %}"></script>

        <script>
            $(document).ready(function () {
                // تنظیمات اولیه
                function updateDateTime() {
                    const now = new Date().toLocaleDateString('fa-IR', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                    $('#datetime').text(now);
                }

                updateDateTime();
                setInterval(updateDateTime, 1000);

                const sidebar = $('#sidebar');
                const toggleBtn = $('#sidebarToggle');
                const content = $('#mainContent');
                toggleBtn.on('click', function () {
                    sidebar.toggleClass('active animate__animated animate__slideInRight');
                    sidebar.removeClass('animate__slideOutRight');
                    content.toggleClass('shifted');
                    if (!sidebar.hasClass('active')) {
                        sidebar.addClass('animate__animated animate__slideOutRight');
                    }
                });

                jalaliDatepicker.startWatch();

                // تنظیم دیتاپیکر جلالی
                $('[data-jdp]').pDatepicker({
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    initialValue: false,
                    persianDigit: true
                });

                // فقط برای کاربران احراز هویت‌شده اعلان‌ها را بررسی کن
                {% if user.is_authenticated %}
                    // تابع برای بارگذاری لیست اعلان‌ها
                    function fetchNotifications() {
                        $.ajax({
                            url: "{% url 'notifications:get_notifications' %}",
                            type: "GET",
                            success: function (data) {
                                const notificationList = $('#notification-list');
                                notificationList.empty();
                                if (data.notifications.length > 0) {
                                    data.notifications.forEach(notification => {
                                        const unreadClass = notification.unread ? 'unread' : '';
                                        const item = `
                                            <li class="notification-item ${unreadClass}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    {#<a class="dropdown-item" href="{% url 'notifications:mark_as_read' 0 %}?next={% url 'notifications_inbox' %}".replace('0', notification.id)>#}
                                                    {#    <div class="d-flex align-items-center">#}
                                                    {#        <i class="fas fa-bell me-2 text-primary"></i>#}
                                                    {#        <div>#}
                                                    {#            <p class="mb-0">#}
                                                    {#                ${notification.actor} ${notification.verb}#}
                                                    {#                ${notification.target ? `(${notification.target})` : ''}#}
                                                    {#            </p>#}
                                                    {#            ${notification.description ? `<small class="text-muted">${notification.description}</small><br>` : ''}#}
                                                    {#            <small class="text-muted">${notification.timestamp}</small>#}
                                                    {#        </div>#}
                                                    {#    </div>#}
                                                    {#</a>#}
                                                    <button class="btn btn-sm btn-outline-danger delete-notification"
                                                            data-id="${notification.id}">{% trans "حذف" %}</button>
                                                </div>
                                            </li>`;
                                        notificationList.append(item);
                                    });
                                } else {
                                    notificationList.append('<li class="dropdown-item text-muted">{% trans "اعلانی وجود ندارد" %}</li>');
                                }

                                // به‌روزرسانی تعداد اعلان‌ها
                                updateNotificationBadge(data.unread_count);
                            },
                            error: function (xhr, status, error) {
                                console.error("Error fetching notifications:", error);
                            }
                        });
                    }

                    // تابع به‌روزرسانی badge اعلان‌ها
                    function updateNotificationBadge(count) {
                        const $badge = $('.notification-badge');
                        if (count > 0) {
                            $badge.text(count).show();
                        } else {
                            $badge.hide();
                        }
                    }

                    // بارگذاری اولیه اعلان‌ها
                    fetchNotifications();

                    // بررسی اعلان‌های جدید هر 30 ثانیه
                    setInterval(fetchNotifications, 30000);

                    // مدیریت حذف اعلان‌ها
                    $(document).on('click', '.delete-notification', function () {
                        const notificationId = $(this).data('id');
                        const listItem = $(this).closest('.notification-item');
                        if (confirm('{% trans "آیا از حذف این اعلان اطمینان دارید؟" %}')) {
                            $.ajax({
                                url: "{% url 'notifications:delete' 0 %}".replace('0', notificationId),
                                type: "POST",
                                data: {
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function (response) {
                                    if (response.status === 'success') {
                                        listItem.remove();
                                        fetchNotifications(); // به‌روزرسانی لیست اعلان‌ها
                                    } else {
                                        alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                                    }
                                },
                                error: function (xhr) {
                                    console.error("Error deleting notification:", xhr.responseJSON?.message || "Unknown error");
                                    alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                                }
                            });
                        }
                    });
                {% endif %}
            });
        </script>
        <script>
            $(document).ready(function() {
                $('[data-jdp]').pDatepicker({
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    initialValue: false,
                    persianDigit: true
                });
            });
        </script>
        <script>
            $(document).ready(function () {
                // تنظیمات اولیه
                function updateDateTime() {
                    const now = new Date().toLocaleDateString('fa-IR', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                    $('#datetime').text(now);
                }

                updateDateTime();
                setInterval(updateDateTime, 1000);

                const sidebar = $('#sidebar');
                const toggleBtn = $('#sidebarToggle');
                const content = $('#mainContent');
                toggleBtn.on('click', function () {
                    sidebar.toggleClass('active animate__animated animate__slideInRight');
                    sidebar.removeClass('animate__slideOutRight');
                    content.toggleClass('shifted');
                    if (!sidebar.hasClass('active')) {
                        sidebar.addClass('animate__animated animate__slideOutRight');
                    }
                });

                jalaliDatepicker.startWatch();

                // تنظیم دیتاپیکر جلالی
                $('[data-jdp]').pDatepicker({
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    initialValue: false,
                    persianDigit: true
                });

                // فقط برای کاربران احراز هویت‌شده اعلان‌ها را بررسی کن
                {% if user.is_authenticated %}
                    // تابع برای بارگذاری لیست اعلان‌ها
                                        // تابع برای بارگذاری لیست اعلان‌ها
                    function fetchNotifications() {
                        $.ajax({
                            url: "{% url 'notifications:get_notifications' %}",
                            type: "GET",
                            success: function (data) {
                                const notificationList = $('#get_notifications');
                                notificationList.empty();
                                if (data.notifications.length > 0) {
                                    data.notifications.forEach(notification => {
                                        const unreadClass = notification.unread ? 'unread' : '';
                                        const item = `
                                            <li class="notification-item ${unreadClass}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    {#<a class="dropdown-item" href="{% url 'notifications:unread' 0 %}?next={% url 'notifications_inbox' %}".replace('0', notification.id)>#}
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-bell me-2 text-primary"></i>
                                                            <div>
                                                                <p class="mb-0">
                                                                    ${notification.actor} ${notification.verb}
                                                                    ${notification.target ? `(${notification.target})` : ''}
                                                                </p>
                                                                ${notification.description ? `<small class="text-muted">${notification.description}</small><br>` : ''}
                                                                <small class="text-muted">${notification.timestamp}</small>
                                                            </div>
                                                        </div>
                                                    {#</a>#}
                                                    <button class="btn btn-sm btn-outline-danger delete-notification"
                                                            data-id="${notification.id}">{% trans "حذف" %}</button>
                                                </div>
                                            </li>`;
                                        notificationList.append(item);
                                    });
                                } else {
                                    notificationList.append('<li class="dropdown-item text-muted">{% trans "اعلانی وجود ندارد" %}</li>');
                                }

                                // به‌روزرسانی تعداد اعلان‌ها
                                updateNotificationBadge(data.unread_count);
                            },
                            error: function (xhr, status, error) {
                                console.error("Error fetching notifications:", error);
                            }
                        });
                    }

                    // تابع به‌روزرسانی badge اعلان‌ها
                    function updateNotificationBadge(count) {
                        const $badge = $('.notification-badge');
                        if (count > 0) {
                            $badge.text(count).show();
                        } else {
                            $badge.hide();
                        }
                    }

                    // بارگذاری اولیه اعلان‌ها
                    fetchNotifications();

                    // بررسی اعلان‌های جدید هر 30 ثانیه
                    setInterval(fetchNotifications, 30000);

                    // مدیریت حذف اعلان‌ها
                    $(document).on('click', '.delete-notification', function () {
                        const notificationId = $(this).data('id');
                        const listItem = $(this).closest('.notification-item');
                        if (confirm('{% trans "آیا از حذف این اعلان اطمینان دارید؟" %}')) {
                            $.ajax({
                                url: "{% url 'notifications:delete' 0 %}".replace('0', notificationId),
                                type: "POST",
                                data: {
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function (response) {
                                    if (response.status === 'success') {
                                        listItem.remove();
                                        fetchNotifications(); // به‌روزرسانی لیست اعلان‌ها
                                    } else {
                                        alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                                    }
                                },
                                error: function (xhr) {
                                    console.error("Error deleting notification:", xhr.responseJSON?.message || "Unknown error");
                                    alert('{% trans "خطایی در حذف اعلان رخ داد" %}');
                                }
                            });
                        }
                    });
                {% endif %}
            
            const unreadClass = notification.unread ? 'unread' : '';
                                    const item = `
                                        <li class="notification-item ${unreadClass}">
                                            <div class="d-flex justify-content-between align-items-center p-2">
                                                <a class="dropdown-item" href="${finalUrl}">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-bell me-2 text-primary"></i>
                                                        <div>
                                                            <p class="mb-0 small">
                                                                ${notification.actor} ${notification.verb}
                                                                ${notification.target ? `<strong>(${notification.target})</strong>` : ''}
                                                            </p>
                                                            ${notification.description ? `<small class="text-muted d-block">${notification.description}</small>` : ''}
                                                            <small class="text-muted">${notification.timestamp}</small>
                                                        </div>
                                                    </div>
                                                </a>
                                                <button class="btn btn-sm btn-icon text-danger delete-notification ms-2"
                                                        data-id="${notification.id}" data-bs-toggle="tooltip" title="{% trans 'حذف اعلان' %}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </li>`;
                                    notificationList.append(item);
                                });
                            } else {
                                notificationList.append('<li class="dropdown-item text-muted text-center p-3">{% trans "اعلانی برای نمایش وجود ندارد." %}</li>');
                            }
                            
                            // Re-initialize tooltips for new delete buttons
                            $('[data-bs-toggle="tooltip"]').tooltip();

                            // به‌روزرسانی تعداد اعلان‌ها
                            updateNotificationBadge(data.unread_count);
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching notifications:", error);
                        }
                    });
                } 
            });
            
    </script>
        <script>
            $(document).ready(function() {
                $('[data-jdp]').pDatepicker({
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    initialValue: false,
                    persianDigit: true
                });
            });
        </script>
{% block extra_js %}{% endblock %}

</body>
</html>
=======
        {% block content %}{% endblock %}
    </div>
</main>

<!-- فوتر -->
<footer class="footer animate__animated animate__fadeInUp">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-4 mb-3">
                <h5><i class="fas fa-map-marker-alt me-2"></i> {% trans "دفتر ما" %}</h5>
                <p>{% trans "آدرس دفتر" %}</p>
            </div>
            <div class="col-md-4 mb-3">
                <h5><i class="fas fa-envelope me-2"></i> {% trans "ایمیل" %}</h5>
                <p><a href="mailto:info@rcms.com">info@rcms.com</a></p>
            </div>
            <div class="col-md-4 mb-3">
                <h5><i class="fas fa-phone me-2"></i> {% trans "تلفن" %}</h5>
                <p><a href="tel:123-456-7890">123-456-7890</a></p>
            </div>
        </div>
        <p>© 2024 RCMS. {% trans "همه حقوق محفوظ است." %}</p>
    </div>
</footer>

{###########################################}
<!-- فایل‌های JS مورد نیاز برای Persian Datepicker -->
<!-- فایل‌های JS -->
<script src="{% static 'admin/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'admin/js/jquery-ui.min.js' %}"></script>
<script src="{% static 'admin/js/datepicker-fa.js' %}"></script>
<script src="{% static 'admin/js/django_jalali.min.js' %}"></script>
<script src="{% static 'admin/js/jalalidatepicker.min.js' %}"></script>
<script src="{% static 'admin/js/bootstrap.bundle.min.js' %}"></script>
<!-- تبدیل اعداد هنگام تابپ به هزارگان  -->
<script src="{% static 'admin/js/numberFormatter.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        jalaliDatepicker.startWatch();
    });
    jalaliDatepicker.startWatch();
</script>

<script>
    $(document).ready(function () {
        // تاریخ شمسی در نوار ناوبری
        function updateDateTime() {
            const now = new Date().toLocaleDateString('fa-IR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            $('#datetime').text(now);
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // سایر اسکریپت‌ها (منو، تم، لودر)
        const sidebar = $('#sidebar');
        const toggleBtn = $('#sidebarToggle');
        const content = $('.content');
        const themeSelector = $('#themeSelector');
        const loader = $('#loader');

        toggleBtn.on('click', function () {
            sidebar.toggleClass('active');
            content.toggleClass('shifted');
        });

        themeSelector.on('change', function () {
            document.body.className = 'theme-' + this.value;
        });

        loader.show();
        setTimeout(() => loader.hide(), 2000);

        sidebar.on('mouseover', () => sidebar.addClass('animate__pulse'));
        sidebar.on('mouseout', () => sidebar.removeClass('animate__pulse'));
    });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>


<!--
{#<script src="{% static 'admin/js/persian-date.min.js' %}"></script>#}
{#<script src="{% static 'admin/js/persian-datepicker.min.js' %}"></script>#}

{#<link rel="stylesheet" href="{% static 'admin/jquery.ui.datepicker.jalali/themes/base/jquery-ui.min.css' %}">#}
{#<script src="{% static 'admin/jquery.ui.datepicker.jalali/scripts/jquery-1.10.2.min.js' %}"></script>#}
{#<script src="{% static 'admin/jquery.ui.datepicker.jalali/scripts/jquery.ui.core.js' %}"></script>#}
{#<script src="{% static 'admin/jquery.ui.datepicker.jalali/scripts/jquery.ui.datepicker-cc.js' %}"></script>#}
{#<script src="{% static 'admin/jquery.ui.datepicker.jalali/scripts/calendar.js' %}"></script>#}
{#<script src="{% static 'admin/jquery.ui.datepicker.jalali/scripts/jquery.ui.datepicker-cc-fa.js' %}"></script>#}


-->
>>>>>>> 171b55a74efe3adb976919af53d3bd582bb2266e
