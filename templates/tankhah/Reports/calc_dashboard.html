{% extends 'base.html' %}
{% load i18n rcms_custom_filters jformat static %}

{% block extra_css %}
    <style>
        .container-fluid { max-width: 1400px; margin-top: 2rem; }
        .card { border: none; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .card-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; font-weight: 600; font-size: 1.1rem; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
        .pagination .page-item.active .page-link { z-index: 1; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title text-center mb-4">{% trans "داشبورد مالی" %}</h1>

            <form method="get" class="mb-5 p-3 bg-light border rounded">
                <div class="row g-3 align-items-center">
                    <div class="col-md-5">
                        <label for="projectFilter" class="form-label">{% trans "فیلتر بر اساس پروژه" %}</label>
                        <select name="project" id="projectFilter" class="form-select">
                            <option value="">{% trans "همه پروژه‌ها" %}</option>
                            {% for project in projects_for_filter %}
                                <option value="{{ project.id }}" {% if request.GET.project|add:"0" == project.id %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> {% trans "اعمال فیلتر" %}</button>
                    </div>
                </div>
            </form>

            <div class="row mb-5">
                <div class="col-lg-7">
                    <div class="card h-100">
                        <div class="card-header">{% trans "آمار کلی" %}</div>
                        <div class="card-body">
                            <table class="table table-striped table-hover">
                                <tbody>
                                    <tr><th>{% trans "مجموع مبلغ تنخواه‌ها" %}</th><td>{{ total_tanbakh_amount|format_negative }} {% trans "ریال" %}</td></tr>
                                    <tr><th>{% trans "تعداد کل تنخواه‌ها" %}</th><td>{{ total_tankhahs|format_negative }}</td></tr>
                                    <tr><th>{% trans "تعداد تنخواه‌های آرشیو شده" %}</th><td>{{ archived_tanbakhs|format_negative }}</td></tr>
                                    <tr><th>{% trans "میانگین زمان پردازش (پرداخت شده‌ها)" %}</th><td>{{ avg_processing_time.days|format_negative }} {% trans "روز" %}</td></tr>
                                    <tr><th>{% trans "حجم کل تصاویر (مگابایت)" %}</th><td>{{ total_image_size_mb|floatformat:2|format_negative }}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card h-100">
                        <div class="card-header">{% trans "نمودار وضعیت تنخواه‌ها" %}</div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <div class="chart-container" style="height: 300px;"><canvas id="statusChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-5">
                <div class="card-header">{% trans "لیست تنخواه‌ها (صفحه" %} {{ page_obj.number|format_negative }} {% trans "از" %} {{ page_obj.paginator.num_pages|format_negative }})</div>
                <div class="card-body p-0">
                    {% if page_obj %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>{% trans "ردیف" %}</th><th>{% trans "شماره تنخواه" %}</th><th>{% trans "سازمان" %}</th>
                                        <th>{% trans "پروژه" %}</th><th>{% trans "مبلغ (ریال)" %}</th><th>{% trans "وضعیت" %}</th><th>{% trans "تاریخ" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tankhah in page_obj %}
                                        <tr>
                                            <td>{{ page_obj.start_index|add:forloop.counter0|format_negative }}</td>
                                            <td><a href="#">{{ tankhah.number|to_persian_number_with_comma }}</a></td>
                                            <td>{{ tankhah.organization.name }}</td><td>{{ tankhah.project.name|default:"-" }}</td>
                                            <td>{{ tankhah.amount|format_negative }}</td>
                                            <td><span class="badge bg-secondary">{{ tankhah.status.name|default:"نامشخص" }}</span></td>
                                            <td>{{ tankhah.date|jformat:"%Y/%m/%d" | to_persian_number}}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav class="p-3">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}<li class="page-item"><a class="page-link" href="?page=1">&laquo;</a></li><li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "قبلی" %}</a></li>{% endif %}
                                <li class="page-item disabled"><span class="page-link">{{ page_obj.number|format_negative }}</span></li>
                                {% if page_obj.has_next %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "بعدی" %}</a></li><li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">&raquo;</a></li>{% endif %}
                            </ul>
                        </nav>
                    {% else %}
                        <p class="text-center p-3">{% trans "هیچ تنخواهی برای نمایش یافت نشد." %}</p>
                    {% endif %}
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-lg-12">
                     <div class="card"><div class="card-header">{% trans "عملکرد سازمان‌ها" %}</div><div class="card-body"><div class="chart-container"><canvas id="orgChart"></canvas></div></div></div>
                </div>
                <div class="col-lg-12 mt-4">
                    <div class="card"><div class="card-header">{% trans "عملکرد کاربران (تعداد اقدامات)" %}</div><div class="card-body"><div class="chart-container"><canvas id="userChart"></canvas></div></div></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ status_chart_data_json|json_script:"status-chart-data" }}
    {{ org_chart_data_json|json_script:"org-chart-data" }}
    {{ user_chart_data_json|json_script:"user-chart-data" }}

    <script src="{% static 'admin/js/chart.umd.min.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chartDefaultOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { family: 'Vazirmatn, sans-serif' } } } }, scales: { x: { ticks: { font: { family: 'Vazirmatn, sans-serif' } } }, y: { ticks: { font: { family: 'Vazirmatn, sans-serif' } } } } };
            function createChart(canvasId, dataId, chartType, customOptions = {}) {
                console.log(`[Chart Loader] Attempting to create: ${canvasId}`);
                const canvas = document.getElementById(canvasId);
                const dataElement = document.getElementById(dataId);
                if (!canvas) { console.error(`[Chart Loader] Fatal: Canvas element '${canvasId}' not found.`); return; }
                if (!dataElement) { console.error(`[Chart Loader] Fatal: Data script tag '${dataId}' not found.`); return; }
                let chartData;
                try { chartData = JSON.parse(dataElement.textContent); } catch (e) { console.error(`[Chart Loader] Fatal: Could not parse JSON from #${dataId}.`, e); return; }
                if (!chartData || !chartData.labels || !chartData.datasets || chartData.labels.length === 0) {
                    console.warn(`[Chart Loader] Skipping '${canvasId}': Data is empty or invalid.`);
                    const ctx = canvas.getContext('2d');
                    ctx.font = '16px Vazirmatn';
                    ctx.fillStyle = '#888';
                    ctx.textAlign = 'center';
                    ctx.fillText('داده‌ای برای نمایش وجود ندارد', canvas.width / 2, canvas.height / 2);
                    return;
                }
                console.log(`[Chart Loader] Data for ${canvasId} is valid. Rendering chart...`);
                new Chart(canvas, { type: chartType, data: chartData, options: { ...chartDefaultOptions, ...customOptions } });
            }
            createChart('statusChart', 'status-chart-data', 'doughnut', { plugins: { legend: { position: 'right' } } });
            createChart('userChart', 'user-chart-data', 'bar', { scales: { x: { stacked: true }, y: { stacked: true } } });
            createChart('orgChart', 'org-chart-data', 'bar');
        });
    </script>
{% endblock %}