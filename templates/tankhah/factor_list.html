{% extends "base.html" %}
{% load static i18n humanize rcms_custom_filters   %}

{% block title %}{% trans "مدیریت فاکتورها" %}{% endblock %}

{% block extra_css %}

<style>
/* استایل‌های فاکتور لیست */
.stat-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.stat-icon {
    font-size: 2rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--bs-primary);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--bs-secondary);
}

.table {
    border-radius: 0.5rem;
    overflow: hidden;
}

.table thead th {
    background-color: var(--bs-light);
    border: none;
    font-weight: 600;
}

.table tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
</style>
{% endblock %}  

{% block content %}
<div class="container-fluid main-content py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 fw-bold">
            <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>{% trans "مدیریت فاکتورها" %}
        </h1>
        <a href="{% url 'Nfactor_create' %}" class="btn btn-primary rounded-pill shadow-sm" aria-label="{% trans 'ایجاد فاکتور جدید' %}">
            <i class="fas fa-plus me-2"></i>{% trans "ایجاد فاکتور جدید" %}
        </a>
    </div>

    <!-- Stat Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card stat-card h-100" style="--stat-color: var(--primary);">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-file-invoice stat-icon text-primary"></i>
                    <div class="ms-3">
                        <div class="stat-value">{{ total_factors|default:0|to_persian_number }}</div>
                        <div class="stat-label">{% trans "تعداد کل فاکتورها" %}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card h-100" style="--stat-color: var(--success);">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-money-bill-wave stat-icon text-success"></i>
                    <div class="ms-3">
                        <div class="stat-value">{{ total_amount|floatformat:0|intcomma|to_persian_number }}</div>
                        <div class="stat-label">{% trans "مبلغ کل فاکتورها (ریال)" %}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card h-100" style="--stat-color: var(--info);">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-building stat-icon text-info"></i>
                    <div class="ms-3">
                        <div class="stat-value">{{ organizations_count|default:0|to_persian_number }}</div>
                        <div class="stat-label">{% trans "سازمان‌های درگیر" %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="q" class="form-label fw-semibold">{% trans "جستجو" %}</label>
                    <div class="input-group search-container">
                        <span class="input-group-text border-end-0 bg-white">
                            <i class="fas fa-search text-primary"></i>
                        </span>
                        <input type="text" name="q" id="factorSearch" value="{{ query|default_if_none:'' }}"
                               class="form-control border-start-0" placeholder="{% trans 'شماره فاکتور، تنخواه، پروژه...' %}"
                               aria-label="{% trans 'جستجوی فاکتور' %}">
                        <button type="button" class="btn btn-clear" id="clearSearch" aria-label="{% trans 'پاک کردن جستجو' %}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="date" class="form-label fw-semibold">{% trans "تاریخ فاکتور" %}</label>
                    <input type="text" name="date" id="date" data-jdp value="{{ date_query|default_if_none:'' }}"
                           class="form-control" placeholder="{% trans 'مثال: 1403/05/15'|to_persian_number %}"
                           aria-label="{% trans 'تاریخ فاکتور' %}">
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label fw-semibold">{% trans "وضعیت" %}</label>
                    <select name="status" id="status" class="form-select" aria-label="{% trans 'وضعیت فاکتور' %}">
                        <option value="">{% trans "همه" %}</option>
                        {% for status_val, display in status_choices %}
                            <option value="{{ status_val }}" {% if status_val == status_query %}selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100" aria-label="{% trans 'اعمال فیلتر' %}">
                        <i class="fas fa-filter me-2"></i>{% trans "اعمال" %}
                    </button>
                    <a href="{% url 'factor_list' %}" class="btn btn-outline-secondary" aria-label="{% trans 'پاک کردن فیلترها' %}">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                <input type="hidden" name="view" value="{{ active_view }}">
            </form>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs nav-justified border-bottom-0 mb-4">
        <li class="nav-item">
            <a class="nav-link {% if active_view == 'all' %}active{% endif %}" href="?view=all&q={{ query }}&status={{ status_query }}&date={{ date_query }}"
               aria-current="{% if active_view == 'all' %}true{% else %}false{% endif %}">{% trans "همه فاکتورها" %}</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_view == 'final' %}active{% endif %}" href="?view=final&q={{ query }}&status={{ status_query }}&date={{ date_query }}"
               aria-current="{% if active_view == 'final' %}true{% else %}false{% endif %}">{% trans "فاکتورهای نهایی" %}</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-0">
            <div class="tab-content">
                <!-- All Factors Tab -->
                <div id="all-factors" class="tab-pane {% if active_view == 'all' %}show active{% endif %}">
                    {% if grouped_by_org %}
                        <div class="accordion" id="orgAccordion">
                            {% for org_name, org_data in grouped_by_org.items %}
                                <div class="accordion-item mb-2">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#org-{{ org_data.org_obj.id }}"
                                                aria-expanded="false" aria-controls="org-{{ org_data.org_obj.id }}">
                                            <div class="d-flex w-100 justify-content-between align-items-center">
                                                <span class="fw-bold"><i class="fas fa-building me-2"></i>{{ org_name }}</span>
                                                <span class="badge bg-primary rounded-pill">
                                                    {{ org_data.total_factors|to_persian_number }} {% trans "فاکتور" %}
                                                </span>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="org-{{ org_data.org_obj.id }}" class="accordion-collapse collapse"
                                         data-bs-parent="#orgAccordion">
                                        <div class="accordion-body p-0">
                                            {% for project_name, project_data in org_data.projects.items %}
                                                <div class="p-3 bg-light">
                                                    <h6 class="fw-bold"><i class="fas fa-project-diagram me-2"></i>{{ project_name }}
                                                        <small class="text-muted">({{ project_data.total_factors|to_persian_number }} {% trans "فاکتور" %})</small>
                                                    </h6>
                                                </div>
                                                {% for tankhah_number, tankhah_data in project_data.tankhahs.items %}
                                                    <div class="p-3 ps-5">
                                                        <p class="mb-2"><i class="fas fa-file-alt me-2"></i>{% trans "تنخواه" %}: {{ tankhah_number }}
                                                            (<small  style="color:#ffc504"> {{ tankhah_data.total_factors|to_persian_number }}
                                                                <strong style="color:red;">
                                                                    {% trans "فاکتور" %} - {% trans "مبلغ کل" %}: {{ tankhah_data.total_amount|floatformat:0|intcomma|to_persian_number }} {% trans "ریال" %})
                                                                </strong></small>
                                                        </p>
                                                        <div class="table-responsive">
                                                            <table class="table table-hover align-middle mb-0 responsive-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th scope="col">{% trans "ردیف" %}</th>
                                                                        <th scope="col">{% trans "شماره / تاریخ" %}</th>
                                                                        <th scope="col">{% trans "بودجه" %}</th>
                                                                        <th scope="col">{% trans "مبلغ (ریال)" %}</th>
                                                                        <th scope="col">{% trans "وضعیت" %}</th>
                                                                        <th scope="col">{% trans "آخرین اقدام" %}</th>
                                                                        <th scope="col">{% trans "صادر کننده فاکتور" %}</th>
                                                                        <th scope="col">{% trans "عملیات" %}</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for factor in tankhah_data.factors %}
                                                                        <tr class="factor-row">
                                                                            <td data-label="{% trans 'ردیف' %}">{{ forloop.counter|to_persian_number }}</td>
                                                                            <td data-label="{% trans 'شماره / تاریخ' %}">
                                                                                <div class="fw-bold">{{ factor.number|to_persian_number }}</div>
                                                                                <small class="text-muted">{{ factor.jalali_date|to_persian_number }}</small>
                                                                            </td>
                                                                            <td data-label="{% trans 'بودجه' %}" class="budget-cell">
                                                                                <div class="fw-semibold">{{ factor.category.name }}</div>
                                                                                <small class="text-muted">{{ factor.tankhah.project_budget_allocation.budget_item.name|default:"-" }}</small>
                                                                            </td>
                                                                            <td data-label="{% trans 'مبلغ' %}" class="fw-bold text-success">
                                                                                {{ factor.amount|floatformat:0|intcomma|to_persian_number }}
                                                                            </td>
                                                                            <td data-label="{% trans 'وضعیت' %}">
                                                                                <span class="status-badge status-badge-{{ factor.status.code|default:factor.status }}">
                                                                                    <i class="fas fa-circle small"></i>
                                                                                    {{ factor.status.name|default:"نامشخص" }}
                                                                                    {{ factor.status.name }}
                                                                                </span>
                                                                                {% if factor.is_locked %}
                                                                                    <i class="fas fa-lock text-danger ms-2" data-bs-toggle="tooltip" title="{% trans 'قفل شده' %}"></i>
                                                                                {% endif %}
                                                                            </td>
                                                                            <td data-label="{% trans 'آخرین اقدام' %}" class="actor-cell">
                                                                                <div class="actor-name" data-bs-toggle="tooltip" title="{{ factor.approvers_display_list|default:'بدون تأییدکننده' }} -">
                                                                                    {{ factor.last_actor_name|default:"بدون اقدام" }}
                                                                                </div>
                                                                                <span class="badge bg-info text-white actor-action">
                                                                                    {{ factor.last_action_verb|default:"بدون اقدام" }}
                                                                                </span>
                                                                            </td>

                                                                            <td data-label="{% trans 'صادر کننده' %}" class="actor-cell">
                                                                                <div class="actor-name" data-bs-toggle="tooltip"
                                                                                     title="{{ factor.payee_info.name|default:'بدون تأییدکننده' }}--{{ factor.payee_info.national_id|default:"بدون کد ملی" |format_negative}}
                                                                                    {{ factor.payee_info.entity_type|default:"بدون ماهیت شخص" }}--{{ factor.payee_info.payee_type|default:"بدون نوع دریافت‌کننده" }} ">
                                                                                    {{ factor.payee_info.name|default:"بدون مشخصه" }}
                                                                                <!-- <span class="badge bg-info text-white actor-action">
                                                                                    {{ factor.payee_info.entity_type|default:"بدون ماهیت شخص" }}
                                                                                </span>
                                                                                <span class="badge bg-info text-white actor-action">
                                                                                    {{ factor.payee_info.payee_type|default:"بدون نوع دریافت‌کننده" }}
                                                                                </span>
                                                                                <span class="badge bg-danger text-white actor-action">
                                                                                    {{ factor.payee_info.payee_type|default:"بدون نوع دریافت‌کننده" }}
                                                                                </span> -->
                                                                                </div>

                                                                            </td>
                                                                            <td data-label="{% trans 'عملیات' %}">
                                                                                <div class="btn-group">
                                                                                    <a href="{% url 'detail_factor' factor.pk %}" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="{% trans 'جزئیات' %}">
                                                                                        <i class="fas fa-info-circle"></i>
                                                                                    </a>
                                                                                    {% if factor.can_approve %}
                                                                                        <a href="{% url 'factor_approve' factor.pk %}" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="{% trans 'تأیید' %}">
                                                                                            <i class="fas fa-check"></i>
                                                                                        </a>
                                                                                    {% endif %}
                                                                                    {% if not factor.is_locked %}
                                                                                        <a href="{% url 'factor_edit' factor.pk %}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="{% trans 'ویرایش' %}">
                                                                                            <i class="fas fa-edit"></i>
                                                                                        </a>
                                                                                        <a href="{% url 'factor_delete' factor.pk %}" class="btn btn-sm btn-outline-danger factor-action-btn" data-action="delete" data-bs-toggle="tooltip" title="{% trans 'حذف' %}">
                                                                                            <i class="fas fa-trash"></i>
                                                                                        </a>
                                                                                    {% endif %}
                                                                                    {% if user.is_superuser or user.is_staff %}
                                                                                        <a href="{% url 'admin_workflow_control' 'factor' factor.pk %}" class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" title="{% trans 'کنترل گردش کار (ادمین)' %}">
                                                                                            <i class="fas fa-user-shield"></i>
                                                                                        </a>
                                                                                    {% endif %}
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans "هیچ فاکتوری یافت نشد." %}</h5>
                            <p>{% if query or status_query or date_query %}
                                {% trans "با فیلترهای انتخابی نتیجه‌ای یافت نشد." %}
                            {% else %}
                                {% trans "برای شروع یک فاکتور جدید ایجاد کنید." %}
                            {% endif %}</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Final Factors Tab -->
                <div id="final-factors" class="tab-pane {% if active_view == 'final' %}show active{% endif %}">
                    {% if final_factors_grouped %}
                        <div class="p-3 bg-light mb-3">
                            <h5 class="mb-0">
                                {% trans "آمار فاکتورهای نهایی" %}: {{ final_factors_stats.count|to_persian_number }} {% trans "فاکتور" %} - {% trans "مبلغ کل" %}: {{ final_factors_stats.total_amount|floatformat:0|intcomma|to_persian_number }} {% trans "ریال" %}
                            </h5>
                        </div>
                        {% for org_name, org_data in final_factors_grouped.items %}
                            <div class="p-3 bg-light">
                                <h5 class="fw-bold"><i class="fas fa-building me-2"></i>{{ org_name }}
                                    <small class="text-muted">({{ org_data.total_factors|to_persian_number }} {% trans "فاکتور" %})</small>
                                </h5>
                            </div>
                            {% for project_name, project_data in org_data.projects.items %}
                                <div class="p-3 ps-3">
                                    <h6 class="fw-bold"><i class="fas fa-project-diagram me-2"></i>{{ project_name }}
                                        <small class="text-muted">({{ project_data.total_factors|to_persian_number }} {% trans "فاکتور" %})</small>
                                    </h6>
                                </div>
                                {% for tankhah_number, tankhah_data in project_data.tankhahs.items %}
                                    <div class="p-3 ps-5">
                                        <p class="mb-2"><i class="fas fa-file-alt me-2"></i>{% trans "تنخواه" %}: {{ tankhah_number }}
                                            <small class="text-muted">({{ tankhah_data.total_factors|to_persian_number }} {% trans "فاکتور" %} - {% trans "مبلغ کل" %}: {{ tankhah_data.total_amount|floatformat:0|intcomma|to_persian_number }} {% trans "ریال" %})</small>
                                        </p>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0 responsive-table">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">{% trans "ردیف" %}</th>
                                                        <th scope="col">{% trans "شماره / تاریخ" %}</th>
                                                        <th scope="col">{% trans "بودجه" %}</th>
                                                        <th scope="col">{% trans "مبلغ (ریال)" %}</th>
                                                        <th scope="col">{% trans "عملیات" %}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for factor in tankhah_data.factors %}
                                                        <tr class="factor-row">
                                                            <td data-label="{% trans 'ردیف' %}">{{ forloop.counter|to_persian_number }}</td>
                                                            <td data-label="{% trans 'شماره / تاریخ' %}">
                                                                <div class="fw-bold">{{ factor.number|to_persian_number }}</div>
                                                                <small class="text-muted">{{ factor.jalali_date|to_persian_number }}</small>
                                                            </td>
                                                            <td data-label="{% trans 'بودجه' %}" class="budget-cell">
                                                                <div class="fw-semibold">{{ factor.category.name }}</div>
                                                                <small class="text-muted">{{ factor.tankhah.project_budget_allocation.budget_item.name|default:"-" }}</small>
                                                            </td>
                                                            <td data-label="{% trans 'مبلغ' %}" class="fw-bold text-success">
                                                                {{ factor.amount|floatformat:0|intcomma|to_persian_number }}
                                                            </td>
                                                            <td data-label="{% trans 'عملیات' %}">
                                                                <div class="btn-group">
                                                                    <a href="{% url 'detail_factor' factor.pk %}" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="{% trans 'جزئیات' %}">
                                                                        <i class="fas fa-info-circle"></i>
                                                                    </a>
                                                                    {% if user.is_superuser or user.is_staff %}
                                                                        <a href="{% url 'admin_workflow_control' 'factor' factor.pk %}" class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" title="{% trans 'کنترل گردش کار (ادمین)' %}">
                                                                            <i class="fas fa-user-shield"></i>
                                                                        </a>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans "هیچ فاکتور نهایی یافت نشد." %}</h5>
                            <p>{% if query or status_query or date_query %}
                                {% trans "با فیلترهای انتخابی نتیجه‌ای یافت نشد." %}
                            {% else %}
                                {% trans "هیچ فاکتور نهایی وجود ندارد." %}
                            {% endif %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
            <div class="card-footer bg-light border-0">
                <nav class="d-flex justify-content-center" aria-label="{% trans 'ناوبری صفحه' %}">
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}&status={{ status_query }}&date={{ date_query }}&view={{ active_view }}"
                                   aria-label="{% trans 'صفحه قبلی' %}">‹</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">‹</span></li>
                        {% endif %}
                        {% for i in page_obj.paginator.get_elided_page_range %}
                            {% if page_obj.number == i %}
                                <li class="page-item active"><span class="page-link">{{ i|to_persian_number }}</span></li>
                            {% else %}
                                {% if i == page_obj.paginator.ELLIPSIS %}
                                    <li class="page-item disabled"><span class="page-link">{{ i }}</span></li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ i }}&q={{ query }}&status={{ status_query }}&date={{ date_query }}&view={{ active_view }}">{{ i|to_persian_number }}</a>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}&status={{ status_query }}&date={{ date_query }}&view={{ active_view }}"
                                   aria-label="{% trans 'صفحه بعدی' %}">›</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">›</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        {% endif %}
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmationModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>{% trans "تأیید عملیات" %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{% trans 'بستن' %}"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="fs-5">{% trans "آیا از حذف این فاکتور اطمینان دارید؟ این عمل قابل بازگشت نیست." %}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "انصراف" %}</button>
                    <a href="#" id="confirmActionBtn" class="btn btn-danger">{% trans "بله، حذف کن" %}</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // تنظیم RTL
    document.documentElement.setAttribute('dir', 'rtl');

    // فعال‌سازی Tooltip‌ها
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el, {
            boundary: 'window',
            placement: 'top'
        });
    });

    // تنظیم Jalali Datepicker
    jalaliDatepicker.startWatch({
        selector: '[data-jdp]',
        persianDigits: true,
        autoHide: true,
        format: 'YYYY/MM/DD'
    });

    // جستجوی دینامیک
    const searchInput = document.getElementById('factorSearch');
    const clearSearch = document.getElementById('clearSearch');
    const rows = document.querySelectorAll('.factor-row');

    searchInput.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        clearSearch.classList.toggle('show', keyword.length > 0);

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const cells = row.querySelectorAll('td');

            cells.forEach(cell => {
                cell.innerHTML = cell.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/g, '$1');
            });

            if (keyword && text.includes(keyword)) {
                row.style.display = '';
                cells.forEach(cell => {
                    const cellText = cell.textContent.toLowerCase();
                    if (cellText.includes(keyword)) {
                        const regex = new RegExp(`(${keyword})`, 'gi');
                        cell.innerHTML = cell.innerHTML.replace(regex, '<span class="highlight">$1</span>');
                    }
                });
            } else {
                row.style.display = keyword ? 'none' : '';
            }
        });
    });

    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        clearSearch.classList.remove('show');
        rows.forEach(row => {
            row.style.display = '';
            row.querySelectorAll('td').forEach(cell => {
                cell.innerHTML = cell.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/g, '$1');
            });
        });
    });

    // مدیریت حذف با SweetAlert2
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmBtn = document.getElementById('confirmActionBtn');

    document.querySelectorAll('.factor-action-btn[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            confirmBtn.href = this.href;
            confirmationModal.show();
        });
    });

    // نمایش پیام‌های Django
    {% if messages %}
        {% for message in messages %}
            Swal.fire({
                icon: '{{ message.tags }}' === 'success' ? 'success' : 'error',
                title: '{{ message.tags|capfirst }}',
                text: '{{ message }}',
                timer: 3000,
                showConfirmButton: false
            });
        {% endfor %}
    {% endif %}

    // تنظیم برچسب‌های responsive برای جدول
    document.querySelectorAll('.responsive-table').forEach(table => {
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
        table.querySelectorAll('tbody tr').forEach(row => {
            row.querySelectorAll('td').forEach((td, index) => {
                td.setAttribute('data-label', headers[index]);
            });
        });
    });
});
</script>
{% endblock %}