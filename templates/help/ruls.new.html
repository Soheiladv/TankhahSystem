<!-- core/templates/core/workflow/transition_form.html (نسخه نهایی با راهنمای بصری کامل) -->
{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* استایل‌های سفارشی برای بهبود ظاهر */
    .workflow-step-card {
        transition: box-shadow 0.2s ease-in-out;
        border-left-width: 4px;
    }
    .workflow-step-card .card-body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .workflow-step-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    .connector-icon {
        font-size: 2rem;
        color: #adb5bd; /* خاکستری */
    }
    .step-badge {
        font-size: 1rem;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-md-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white p-3">
                    <h4 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-project-diagram me-2"></i>
                        {{ title }}
                    </h4>
                </div>

                <form method="post" novalidate>
                    {% csrf_token %}
                    <div class="card-body p-4">

                        <!-- راهنمای اصلی -->
                        <div class="alert alert-info border-info">
                            <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>{% trans "راهنمای طراحی قانون گردش کار" %}</h5>
                            <p class="mb-0 small">
                                {% trans "شما در حال تعریف یک **قانون واحد** از نقشه راه فرآیندهای سازمان هستید. این قانون به سیستم می‌گوید که یک سند **چگونه** و توسط **چه کسانی** از یک وضعیت به وضعیت دیگر منتقل می‌شود." %}
                            </p>
                        </div>

                        <!-- نمایش خطاهای کلی -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                        {% endif %}

                        <!-- بخش ۱: اطلاعات شناسایی قانون -->
                        <fieldset class="border p-3 rounded mb-4">
                            <legend class="float-none w-auto px-2 h6 text-muted">{% trans "اطلاعات شناسایی" %}</legend>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">{% trans "نام این قانون" %}</label>
                                    {{ form.name }}
                                    <small class="form-text text-muted">{% trans "(مثال: ارسال توسط کارشناس به مدیر)" %}</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.organization.id_for_label }}" class="form-label fw-bold">{% trans "برای کدام سازمان؟" %}</label>
                                    {{ form.organization }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.entity_type.id_for_label }}" class="form-label fw-bold">{% trans "برای کدام موجودیت؟" %}</label>
                                    {{ form.entity_type }}
                                </div>
                            </div>
                        </fieldset>

                        <!-- بخش ۲: تعریف مسیر انتقال (بصری) -->
                        <fieldset class="border p-3 rounded mb-4">
                            <legend class="float-none w-auto px-2 h6 text-muted">{% trans "مسیر انتقال" %}</legend>
                            <div class="row align-items-stretch text-center g-3 mt-1">
                                <!-- گام ۱: از وضعیت -->
                                <div class="col-md">
                                    <div class="card h-100 workflow-step-card border-secondary">
                                        <div class="card-body">
                                            <div class="step-badge rounded-circle bg-secondary text-white mb-2">۱</div>
                                            <h6 class="card-title">{% trans "اگر وضعیت فعلی بود" %}</h6>
                                            <div class="workflow-step-icon text-secondary"><i class="fas fa-flag"></i></div>
                                            {{ form.from_status }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-auto d-none d-md-flex align-items-center"><i class="fas fa-plus connector-icon"></i></div>
                                <!-- گام ۲: با اقدام -->
                                <div class="col-md">
                                    <div class="card h-100 workflow-step-card border-warning">
                                        <div class="card-body">
                                            <div class="step-badge rounded-circle bg-warning text-dark mb-2">۲</div>
                                            <h6 class="card-title">{% trans "و کاربر اقدام کرد" %}</h6>
                                            <div class="workflow-step-icon text-warning"><i class="fas fa-bolt"></i></div>
                                            {{ form.action }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-auto d-none d-md-flex align-items-center"><i class="fas fa-arrow-right connector-icon"></i></div>
                                <!-- گام ۳: به وضعیت -->
                                <div class="col-md">
                                    <div class="card h-100 workflow-step-card border-success">
                                        <div class="card-body">
                                            <div class="step-badge rounded-circle bg-success text-white mb-2">۳</div>
                                            <h6 class="card-title">{% trans "آنگاه به وضعیت برو" %}</h6>
                                            <div class="workflow-step-icon text-success"><i class="fas fa-flag-checkered"></i></div>
                                            {{ form.to_status }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <!-- بخش سوم: تخصیص مجوزها -->
                        <fieldset class="border p-3 rounded">
                             <legend class="float-none w-auto px-2 h6 text-muted">{% trans "تخصیص مجوز" %}</legend>
                             <div class="mb-3">
                                 <label for="{{ form.allowed_posts.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-users-cog me-2"></i>
                                    {% trans "کدام پست‌ها اجازه اجرای این انتقال را دارند؟" %}
                                 </label>
                                 {{ form.allowed_posts }}
                                 <small class="form-text text-muted d-block mt-1">{% trans "برای انتخاب چند پست، کلید Ctrl را نگه دارید. لیست پست‌ها بر اساس سازمان انتخاب شده در بالا فیلتر نمی‌شود تا بتوانید به پست‌های سازمان‌های دیگر نیز دسترسی دهید." %}</small>
                             </div>
                        </fieldset>

                         <div class="mt-3 form-check form-switch">
                            {{ form.is_active }}
                            <label for="{{ form.is_active.id_for_label }}" class="form-check-label">{{ form.is_active.label }}</label>
                        </div>
                    </div>
                    <div class="card-footer text-end bg-light p-3">
                        <a href="{% url 'transition_list' %}" class="btn btn-secondary">{% trans "انصراف" %}</a>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fas fa-save me-1"></i> {% trans "ذخیره قانون" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}