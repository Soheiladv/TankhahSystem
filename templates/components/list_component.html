{% load i18n rcms_custom_filters %}

{% if items %}
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col" style="width: 5%;">ردیف</th>
                    {% for header in headers %}
                        <th scope="col">{{ header }}</th>
                    {% endfor %}
                    <th scope="col" class="text-center">عملیات</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        {% for field_name in fields %}
                            <td>
                                {% with value=item|get_attribute:field_name %}
                                    {# بررسی اینکه آیا برای این فیلد، فیلتری تعریف شده است؟ #}
                                    {% if field_filters and field_name in field_filters %}
                                        {# **اصلاح اصلی اینجا انجام شده است** #}
                                        {# ابتدا نام فیلتر را از دیکشنری استخراج می‌کنیم #}
                                        {% with filter_to_apply=field_filters|get_attribute:field_name %}
                                            {# سپس فیلتر را با نام استخراج شده اعمال می‌کنیم #}
                                            {{ value|apply_filter:filter_to_apply }}
                                        {% endwith %}
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                {% endwith %}
                            </td>
                        {% endfor %}
                        <td class="text-center">
                            {# به جای ارسال پارامترهای جداگانه، لیست کامل actions ارسال می‌شود #}
                            {% action_buttons item actions %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-info text-center m-3">
        <i class="fas fa-info-circle me-2"></i>
        {{ empty_message|default:"هیچ موردی برای نمایش وجود ندارد." }}
    </div>
{% endif %}
