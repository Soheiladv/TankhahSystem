{% extends 'base.html' %}
{% load i18n %}
{% load jformat rcms_custom_filters %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Card -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="card-title mb-0">
                        <i class="fas fa-sitemap me-2"></i>
                        {{ post.name }}
                    </h1>
                    <small class="opacity-75">{{ post.organization.name }}</small>
                </div>
                <div class="btn-group">
                    <a href="{% url 'post_list' %}" class="btn btn-light">
                        <i class="fas fa-arrow-left me-1"></i>{% trans "بازگشت" %}
                    </a>
                    {% if perms.core.Post_update %}
                        <a href="{% url 'post_update' post.pk %}" class="btn btn-warning">
                            <i class="fas fa-edit me-1"></i>{% trans "ویرایش" %}
                        </a>
                    {% endif %}
                    <a href="{% url 'workflow_management:post_assignment_list' %}?post_id={{ post.pk }}" class="btn btn-info">
                        <i class="fas fa-cogs me-1"></i>{% trans "مدیریت قوانین" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card bg-success text-white text-center">
                <div class="card-body">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4>{{ stats.active_users_count }}</h4>
                    <small>{% trans "کاربران فعال" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white text-center">
                <div class="card-body">
                    <i class="fas fa-user-slash fa-2x mb-2"></i>
                    <h4>{{ stats.inactive_users_count }}</h4>
                    <small>{% trans "کاربران غیرفعال" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white text-center">
                <div class="card-body">
                    <i class="fas fa-child fa-2x mb-2"></i>
                    <h4>{{ stats.child_posts_count }}</h4>
                    <small>{% trans "پست‌های فرزند" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-primary text-white text-center">
                <div class="card-body">
                    <i class="fas fa-tasks fa-2x mb-2"></i>
                    <h4>{{ stats.post_actions_count }}</h4>
                    <small>{% trans "اقدامات مجاز" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white text-center">
                <div class="card-body">
                    <i class="fas fa-gavel fa-2x mb-2"></i>
                    <h4>{{ stats.rule_assignments_count }}</h4>
                    <small>{% trans "قوانین تخصیص" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white text-center">
                <div class="card-body">
                    <i class="fas fa-layer-group fa-2x mb-2"></i>
                    <h4>{{ post.level }}</h4>
                    <small>{% trans "سطح" %}</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- اطلاعات پایه -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        {% trans "اطلاعات پایه" %}
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>{% trans "نام پست:" %}</strong></td>
                            <td>{{ post.name }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "سازمان:" %}</strong></td>
                            <td>
                                <span class="badge bg-primary">{{ post.organization.name }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "پست والد:" %}</strong></td>
                            <td>
                                {% if post.parent %}
                                    <a href="{% url 'post_detail' post.parent.pk %}" class="text-decoration-none">
                                        {{ post.parent.name }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "شاخه:" %}</strong></td>
                            <td>
                                {% if post.branch %}
                                    <span class="badge bg-info">{{ post.branch.name }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "وضعیت:" %}</strong></td>
                            <td>
                                {% if post.is_active %}
                                    <span class="badge bg-success">{% trans "فعال" %}</span>
                                {% else %}
                                    <span class="badge bg-danger">{% trans "غیرفعال" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "حداکثر سطح تغییر:" %}</strong></td>
                            <td>{{ post.max_change_level }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- مجوزهای ویژه -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        {% trans "مجوزهای ویژه" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-2">
                        {% if post.is_payment_order_signer %}
                            <span class="badge bg-success">
                                <i class="fas fa-signature me-1"></i>
                                {% trans "امضای دستور پرداخت" %}
                            </span>
                        {% endif %}
                        {% if post.can_final_approve_factor %}
                            <span class="badge bg-warning">
                                <i class="fas fa-check-double me-1"></i>
                                {% trans "تایید نهایی فاکتور" %}
                            </span>
                        {% endif %}
                        {% if post.can_final_approve_tankhah %}
                            <span class="badge bg-info">
                                <i class="fas fa-check-double me-1"></i>
                                {% trans "تایید نهایی تنخواه" %}
                            </span>
                        {% endif %}
                        {% if post.can_final_approve_budget %}
                            <span class="badge bg-primary">
                                <i class="fas fa-check-double me-1"></i>
                                {% trans "تایید نهایی بودجه" %}
                            </span>
                        {% endif %}
                        {% if not post.is_payment_order_signer and not post.can_final_approve_factor and not post.can_final_approve_tankhah and not post.can_final_approve_budget %}
                            <span class="text-muted">{% trans "هیچ مجوز ویژه‌ای تعریف نشده" %}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- محتوای اصلی -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs" id="postTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>{% trans "کاربران" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="children-tab" data-bs-toggle="tab" data-bs-target="#children" type="button" role="tab">
                                <i class="fas fa-child me-1"></i>{% trans "پست‌های فرزند" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab">
                                <i class="fas fa-tasks me-1"></i>{% trans "اقدامات مجاز" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">
                                <i class="fas fa-gavel me-1"></i>{% trans "قوانین" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                                <i class="fas fa-history me-1"></i>{% trans "تاریخچه" %}
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="postTabsContent">
                        <!-- Users Tab -->
                        <div class="tab-pane fade show active" id="users" role="tabpanel">
                            <div class="row">
                                <!-- Active Users -->
                                <div class="col-md-6">
                                    <h6 class="text-success">
                                        <i class="fas fa-users me-1"></i>
                                        {% trans "کاربران فعال" %} ({{ active_users.count }})
                                    </h6>
                                    {% if active_users %}
                                        <div class="list-group">
                                            {% for userpost in active_users %}
                                                <div class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-1">{{ userpost.user.get_full_name|default:userpost.user.username }}</h6>
                                                            <small class="text-muted">{{ userpost.user.username }}</small>
                                                        </div>
                                                        <div class="text-end">
                                                            <small class="text-muted">
                                                                {% if userpost.start_date %}
                                                                    {{ userpost.start_date|jformat:"%Y/%m/%d" }}
                                                                {% endif %}
                                                                {% if userpost.end_date %}
                                                                    - {{ userpost.end_date|jformat:"%Y/%m/%d" }}
                                                                {% else %}
                                                                    - {% trans "فعلی" %}
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-users fa-2x mb-2"></i>
                                            <p>{% trans "هیچ کاربر فعالی یافت نشد" %}</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Inactive Users -->
                                <div class="col-md-6">
                                    <h6 class="text-warning">
                                        <i class="fas fa-user-slash me-1"></i>
                                        {% trans "کاربران غیرفعال" %} ({{ inactive_users.count }})
                                    </h6>
                                    {% if inactive_users %}
                                        <div class="list-group">
                                            {% for userpost in inactive_users %}
                                                <div class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-1">{{ userpost.user.get_full_name|default:userpost.user.username }}</h6>
                                                            <small class="text-muted">{{ userpost.user.username }}</small>
                                                        </div>
                                                        <div class="text-end">
                                                            <small class="text-muted">
                                                                {% if userpost.start_date %}
                                                                    {{ userpost.start_date|jformat:"%Y/%m/%d" }}
                                                                {% endif %}
                                                                {% if userpost.end_date %}
                                                                    - {{ userpost.end_date|jformat:"%Y/%m/%d" }}
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-user-slash fa-2x mb-2"></i>
                                            <p>{% trans "هیچ کاربر غیرفعالی یافت نشد" %}</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Children Tab -->
                        <div class="tab-pane fade" id="children" role="tabpanel">
                            {% if child_posts %}
                                <div class="row">
                                    {% for child in child_posts %}
                                        <div class="col-md-6 mb-3">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-1">
                                                                <a href="{% url 'post_detail' child.pk %}" class="text-decoration-none">
                                                                    {{ child.name }}
                                                                </a>
                                                            </h6>
                                                            <small class="text-muted">{{ child.organization.name }}</small>
                                                        </div>
                                                        <div class="text-end">
                                                            <span class="badge bg-info">سطح {{ child.level }}</span>
                                                            {% if child.branch %}
                                                                <br><small class="text-muted">{{ child.branch.name }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-child fa-3x mb-3"></i>
                                    <h5>{% trans "هیچ پست فرزندی یافت نشد" %}</h5>
                                    <p>{% trans "این پست هیچ پست فرزندی ندارد" %}</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Actions Tab -->
                        <div class="tab-pane fade" id="actions" role="tabpanel">
                            {% if post_actions %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>{% trans "مرحله" %}</th>
                                                <th>{% trans "نوع اقدام" %}</th>
                                                <th>{% trans "نوع موجودیت" %}</th>
                                                <th>{% trans "اقدامات مجاز" %}</th>
                                                <th>{% trans "وضعیت" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for action in post_actions %}
                                                <tr>
                                                    <td>{{ action.stage.name }}</td>
                                                    <td>{{ action.get_action_type_display }}</td>
                                                    <td>{{ action.get_entity_type_display }}</td>
                                                    <td>
                                                        {% for allowed_action in action.allowed_actions %}
                                                            <span class="badge bg-secondary me-1">{{ allowed_action }}</span>
                                                        {% endfor %}
                                                    </td>
                                                    <td>
                                                        {% if action.is_active %}
                                                            <span class="badge bg-success">{% trans "فعال" %}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">{% trans "غیرفعال" %}</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-tasks fa-3x mb-3"></i>
                                    <h5>{% trans "هیچ اقدام مجازی تعریف نشده" %}</h5>
                                    <p>{% trans "برای این پست هیچ اقدام مجازی تعریف نشده است" %}</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Rules Tab -->
                        <div class="tab-pane fade" id="rules" role="tabpanel">
                            {% if rule_assignments %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>{% trans "اقدام" %}</th>
                                                <th>{% trans "سازمان" %}</th>
                                                <th>{% trans "نوع موجودیت" %}</th>
                                                <th>{% trans "وضعیت" %}</th>
                                                <th>{% trans "تاریخ ایجاد" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for rule in rule_assignments %}
                                                <tr>
                                                    <td>{{ rule.action.name }}</td>
                                                    <td>{{ rule.organization.name }}</td>
                                                    <td>{{ rule.get_entity_type_display }}</td>
                                                    <td>
                                                        {% if rule.is_active %}
                                                            <span class="badge bg-success">{% trans "فعال" %}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">{% trans "غیرفعال" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ rule.created_at|jformat:"%Y/%m/%d" }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-gavel fa-3x mb-3"></i>
                                    <h5>{% trans "هیچ قانونی تخصیص نیافته" %}</h5>
                                    <p>{% trans "برای این پست هیچ قانونی تخصیص نیافته است" %}</p>
                                    <a href="{% url 'workflow_management:post_assignment_list' %}?post_id={{ post.pk }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>{% trans "تخصیص قانون" %}
                                    </a>
                                </div>
                            {% endif %}
                        </div>

                        <!-- History Tab -->
                        <div class="tab-pane fade" id="history" role="tabpanel">
                            {% if post.posthistory_set.all %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>{% trans "فیلد تغییر یافته" %}</th>
                                                <th>{% trans "مقدار قبلی" %}</th>
                                                <th>{% trans "مقدار جدید" %}</th>
                                                <th>{% trans "تغییر دهنده" %}</th>
                                                <th>{% trans "تاریخ تغییر" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for history in post.posthistory_set.all %}
                                                <tr>
                                                    <td>{{ history.changed_field }}</td>
                                                    <td>{{ history.old_value|default:"-" }}</td>
                                                    <td>{{ history.new_value|default:"-" }}</td>
                                                    <td>
                                                        {% if history.changed_by %}
                                                            {{ history.changed_by.get_full_name|default:history.changed_by.username }}
                                                        {% else %}
                                                            <span class="text-muted">{% trans "کاربر حذف شده" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ history.changed_at|jformat:"%Y/%m/%d %H:%M" }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-history fa-3x mb-3"></i>
                                    <h5>{% trans "هیچ تاریخچه‌ای یافت نشد" %}</h5>
                                    <p>{% trans "برای این پست هیچ تاریخچه تغییراتی ثبت نشده است" %}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}