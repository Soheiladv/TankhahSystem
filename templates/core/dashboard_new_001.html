{% extends "base.html" %}
{% load i18n static jformat rcms_custom_filters jalali_tags %}

{% block extra_head %}
 <style>
        body {
               background-color: #f0f2f5; /* [cite: 2] */
            color: #333; /* [cite: 2] */
            direction: rtl;
        }

        :root {
            --primary-color: #6a0572; /* [cite: 2] */
            --secondary-color: #892cdc; /* [cite: 2] */
            --success-color: #2ecc71; /* [cite: 2] */
            --info-color: #3498db; /* [cite: 2] */
            --warning-color: #f1c40f; /* [cite: 2] */
            --danger-color: #e74c3c; /* [cite: 2] */
            --light-bg: #ffffff; /* [cite: 2] */
            --dark-text: #2c3e50; /* [cite: 2] */
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.1); /* [cite: 2] */
            --hover-shadow: 0 12px 24px rgba(0, 0, 0, 0.15); /* [cite: 2] */
            --border-radius: 12px; /* [cite: 2] */
        }

        .dashboard-card {
            background-color: var(--light-bg); /* [cite: 2] */
            border-radius: var(--border-radius); /* [cite: 2] */
            box-shadow: var(--shadow); /* [cite: 2] */
            margin-bottom: 30px; /* [cite: 2] */
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* [cite: 2] */
            border: none; /* [cite: 2] */
        }

        .dashboard-card:hover {
            transform: translateY(-8px); /* [cite: 2] */
            box-shadow: var(--hover-shadow); /* [cite: 2] */
        }

        .accordion-item .accordion-header { /* [cite: 2] */
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); /* [cite: 2] */
            color: white; /* [cite: 2] */
            border-radius: var(--border-radius); /* [cite: 2] */
            padding: 18px 25px; /* [cite: 2] */
            box-shadow: var(--shadow); /* [cite: 2] */
            position: relative; /* [cite: 2] */
            z-index: 1; /* [cite: 2] */
            font-weight: 700; /* [cite: 2] */
            font-size: 1.1em; /* [cite: 2] */
            cursor: pointer; /* [cite: 2] */
            transition: all 0.3s ease; /* [cite: 2] */
        }
        .accordion-item .accordion-header:hover { /* [cite: 2] */
            opacity: 0.9; /* [cite: 2] */
        }
        .accordion-item .accordion-header.collapsed { /* [cite: 2] */
             /* حفظ border-radius کامل وقتی بسته است */
        }
        .accordion-item .accordion-button { /* [cite: 2] */
            background-color: transparent; /* [cite: 2] */
            color: inherit; /* [cite: 2] */
            box-shadow: none; /* [cite: 2] */
            padding: 0; /* [cite: 2] */
            font-size: 1.1em; /* [cite: 2] */
            font-weight: 700; /* [cite: 2] */
            border: none; /* [cite: 2] */
            text-align: right; /* [cite: 2] */
            width: 100%;
            display: flex; /* [cite: 2] */
            justify-content: space-between; /* [cite: 2] */
        }
        .accordion-item .accordion-button:not(.collapsed) { /* [cite: 2] */
            background-color: transparent; /* [cite: 2] */
            color: inherit; /* [cite: 2] */
            box-shadow: none; /* [cite: 2] */
        }
        .accordion-item .accordion-button::after { /* [cite: 2] */
            content: '\f078'; /* FontAwesome Angle Down */
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: 0.5rem; /* [cite: 2] */
            transition: transform 0.2s ease-in-out; /* [cite: 2] */
            transform: rotate(0deg); /* [cite: 2] */
        }
        .accordion-item .accordion-button.collapsed::after { /* [cite: 2] */
            transform: rotate(-90deg); /* [cite: 2] */
        }

        .accordion-item .accordion-body { /* [cite: 2] */
            padding: 25px; /* [cite: 2] */
            background-color: var(--light-bg); /* [cite: 2] */
            border-bottom-left-radius: var(--border-radius); /* [cite: 2] */
            border-bottom-right-radius: var(--border-radius); /* [cite: 2] */
            box-shadow: var(--shadow); /* [cite: 2] */
            margin-top: -1px; /* [cite: 2] */
            position: relative; /* [cite: 2] */
            z-index: 0; /* [cite: 2] */
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .accordion-item .accordion-header.collapsed + .accordion-collapse .accordion-body {
            margin-top: -20px; /* [cite: 2] */
        }
        .accordion-item .accordion-header:not(.collapsed) {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }


        .dashboard-card h5 { /* [cite: 2] */
            color: var(--dark-text); /* [cite: 2] */
            margin-bottom: 15px; /* [cite: 2] */
            font-weight: 700; /* [cite: 2] */
        }
        .dashboard-card .card-value { /* [cite: 2] */
            font-size: 2.5em; /* [cite: 2] */
            font-weight: bold; /* [cite: 2] */
            color: var(--primary-color); /* [cite: 2] */
            line-height: 1.2; /* [cite: 2] */
            animation: fadeInDown 0.8s ease-out; /* [cite: 2] */
        }
        .dashboard-card .card-text { /* [cite: 2] */
            color: #777; /* [cite: 2] */
            font-size: 1em; /* [cite: 2] */
            margin-top: 5px; /* [cite: 2] */
        }
        .metric-box { /* [cite: 2] */
            background-color: #f7f7f7; /* [cite: 2] */
            border-radius: 10px; /* [cite: 2] */
            padding: 20px; /* [cite: 2] */
            text-align: center; /* [cite: 2] */
            transition: all 0.3s ease; /* [cite: 2] */
            border: 1px solid #eee; /* [cite: 2] */
            height: 100%;
        }
        .metric-box:hover { /* [cite: 2] */
            background-color: #e9ecef; /* [cite: 2] */
            transform: scale(1.02); /* [cite: 2] */
        }
        .metric-box .icon { /* [cite: 2] */
            font-size: 2.2em; /* [cite: 2] */
            margin-bottom: 10px; /* [cite: 2] */
            color: var(--primary-color); /* [cite: 2] */
        }
        .chart-container { /* [cite: 2] */
            position: relative; /* [cite: 2] */
            height: 350px; /* [cite: 2] */
            width: 100%; /* [cite: 2] */
            padding: 10px; /* [cite: 2] */
            box-sizing: border-box; /* [cite: 2] */
        }
        .list-group-item { /* [cite: 2] */
            display: flex; /* [cite: 2] */
            justify-content: space-between; /* [cite: 2] */
            align-items: center; /* [cite: 2] */
            padding: 12px 20px; /* [cite: 2] */
            border-bottom: 1px solid #e9ecef; /* [cite: 2] */
            transition: background-color 0.3s ease; /* [cite: 2] */
        }
        .list-group-item:hover { /* [cite: 2] */
            background-color: #f8f9fa; /* [cite: 2] */
        }
        .list-group-item:last-child { /* [cite: 2] */
            border-bottom: none; /* [cite: 2] */
        }
        .list-group-item strong { /* [cite: 2] */
            color: var(--dark-text); /* [cite: 2] */
        }
        .list-group-item small { /* [cite: 2] */
            color: #888; /* [cite: 2] */
        }
        .badge { /* [cite: 2] */
            font-size: 0.85em; /* [cite: 2] */
            padding: 0.5em 0.8em; /* [cite: 2] */
            border-radius: 50px; /* [cite: 2] */
            font-weight: 600; /* [cite: 2] */
        }
        .progress { /* [cite: 2] */
            height: 10px; /* [cite: 2] */
            border-radius: 5px; /* [cite: 2] */
            background-color: #e9ecef; /* [cite: 2] */
            margin-top: 8px; /* [cite: 2] */
        }
        .progress-bar { /* [cite: 2] */
            border-radius: 5px; /* [cite: 2] */
            transition: width 0.6s ease-in-out; /* [cite: 2] */
        }
        .btn-outline-primary { /* [cite: 2] */
            color: var(--primary-color); /* [cite: 2] */
            border-color: var(--primary-color); /* [cite: 2] */
            transition: all 0.3s ease; /* [cite: 2] */
            width: 100%; /* [cite: 2] */
        }
        .btn-outline-primary:hover { /* [cite: 2] */
            background-color: var(--primary-color); /* [cite: 2] */
            color: white; /* [cite: 2] */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* [cite: 2] */
            transform: translateY(-2px); /* [cite: 2] */
        }
        .mr-2 { margin-right: 0.5rem !important; }
        .ml-2 { margin-left: 0.5rem !important; }

        /* Chart.js Tooltip */
        #chartjs-tooltip { /* [cite: 2] */
            opacity: 0; /* [cite: 2] */
            position: absolute; /* [cite: 2] */
            background: rgba(0, 0, 0, 0.75); /* [cite: 2] */
            color: white; /* [cite: 2] */
            border-radius: 4px; /* [cite: 2] */
            padding: 8px 12px; /* [cite: 2] */
            font-family: 'Vazirmatn', sans-serif; /* [cite: 2] */
            pointer-events: none; /* [cite: 2] */
            transition: opacity 0.15s ease, transform 0.15s ease; /* [cite: 2] */
            font-size: 0.9rem;
            z-index: 10000;
            transform: translate(-50%, calc(-100% - 10px)); /* Position above cursor */
        }
        #chartjs-tooltip h3 { /* [cite: 2] */
            margin: 0 0 8px; /* [cite: 2] */
            font-size: 1rem; /* [cite: 2] */
            font-weight: bold;
        }
        #chartjs-tooltip p { /* [cite: 2] */
            margin: 0 0 4px; /* [cite: 2] */
            display: flex; /* [cite: 2] */
            align-items: center; /* [cite: 2] */
            font-size: 0.85rem; /* [cite: 2] */
        }
        #chartjs-tooltip p:last-child {
            margin-bottom: 0;
        }
        .chartjs-tooltip-key { /* [cite: 2] */
            display: inline-block; /* [cite: 2] */
            width: 10px; /* [cite: 2] */
            height: 10px; /* [cite: 2] */
            margin-left: 8px; /* تغییر به margin-left برای RTL */ /* [cite: 2] */
            border-radius: 50%; /* [cite: 2] */
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 text-center animate__animated animate__fadeInDown">
        <i class="fas fa-tachometer-alt text-primary mr-2"></i>{% translate "داشبورد مدیریت تنخواه و بودجه" %}
        <small class="text-muted ml-2" style="font-size: 0.6em;">v.{{ version }}</small> </h2>

    {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show animate__animated animate__fadeIn" role="alert"> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="accordion mb-4 animate__animated animate__fadeInUp" id="accordionQuickLinks"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingQuickLinks"> <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseQuickLinks" aria-expanded="true"
                        aria-controls="collapseQuickLinks"> <i class="fas fa-link mr-2"></i>{% translate "دسترسی‌های سریع" %} </button>
            </h2>
            <div id="collapseQuickLinks" class="accordion-collapse collapse show"
                 aria-labelledby="headingQuickLinks"
                 data-bs-parent="#accordionQuickLinks"> <div class="accordion-body"> {% for category, links_list in dashboard_links.items %}
                        <h6 class="mt-3 mb-2 text-secondary"> <i class="fas fa-folder-open mr-2"></i>{{ category }} </h6>
                        <div class="row">
                            {% for link_item in links_list %}
                                <div class="col-lg-3 col-md-4 col-sm-6 mb-3"> <a href="{% if link_item.url %}{% url link_item.url %}{% else %}#{% endif %}"
                                       class="btn btn-outline-primary btn-block d-flex align-items-center justify-content-start py-2 text-truncate"> <i class="{{ link_item.icon|default:'fas fa-caret-left' }} mr-2"></i> <span>{{ link_item.name }}</span> </a>
                                </div>
                            {% endfor %}
                        </div>
                        {% if not forloop.last %}
                            <hr class="my-3"> {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-0.1s" id="accordionBudgetOverview"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingBudgetOverview" style="background: linear-gradient(45deg, var(--info-color), #5dade2);"> <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseBudgetOverview" aria-expanded="true"
                        aria-controls="collapseBudgetOverview"> <i class="fas fa-chart-pie mr-2"></i>{% translate "خلاصه وضعیت بودجه (ریال)" %} </button>
            </h2>
            <div id="collapseBudgetOverview" class="accordion-collapse collapse show"
                 aria-labelledby="headingBudgetOverview"
                 data-bs-parent="#accordionBudgetOverview"> <div class="accordion-body"> {% if budget_stats_permission_denied %} <div class="alert alert-warning"> <i class="fas fa-exclamation-triangle mr-2"></i>{% translate "شما اجازه دسترسی به آمار بودجه را ندارید." %} </div>
                    {% elif budget_stats_error %}
                         <div class="alert alert-danger">
                            <i class="fas fa-times-circle mr-2"></i>{% translate "خطا در بارگذاری آمار بودجه." %}
                        </div>
                    {% else %}
                        <div class="row text-center">
                            <div class="col-md-3 mb-3"> <div class="metric-box animate__animated animate__fadeInDown"> <i class="fas fa-coins icon" style="color: var(--info-color);"></i> <div class="card-value" style="color: var(--info-color);"> <span class="num-format">{{ total_allocated_budget|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "کل بودجه تخصیص یافته" %}</p> </div>
                            </div>
                            <div class="col-md-3 mb-3"> <div class="metric-box animate__animated animate__fadeInDown animate__delay-0.1s"> <i class="fas fa-money-bill-wave icon" style="color: var(--success-color);"></i> <div class="card-value" style="color: var(--success-color);"> <span class="num-format">{{ total_consumed_budget|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "کل بودجه مصرف شده" %}</p> </div>
                            </div>
                            <div class="col-md-3 mb-3"> <div class="metric-box animate__animated animate__fadeInDown animate__delay-0.2s"> <i class="fas fa-wallet icon" style="color: var(--danger-color);"></i> <div class="card-value" style="color: var(--danger-color);"> <span class="num-format">{{ remaining_total_budget|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "بودجه باقی‌مانده کل" %}</p> </div>
                            </div>
                            <div class="col-md-3 mb-3"> <div class="metric-box animate__animated animate__fadeInDown animate__delay-0.3s"> <i class="fas fa-percent icon" style="color: var(--warning-color);"></i> <div class="card-value" style="color: var(--warning-color);"> {{ percentage_consumed_budget|default:0|floatformat:2|format_negative }}%
                                    </div>
                                    <p class="card-text">{% translate "درصد مصرف بودجه" %}</p> </div>
                            </div>
                        </div>
                        <div class="row text-center mt-4"> <div class="col-md-4 mb-3"> <div class="metric-box animate__animated animate__fadeInUp"> <i class="fas fa-calendar-check icon"></i> <div class="card-value" style="font-size: 2em; color: var(--dark-text);"> {{ active_budget_periods_count|default:0|format_negative }}
                                    </div>
                                    <p class="card-text">{% translate "دوره‌های بودجه فعال" %}</p> </div>
                            </div>
                            <div class="col-md-4 mb-3"> <div class="metric-box animate__animated animate__fadeInUp animate__delay-0.1s"> <i class="fas fa-sitemap icon"></i> <div class="card-value" style="font-size: 2em; color: var(--dark-text);"> {{ active_budget_allocations_count|default:0|format_negative }}
                                    </div>
                                    <p class="card-text">{% translate "تخصیص‌های بودجه فعال" %}</p> </div>
                            </div>
                            <div class="col-md-4 mb-3"> <div class="metric-box animate__animated animate__fadeInUp animate__delay-0.2s"> <i class="fas fa-project-diagram icon"></i> <div class="card-value" style="font-size: 2em; color: var(--dark-text);"> {{ active_cost_centers_count|default:0|format_negative }} {# یا active_projects_with_budget_count #} </div>
                                    <p class="card-text">{% translate "مراکز هزینه/پروژه فعال با بودجه" %}</p> </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-0.2s" id="accordionTankhahOverview"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingTankhahOverview" style="background: linear-gradient(45deg, var(--success-color), #27ae60);"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTankhahOverview" aria-expanded="false"
                        aria-controls="collapseTankhahOverview"> <i class="fas fa-file-invoice-dollar mr-2"></i>{% translate "خلاصه وضعیت تنخواه (ریال)" %} </button>
            </h2>
            <div id="collapseTankhahOverview" class="accordion-collapse collapse"
                 aria-labelledby="headingTankhahOverview"
                 data-bs-parent="#accordionTankhahOverview"> <div class="accordion-body"> {% if tankhah_stats_permission_denied %} <div class="alert alert-warning"> <i class="fas fa-exclamation-triangle mr-2"></i>{% translate "شما اجازه دسترسی به آمار تنخواه را ندارید." %} </div>
                    {% elif tankhah_stats_error %}
                         <div class="alert alert-danger">
                            <i class="fas fa-times-circle mr-2"></i>{% translate "خطا در بارگذاری آمار تنخواه." %}
                        </div>
                    {% else %}
                        <div class="row text-center">
                            <div class="col-md-3 col-6 mb-3"> <div class="metric-box animate__animated animate__fadeInLeft"> <i class="fas fa-tasks icon" style="color: var(--success-color);"></i> <div class="card-value" style="color: var(--success-color);"> {{ active_tankhah_count|default:0|format_negative }}
                                    </div>
                                    <p class="card-text">{% translate "تنخواه‌های در جریان" %}</p> </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3"> <div class="metric-box animate__animated animate__fadeInLeft animate__delay-0.1s"> <i class="fas fa-calendar-day icon" style="color: var(--info-color);"></i> <div class="card-value" style="color: var(--info-color);"> <span class="num-format">{{ current_month_total_amount|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "مبلغ فاکتورهای پرداخت شده ماه جاری" %}</p> </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3"> <div class="metric-box animate__animated animate__fadeInLeft animate__delay-0.2s"> <i class="fas fa-hourglass-half icon" style="color: var(--warning-color);"></i> <div class="card-value" style="color: var(--warning-color);"> {{ pending_approval_count|default:0|format_negative }}
                                    </div>
                                    <p class="card-text">{% translate "تنخواه‌های در انتظار تایید" %}</p> </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3"> <div class="metric-box animate__animated animate__fadeInLeft animate__delay-0.3s"> <i class="fas fa-ban icon" style="color: var(--danger-color);"></i> <div class="card-value" style="color: var(--danger-color);"> {{ recent_rejected_factors|default:0|format_negative }}
                                    </div>
                                    <p class="card-text">{% translate "فاکتورهای رد شده (۹۰ روز اخیر)" %}</p> </div>
                            </div>
                        </div>
                         <div class="row text-center mt-4"> <div class="col-md-4 mb-3"> <div class="metric-box animate__animated animate__fadeInRight"> <i class="fas fa-hand-holding-usd icon"></i> <div class="card-value" style="font-size: 2em; color: var(--dark-text);"> <span class="num-format">{{ total_allocated_tankhah|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "کل تنخواه تخصیص یافته" %}</p> </div>
                            </div>
                            <div class="col-md-4 mb-3"> <div class="metric-box animate__animated animate__fadeInRight animate__delay-0.1s"> <i class="fas fa-receipt icon"></i> <div class="card-value" style="font-size: 2em; color: var(--dark-text);"> <span class="num-format">{{ total_spent_on_factors|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "کل مبلغ مصرف شده در فاکتورها" %}</p> </div>
                            </div>
                            <div class="col-md-4 mb-3"> <div class="metric-box animate__animated animate__fadeInRight animate__delay-0.2s"> <i class="fas fa-funnel-dollar icon"></i> <div class="card-value" style="font-size: 2em; color: var(--dark-text);"> <span class="num-format">{{ total_unspent_tankhah|default:0|floatformat:0|format_negative }}</span> </div>
                                    <p class="card-text">{% translate "کل تنخواه مصرف نشده" %}</p> </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-0.3s" id="accordionCharts"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingCharts" style="background: linear-gradient(45deg, #FF6F61, #DE4B4B);"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseCharts" aria-expanded="false" aria-controls="collapseCharts"> <i class="fas fa-chart-area mr-2"></i>{% translate "نمودارهای تحلیلی" %} </button>
            </h2>
            <div id="collapseCharts" class="accordion-collapse collapse" aria-labelledby="headingCharts"
                 data-bs-parent="#accordionCharts"> <div class="accordion-body"> <div class="row">
                        <div class="col-lg-6 mb-4"> <div class="dashboard-card p-3"> <h5 class="text-center">{% translate "مصرف بودجه بر اساس دسته" %}</h5>
                                {% if budget_stats_permission_denied %} <div class="alert alert-warning">{% translate "شما اجازه دسترسی به این نمودار را ندارید." %}</div> {% else %}
                                    <div class="chart-container"> <canvas id="budgetCategoryChart"></canvas> </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4"> <div class="dashboard-card p-3"> <h5 class="text-center">{% translate "بودجه تخصیص‌یافته در مقابل مصرف‌شده (۶ ماه گذشته)" %}</h5>
                                {% if budget_stats_permission_denied %} <div class="alert alert-warning">{% translate "شما اجازه دسترسی به این نمودار را ندارید." %}</div> {% else %}
                                    <div class="chart-container"> <canvas id="budgetVsActualChart"></canvas> </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 mb-4"> <div class="dashboard-card p-3"> <h5 class="text-center">{% translate "روند تنخواه ماهانه (فاکتورهای پرداخت شده)" %}</h5>
                                {% if tankhah_stats_permission_denied %} <div class="alert alert-warning">{% translate "شما اجازه دسترسی به این نمودار را ندارید." %}</div> {% else %}
                                    <div class="chart-container"> <canvas id="monthlyTankhahChart"></canvas> </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4"> <div class="dashboard-card p-3"> <h5 class="text-center">{% translate "روند تنخواه فصلی (فاکتورهای پرداخت شده)" %}</h5>
                                {% if tankhah_stats_permission_denied %} <div class="alert alert-warning">{% translate "شما اجازه دسترسی به این نمودار را ندارید." %}</div> {% else %}
                                    <div class="chart-container"> <canvas id="quarterlyTankhahChart"></canvas> </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-lg-12 mb-4">
                            <div class="dashboard-card p-3">
                                <h5 class="text-center">{% translate "وضعیت بودجه پروژه‌ها" %}</h5>
                                {% if project_status_permission_denied %}
                                    <div class="alert alert-warning">{% translate "شما اجازه دسترسی به این نمودار را ندارید." %}</div>
                                {% else %}
                                    <div class="chart-container">
                                        <canvas id="projectBudgetChart"></canvas> </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-0.4s" id="accordionProjectStatus"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingProjectStatus" style="background: linear-gradient(45deg, #FFA07A, #FA8072);"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseProjectStatus" aria-expanded="false"
                        aria-controls="collapseProjectStatus"> <i class="fas fa-tasks mr-2"></i>{% translate "وضعیت بودجه پروژه‌ها (ریال)" %} </button>
            </h2>
            <div id="collapseProjectStatus" class="accordion-collapse collapse"
                 aria-labelledby="headingProjectStatus"
                 data-bs-parent="#accordionProjectStatus"> <div class="accordion-body"> {% if project_status_permission_denied %} <div class="alert alert-warning">{% translate "شما اجازه دسترسی به وضعیت پروژه‌ها را ندارید." %}</div> {% else %}
                        <ul class="list-group list-group-flush"> {% for project_item in project_budget_status %}
                                <li class="list-group-item animate__animated animate__fadeInUp"> <div class="flex-grow-1 mr-3"> <strong>{{ project_item.name }}</strong> <small class="text-muted d-block"> {% translate "مصرف:" %} <span class="num-format">{{ project_item.consumed|default:0|floatformat:0|format_negative }}</span> / {% translate "تخصیص:" %} <span class="num-format">{{ project_item.allocated|default:0|floatformat:0|format_negative }}</span> </small>
                                        <div class="progress mt-2"> {% with percentage=project_item.percentage_consumed|default:0|floatformat:2 %}
                                            <div class="progress-bar" role="progressbar"
                                                 style="width: {{ percentage }}%; background-color: {% if percentage > 85 %}var(--danger-color){% elif percentage > 60 %}var(--warning-color){% else %}var(--success-color){% endif %};"
                                                 aria-valuenow="{{ percentage }}"
                                                 aria-valuemin="0" aria-valuemax="100"></div> {% endwith %}
                                        </div>
                                    </div>
                                    <div class="text-right"> {% with percentage=project_item.percentage_consumed|default:0|floatformat:2 %}
                                        <span class="badge badge-pill"
                                              style="background-color: {% if percentage > 85 %}var(--danger-color){% elif percentage > 60 %}var(--warning-color){% else %}var(--success-color){% endif %}; color: white;"> {{ percentage|format_negative }}%
                                        </span>
                                        {% endwith %}
                                        <small class="text-muted d-block">{% translate "باقی‌مانده:" %} <span class="num-format">{{ project_item.remaining|default:0|floatformat:0|format_negative }}</span></small> </div>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-center text-muted">{% translate "اطلاعاتی برای پروژه‌ها یافت نشد." %}</li> {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-0.5s" id="accordionBudgetWarnings"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingBudgetWarnings" style="background: linear-gradient(45deg, #FF69B4, #EE82EE);"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseBudgetWarnings" aria-expanded="false"
                        aria-controls="collapseBudgetWarnings"> <i class="fas fa-bell-on mr-2"></i>{% translate "هشدارهای اخیر بودجه" %} </button>
            </h2>
            <div id="collapseBudgetWarnings" class="accordion-collapse collapse"
                 aria-labelledby="headingBudgetWarnings"
                 data-bs-parent="#accordionBudgetWarnings"> <div class="accordion-body"> {% if budget_alerts_permission_denied %} <div class="alert alert-warning">{% translate "شما اجازه دسترسی به هشدارهای بودجه را ندارید." %}</div> {% else %}
                        <ul class="list-group list-group-flush"> {% for warning_item in recent_budget_warnings %}
                                <li class="list-group-item animate__animated animate__fadeInUp"> <div> <strong><i class="fas fa-exclamation-triangle text-danger mr-2"></i>{{ warning_item.details }}</strong> <small class="text-muted d-block"> {% translate "زمان:" %} {{ warning_item.timestamp|jformat:"%Y/%m/%d %H:%M" }} - {% translate "توسط:" %} {{ warning_item.created_by.username }} </small>
                                    </div>
                                    <span class="badge badge-pill" style="background-color: var(--danger-color); color:white;">{% translate "بودجه" %}</span> </li>
                            {% empty %}
                                <li class="list-group-item text-center text-muted">{% translate "هشداری یافت نشد." %}</li> {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-0.6s" id="accordionRecentActivities"> <div class="accordion-item dashboard-card"> <h2 class="accordion-header" id="headingRecentActivities" style="background: linear-gradient(45deg, #A7D7C5, #7CC6B9);"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseRecentActivities" aria-expanded="false"
                        aria-controls="collapseRecentActivities"> <i class="fas fa-history mr-2"></i>{% translate "فعالیت‌های اخیر" %} </button>
            </h2>
            <div id="collapseRecentActivities" class="accordion-collapse collapse"
                 aria-labelledby="headingRecentActivities"
                 data-bs-parent="#accordionRecentActivities"> <div class="accordion-body"> {% if user_activity_permission_denied %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            {% translate "شما اجازه دسترسی به فعالیت‌های اخیر را ندارید." %}
                        </div>
                    {% else %}
                        <ul class="list-group list-group-flush"> {% for activity in recent_activities %}
                                <li class="list-group-item animate__animated animate__fadeInUp"> <div> <strong>
                                            {% if activity.tankhah %} {% translate "تنخواه" %} #{{ activity.tankhah.number }} {% elif activity.factor %} {% translate "فاکتور" %} #{{ activity.factor.number }} {% else %}
                                                {% translate "فعالیت نامشخص" %}
                                            {% endif %}
                                            - {{ activity.get_action_display }} </strong>
                                        <small class="text-muted d-block"> {% translate "توسط:" %} {{ activity.user.username }} - {% translate "در تاریخ:" %} {{ activity.timestamp|jformat:"%Y/%m/%d %H:%M" }} {% if activity.comment and activity.comment != "" %}
                                                <br>
                                                {% translate "نظر:" %} {{ activity.comment }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <span class="badge badge-pill" style="background-color: #6c757d; color: white;"> {% if activity.tankhah %} {% translate "تنخواه" %}
                                        {% elif activity.factor %} {% translate "فاکتور" %}
                                        {% else %}
                                            {% translate "عمومی" %}
                                        {% endif %}
                                    </span>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-center text-muted">{% translate "فعالیت اخیری یافت نشد." %}</li> {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'admin/js/chart.min.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // فرمت کردن اعداد با کاما
            function formatNumberWithCommas(x) { // [cite: 2]
                if (x === null || x === undefined) return '0';
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); // [cite: 2]
            }

            document.querySelectorAll('.num-format').forEach(function (element) { // [cite: 2]
                const rawValue = element.textContent.trim().replace(/,/g, ''); // [cite: 2]
                const value = parseFloat(rawValue); // [cite: 2]
                if (!isNaN(value)) { // [cite: 2]
                    element.textContent = formatNumberWithCommas(value); // [cite: 2]
                } else if (element.textContent.trim() === '-' || rawValue === ''){ // Handle cases like '-' or empty
                     element.textContent = '0';
                }
            });

            // تنظیمات عمومی Chart.js
            Chart.defaults.font.family = "'Vazirmatn', 'Parastoo', sans-serif"; // [cite: 2]
            Chart.defaults.color = 'var(--dark-text)'; // [cite: 2]
            Chart.defaults.borderColor = '#e0e0e0'; // [cite: 2]

            const customTooltip = { // [cite: 2]
                enabled: true,
                external: function(context) { // [cite: 2]
                    let tooltipEl = document.getElementById('chartjs-tooltip'); // [cite: 2]

                    if (!tooltipEl) { // [cite: 2]
                        tooltipEl = document.createElement('div'); // [cite: 2]
                        tooltipEl.id = 'chartjs-tooltip'; // [cite: 2]
                        tooltipEl.classList.add('chartjs-tooltip'); // [cite: 2]
                        document.body.appendChild(tooltipEl); // [cite: 2]
                    }

                    const tooltipModel = context.tooltip; // [cite: 2]
                    if (tooltipModel.opacity === 0) { // [cite: 2]
                        tooltipEl.style.opacity = 0; // [cite: 2]
                        return; // [cite: 2]
                    }

                    tooltipEl.classList.remove('above', 'below', 'no-transform');
                    if (tooltipModel.yAlign) {
                        tooltipEl.classList.add(tooltipModel.yAlign);
                    } else {
                        tooltipEl.classList.add('no-transform');
                    }

                    function getBody(bodyItem) { // [cite: 2]
                        return bodyItem.lines; // [cite: 2]
                    }

                    if (tooltipModel.body) { // [cite: 2]
                        const titleLines = tooltipModel.title || []; // [cite: 2]
                        const bodyLines = tooltipModel.body.map(getBody); // [cite: 2]

                        let innerHtml = '<div>'; // [cite: 2]

                        titleLines.forEach(function(title) { // [cite: 2]
                            innerHtml += '<h3>' + title + '</h3>'; // [cite: 2]
                        });

                        bodyLines.forEach(function(body, i) { // [cite: 2]
                            const colors = tooltipModel.labelColors[i]; // [cite: 2]
                            let style = 'background:' + colors.backgroundColor; // [cite: 2]
                            style += '; border-color:' + colors.borderColor;
                            style += '; border-width: 2px';
                            const span = '<span class="chartjs-tooltip-key" style="' + style + '"></span>'; // [cite: 2]
                            innerHtml += '<p>' + span + body + '</p>'; // [cite: 2]
                        });
                        innerHtml += '</div>'; // [cite: 2]

                        tooltipEl.innerHTML = innerHtml; // [cite: 2]
                    }

                    const position = context.chart.canvas.getBoundingClientRect(); // [cite: 2]
                    tooltipEl.style.opacity = 1; // [cite: 2]
                    tooltipEl.style.position = 'absolute'; // [cite: 2]
                    tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px'; // [cite: 2]
                    tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px'; // [cite: 2]
                    tooltipEl.style.font = tooltipModel.options.bodyFont.string;
                    tooltipEl.style.padding = tooltipModel.padding + 'px ' + tooltipModel.padding + 'px';
                    tooltipEl.style.pointerEvents = 'none'; // [cite: 2]
                    tooltipEl.style.transform = 'translate(-50%, -100%)'; // Adjust based on caret position
                }
            };


            // پالت رنگی
            const vividColors = [ // [cite: 2]
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                '#E63946', '#F1FAEE', '#A8DADC', '#457B9D', '#1D3557', '#F4A261'
            ];
            const vividColorsTransparent = vividColors.map(color => // [cite: 2]
                color.startsWith('rgba') ? color.replace(/,\s*\d?\.?\d*\s*\)/, ', 0.7)') : color.replace('#', 'rgba(') + parseInt(color.substring(1,3),16) + ',' + parseInt(color.substring(3,5),16) + ',' + parseInt(color.substring(5,7),16) + ', 0.7)'
            );
             const vividColorsLight = vividColors.map(color => // [cite: 2]
                color.startsWith('rgba') ? color.replace(/,\s*\d?\.?\d*\s*\)/, ', 0.2)') : color.replace('#', 'rgba(') + parseInt(color.substring(1,3),16) + ',' + parseInt(color.substring(3,5),16) + ',' + parseInt(color.substring(5,7),16) + ', 0.2)'
            );


            function createChart(canvasId, type, labels, datasets, options = {}) { // [cite: 2]
                const ctx = document.getElementById(canvasId); // [cite: 2]
                if (!ctx) { // [cite: 2]
                    console.warn(`Canvas element with ID '${canvasId}' not found. Skipping chart creation.`); // [cite: 2]
                    return null; // [cite: 2]
                }
                // برای جلوگیری از ایجاد چندباره چارت روی یک canvas
                if (Chart.getChart(ctx)) {
                    Chart.getChart(ctx).destroy();
                }
                try {
                    return new Chart(ctx.getContext('2d'), { // [cite: 2]
                        type: type, // [cite: 2]
                        data: { // [cite: 2]
                            labels: labels, // [cite: 2]
                            datasets: datasets.map((ds, index) => ({
                                ...ds,
                                backgroundColor: ds.backgroundColor || vividColorsTransparent[index % vividColorsTransparent.length],
                                borderColor: ds.borderColor || vividColors[index % vividColors.length],
                                borderWidth: ds.borderWidth === undefined ? 1 : ds.borderWidth,
                            }))
                        },
                        options: { // [cite: 2]
                            responsive: true, // [cite: 2]
                            maintainAspectRatio: false, // [cite: 2]
                            animation: { // [cite: 2]
                                duration: 1000, // [cite: 2]
                                easing: 'easeOutQuart' // [cite: 2]
                            },
                            plugins: { // [cite: 2]
                                legend: { // [cite: 2]
                                    position: 'top', // [cite: 2]
                                    labels: { font: { size: 12 } } // [cite: 2]
                                },
                                title: { // [cite: 2]
                                    display: !!options.titleText, // [cite: 2]
                                    text: options.titleText || '', // [cite: 2]
                                    font: { size: 16, weight: 'bold' }, // [cite: 2]
                                    color: 'var(--dark-text)' // [cite: 2]
                                },
                                tooltip: customTooltip, // [cite: 2]
                                datalabels: { // [cite: 2]
                                   display: options.datalabelsDisplay === undefined ? false : options.datalabelsDisplay, // [cite: 2]
                                    color: '#fff', // [cite: 2]
                                    font: { weight: 'bold' }, // [cite: 2]
                                    formatter: (value, context) => { // [cite: 2]
                                        if (type === 'doughnut' || type === 'pie') {
                                            let sum = context.chart.data.datasets[0].data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0); // [cite: 2]
                                            if (sum === 0) return '0%'; // [cite: 2]
                                            let percentage = (parseFloat(value) * 100 / sum).toFixed(1) + "%"; // [cite: 2]
                                            return percentage; // [cite: 2]
                                        }
                                        return formatNumberWithCommas(parseFloat(value)); // [cite: 2]
                                    }
                                }
                            },
                            scales: options.scales || {}, // [cite: 2]
                            ...(options.extraOptions || {}) // [cite: 2]
                        }
                    });
                } catch (e) {
                    console.error("Error creating chart:", canvasId, e);
                    return null;
                }
            }
            // رندر دوباره چارت‌ها وقتی accordion باز/بسته می‌شود
            document.querySelectorAll('.accordion-collapse').forEach(function (collapseEl) { // [cite: 2]
                collapseEl.addEventListener('shown.bs.collapse', function () { // [cite: 2]
                    if (this.id === 'collapseCharts') { // [cite: 2]
                        console.log("Charts accordion opened, attempting to resize charts."); // [cite: 2]
                        // دسترسی به همه نمونه‌های چارت و تغییر اندازه آنها
                        for(var id in Chart.instances){
                            Chart.instances[id].resize();
                        }
                    }
                });
            });


            // چارت وضعیت بودجه پروژه‌ها
            {% if can_view_project_status and project_chart_data.labels and project_chart_data.allocated and project_chart_data.consumed %} try {
                    const projectChartLabels = JSON.parse('{{ project_chart_data.labels|escapejs }}'); // [cite: 2]
                    const projectChartAllocated = JSON.parse('{{ project_chart_data.allocated|escapejs }}'); // [cite: 2]
                    const projectChartConsumed = JSON.parse('{{ project_chart_data.consumed|escapejs }}'); // [cite: 2]
                    const projectChartRemaining = JSON.parse('{{ project_chart_data.remaining|escapejs }}'); // [cite: 2]

                    if (projectChartLabels.length > 0) { // [cite: 2]
                        createChart('projectBudgetChart', 'bar', projectChartLabels, [ // [cite: 2]
                            { label: '{% translate "تخصیص‌یافته" %}', data: projectChartAllocated, backgroundColor: vividColorsTransparent[0], borderColor: vividColors[0] }, // [cite: 2]
                            { label: '{% translate "مصرف‌شده" %}', data: projectChartConsumed, backgroundColor: vividColorsTransparent[1], borderColor: vividColors[1] }, // [cite: 2]
                           // { label: '{% translate "باقی‌مانده" %}', data: projectChartRemaining, backgroundColor: vividColorsTransparent[2], borderColor: vividColors[2] } // [cite: 2]
                        ], {
                            titleText: '{% translate "وضعیت بودجه پروژه‌ها" %}', // [cite: 2]
                            scales: { // [cite: 2]
                                x: { title: { display: true, text: '{% translate "پروژه" %}' } }, // [cite: 2]
                                y: { beginAtZero: true, title: { display: true, text: '{% translate "مبلغ (ریال)" %}' }, ticks: { callback: value => formatNumberWithCommas(value) } } // [cite: 2]
                            }
                        });
                    } else { console.warn("Project chart data is empty."); } // [cite: 2]
                } catch (e) { console.error("Error parsing or rendering project chart:", e); }
            {% else %}
                console.warn("Project status permission denied or data missing for project chart."); // [cite: 2]
            {% endif %}


            // چارت مصرف بودجه بر اساس دسته
            {% if can_view_budget_stats and budget_category_consumption.labels and budget_category_consumption.values %} try {
                    const budgetCategoryLabels = JSON.parse('{{ budget_category_consumption.labels|escapejs }}'); // [cite: 2]
                    const budgetCategoryValues = JSON.parse('{{ budget_category_consumption.values|escapejs }}'); // [cite: 2]
                    if (budgetCategoryLabels.length > 0 && budgetCategoryValues.length > 0) { // [cite: 2]
                        createChart('budgetCategoryChart', 'doughnut', budgetCategoryLabels, [{ // [cite: 2]
                            data: budgetCategoryValues, // [cite: 2]
                            // backgroundColor: vividColorsTransparent.slice(0, budgetCategoryLabels.length), // [cite: 2]
                            // borderColor: 'var(--light-bg)', // [cite: 2]
                            // borderWidth: 2 // [cite: 2]
                        }], {
                            titleText: '{% translate "مصرف بودجه بر اساس دسته" %}', // [cite: 2]
                            datalabelsDisplay: true // [cite: 2]
                        });
                    } else { console.warn("Budget category chart data is empty.");} // [cite: 2]
                } catch (e) { console.error("Error parsing or rendering budget category chart:", e); }
            {% else %}
                console.warn("Budget stats permission denied or data missing for budget category chart."); // [cite: 2]
            {% endif %}

            // چارت بودجه تخصیص‌یافته در مقابل مصرف‌شده
            {% if can_view_budget_stats and budget_vs_actual_data.labels and budget_vs_actual_data.allocated and budget_vs_actual_data.consumed %} try {
                    const budgetVsActualLabels = JSON.parse('{{ budget_vs_actual_data.labels|escapejs }}'); // [cite: 2]
                    const budgetVsActualAllocated = JSON.parse('{{ budget_vs_actual_data.allocated|escapejs }}'); // [cite: 2]
                    const budgetVsActualConsumed = JSON.parse('{{ budget_vs_actual_data.consumed|escapejs }}'); // [cite: 2]
                    if (budgetVsActualLabels.length > 0) { // [cite: 2]
                        createChart('budgetVsActualChart', 'bar', budgetVsActualLabels, [ // [cite: 2]
                            { label: '{% translate "تخصیص‌یافته" %}', data: budgetVsActualAllocated, backgroundColor: vividColorsTransparent[3], borderColor: vividColors[3] }, // [cite: 2]
                            { label: '{% translate "مصرف‌شده" %}', data: budgetVsActualConsumed, backgroundColor: vividColorsTransparent[4], borderColor: vividColors[4] } // [cite: 2]
                        ], {
                            titleText: '{% translate "بودجه تخصیص‌یافته در مقابل مصرف‌شده (۶ ماه گذشته)" %}', // [cite: 2]
                            scales: { // [cite: 2]
                                x: { title: { display: true, text: '{% translate "ماه" %}' } }, // [cite: 2]
                                y: { beginAtZero: true, title: { display: true, text: '{% translate "مبلغ (ریال)" %}' }, ticks: { callback: value => formatNumberWithCommas(value) } } // [cite: 2]
                            }
                        });
                    } else { console.warn("Budget vs actual chart data is empty."); } // [cite: 2]
                } catch (e) { console.error("Error parsing or rendering budget vs actual chart:", e); }
            {% else %}
                console.warn("Budget stats permission denied or data missing for budget vs actual chart."); // [cite: 2]
            {% endif %}

            // چارت تنخواه ماهانه
            {% if can_view_tankhah_stats and monthly_report_data.labels and monthly_report_data.values %} try {
                    const monthlyTankhahLabels = JSON.parse('{{ monthly_report_data.labels|escapejs }}'); // [cite: 2]
                    const monthlyTankhahValues = JSON.parse('{{ monthly_report_data.values|escapejs }}'); // [cite: 2]
                    if (monthlyTankhahLabels.length > 0) { // [cite: 2]
                        createChart('monthlyTankhahChart', 'line', monthlyTankhahLabels, [{ // [cite: 2]
                            label: '{% translate "مبلغ فاکتورهای پرداخت‌شده" %}', // [cite: 2]
                            data: monthlyTankhahValues, // [cite: 2]
                            borderColor: vividColors[5], // [cite: 2]
                            backgroundColor: vividColorsLight[5], // [cite: 2]
                            fill: true, // [cite: 2]
                            tension: 0.3 // [cite: 2]
                        }], {
                            titleText: '{% translate "روند تنخواه ماهانه" %}', // [cite: 2]
                            scales: { // [cite: 2]
                                x: { title: { display: true, text: '{% translate "ماه" %}' } }, // [cite: 2]
                                y: { beginAtZero: true, title: { display: true, text: '{% translate "مبلغ (ریال)" %}' }, ticks: { callback: value => formatNumberWithCommas(value) } } // [cite: 2]
                            }
                        });
                    } else { console.warn("Monthly tankhah chart data is empty."); } // [cite: 2]
                } catch(e) { console.error("Error parsing or rendering monthly tankhah chart:", e); }
            {% else %}
                console.warn("Tankhah stats permission denied or data missing for monthly tankhah chart."); // [cite: 2]
            {% endif %}

            // چارت تنخواه فصلی
            {% if can_view_tankhah_stats and quarterly_report_data.labels and quarterly_report_data.values %} try {
                    const quarterlyTankhahLabels = JSON.parse('{{ quarterly_report_data.labels|escapejs }}'); // [cite: 2]
                    const quarterlyTankhahValues = JSON.parse('{{ quarterly_report_data.values|escapejs }}'); // [cite: 2]
                    if (quarterlyTankhahLabels.length > 0 ) { // [cite: 2]
                        createChart('quarterlyTankhahChart', 'bar', quarterlyTankhahLabels, [{ // [cite: 2]
                            label: '{% translate "مبلغ فاکتورهای پرداخت‌شده" %}', // [cite: 2]
                            data: quarterlyTankhahValues, // [cite: 2]
                           // backgroundColor: vividColorsTransparent[6], // [cite: 2]
                           // borderColor: vividColors[6], // [cite: 2]
                           // borderWidth: 1 // [cite: 2]
                        }], {
                            titleText: '{% translate "روند تنخواه فصلی" %}', // [cite: 2]
                            scales: { // [cite: 2]
                                x: { title: { display: true, text: '{% translate "فصل" %}' } }, // [cite: 2]
                                y: { beginAtZero: true, title: { display: true, text: '{% translate "مبلغ (ریال)" %}' }, ticks: { callback: value => formatNumberWithCommas(value) } } // [cite: 2]
                            }
                        });
                    } else { console.warn("Quarterly tankhah chart data is empty."); } // [cite: 2]
                } catch(e) { console.error("Error parsing or rendering quarterly tankhah chart:", e); }
            {% else %}
                console.warn("Tankhah stats permission denied or data missing for quarterly tankhah chart."); // [cite: 2]
            {% endif %}
        });
    </script>
{% endblock %}

{#{% extends 'base.html' %}#}
{#{% load i18n static jformat  rcms_custom_filters jalali_tags %}#}
{##}
{#{% block extra_head %}#}
{##}
{#    <style>#}
{#        @font-face {#}
{#            font-family: 'Parastoo';#}
{#            src: url('{% static 'admin/fonts/Parastoo.woff2' %}') format('woff2');#}
{#            font-weight: normal;#}
{#            font-style: normal;#}
{#        }#}
{##}
{#        body {#}
{#            font-family: 'Parastoo', sans-serif;#}
{#            background-color: #f0f2f5; /* Light grey background */#}
{#            color: #333;#}
{#        }#}
{##}
{#        :root {#}
{#            --primary-color: #6a0572; /* Deep Purple */#}
{#            --secondary-color: #892cdc; /* Medium Purple */#}
{#            --success-color: #2ecc71; /* Emerald Green */#}
{#            --info-color: #3498db; /* Peter River Blue */#}
{#            --warning-color: #f1c40f; /* Sunflower Yellow */#}
{#            --danger-color: #e74c3c; /* Alizarin Red */#}
{#            --light-bg: #ffffff;#}
{#            --dark-text: #2c3e50;#}
{#            --shadow: 0 8px 16px rgba(0, 0, 0, 0.1);#}
{#            --hover-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);#}
{#            --border-radius: 12px;#}
{#        }#}
{##}
{#        .dashboard-card {#}
{#            background-color: var(--light-bg);#}
{#            border-radius: var(--border-radius);#}
{#            box-shadow: var(--shadow);#}
{#            margin-bottom: 30px;#}
{#            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);#}
{#            border: none; /* Remove default bootstrap border */#}
{#        }#}
{##}
{#        .dashboard-card:hover {#}
{#            transform: translateY(-8px);#}
{#            box-shadow: var(--hover-shadow);#}
{#        }#}
{##}
{#        .dashboard-card .card-header {#}
{#            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));#}
{#            color: white;#}
{#            border-top-left-radius: var(--border-radius);#}
{#            border-top-right-radius: var(--border-radius);#}
{#            padding: 18px 25px;#}
{#            margin: -25px -25px 20px -25px; /* Pull header into negative margin */#}
{#            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);#}
{#            position: relative;#}
{#            z-index: 1;#}
{#            font-weight: 700;#}
{#            font-size: 1.1em;#}
{#            cursor: pointer; /* Indicate it's clickable */#}
{#        }#}
{##}
{#        /* Specific styling for accordion header */#}
{#        .accordion-item .accordion-header {#}
{#            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));#}
{#            color: white;#}
{#            border-radius: var(--border-radius); /* Full border-radius when collapsed */#}
{#            padding: 18px 25px;#}
{#            box-shadow: var(--shadow);#}
{#            position: relative;#}
{#            z-index: 1;#}
{#            font-weight: 700;#}
{#            font-size: 1.1em;#}
{#            cursor: pointer;#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .accordion-item .accordion-header:hover {#}
{#            opacity: 0.9;#}
{#        }#}
{##}
{#        .accordion-item .accordion-header.collapsed {#}
{#            border-bottom-left-radius: var(--border-radius);#}
{#            border-bottom-right-radius: var(--border-radius);#}
{#        }#}
{##}
{#        .accordion-item .accordion-button {#}
{#            background-color: transparent;#}
{#            color: inherit;#}
{#            box-shadow: none;#}
{#            padding: 0;#}
{#            font-size: 1.1em;#}
{#            font-weight: 700;#}
{#            border: none;#}
{#            text-align: right; /* For RTL */#}
{#            flex-direction: row-reverse; /* For RTL icon alignment */#}
{#        }#}
{##}
{#        .accordion-item .accordion-button:not(.collapsed) {#}
{#            background-color: transparent;#}
{#            color: inherit;#}
{#            box-shadow: none;#}
{#        }#}
{##}
{#        .accordion-item .accordion-button::after {#}
{#            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");#}
{#            transform: rotate(-90deg); /* Initial state for RTL (arrow pointing left) */#}
{#            transition: transform 0.2s ease-in-out;#}
{#            margin-left: 0; /* Adjust margin for RTL */#}
{#            margin-right: 0.5rem; /* Space between text and icon for RTL */#}
{#        }#}
{##}
{#        .accordion-item .accordion-button:not(.collapsed)::after {#}
{#            transform: rotate(0deg); /* Rotated state for RTL (arrow pointing down) */#}
{#        }#}
{##}
{#        .accordion-item .accordion-body {#}
{#            padding: 25px;#}
{#            background-color: var(--light-bg);#}
{#            border-bottom-left-radius: var(--border-radius);#}
{#            border-bottom-right-radius: var(--border-radius);#}
{#            box-shadow: var(--shadow);#}
{#            margin-top: -20px; /* Overlap with header slightly */#}
{#            position: relative;#}
{#            z-index: 0;#}
{#        }#}
{##}
{#        .dashboard-card h5 {#}
{#            color: var(--dark-text);#}
{#            margin-bottom: 15px;#}
{#            font-weight: 700;#}
{#        }#}
{##}
{#        .dashboard-card .card-value {#}
{#            font-size: 3em;#}
{#            font-weight: bold;#}
{#            color: var(--primary-color);#}
{#            line-height: 1.2;#}
{#            animation: fadeInDown 0.8s ease-out;#}
{#        }#}
{##}
{#        .dashboard-card .card-text {#}
{#            color: #777;#}
{#            font-size: 1em;#}
{#            margin-top: 5px;#}
{#        }#}
{##}
{#        .metric-box {#}
{#            background-color: #f7f7f7;#}
{#            border-radius: 10px;#}
{#            padding: 20px;#}
{#            text-align: center;#}
{#            transition: all 0.3s ease;#}
{#            border: 1px solid #eee;#}
{#        }#}
{##}
{#        .metric-box:hover {#}
{#            background-color: #e9ecef;#}
{#            transform: scale(1.02);#}
{#        }#}
{##}
{#        .metric-box .icon {#}
{#            font-size: 2.2em;#}
{#            margin-bottom: 10px;#}
{#            color: var(--primary-color);#}
{#        }#}
{##}
{#        .chart-container {#}
{#            position: relative;#}
{#            height: 350px; /* Adjusted for better look */#}
{#            width: 100%;#}
{#            padding: 10px;#}
{#            box-sizing: border-box;#}
{#        }#}
{##}
{#        .list-group-item {#}
{#            display: flex;#}
{#            justify-content: space-between;#}
{#            align-items: center;#}
{#            padding: 12px 20px;#}
{#            border-bottom: 1px solid #e9ecef;#}
{#            transition: background-color 0.3s ease;#}
{#        }#}
{##}
{#        .list-group-item:hover {#}
{#            background-color: #f8f9fa;#}
{#        }#}
{##}
{#        .list-group-item:last-child {#}
{#            border-bottom: none;#}
{#        }#}
{##}
{#        .list-group-item strong {#}
{#            color: var(--dark-text);#}
{#        }#}
{##}
{#        .list-group-item small {#}
{#            color: #888;#}
{#        }#}
{##}
{#        .badge {#}
{#            font-size: 0.85em;#}
{#            padding: 0.5em 0.8em;#}
{#            border-radius: 50px;#}
{#            font-weight: 600;#}
{#        }#}
{##}
{#        .progress {#}
{#            height: 10px;#}
{#            border-radius: 5px;#}
{#            background-color: #e9ecef;#}
{#            margin-top: 8px;#}
{#        }#}
{##}
{#        .progress-bar {#}
{#            border-radius: 5px;#}
{#            transition: width 0.6s ease-in-out;#}
{#        }#}
{##}
{#        .alert {#}
{#            border-radius: var(--border-radius);#}
{#            animation: fadeIn 0.5s ease-out;#}
{#        }#}
{##}
{#        .btn-outline-primary {#}
{#            color: var(--primary-color);#}
{#            border-color: var(--primary-color);#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .btn-outline-primary:hover {#}
{#            background-color: var(--primary-color);#}
{#            color: white;#}
{#            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);#}
{#            transform: translateY(-2px);#}
{#        }#}
{##}
{#        .btn-sm-outline-light { /* For quick links toggle */#}
{#            border-color: rgba(255, 255, 255, 0.5);#}
{#            color: white;#}
{#        }#}
{##}
{#        .btn-sm-outline-light:hover {#}
{#            background-color: rgba(255, 255, 255, 0.2);#}
{#            color: white;#}
{#            border-color: white;#}
{#        }#}
{##}
{#        /* Chart.js specific styling */#}
{#        .chartjs-tooltip {#}
{#            opacity: 1;#}
{#            position: absolute;#}
{#            background: rgba(0, 0, 0, 0.7);#}
{#            color: white;#}
{#            border-radius: 4px;#}
{#            padding: 8px;#}
{#            font-family: 'Vazirmatn', sans-serif;#}
{#            pointer-events: none;#}
{#            transition: all 0.1s ease;#}
{#        }#}
{##}
{#        .chartjs-tooltip-key {#}
{#            display: inline-block;#}
{#            width: 10px;#}
{#            height: 10px;#}
{#            margin-right: 8px;#}
{#            border-radius: 50%;#}
{#        }#}
{##}
{#        /* Responsive adjustments */#}
{#        @media (max-width: 768px) {#}
{#            .dashboard-card .card-value {#}
{#                font-size: 2.5em;#}
{#            }#}
{##}
{#            .dashboard-card .card-header {#}
{#                font-size: 1em;#}
{#                padding: 15px 20px;#}
{#            }#}
{##}
{#            .metric-box {#}
{#                padding: 15px;#}
{#            }#}
{#        }#}
{##}
{#        .chartjs-tooltip {#}
{#            position: absolute;#}
{#            background: rgba(0, 0, 0, 0.8);#}
{#            color: white;#}
{#            border-radius: 4px;#}
{#            padding: 10px;#}
{#            pointer-events: none;#}
{#            z-index: 1000;#}
{#            font-family: 'Vazirmatn', sans-serif;#}
{#        }#}
{##}
{#        .chartjs-tooltip h3 {#}
{#            margin: 0 0 5px;#}
{#            font-size: 14px;#}
{#        }#}
{##}
{#        .chartjs-tooltip p {#}
{#            margin: 0;#}
{#            display: flex;#}
{#            align-items: center;#}
{#            font-size: 12px;#}
{#        }#}
{##}
{#        .chartjs-tooltip-key {#}
{#            width: 10px;#}
{#            height: 10px;#}
{#            margin-left: 5px;#}
{#            display: inline-block;#}
{#        }#}
{##}
{#        .chart-container {#}
{#            position: relative;#}
{#            height: 300px;#}
{#            width: 100%;#}
{#        }#}
{##}
{#        .dashboard-card {#}
{#            background: var(--light-bg);#}
{#            border-radius: 8px;#}
{#            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);#}
{#        }#}
{##}
{#        .stat-card {#}
{#            text-align: center;#}
{#            padding: 20px;#}
{#            border-radius: 8px;#}
{#            background: #fff;#}
{#            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);#}
{#        }#}
{##}
{#        .stat-card h4 {#}
{#            font-size: 1.2rem;#}
{#            margin-bottom: 10px;#}
{#        }#}
{##}
{#        .stat-card .stat-value {#}
{#            font-size: 1.8rem;#}
{#            font-weight: bold;#}
{#            color: var(--primary);#}
{#        }#}
{#    </style>#}
{#        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.min.js"></script>#}
{# <script src="{% static 'admin/js/chart.min.js' %}"></script>#}
{#{% endblock %}#}
{##}
{#{% block content %}#}
{#    <div class="container-fluid mt-4">#}
{#    <h2 class="mb-4 text-center animate__animated animate__fadeInDown">#}
{#        <i class="fas fa-chart-line text-primary mr-2"></i>{% translate "داشبورد مدیریت تنخواه و بودجه" %}#}
{#        <small class="text-muted ml-2" style="font-size: 0.6em;">v. {{ version }}</small>#}
{#    </h2>#}
{##}
{#    {% if messages %}#}
{#        <div class="row">#}
{#            <div class="col-12">#}
{#                {% for message in messages %}#}
{#                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show animate__animated animate__fadeIn"#}
{#                         role="alert">#}
{#                        {{ message }}#}
{#                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">#}
{#                            <span aria-hidden="true">&times;</span>#}
{#                        </button>#}
{#                    </div>#}
{#                {% endfor %}#}
{#                </div>#}
{#            </div>#}
{#    {% endif %}#}
{#    <!--   اعلان ها-->#}
{#        {% if notifications %}#}
{#            <div class="alert alert-info">#}
{#                <h5>{% trans "اعلان‌های جدید" %} ({{ unread_count }})</h5>#}
{#                <ul>#}
{#                    {% for notification in notifications %}#}
{#                        <li>{{ notification.actor }} {{ notification.verb }} ({{ notification.timestamp|jformat:"%Y/%m/%d %H:%M" }})</li>#}
{#                    {% endfor %}#}
{#                </ul>#}
{#            </div>#}
{#        {% endif %}#}
{#    <!-- دسترسی‌های سریع-->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp" id="accordionQuickLinks">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingQuickLinks">#}
{#                <button class="accordion-button" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseQuickLinks" aria-expanded="true"#}
{#                        aria-controls="collapseQuickLinks">#}
{#                    <i class="fas fa-th-list mr-2"></i>{% translate "دسترسی‌های سریع" %}#}
{#                    </button>#}
{#                </h2>#}
{#            <div id="collapseQuickLinks" class="accordion-collapse collapse show"#}
{#                 aria-labelledby="headingQuickLinks"#}
{#                 data-bs-parent="#accordionQuickLinks">#}
{#                <div class="accordion-body">#}
{#                        {% for category, links in dashboard_links.items %}#}
{#                            <h6 class="mt-4 mb-3 text-secondary animate__animated animate__fadeInLeft animate__delay-1s">#}
{#                                <i class="fas fa-folder-open mr-2"></i>{{ category }}#}
{#                            </h6>#}
{#                            <div class="row">#}
{#                                {% for link in links %}#}
{#                                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3 animate__animated animate__zoomIn animate__delay-{{ forloop.counter0 }}s">#}
{#                                        <a href="{% url link.url %}"#}
{#                                           class="btn btn-outline-primary btn-block d-flex align-items-center justify-content-center py-2">#}
{#                                            <i class="{{ link.icon|default:'fas fa-caret-right' }} mr-2"></i>#}
{#                                            <span class="text-truncate">{{ link.name }}</span>#}
{#                                        </a>#}
{#                                    </div>#}
{#                                {% endfor %}#}
{#                            </div>#}
{#                            {% if not forloop.last %}#}
{#                                <hr class="my-4">#}
{#                            {% endif %}#}
{#                        {% endfor %}#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    <!-- خلاصه بودجه -->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-1s" id="accordionBudgetOverview">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingBudgetOverview"#}
{#                style="background: linear-gradient(45deg, var(--info-color), #5dade2);">#}
{#                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseBudgetOverview" aria-expanded="false"#}
{#                        aria-controls="collapseBudgetOverview">#}
{#                    <i class="fas fa-chart-pie mr-2"></i>{% translate "خلاصه وضعیت بودجه(ريال)" %}#}
{#                </button>#}
{#            </h2>#}
{#            <div id="collapseBudgetOverview" class="accordion-collapse collapse"#}
{#                 aria-labelledby="headingBudgetOverview"#}
{#                 data-bs-parent="#accordionBudgetOverview">#}
{#                <div class="accordion-body">#}
{#                    {% if budget_stats_permission_denied %}#}
{#                        <div class="alert alert-warning animate__animated animate__shakeX">#}
{#                            <i class="fas fa-exclamation-triangle mr-2"></i>#}
{#                            {% translate "شما اجازه دسترسی به آمار بودجه را ندارید." %}#}
{#                        </div>#}
{#                    {% else %}#}
{#                        <div class="row text-center">#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInDown">#}
{#                                    <i class="fas fa-coins icon" style="color: var(--info-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--info-color);">#}
{#                                        <span class="num-format">{{ total_allocated_budget|format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "کل بودجه تخصیص یافته" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInDown animate__delay-0.1s">#}
{#                                    <i class="fas fa-money-bill-wave icon" style="color: var(--success-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--success-color);">#}
{#                                        <span class="num-format">{{ total_consumed_budget|floatformat:0 |format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "کل بودجه مصرف شده" %}</p>#}
{#                                    </div>#}
{#                                </div>#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInDown animate__delay-0.2s">#}
{#                                    <i class="fas fa-wallet icon" style="color: var(--danger-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--danger-color);">#}
{#                                        <span class="num-format">{{ remaining_total_budget|floatformat:0 |format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "بودجه باقی‌مانده کل" %}</p>#}
{#                                    </div>#}
{#                                </div>#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInDown animate__delay-0.3s">#}
{#                                    <i class="fas fa-percent icon" style="color: var(--warning-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--warning-color);">#}
{#                                        {{ percentage_consumed_budget|floatformat:2|format_negative }}%#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "درصد مصرف بودجه" %}</p>#}
{#                                    </div>#}
{#                                </div>#}
{#                        </div>#}
{#                        <div class="row text-center mt-4">#}
{#                            <div class="col-md-4 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInUp">#}
{#                                    <i class="fas fa-calendar-alt icon"></i>#}
{#                                    <div class="card-value" style="font-size: 2em; color: var(--dark-text);">#}
{#                                        {{ active_budget_periods_count|format_negative }}#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "دوره‌های بودجه فعال" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-4 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInUp animate__delay-0.1s">#}
{#                                    <i class="fas fa-code-branch icon"></i>#}
{#                                    <div class="card-value" style="font-size: 2em; color: var(--dark-text);">#}
{#                                        {{ active_budget_allocations_count|format_negative }}#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "تخصیص‌های بودجه فعال" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-4 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInUp animate__delay-0.2s">#}
{#                                    <i class="fas fa-building icon"></i>#}
{#                                    <div class="card-value" style="font-size: 2em; color: var(--dark-text);">#}
{#                                        {{ active_cost_centers_count|format_negative }}#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "مراکز هزینه فعال" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    {% endif %}#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#    <!-- خلاصه تنخواه -->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-1.2s"#}
{#         id="accordionTankhahOverview">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingTankhahOverview"#}
{#                style="background: linear-gradient(45deg, var(--success-color), #27ae60);">#}
{#                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseTankhahOverview" aria-expanded="false"#}
{#                        aria-controls="collapseTankhahOverview">#}
{#                    <i class="fas fa-money-check-alt mr-2"></i>{% translate "خلاصه وضعیت تنخواه(ريال)" %}#}
{#                </button>#}
{#            </h2>#}
{#            <div id="collapseTankhahOverview" class="accordion-collapse collapse"#}
{#                 aria-labelledby="headingTankhahOverview"#}
{#                 data-bs-parent="#accordionTankhahOverview">#}
{#                <div class="accordion-body">#}
{#                    {% if tankhah_stats_permission_denied %}#}
{#                        <div class="alert alert-warning animate__animated animate__shakeX">#}
{#                            <i class="fas fa-exclamation-triangle mr-2"></i>#}
{#                            {% translate "شما اجازه دسترسی به آمار تنخواه را ندارید." %}#}
{#                            </div>#}
{#                        {% else %}#}
{#                        <div class="row text-center">#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInLeft">#}
{#                                    <i class="fas fa-list-alt icon" style="color: var(--success-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--success-color);">#}
{#                                        {{ active_tankhah_count|format_negative }}#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "تنخواه‌های در جریان" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInLeft animate__delay-0.1s">#}
{#                                    <i class="fas fa-file-invoice-dollar icon"#}
{#                                       style="color: var(--info-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--info-color);">#}
{#                                        <span class="num-format">{{ current_month_total_amount|floatformat:0 |format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "مبلغ تنخواه‌های پرداخت شده ماه جاری" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInLeft animate__delay-0.2s">#}
{#                                    <i class="fas fa-hourglass-half icon" style="color: var(--warning-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--warning-color);">#}
{#                                        {{ pending_approval_count|format_negative }}#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "تنخواه‌های در انتظار تایید" %}</p>#}
{#                                    </div>#}
{#                                </div>#}
{#                            <div class="col-md-3 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInLeft animate__delay-0.3s">#}
{#                                    <i class="fas fa-times-circle icon" style="color: var(--danger-color);"></i>#}
{#                                    <div class="card-value" style="color: var(--danger-color);">#}
{#                                        {{ recent_rejected_factors |format_negative }}#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "فاکتورهای رد شده" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="row text-center mt-4">#}
{#                            <div class="col-md-4 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInRight">#}
{#                                    <i class="fas fa-hand-holding-usd icon"></i>#}
{#                                    <div class="card-value" style="font-size: 2em; color: var(--dark-text);">#}
{#                                        <span class="num-format">{{ total_allocated_tankhah|floatformat:0|format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "کل تنخواه تخصیص یافته" %}</p>#}
{#                                    </div>#}
{#                                </div>#}
{#                            <div class="col-md-4 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInRight animate__delay-0.1s">#}
{#                                    <i class="fas fa-receipt icon"></i>#}
{#                                    <div class="card-value" style="font-size: 2em; color: var(--dark-text);">#}
{#                                        <span class="num-format">{{ total_spent_on_factors|floatformat:0 |format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "کل مبلغ مصرف شده در فاکتورها" %}</p>#}
{#                                    </div>#}
{#                                </div>#}
{#                            <div class="col-md-4 mb-3">#}
{#                                <div class="metric-box animate__animated animate__fadeInRight animate__delay-0.2s">#}
{#                                    <i class="fas fa-funnel-dollar icon"></i>#}
{#                                    <div class="card-value" style="font-size: 2em; color: var(--dark-text);">#}
{#                                        <span class="num-format">{{ total_unspent_tankhah|floatformat:0|format_negative }}</span>#}
{#                                    </div>#}
{#                                    <p class="card-text">{% translate "کل تنخواه مصرف نشده" %}</p>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                        {% endif %}#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    <!-- نمودار تحلیلی  -->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-1.4s" id="accordionCharts">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingCharts"#}
{#                style="background: linear-gradient(45deg, #FF6F61, #DE4B4B);">#}
{#                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseCharts" aria-expanded="false" aria-controls="collapseCharts">#}
{#                    <i class="fas fa-chart-bar mr-2"></i>{% translate "نمودارهای تحلیلی" %}#}
{#                    </button>#}
{#                </h2>#}
{#            <div id="collapseCharts" class="accordion-collapse collapse" aria-labelledby="headingCharts"#}
{#                 data-bs-parent="#accordionCharts">#}
{#                    <div class="accordion-body">#}
{#                        <div class="row">#}
{#                            <div class="col-md-6 mb-4">#}
{#                                <div class="dashboard-card p-0"> {# Remove default padding as accordion body has it #}
{#                                    <div class="card-body">#}
{#                                        {% if budget_stats_permission_denied %}#}
{#                                            <div class="alert alert-warning">#}
{#                                                {% translate "شما اجازه دسترسی به نمودارها را ندارید." %}#}
{#                                            </div>#}
{#                                        {% else %}#}
{#                                            <div class="chart-container">#}
{#                                                <canvas id="budgetCategoryChart"></canvas>#}
{#                                            </div>#}
{#                                        {% endif %}#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-6 mb-4">#}
{#                                <div class="dashboard-card p-0">#}
{#                                    <div class="card-body">#}
{#                                        {% if budget_stats_permission_denied %}#}
{#                                            <div class="alert alert-warning">#}
{#                                                {% translate "شما اجازه دسترسی به نمودارها را ندارید." %}#}
{#                                            </div>#}
{#                                        {% else %}#}
{#                                            <div class="chart-container">#}
{#                                                <canvas id="budgetVsActualChart"></canvas>#}
{#                                            </div>#}
{#                                        {% endif %}#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="row">#}
{#                            <div class="col-md-6 mb-4">#}
{#                                <div class="dashboard-card p-0">#}
{#                                    <div class="card-body">#}
{#                                        {% if tankhah_stats_permission_denied %}#}
{#                                            <div class="alert alert-warning">#}
{#                                                {% translate "شما اجازه دسترسی به نمودارها را ندارید." %}#}
{#                                            </div>#}
{#                                        {% else %}#}
{#                                            <div class="chart-container">#}
{#                                                <canvas id="monthlyTankhahChart"></canvas>#}
{#                                            </div>#}
{#                                        {% endif %}#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                            <div class="col-md-6 mb-4">#}
{#                                <div class="dashboard-card p-0">#}
{#                                    <div class="card-body">#}
{#                                        {% if tankhah_stats_permission_denied %}#}
{#                                            <div class="alert alert-warning">#}
{#                                                {% translate "شما اجازه دسترسی به نمودارها را ندارید." %}#}
{#                                            </div>#}
{#                                        {% else %}#}
{#                                            <div class="chart-container">#}
{#                                                <canvas id="quarterlyTankhahChart"></canvas>#}
{#                                            </div>#}
{#                                        {% endif %}#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#    <!-- جدول وضعیت پروژه‌ها -->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-1.8s" id="accordionProjectStatus">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingProjectStatus"#}
{#                style="background: linear-gradient(45deg, #FFA07A, #FA8072);">#}
{#                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseProjectStatus" aria-expanded="false"#}
{#                        aria-controls="collapseProjectStatus">#}
{#                    <i class="fas fa-project-diagram mr-2"></i>{% translate "وضعیت بودجه پروژه‌ها(ريال)" %}#}
{#                    </button>#}
{#                </h2>#}
{#            <div id="collapseProjectStatus" class="accordion-collapse collapse"#}
{#                 aria-labelledby="headingProjectStatus"#}
{#                 data-bs-parent="#accordionProjectStatus">#}
{#                    <div class="accordion-body">#}
{#                        {% if budget_stats_permission_denied %}#}
{#                            <div class="alert alert-warning">#}
{#                                {% translate "شما اجازه دسترسی به وضعیت پروژه‌ها را ندارید." %}#}
{#                            </div>#}
{#                        {% else %}#}
{#                            <ul class="list-group list-group-flush">#}
{#                                {% for project in project_budget_status %}#}
{#                                    <li class="list-group-item animate__animated animate__fadeInUp animate__delay-{{ forloop.counter | format_negative }}s">#}
{#                                        <div class="flex-grow-1 mr-3">#}
{#                                            <strong>{{ project.name }}</strong>#}
{#                                            <small class="text-muted d-block">#}
{#                                                {% translate "مصرف:" %} <span#}
{#                                                    class="num-format">{{ project.consumed|floatformat:0| format_negative }}</span>#}
{#                                                /#}
{#                                                {% translate "تخصیص:" %} <span#}
{#                                                    class="num-format">{{ project.allocated|floatformat:0| format_negative }}</span>#}
{#                                            </small>#}
{#                                            <div class="progress mt-2">#}
{#                                                <div class="progress-bar" role="progressbar"#}
{#                                                     style="width: {{ project.percentage_consumed|floatformat:2| format_negative }}%; background-color: {{ project.percentage_consumed }};"#}
{#                                                     aria-valuenow="{{ project.percentage_consumed|floatformat:2 | format_negative }}"#}
{#                                                     aria-valuemin="0" aria-valuemax="100"></div>#}
{#                                            </div>#}
{#                                        </div>#}
{#                                        <div class="text-right">#}
{#                                            <span class="badge badge-pill"#}
{#                                                  style="background-color: {{ project.percentage_consumed }}; color: white;">#}
{#                                                {{ project.percentage_consumed|floatformat:2 | format_negative }}%#}
{#                                            </span>#}
{#                                            <small class="text-muted d-block">{% translate "باقی‌مانده:" %} <span#}
{#                                                    class="num-format">{{ project.remaining|floatformat:0| format_negative }}</span></small>#}
{#                                        </div>#}
{#                                    </li>#}
{#                                {% empty %}#}
{#                                    <li class="list-group-item text-center text-muted">{% translate "اطلاعاتی برای پروژه‌ها یافت نشد." %}</li>#}
{#                                {% endfor %}#}
{#                            </ul>#}
{#                        {% endif %}#}
{#                    </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#    <!-- هشدار بودجه -->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-1.8s"#}
{#         id="accordionBudgetWarnings">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingBudgetWarnings"#}
{#                style="background: linear-gradient(45deg, #FF69B4, #EE82EE);">#}
{#                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseBudgetWarnings" aria-expanded="false"#}
{#                        aria-controls="collapseBudgetWarnings">#}
{#                    <i class="fas fa-exclamation-triangle mr-2"></i>{% translate "هشدارهای اخیر بودجه" %}#}
{#                </button>#}
{#            </h2>#}
{#            <div id="collapseBudgetWarnings" class="accordion-collapse collapse"#}
{#                 aria-labelledby="headingBudgetWarnings"#}
{#                 data-bs-parent="#accordionBudgetWarnings">#}
{#                <div class="accordion-body">#}
{#                    {% if budget_stats_permission_denied %}#}
{#                        <div class="alert alert-warning">#}
{#                            {% translate "شما اجازه دسترسی به هشدارهای بودجه را ندارید." %}#}
{#                        </div>#}
{#                    {% else %}#}
{#                        <ul class="list-group list-group-flush">#}
{#                            {% for warning in recent_budget_warnings %}#}
{#                                <li class="list-group-item animate__animated animate__fadeInUp animate__delay-{{ forloop.counter }}s">#}
{#                                    <div>#}
{#                                        <strong><i#}
{#                                                class="fas fa-bell text-danger mr-2"></i>{% translate "هشدار:" %} {{ warning.details }}#}
{#                                        </strong>#}
{#                                        <small class="text-muted d-block">#}
{#                                            {% translate "زمان:" %} {{ warning.timestamp|jformat:"%Y/%m/%d %H:%M" }}#}
{#                                            -#}
{#                                            {% translate "توسط:" %} {{ warning.created_by.username }}#}
{#                                        </small>#}
{#                                    </div>#}
{#                                    <span class="badge badge-pill badge-danger">{% translate "بودجه" %}</span>#}
{#                                </li>#}
{#                            {% empty %}#}
{#                                <li class="list-group-item text-center text-muted">{% translate "هشداری یافت نشد." %}</li>#}
{#                            {% endfor %}#}
{#                        </ul>#}
{#                    {% endif %}#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    <!-- فعالیت‌های اخیر  -->#}
{#    <div class="accordion mb-4 animate__animated animate__fadeInUp animate__delay-2s"#}
{#         id="accordionRecentActivities">#}
{#        <div class="accordion-item dashboard-card">#}
{#            <h2 class="accordion-header" id="headingRecentActivities"#}
{#                style="background: linear-gradient(45deg, #A7D7C5, #7CC6B9);">#}
{#                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"#}
{#                        data-bs-target="#collapseRecentActivities" aria-expanded="false"#}
{#                        aria-controls="collapseRecentActivities">#}
{#                    <i class="fas fa-history mr-2"></i>{% translate "فعالیت‌های اخیر" %}#}
{#                    </button>#}
{#                </h2>#}
{#            <div id="collapseRecentActivities" class="accordion-collapse collapse"#}
{#                 aria-labelledby="headingRecentActivities"#}
{#                 data-bs-parent="#accordionRecentActivities">#}
{#                <div class="accordion-body">#}
{#                    <ul class="list-group list-group-flush">#}
{#                            {% for activity in recent_activities %}#}
{#                                <li class="list-group-item animate__animated animate__fadeInUp animate__delay-{{ forloop.counter }}s">#}
{#                                    <div>#}
{#                                        <strong>#}
{#                                            {% if activity.tankhah %}#}
{#                                                {% translate "تنخواه" %} #{{ activity.tankhah.number }}#}
{#                                            {% elif activity.factor %}#}
{#                                                {% translate "فاکتور" %} #{{ activity.factor.number }}#}
{#                                            {% endif %}#}
{#                                            - {{ activity.get_action_display }}#}
{#                                        </strong>#}
{#                                        <small class="text-muted d-block">#}
{#                                            {% translate "توسط:" %} {{ activity.user.username }} -#}
                                            {# Changed activity.approver to activity.user #}
{#                                            {% translate "در تاریخ:" %} {{ activity.timestamp|jformat:"%Y/%m/%d %H:%M" }}#}
{#                                        </small>#}
{#                                    </div>#}
{#                                    <span class="badge badge-pill badge-secondary"#}
{#                                          style="background-color: #6c757d; color: white;">#}
{#                                        {% if activity.tankhah %}#}
{#                                            {% translate "تنخواه" %}#}
{#                                        {% elif activity.factor %}#}
{#                                            {% translate "فاکتور" %}#}
{#                                        {% endif %}#}
{#                                    </span>#}
{#                                </li>#}
{#                            {% empty %}#}
{#                                <li class="list-group-item text-center text-muted">{% translate "فعالیت اخیری یافت نشد." %}</li>#}
{#                            {% endfor %}#}
{#                    </ul>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{##}
{#    <div class="col-md-6 mb-4">#}
{#        <div class="dashboard-card p-0">#}
{#            <div class="card-body">#}
{#                {% if budget_stats_permission_denied %}#}
{#                    <div class="alert alert-warning">#}
{#                        {% translate "شما اجازه دسترسی به نمودارها را ندارید." %}#}
{#                    </div>#}
{#                {% else %}#}
{#                    <div class="chart-container">#}
{#                        <canvas id="projectBudgetChart"></canvas>#}
{#                    </div>#}
{#                {% endif %}#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#        <div class="container-fluid mt-5 pt-3">#}
{#        <h1>{% trans "داشبورد" %}</h1>#}
{#        <div class="row g-4">#}
{#            <div class="col-12">#}
{#                <div class="dashboard-card">#}
{#                    {% if can_view_project_status %}#}
{#                        <div class="chart-container">#}
{#                            <canvas id="projectBudgetChart"></canvas>#}
{#                        </div>#}
{#                    {% else %}#}
{#                        <div class="alert alert-warning">#}
{#                            {% trans "شما اجازه دسترسی به نمودار پروژه‌ها را ندارید." %}#}
{#                        </div>#}
{#                    {% endif %}#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{##}
{#{% endblock %}#}
{#{% block extra_js %}#}
{##}
{##}
{#    <script>#}
{#        document.addEventListener('DOMContentLoaded', function () {#}
{#            // فرمت کردن اعداد با کاما (مثل 1,234,567)#}
{#            function formatNumberWithCommas(x) {#}
{#                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");#}
{#            }#}
{##}
{#            // اعمال فرمت اعداد به المنت‌های با کلاس 'num-format'#}
{#            document.querySelectorAll('.num-format').forEach(function (element) {#}
{#                const value = parseFloat(element.textContent.replace(/,/g, '')); // حذف کاماهای موجود#}
{#                if (!isNaN(value)) {#}
{#                    element.textContent = formatNumberWithCommas(value);#}
{#                }#}
{#            });#}
{##}
{#            // تنظیمات عمومی Chart.js#}
{#            Chart.defaults.font.family = "'Vazirmatn', 'Arial', sans-serif";#}
{#            Chart.defaults.color = 'var(--dark-text)';#}
{#            Chart.defaults.borderColor = '#e0e0e0';#}
{##}
{#            // تولتیپ سفارشی برای چارت‌ها#}
{#            const customTooltip = {#}
{#                external: function (context) {#}
{#                    let tooltipEl = document.getElementById('chartjs-tooltip');#}
{#                    if (!tooltipEl) {#}
{#                        tooltipEl = document.createElement('div');#}
{#                        tooltipEl.id = 'chartjs-tooltip';#}
{#                        tooltipEl.classList.add('chartjs-tooltip');#}
{#                        document.body.appendChild(tooltipEl);#}
{#                    }#}
{##}
{#                    const tooltipModel = context.tooltip;#}
{#                    if (tooltipModel.opacity === 0) {#}
{#                        tooltipEl.style.opacity = 0;#}
{#                        return;#}
{#                    }#}
{##}
{#                    function getBody(bodyItem) {#}
{#                        return bodyItem.lines;#}
{#                    }#}
{##}
{#                    if (tooltipModel.body) {#}
{#                        const titleLines = tooltipModel.title || [];#}
{#                        const bodyLines = tooltipModel.body.map(getBody);#}
{##}
{#                        let innerHtml = '<div>';#}
{#                        titleLines.forEach(function (title) {#}
{#                            innerHtml += '<h3>' + title + '</h3>';#}
{#                        });#}
{#                        bodyLines.forEach(function (body, i) {#}
{#                            const colors = tooltipModel.labelColors[i];#}
{#                            const span = '<span class="chartjs-tooltip-key" style="background-color:' + colors.backgroundColor + '"></span>';#}
{#                            innerHtml += '<p>' + span + body + '</p>';#}
{#                        });#}
{#                        innerHtml += '</div>';#}
{#                        tooltipEl.innerHTML = innerHtml;#}
{#                    }#}
{##}
{#                    const position = context.chart.canvas.getBoundingClientRect();#}
{#                    tooltipEl.style.opacity = 1;#}
{#                    tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';#}
{#                    tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';#}
{#                }#}
{#            };#}
{##}
{#            // پالت رنگی#}
{#            const vividColors = [#}
{#                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'#}
{#            ];#}
{#            const vividColorsTransparent = vividColors.map(color => color.replace('#', 'rgba(') + ', 0.7)');#}
{#            const vividColorsLight = vividColors.map(color => color.replace('#', 'rgba(') + ', 0.2)');#}
{##}
{#            // تابع کمکی برای ساخت چارت#}
{#            function createChart(canvasId, type, labels, datasets, options = {}) {#}
{#                const ctx = document.getElementById(canvasId);#}
{#                if (!ctx) {#}
{#                    console.warn(`Canvas element with ID '${canvasId}' not found. Skipping chart creation.`);#}
{#                    return null;#}
{#                }#}
{#                const chartCtx = ctx.getContext('2d');#}
{##}
{#                return new Chart(chartCtx, {#}
{#                    type: type,#}
{#                    data: {#}
{#                        labels: labels,#}
{#                        datasets: datasets#}
{#                    },#}
{#                    options: {#}
{#                        responsive: true,#}
{#                        maintainAspectRatio: false,#}
{#                        animation: {#}
{#                            duration: 1200,#}
{#                            easing: 'easeOutQuart'#}
{#                        },#}
{#                        plugins: {#}
{#                            legend: {#}
{#                                position: 'top',#}
{#                                labels: {#}
{#                                    font: {size: 14}#}
{#                                }#}
{#                            },#}
{#                            title: {#}
{#                                display: true,#}
{#                                text: options.titleText || '',#}
{#                                font: {size: 18, weight: 'bold'},#}
{#                                color: 'var(--dark-text)'#}
{#                            },#}
{#                            tooltip: customTooltip,#}
{#                            datalabels: {#}
{#                                display: options.datalabelsDisplay || false,#}
{#                                color: 'white',#}
{#                                font: {weight: 'bold'},#}
{#                                formatter: (value, context) => {#}
{#                                    return formatNumberWithCommas(value);#}
{#                                }#}
{#                            }#}
{#                        },#}
{#                        scales: options.scales || {},#}
{#                        ...options.extraOptions#}
{#                    }#}
{#                });#}
{#            }#}
{##}
{#            // رندر دوباره چارت‌ها وقتی accordion باز می‌شه#}
{#            document.querySelectorAll('.accordion-collapse').forEach(function (collapseEl) {#}
{#                collapseEl.addEventListener('shown.bs.collapse', function () {#}
{#                    if (this.id === 'collapseCharts') {#}
{#                        console.log("Charts section opened. Resizing charts...");#}
{#                        Chart.instances.forEach(chart => chart.resize());#}
{#                    }#}
{#                });#}
{#            });#}
{##}
{#            // چارت وضعیت بودجه پروژه‌ها (Bar)#}
{#            {% if not can_view_project_status|is_false and project_chart_data.labels and project_chart_data.allocated and project_chart_data.consumed and project_chart_data.remaining %}#}
{#                const projectChartLabels = JSON.parse('{{ project_chart_data.labels|escapejs }}');#}
{#                const projectChartAllocated = JSON.parse('{{ project_chart_data.allocated|escapejs }}');#}
{#                const projectChartConsumed = JSON.parse('{{ project_chart_data.consumed|escapejs }}');#}
{#                const projectChartRemaining = JSON.parse('{{ project_chart_data.remaining|escapejs }}');#}
{#                if (projectChartLabels.length > 0 && projectChartAllocated.length > 0) {#}
{#                    createChart('projectBudgetChart', 'bar', projectChartLabels, [#}
{#                        {#}
{#                            label: '{% translate "تخصیص‌یافته" %}',#}
{#                            data: projectChartAllocated,#}
{#                            backgroundColor: vividColors[1],#}
{#                            borderColor: vividColors[1],#}
{#                            borderWidth: 1#}
{#                        },#}
{#                        {#}
{#                            label: '{% translate "مصرف‌شده" %}',#}
{#                            data: projectChartConsumed,#}
{#                            backgroundColor: vividColors[0],#}
{#                            borderColor: vividColors[0],#}
{#                            borderWidth: 1#}
{#                        },#}
{#                        {#}
{#                            label: '{% translate "باقی‌مانده" %}',#}
{#                            data: projectChartRemaining,#}
{#                            backgroundColor: vividColors[2],#}
{#                            borderColor: vividColors[2],#}
{#                            borderWidth: 1#}
{#                        }#}
{#                    ], {#}
{#                        titleText: '{% translate "وضعیت بودجه پروژه‌ها" %}',#}
{#                        scales: {#}
{#                            x: {title: {display: true, text: '{% translate "پروژه" %}'}},#}
{#                            y: {#}
{#                                beginAtZero: true,#}
{#                                title: {display: true, text: '{% translate "مبلغ" %}'},#}
{#                                ticks: {#}
{#                                    callback: function (value) {#}
{#                                        return formatNumberWithCommas(value);#}
{#                                    }#}
{#                                }#}
{#                            }#}
{#                        }#}
{#                    });#}
{#                } else {#}
{#                    console.warn("Project chart data is empty. Skipping chart rendering.");#}
{#                }#}
{#            {% else %}#}
{#                console.warn("Project stats permission denied or data missing for project chart.");#}
{#            {% endif %}#}
{##}
{#            // چارت مصرف بودجه بر اساس دسته (Doughnut)#}
{#            {% if not can_view_budget_stats|is_false and budget_category_consumption.labels and budget_category_consumption.values %}#}
{#                const budgetCategoryLabels = JSON.parse('{{ budget_category_consumption.labels|escapejs }}');#}
{#                const budgetCategoryValues = JSON.parse('{{ budget_category_consumption.values|escapejs }}');#}
{#                if (budgetCategoryLabels.length > 0 && budgetCategoryValues.length > 0) {#}
{#                    createChart('budgetCategoryChart', 'doughnut', budgetCategoryLabels, [{#}
{#                        data: budgetCategoryValues,#}
{#                        backgroundColor: vividColorsTransparent.slice(0, budgetCategoryLabels.length),#}
{#                        borderColor: 'var(--light-bg)',#}
{#                        borderWidth: 2#}
{#                    }], {#}
{#                        titleText: '{% translate "مصرف بودجه بر اساس دسته" %}',#}
{#                        datalabelsDisplay: true,#}
{#                        plugins: {#}
{#                            datalabels: {#}
{#                                formatter: (value, context) => {#}
{#                                    let sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);#}
{#                                    if (sum === 0) return '0%';#}
{#                                    let percentage = (value * 100 / sum).toFixed(2) + "%";#}
{#                                    return percentage;#}
{#                                }#}
{#                            }#}
{#                        }#}
{#                    });#}
{#                } else {#}
{#                    console.warn("Budget category chart data is empty. Skipping chart rendering.");#}
{#                }#}
{#            {% else %}#}
{#                console.warn("Budget stats permission denied or data missing for budget category chart.");#}
{#            {% endif %}#}
{##}
{#            // چارت بودجه تخصیص‌یافته در مقابل مصرف‌شده (Bar)#}
{#            {% if not can_view_budget_stats|is_false and budget_vs_actual_data.labels and budget_vs_actual_data.allocated and budget_vs_actual_data.consumed %}#}
{#                const budgetVsActualLabels = JSON.parse('{{ budget_vs_actual_data.labels|escapejs }}');#}
{#                const budgetVsActualAllocated = JSON.parse('{{ budget_vs_actual_data.allocated|escapejs }}');#}
{#                const budgetVsActualConsumed = JSON.parse('{{ budget_vs_actual_data.consumed|escapejs }}');#}
{#                if (budgetVsActualLabels.length > 0 && budgetVsActualAllocated.length > 0 && budgetVsActualConsumed.length > 0) {#}
{#                    createChart('budgetVsActualChart', 'bar', budgetVsActualLabels, [#}
{#                        {#}
{#                            label: '{% translate "تخصیص‌یافته" %}',#}
{#                            data: budgetVsActualAllocated,#}
{#                            backgroundColor: vividColors[1],#}
{#                            borderColor: vividColors[1],#}
{#                            borderWidth: 1#}
{#                        },#}
{#                        {#}
{#                            label: '{% translate "مصرف‌شده" %}',#}
{#                            data: budgetVsActualConsumed,#}
{#                            backgroundColor: vividColors[0],#}
{#                            borderColor: vividColors[0],#}
{#                            borderWidth: 1#}
{#                        }#}
{#                    ], {#}
{#                        titleText: '{% translate "بودجه تخصیص‌یافته در مقابل مصرف‌شده (۶ ماه گذشته)" %}',#}
{#                        scales: {#}
{#                            x: {title: {display: true, text: '{% translate "ماه" %}'}},#}
{#                            y: {#}
{#                                beginAtZero: true,#}
{#                                title: {display: true, text: '{% translate "مبلغ" %}'},#}
{#                                ticks: {#}
{#                                    callback: function (value) {#}
{#                                        return formatNumberWithCommas(value);#}
{#                                    }#}
{#                                }#}
{#                            }#}
{#                        }#}
{#                    });#}
{#                } else {#}
{#                    console.warn("Budget vs actual chart data is empty. Skipping chart rendering.");#}
{#                }#}
{#            {% else %}#}
{#                console.warn("Budget stats permission denied or data missing for budget vs actual chart.");#}
{#            {% endif %}#}
{##}
{#            // چارت تنخواه ماهانه (Line)#}
{#            {% if not can_view_tankhah_stats|is_false and monthly_report_data.labels and monthly_report_data.values %}#}
{#                const monthlyTankhahLabels = JSON.parse('{{ monthly_report_data.labels|escapejs }}');#}
{#                const monthlyTankhahValues = JSON.parse('{{ monthly_report_data.values|escapejs }}');#}
{#                if (monthlyTankhahLabels.length > 0 && monthlyTankhahValues.length > 0) {#}
{#                    createChart('monthlyTankhahChart', 'line', monthlyTankhahLabels, [{#}
{#                        label: '{% translate "مبلغ تنخواه پرداخت‌شده" %}',#}
{#                        data: monthlyTankhahValues,#}
{#                        borderColor: vividColors[3],#}
{#                        backgroundColor: vividColorsLight[3],#}
{#                        fill: true,#}
{#                        tension: 0.4#}
{#                    }], {#}
{#                        titleText: '{% translate "روند تنخواه ماهانه" %}',#}
{#                        scales: {#}
{#                            x: {title: {display: true, text: '{% translate "ماه" %}'}},#}
{#                            y: {#}
{#                                beginAtZero: true,#}
{#                                title: {display: true, text: '{% translate "مبلغ" %}'},#}
{#                                ticks: {#}
{#                                    callback: function (value) {#}
{#                                        return formatNumberWithCommas(value);#}
{#                                    }#}
{#                                }#}
{#                            }#}
{#                        }#}
{#                    });#}
{#                } else {#}
{#                    console.warn("Monthly tankhah chart data is empty. Skipping chart rendering.");#}
{#                }#}
{#            {% else %}#}
{#                console.warn("Tankhah stats permission denied or data missing for monthly tankhah chart.");#}
{#            {% endif %}#}
{##}
{#            // چارت تنخواه فصلی (Bar)#}
{#            {% if not can_view_tankhah_stats|is_false and quarterly_report_data.labels and quarterly_report_data.values %}#}
{#                const quarterlyTankhahLabels = JSON.parse('{{ quarterly_report_data.labels|escapejs }}');#}
{#                const quarterlyTankhahValues = JSON.parse('{{ quarterly_report_data.values|escapejs }}');#}
{#                if (quarterlyTankhahLabels.length > 0 && quarterlyTankhahValues.length > 0) {#}
{#                    createChart('quarterlyTankhahChart', 'bar', quarterlyTankhahLabels, [{#}
{#                        label: '{% translate "مبلغ تنخواه پرداخت‌شده" %}',#}
{#                        data: quarterlyTankhahValues,#}
{#                        backgroundColor: vividColorsTransparent[2],#}
{#                        borderColor: vividColors[2],#}
{#                        borderWidth: 1#}
{#                    }], {#}
{#                        titleText: '{% translate "روند تنخواه فصلی" %}',#}
{#                        scales: {#}
{#                            x: {title: {display: true, text: '{% translate "فصل" %}'}},#}
{#                            y: {#}
{#                                beginAtZero: true,#}
{#                                title: {display: true, text: '{% translate "مبلغ" %}'},#}
{#                                ticks: {#}
{#                                    callback: function (value) {#}
{#                                        return formatNumberWithCommas(value);#}
{#                                    }#}
{#                                }#}
{#                            }#}
{#                        }#}
{#                    });#}
{#                } else {#}
{#                    console.warn("Quarterly tankhah chart data is empty. Skipping chart rendering.");#}
{#                }#}
{#            {% else %}#}
{#                console.warn("Tankhah stats permission denied or data missing for quarterly tankhah chart.");#}
{#            {% endif %}#}
{#        });#}
{#    </script>#}
{##}
{#{% endblock %}#}