{% extends 'base.html' %}
{% load i18n rcms_custom_filters static %}

{% block title %}لیست مراحل گردش کار{% endblock %}

{% block content %}
<div class="card p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">{% trans "مراحل گردش کار" %}</h1>
        <a href="{% url 'workflow_stage_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> {% trans "افزودن مرحله جدید" %}
        </a>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col" style="width: 5%;">#</th>
                    <th scope="col">{% trans "نام مرحله" %}</th>
                    <th scope="col" style="width: 10%;">{% trans "ترتیب" %}</th>
                    <th scope="col" style="width: 10%;">{% trans "وضعیت" %}</th>
                    <th scope="col">{% trans "توضیحات" %}</th>
                    <th scope="col" style="width: 15%;">{% trans "عملیات" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for stage in stages %}
                    {# یک ردیف برای هر مرحله، با استایل شرطی برای مرحله نهایی #}
                    <tr class="{% if stage.is_final_stage %}table-info fw-bold{% endif %}">
                        
                        <td>{{ forloop.counter | to_persian_number }}</td>
                        
                        <td>
                            {# نمایش بج "نهایی" برای مرحله آخر #}
                            {% if stage.is_final_stage %}
                                <span class="badge bg-primary me-2">{% trans "نهایی" %}</span>
                            {% endif %}
                            {{ stage.name }}
                        </td>

                        <td>{{ stage.order | to_persian_number }}</td>
                        
                        <td>
                            {# استفاده از بج‌های بوت‌استرپ برای نمایش وضعیت #}
                            {% if stage.is_active %}
                                <span class="badge bg-success">{% trans "فعال" %}</span>
                            {% else %}
                                <span class="badge bg-secondary">{% trans "غیرفعال" %}</span>
                            {% endif %}
                        </td>
                        
                        {# نمایش خلاصه توضیحات برای جلوگیری از به هم ریختن جدول #}
                        <td>{{ stage.description|truncatewords:10|default:"-" }}</td>
                        
                        <td>
                            {# دکمه‌های عملیات با بررسی دسترسی #}
                            {% if perms.core.WorkflowStage_update %}
                                <a href="{% url 'workflow_stage_update' stage.pk %}" class="btn btn-sm btn-outline-secondary" title="ویرایش">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                            {% endif %}
                            {% if perms.core.WorkflowStage_delete %}
                                <a href="{% url 'workflow_stage_delete' stage.pk %}" class="btn btn-sm btn-outline-danger" title="حذف">
                                    <i class="bi bi-trash3"></i>
                                </a>
                            {% endif %}
                        </td>

                    </tr>
                {% empty %}
                    <tr>
                        {# اصلاح `colspan` به تعداد صحیح ستون‌ها #}
                        <td colspan="6" class="text-center py-4">{% trans "مرحله‌ای یافت نشد." %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}