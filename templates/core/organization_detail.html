{% extends 'base.html' %}
{% load i18n static rcms_custom_filters jalali_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .info-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
    }
    .stat-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
    }
    .stat-card .stat-number {
        font-size: 2rem;
        font-weight: bold;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .manager-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }
    .budget-period-card {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }
    .consumption-bar {
        height: 8px;
        background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
        border-radius: 4px;
        margin: 10px 0;
    }
    .progress-bar-custom {
        height: 8px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 4px;
    }
    .table-modern {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .table-modern thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .badge-modern {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-building me-2"></i>{{ organization.name }}
                        </h3>
                        <div>
                            <a href="{% url 'organization_update' organization.pk %}" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-edit me-1"></i>{% trans "ویرایش" %}
                            </a>
                            <a href="{% url 'organization_list' %}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-arrow-right me-1"></i>{% trans "بازگشت" %}
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">{% trans "کد سازمان" %}:</td>
                                    <td>{{ organization.code|to_persian_number }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "نوع سازمان" %}:</td>
                                    <td>{{ organization.org_type.fname|default:"نامشخص" }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "وضعیت" %}:</td>
                                    <td>
                                        <span class="badge-modern {% if organization.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if organization.is_active %}{% trans "فعال" %}{% else %}{% trans "غیرفعال" %}{% endif %}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">{% trans "تاریخ ایجاد" %}:</td>
                                    <td>{{ organization.created_at|to_jalali:"%Y/%m/%d"|to_persian_number }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "توضیحات" %}:</td>
                                    <td>{{ organization.description|default:"-" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <div class="stat-number">{{ organization.budget_details.total_allocated|floatformat:"0"|format_negative|to_persian_number }}</div>
                <div>{% trans "بودجه تخصیص‌یافته (ریال)" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <div class="stat-number">{{ organization.budget_details.total_consumed|floatformat:"0"|format_negative|to_persian_number }}</div>
                <div>{% trans "بودجه مصرف‌شده (ریال)" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-wallet fa-2x mb-2"></i>
                <div class="stat-number {% if organization.budget_details.remaining_budget < 0 %}text-warning{% endif %}">
                    {{ organization.budget_details.remaining_budget|floatformat:"0"|format_negative|to_persian_number }}
                </div>
                <div>{% trans "مانده بودجه (ریال)" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-project-diagram fa-2x mb-2"></i>
                <div class="stat-number">{{ organization.budget_details.project_count|to_persian_number }}</div>
                <div>{% trans "تعداد پروژه‌ها" %}</div>
            </div>
        </div>
    </div>

        <!-- Additional Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div class="stat-number">{{ posts_stats.total_posts|to_persian_number }}</div>
                    <div>{% trans "تعداد پست‌ها" %}</div>
                    <small class="text-muted">
                        {% trans "فعال" %}: {{ posts_stats.active_posts|to_persian_number }} | 
                        {% trans "غیرفعال" %}: {{ posts_stats.inactive_posts|to_persian_number }}
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-user-check fa-2x mb-2"></i>
                    <div class="stat-number">{{ users_stats.total_users|to_persian_number }}</div>
                    <div>{% trans "تعداد کاربران" %}</div>
                    <small class="text-muted">
                        {% trans "فعال" %}: {{ users_stats.active_users|to_persian_number }} | 
                        {% trans "غیرفعال" %}: {{ users_stats.inactive_users|to_persian_number }}
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                    <div class="stat-number">{{ budget_periods_stats.total_periods|to_persian_number }}</div>
                    <div>{% trans "دوره‌های بودجه" %}</div>
                    <small class="text-muted">
                        {% trans "فعال" %}: {{ budget_periods_stats.active_periods|to_persian_number }} | 
                        {% trans "تکمیل شده" %}: {{ budget_periods_stats.completed_periods|to_persian_number }}
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                    <div class="stat-number">{{ budget_details.allocation_count|to_persian_number }}</div>
                    <div>{% trans "تخصیص‌های بودجه" %}</div>
                    <small class="text-muted">
                        {% trans "کل مبلغ" %}: {{ budget_details.total_allocated|floatformat:"0"|format_negative|to_persian_number }} ریال
                    </small>
                </div>
            </div>
        </div>

    <!-- Budget Consumption Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-chart-pie me-2"></i>{% trans "نمودار مصرف بودجه" %}
                </h5>
                {% if organization.budget_details.total_allocated > 0 %}
                    {% widthratio organization.budget_details.total_consumed organization.budget_details.total_allocated 100 as consumption_percentage %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>{% trans "مصرف شده" %}</span>
                            <span>{{ consumption_percentage|to_persian_number }}%</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-custom" role="progressbar" 
                                 style="width: {{ consumption_percentage }}%" 
                                 aria-valuenow="{{ consumption_percentage }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ consumption_percentage|to_persian_number }}%
                            </div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="consumption-bar"></div>
                            <small>{% trans "بودجه کل" %}: {{ organization.budget_details.total_allocated|floatformat:"0"|format_negative|to_persian_number }} ریال</small>
                        </div>
                        <div class="col-md-4">
                            <div class="consumption-bar"></div>
                            <small>{% trans "مصرف شده" %}: {{ organization.budget_details.total_consumed|floatformat:"0"|format_negative|to_persian_number }} ریال</small>
                        </div>
                        <div class="col-md-4">
                            <div class="consumption-bar"></div>
                            <small>{% trans "باقی‌مانده" %}: {{ organization.budget_details.remaining_budget|floatformat:"0"|format_negative|to_persian_number }} ریال</small>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <p>{% trans "هیچ بودجه‌ای برای این سازمان تخصیص نیافته است." %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Budget Periods -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>{% trans "دوره‌های بودجه" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if organization.budget_periods.exists %}
                        <div class="row">
                            {% for period in organization.budget_periods.all %}
                                <div class="col-md-6 mb-3">
                                    <div class="budget-period-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0">{{ period.name }}</h6>
                                            <span class="badge-modern {% if period.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if period.is_active %}{% trans "فعال" %}{% else %}{% trans "غیرفعال" %}{% endif %}
                                            </span>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <small><i class="fas fa-calendar-start me-1"></i>{% trans "از" %}: {{ period.start_date|to_jalali:"%Y/%m/%d"|to_persian_number }}</small><br>
                                                <small><i class="fas fa-calendar-end me-1"></i>{% trans "تا" %}: {{ period.end_date|to_jalali:"%Y/%m/%d"|to_persian_number }}</small><br>
                                                <small><i class="fas fa-percentage me-1"></i>{% trans "قفل شده" %}: {{ period.locked_percentage|to_persian_number }}%</small>
                                            </div>
                                            <div class="col-6 text-end">
                                                <small><i class="fas fa-money-bill-wave me-1"></i>{% trans "مبلغ کل" %}: {{ period.total_amount|floatformat:"0"|format_negative|to_persian_number }} ریال</small><br>
                                                <small><i class="fas fa-chart-pie me-1"></i>{% trans "تخصیص‌ها" %}: {{ period.total_allocated|floatformat:"0"|format_negative|to_persian_number }} ریال</small><br>
                                                <small><i class="fas fa-undo me-1"></i>{% trans "برگشتی" %}: {{ period.returned_amount|floatformat:"0"|format_negative|to_persian_number }} ریال</small>
                                            </div>
                                        </div>
                                        {% if period.description %}
                                            <div class="mt-2">
                                                <small><i class="fas fa-info-circle me-1"></i>{{ period.description|truncatechars:100 }}</small>
                                            </div>
                                        {% endif %}
                                        <div class="mt-2">
                                            <small><i class="fas fa-user me-1"></i>{% trans "ایجادکننده" %}: {{ period.created_by.get_full_name|default:period.created_by.username|default:"نامشخص" }}</small>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>{% trans "هیچ دوره بودجه‌ای برای این سازمان تعریف نشده است." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Managers and Staff -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>{% trans "مدیران و پرسنل" %}
                    </h5>
                </div>
        <div class="card-body">
                    {% if organization.post_set.exists %}
                        <div class="row">
                            {% for post in organization.post_set.all %}
                                <div class="col-md-6 mb-3">
                                    <div class="manager-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0">
                                                <i class="fas fa-user-tie me-1"></i>{{ post.name }}
                                            </h6>
                                            <span class="badge-modern {% if post.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if post.is_active %}{% trans "فعال" %}{% else %}{% trans "غیرفعال" %}{% endif %}
                                            </span>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <small><i class="fas fa-layer-group me-1"></i>{% trans "سطح" %}: {{ post.level|to_persian_number }}</small><br>
                                                <small><i class="fas fa-building me-1"></i>{% trans "شاخه" %}: {{ post.branch.name|default:"-" }}</small><br>
                                                <small><i class="fas fa-calendar me-1"></i>{% trans "تاریخ ایجاد" %}: {{ post.created_at|to_jalali:"%Y/%m/%d"|to_persian_number }}</small>
                                            </div>
                                            <div class="col-6 text-end">
                                                <small><i class="fas fa-users me-1"></i>{% trans "کاربران" %}: {{ post.userpost_set.count|to_persian_number }}</small><br>
                                                <small><i class="fas fa-user-check me-1"></i>{% trans "فعال" %}: {{ post.active_users_count|to_persian_number }}</small><br>
                                                <small><i class="fas fa-user-times me-1"></i>{% trans "غیرفعال" %}: {{ post.inactive_users_count|to_persian_number }}</small>
                                            </div>
                                        </div>
                                        {% if post.description %}
                                            <div class="mt-2">
                                                <small><i class="fas fa-info-circle me-1"></i>{{ post.description|truncatechars:80 }}</small>
                                            </div>
                                        {% endif %}
                                        {% if post.userpost_set.exists %}
                                            <div class="mt-2">
                                                <small><i class="fas fa-user-friends me-1"></i>{% trans "کاربران فعال" %}:</small>
                                                {% for user_post in post.active_user_posts|slice:":3" %}
                                                    <span class="badge-modern bg-light text-dark me-1">
                                                        {{ user_post.user.get_full_name|default:user_post.user.username }}
                                                    </span>
                                                {% endfor %}
                                                {% if post.active_users_count > 3 %}
                                                    <span class="badge-modern bg-light text-dark">
                                                        +{{ post.active_users_count|add:"-3"|to_persian_number }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-user-slash fa-3x mb-3"></i>
                            <p>{% trans "هیچ پستی برای این سازمان تعریف نشده است." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Allocations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-money-bill-wave me-2"></i>{% trans "تخصیص‌های بودجه" %}
                        </h5>
                        <a href="{% url 'project_budget_allocation_list' organization_id=organization.id %}" class="btn btn-light btn-sm">
                            <i class="fas fa-plus me-1"></i>{% trans "تخصیص جدید" %}
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if organization.budget_allocations.exists %}
                        <div class="table-responsive">
                            <table class="table table-modern table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "پروژه" %}</th>
                                        <th>{% trans "ردیف بودجه" %}</th>
                                        <th>{% trans "مبلغ تخصیص" %}</th>
                                        <th>{% trans "تاریخ تخصیص" %}</th>
                                        <th>{% trans "نوع تخصیص" %}</th>
                                        <th>{% trans "وضعیت" %}</th>
                                        <th>{% trans "ایجادکننده" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for allocation in organization.budget_allocations.all|slice:":10" %}
                                        <tr>
                                            <td>
                                                <i class="fas fa-project-diagram me-1"></i>
                                                {{ allocation.project.name|default:"-" }}
                                            </td>
                                            <td>
                                                <i class="fas fa-list me-1"></i>
                                                {{ allocation.budget_item.name|default:"-" }}
                                            </td>
                                            <td class="text-end">
                                                <strong>{{ allocation.allocated_amount|floatformat:"0"|format_negative|to_persian_number }} ریال</strong>
                                            </td>
                                            <td>
                                                <i class="fas fa-calendar me-1"></i>
                                                {{ allocation.allocation_date|to_jalali:"%Y/%m/%d"|to_persian_number }}
                                            </td>
                                            <td>
                                                <span class="badge-modern bg-info">
                                                    {{ allocation.get_allocation_type_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge-modern {% if allocation.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                    {% if allocation.is_active %}{% trans "فعال" %}{% else %}{% trans "غیرفعال" %}{% endif %}
                                                </span>
                                                {% if allocation.is_locked %}
                                                    <span class="badge-modern bg-warning me-1">{% trans "قفل شده" %}</span>
                                                {% endif %}
                                                {% if allocation.is_stopped %}
                                                    <span class="badge-modern bg-secondary me-1">{% trans "متوقف" %}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <i class="fas fa-user me-1"></i>
                                                {{ allocation.created_by.get_full_name|default:allocation.created_by.username|default:"نامشخص" }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
            </table>
                        </div>
                        {% if organization.budget_allocations.count > 10 %}
                            <div class="text-center mt-3">
                                <a href="{% url 'project_budget_allocation_list' organization_id=organization.id %}" class="btn btn-outline-primary">
                                    {% trans "مشاهده همه تخصیص‌ها" %} ({{ organization.budget_allocations.count|to_persian_number }})
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
                            <p>{% trans "هیچ تخصیص بودجه‌ای برای این سازمان ثبت نشده است." %}</p>
                            <a href="{% url 'project_budget_allocation_list' organization_id=organization.id %}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>{% trans "ایجاد اولین تخصیص" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>{% trans "آمار پیشرفته و تحلیل" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-percentage me-1"></i>{% trans "درصد مصرف بودجه" %}</h6>
                            {% if budget_details.total_allocated > 0 %}
                                {% widthratio budget_details.total_consumed budget_details.total_allocated 100 as consumption_percentage %}
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar {% if consumption_percentage > 80 %}bg-danger{% elif consumption_percentage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                         role="progressbar" style="width: {{ consumption_percentage }}%">
                                        {{ consumption_percentage|to_persian_number }}%
                                    </div>
                                </div>
                                <p class="text-muted small">
                                    {% trans "مصرف شده" %}: {{ budget_details.total_consumed|floatformat:"0"|format_negative|to_persian_number }} ریال 
                                    {% trans "از" %} {{ budget_details.total_allocated|floatformat:"0"|format_negative|to_persian_number }} ریال
                                </p>
                            {% else %}
                                <p class="text-muted">{% trans "هیچ بودجه‌ای تخصیص داده نشده" %}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-trending-up me-1"></i>{% trans "نرخ فعالیت" %}</h6>
                            {% if posts_stats.total_posts > 0 %}
                                {% widthratio posts_stats.active_posts posts_stats.total_posts 100 as activity_rate %}
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar {% if activity_rate > 80 %}bg-success{% elif activity_rate > 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" style="width: {{ activity_rate }}%">
                                        {{ activity_rate|to_persian_number }}%
                                    </div>
                                </div>
                                <p class="text-muted small">
                                    {{ posts_stats.active_posts|to_persian_number }} {% trans "پست فعال" %} 
                                    {% trans "از" %} {{ posts_stats.total_posts|to_persian_number }} {% trans "پست کل" %}
                                </p>
                            {% else %}
                                <p class="text-muted">{% trans "هیچ پستی تعریف نشده" %}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6><i class="fas fa-calendar-check me-1"></i>{% trans "دوره‌های فعال" %}</h6>
                                <div class="h4 text-primary">{{ budget_periods_stats.active_periods|to_persian_number }}</div>
                                <small class="text-muted">{% trans "از" %} {{ budget_periods_stats.total_periods|to_persian_number }} {% trans "دوره" %}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6><i class="fas fa-user-check me-1"></i>{% trans "کاربران فعال" %}</h6>
                                <div class="h4 text-success">{{ users_stats.active_users|to_persian_number }}</div>
                                <small class="text-muted">{% trans "از" %} {{ users_stats.total_users|to_persian_number }} {% trans "کاربر" %}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6><i class="fas fa-project-diagram me-1"></i>{% trans "پروژه‌ها" %}</h6>
                                <div class="h4 text-info">{{ budget_details.project_count|to_persian_number }}</div>
                                <small class="text-muted">{% trans "پروژه مرتبط" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>{% trans "فعالیت‌های اخیر و آمار کلی" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6><i class="fas fa-chart-line me-1"></i>{% trans "آمار بودجه" %}</h6>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "تخصیص شده" %}:</strong> {{ budget_details.total_allocated|floatformat:"0"|format_negative|to_persian_number }} ریال
                                </p>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "مصرف شده" %}:</strong> {{ budget_details.total_consumed|floatformat:"0"|format_negative|to_persian_number }} ریال
                                </p>
                                <p class="text-muted mb-0">
                                    <strong>{% trans "باقی‌مانده" %}:</strong> {{ budget_details.remaining_budget|floatformat:"0"|format_negative|to_persian_number }} ریال
                                </p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6><i class="fas fa-users me-1"></i>{% trans "آمار پرسنل" %}</h6>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "تعداد پست‌ها" %}:</strong> {{ posts_stats.total_posts|to_persian_number }} 
                                    ({% trans "فعال" %}: {{ posts_stats.active_posts|to_persian_number }} | {% trans "غیرفعال" %}: {{ posts_stats.inactive_posts|to_persian_number }})
                                </p>
                                <p class="text-muted mb-0">
                                    <strong>{% trans "تعداد کاربران" %}:</strong> {{ users_stats.total_users|to_persian_number }} 
                                    ({% trans "فعال" %}: {{ users_stats.active_users|to_persian_number }} | {% trans "غیرفعال" %}: {{ users_stats.inactive_users|to_persian_number }})
                                </p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6><i class="fas fa-calendar-alt me-1"></i>{% trans "دوره‌های بودجه" %}</h6>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "کل دوره‌ها" %}:</strong> {{ budget_periods_stats.total_periods|to_persian_number }}
                                </p>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "دوره‌های فعال" %}:</strong> {{ budget_periods_stats.active_periods|to_persian_number }}
                                </p>
                                <p class="text-muted mb-0">
                                    <strong>{% trans "دوره‌های تکمیل شده" %}:</strong> {{ budget_periods_stats.completed_periods|to_persian_number }}
                                </p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6><i class="fas fa-project-diagram me-1"></i>{% trans "پروژه‌ها و تخصیص‌ها" %}</h6>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "تعداد پروژه‌ها" %}:</strong> {{ budget_details.project_count|to_persian_number }}
                                </p>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "تعداد تخصیص‌ها" %}:</strong> {{ budget_details.allocation_count|to_persian_number }}
                                </p>
                                <p class="text-muted mb-0">
                                    <strong>{% trans "آخرین بروزرسانی" %}:</strong> 
                                    {% if budget_details.last_update %}
                                        {{ budget_details.last_update|to_jalali:"%Y/%m/%d %H:%M"|to_persian_number }}
                                    {% else %}
                                        {% trans "هیچ تخصیص بودجه‌ای ثبت نشده" %}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-secondary"></div>
                            <div class="timeline-content">
                                <h6><i class="fas fa-building me-1"></i>{% trans "اطلاعات سازمان" %}</h6>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "کد سازمان" %}:</strong> {{ organization.code }}
                                </p>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "نوع سازمان" %}:</strong> {{ organization.org_type.fname|default:"نامشخص" }}
                                </p>
                                <p class="text-muted mb-1">
                                    <strong>{% trans "وضعیت" %}:</strong> 
                                    {% if organization.is_active %}
                                        <span class="badge bg-success">{% trans "فعال" %}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{% trans "غیرفعال" %}</span>
                                    {% endif %}
                                </p>
                                <p class="text-muted mb-0">
                                    <strong>{% trans "تاریخ ایجاد" %}:</strong> {{ organization.created_at|to_jalali:"%Y/%m/%d %H:%M"|to_persian_number }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>{% trans "داشبورد خلاصه" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-item text-center">
                                <div class="summary-icon">
                                    <i class="fas fa-building fa-2x text-primary"></i>
                                </div>
                                <h6>{% trans "وضعیت سازمان" %}</h6>
                                <p class="mb-0">
                                    {% if organization.is_active %}
                                        <span class="badge bg-success fs-6">{% trans "فعال" %}</span>
                                    {% else %}
                                        <span class="badge bg-danger fs-6">{% trans "غیرفعال" %}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-item text-center">
                                <div class="summary-icon">
                                    <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                                </div>
                                <h6>{% trans "وضعیت بودجه" %}</h6>
                                <p class="mb-0">
                                    {% if budget_details.total_allocated > 0 %}
                                        {% widthratio budget_details.total_consumed budget_details.total_allocated 100 as consumption_percentage %}
                                        {% if consumption_percentage > 80 %}
                                            <span class="badge bg-danger fs-6">{% trans "بحرانی" %}</span>
                                        {% elif consumption_percentage > 60 %}
                                            <span class="badge bg-warning fs-6">{% trans "هشدار" %}</span>
                                        {% else %}
                                            <span class="badge bg-success fs-6">{% trans "سالم" %}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">{% trans "بدون بودجه" %}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-item text-center">
                                <div class="summary-icon">
                                    <i class="fas fa-users fa-2x text-info"></i>
                                </div>
                                <h6>{% trans "وضعیت پرسنل" %}</h6>
                                <p class="mb-0">
                                    {% if posts_stats.total_posts > 0 %}
                                        {% widthratio posts_stats.active_posts posts_stats.total_posts 100 as activity_rate %}
                                        {% if activity_rate > 80 %}
                                            <span class="badge bg-success fs-6">{% trans "عالی" %}</span>
                                        {% elif activity_rate > 50 %}
                                            <span class="badge bg-warning fs-6">{% trans "متوسط" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger fs-6">{% trans "ضعیف" %}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">{% trans "بدون پست" %}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-item text-center">
                                <div class="summary-icon">
                                    <i class="fas fa-calendar-alt fa-2x text-warning"></i>
                                </div>
                                <h6>{% trans "دوره‌های بودجه" %}</h6>
                                <p class="mb-0">
                                    {% if budget_periods_stats.active_periods > 0 %}
                                        <span class="badge bg-success fs-6">{{ budget_periods_stats.active_periods|to_persian_number }} {% trans "فعال" %}</span>
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">{% trans "بدون دوره فعال" %}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-info-circle me-1"></i>{% trans "خلاصه کلی" %}</h6>
                            <p class="text-muted mb-0">
                                {% trans "سازمان" %} <strong>{{ organization.name }}</strong> 
                                {% trans "با کد" %} <strong>{{ organization.code }}</strong> 
                                {% trans "دارای" %} 
                                <strong>{{ posts_stats.total_posts|to_persian_number }}</strong> {% trans "پست" %}،
                                <strong>{{ users_stats.total_users|to_persian_number }}</strong> {% trans "کاربر" %}،
                                <strong>{{ budget_periods_stats.total_periods|to_persian_number }}</strong> {% trans "دوره بودجه" %}،
                                {% trans "و" %} <strong>{{ budget_details.allocation_count|to_persian_number }}</strong> {% trans "تخصیص بودجه" %}
                                {% trans "می‌باشد. مبلغ کل تخصیص‌ها" %} 
                                <strong>{{ budget_details.total_allocated|floatformat:"0"|format_negative|to_persian_number }}</strong> {% trans "ریال" %}
                                {% trans "و مبلغ مصرف شده" %} 
                                <strong>{{ budget_details.total_consumed|floatformat:"0"|format_negative|to_persian_number }}</strong> {% trans "ریال" %}
                                {% trans "است." %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e9ecef;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

.summary-item {
    padding: 20px;
    border-radius: 10px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 15px;
}

.summary-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.summary-icon {
    margin-bottom: 15px;
}

.summary-item h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 10px;
}

.summary-item .badge {
    font-size: 0.9rem;
    padding: 8px 12px;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.progress-bar {
    transition: width 0.6s ease;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-card .card-body h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 8px;
}

.info-card .card-body .row .col-md-4 {
    border-right: 1px solid #e9ecef;
}

.info-card .card-body .row .col-md-4:last-child {
    border-right: none;
}

.info-card .card-body .h4 {
    font-weight: 700;
    margin-bottom: 5px;
}

.info-card .card-body .text-muted.small {
    font-size: 0.85rem;
}
</style>
{% endblock %} 