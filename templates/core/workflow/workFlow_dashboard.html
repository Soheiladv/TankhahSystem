{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "داشبورد مدیریت گردش کار" %}{% endblock %}

{% block extra_css %}
<style>
    .workflow-card {
        transition: transform 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .workflow-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    .action-buttons .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .template-status {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .workflow-flow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .workflow-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
    }
    .workflow-step .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
    }
    .workflow-arrow {
        font-size: 20px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- هدر داشبورد -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="mb-0">{{ templates_count }}</h3>
                                <p class="mb-0">{% trans "تمپلیت‌های فعال" %}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="mb-0">{{ statuses_count }}</h3>
                                <p class="mb-0">{% trans "وضعیت‌ها" %}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="mb-0">{{ actions_count }}</h3>
                                <p class="mb-0">{% trans "اقدامات" %}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="mb-0">{{ transitions_count }}</h3>
                                <p class="mb-0">{% trans "انتقال‌ها" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- دکمه‌های عملیات اصلی -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-cogs me-2"></i>
                        {% trans "عملیات اصلی" %}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'workflow_management:template_create' %}" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-plus me-2"></i>
                                {% trans "ایجاد تمپلیت جدید" %}
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'workflow_management:template_list' %}" class="btn btn-info btn-lg w-100">
                                <i class="fas fa-list me-2"></i>
                                {% trans "مشاهده تمام تمپلیت‌ها" %}
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'workflow_management:post_assignment_list' %}" class="btn btn-warning btn-lg w-100">
                                <i class="fas fa-users me-2"></i>
                                {% trans "تخصیص قوانین به پست‌ها" %}
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-success btn-lg w-100" onclick="showWorkflowBuilder()">
                                <i class="fas fa-sitemap me-2"></i>
                                {% trans "سازنده گردش کار" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- تب‌های اصلی -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="workflowTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                                <i class="fas fa-file-alt me-2"></i>{% trans "تمپلیت‌ها" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="statuses-tab" data-bs-toggle="tab" data-bs-target="#statuses" type="button" role="tab">
                                <i class="fas fa-flag me-2"></i>{% trans "وضعیت‌ها" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab">
                                <i class="fas fa-play me-2"></i>{% trans "اقدامات" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="transitions-tab" data-bs-toggle="tab" data-bs-target="#transitions" type="button" role="tab">
                                <i class="fas fa-exchange-alt me-2"></i>{% trans "انتقال‌ها" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                                <i class="fas fa-chart-bar me-2"></i>{% trans "گزارشات" %}
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="workflowTabContent">
                        <!-- تب تمپلیت‌ها -->
                        <div class="tab-pane fade show active" id="templates" role="tabpanel">
                            <div class="row">
                                {% for template in templates %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card workflow-card h-100">
                                        <div class="template-status">
                                            {% if template.is_active %}
                                                <span class="badge bg-success">{% trans "فعال" %}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{% trans "غیرفعال" %}</span>
                                            {% endif %}
                                            {% if template.is_public %}
                                                <span class="badge bg-info">{% trans "عمومی" %}</span>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title">{{ template.name }}</h5>
                                            <p class="card-text">{{ template.description|truncatechars:100 }}</p>
                                            
                                            <div class="mb-3">
                                                <small class="text-muted">
                                                    <i class="fas fa-building me-1"></i>
                                                    {{ template.organization.name }}
                                                </small><br>
                                                <small class="text-muted">
                                                    <i class="fas fa-tag me-1"></i>
                                                    {{ template.get_entity_type_display }}
                                                </small>
                                            </div>

                                            <!-- نمایش گردش کار -->
                                            <div class="workflow-flow">
                                                {% for status in template.rules_data.statuses|slice:":3" %}
                                                <div class="workflow-step">
                                                    <div class="step-icon bg-primary text-white">
                                                        <i class="fas fa-flag"></i>
                                                    </div>
                                                    <small>{{ status.name }}</small>
                                                </div>
                                                {% if not forloop.last %}
                                                <div class="workflow-arrow">→</div>
                                                {% endif %}
                                                {% endfor %}
                                                {% if template.rules_data.statuses|length > 3 %}
                                                <div class="workflow-step">
                                                    <div class="step-icon bg-secondary text-white">
                                                        <i class="fas fa-ellipsis-h"></i>
                                                    </div>
                                                    <small>...</small>
                                                </div>
                                                {% endif %}
                                            </div>

                                            <div class="action-buttons">
                                                <a href="{% url 'workflow_management:template_detail' template.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{% url 'workflow_management:template_edit' template.id %}" class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{% url 'workflow_management:apply_template' template.id %}" class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-copy"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate({{ template.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="text-center py-5">
                                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                                        <h5>{% trans "هیچ تمپلیتی یافت نشد" %}</h5>
                                        <p class="text-muted">{% trans "برای شروع، یک تمپلیت جدید ایجاد کنید" %}</p>
                                        <a href="{% url 'workflow_management:template_create' %}" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>{% trans "ایجاد تمپلیت جدید" %}
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- تب وضعیت‌ها -->
                        <div class="tab-pane fade" id="statuses" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "وضعیت‌های موجود" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>{% trans "نام" %}</th>
                                                            <th>{% trans "کد" %}</th>
                                                            <th>{% trans "نوع" %}</th>
                                                            <th>{% trans "عملیات" %}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for status in statuses %}
                                                        <tr>
                                                            <td>{{ status.name }}</td>
                                                            <td><code>{{ status.code }}</code></td>
                                                            <td>
                                                                {% if status.is_initial %}
                                                                    <span class="badge bg-primary">{% trans "اولیه" %}</span>
                                                                {% elif status.is_final_approve %}
                                                                    <span class="badge bg-success">{% trans "نهایی" %}</span>
                                                                {% elif status.is_final_reject %}
                                                                    <span class="badge bg-danger">{% trans "رد" %}</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">{% trans "میانی" %}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="editStatus({{ status.id }})">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "ایجاد وضعیت جدید" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="statusForm">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label class="form-label">{% trans "نام وضعیت" %}</label>
                                                    <input type="text" class="form-control" name="name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">{% trans "کد وضعیت" %}</label>
                                                    <input type="text" class="form-control" name="code" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">{% trans "توضیحات" %}</label>
                                                    <textarea class="form-control" name="description" rows="3"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="is_initial" id="is_initial">
                                                        <label class="form-check-label" for="is_initial">
                                                            {% trans "وضعیت اولیه" %}
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="is_final_approve" id="is_final_approve">
                                                        <label class="form-check-label" for="is_final_approve">
                                                            {% trans "وضعیت نهایی (تایید)" %}
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="is_final_reject" id="is_final_reject">
                                                        <label class="form-check-label" for="is_final_reject">
                                                            {% trans "وضعیت نهایی (رد)" %}
                                                        </label>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-2"></i>{% trans "ذخیره" %}
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- تب اقدامات -->
                        <div class="tab-pane fade" id="actions" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "اقدامات موجود" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>{% trans "نام" %}</th>
                                                            <th>{% trans "کد" %}</th>
                                                            <th>{% trans "عملیات" %}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for action in actions %}
                                                        <tr>
                                                            <td>{{ action.name }}</td>
                                                            <td><code>{{ action.code }}</code></td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="editAction({{ action.id }})">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "ایجاد اقدام جدید" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="actionForm">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label class="form-label">{% trans "نام اقدام" %}</label>
                                                    <input type="text" class="form-control" name="name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">{% trans "کد اقدام" %}</label>
                                                    <input type="text" class="form-control" name="code" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">{% trans "توضیحات" %}</label>
                                                    <textarea class="form-control" name="description" rows="3"></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-2"></i>{% trans "ذخیره" %}
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- تب انتقال‌ها -->
                        <div class="tab-pane fade" id="transitions" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "انتقال‌های موجود" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>{% trans "از وضعیت" %}</th>
                                                            <th>{% trans "اقدام" %}</th>
                                                            <th>{% trans "به وضعیت" %}</th>
                                                            <th>{% trans "سازمان" %}</th>
                                                            <th>{% trans "نوع موجودیت" %}</th>
                                                            <th>{% trans "عملیات" %}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for transition in transitions %}
                                                        <tr>
                                                            <td>{{ transition.from_status.name }}</td>
                                                            <td>{{ transition.action.name }}</td>
                                                            <td>{{ transition.to_status.name }}</td>
                                                            <td>{{ transition.organization.name }}</td>
                                                            <td>{{ transition.entity_type.name }}</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="editTransition({{ transition.id }})">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransition({{ transition.id }})">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- تب گزارشات -->
                        <div class="tab-pane fade" id="reports" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "آمار کلی" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="workflowStatsChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>{% trans "گزارشات موجود" %}</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="list-group">
                                                <a href="#" class="list-group-item list-group-item-action">
                                                    <i class="fas fa-chart-pie me-2"></i>
                                                    {% trans "گزارش استفاده از تمپلیت‌ها" %}
                                                </a>
                                                <a href="#" class="list-group-item list-group-item-action">
                                                    <i class="fas fa-clock me-2"></i>
                                                    {% trans "گزارش زمان‌های پردازش" %}
                                                </a>
                                                <a href="#" class="list-group-item list-group-item-action">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    {% trans "گزارش خطاها" %}
                                                </a>
                                                <a href="#" class="list-group-item list-group-item-action">
                                                    <i class="fas fa-users me-2"></i>
                                                    {% trans "گزارش کاربران فعال" %}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال حذف تمپلیت -->
<div class="modal fade" id="deleteTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "تایید حذف" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "آیا مطمئن هستید که می‌خواهید این تمپلیت را حذف کنید؟" %}</p>
                <p class="text-danger"><small>{% trans "این عمل قابل بازگشت نیست." %}</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "انصراف" %}</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">{% trans "حذف" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- مودال سازنده گردش کار -->
<div class="modal fade" id="workflowBuilderModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "سازنده گردش کار" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>{% trans "وضعیت‌ها" %}</h6>
                        <div id="statusPalette" class="border p-3" style="min-height: 200px;">
                            <!-- وضعیت‌ها اینجا نمایش داده می‌شوند -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>{% trans "گردش کار" %}</h6>
                        <div id="workflowCanvas" class="border p-3" style="min-height: 400px;">
                            <!-- گردش کار اینجا طراحی می‌شود -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>{% trans "اقدامات" %}</h6>
                        <div id="actionPalette" class="border p-3" style="min-height: 200px;">
                            <!-- اقدامات اینجا نمایش داده می‌شوند -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "انصراف" %}</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkflow()">{% trans "ذخیره گردش کار" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// متغیرهای全局
let deleteTemplateId = null;

// تابع حذف تمپلیت
function deleteTemplate(templateId) {
    deleteTemplateId = templateId;
    $('#deleteTemplateModal').modal('show');
}

// تایید حذف
$('#confirmDelete').click(function() {
    if (deleteTemplateId) {
        // ارسال درخواست حذف
        fetch(`/workflow-management/templates/${deleteTemplateId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('خطا در حذف تمپلیت: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در حذف تمپلیت');
        });
    }
});

// تابع نمایش سازنده گردش کار
function showWorkflowBuilder() {
    $('#workflowBuilderModal').modal('show');
    loadWorkflowBuilder();
}

// بارگذاری سازنده گردش کار
function loadWorkflowBuilder() {
    // بارگذاری وضعیت‌ها
    loadStatuses();
    // بارگذاری اقدامات
    loadActions();
    // راه‌اندازی canvas
    initWorkflowCanvas();
}

// بارگذاری وضعیت‌ها
function loadStatuses() {
    fetch('/workflow-management/api/statuses/')
        .then(response => response.json())
        .then(data => {
            const palette = document.getElementById('statusPalette');
            palette.innerHTML = '';
            data.statuses.forEach(status => {
                const div = document.createElement('div');
                div.className = 'status-item p-2 mb-2 border rounded cursor-pointer';
                div.innerHTML = `
                    <i class="fas fa-flag me-2"></i>
                    ${status.name}
                `;
                div.draggable = true;
                div.dataset.statusId = status.id;
                palette.appendChild(div);
            });
        });
}

// بارگذاری اقدامات
function loadActions() {
    fetch('/workflow-management/api/actions/')
        .then(response => response.json())
        .then(data => {
            const palette = document.getElementById('actionPalette');
            palette.innerHTML = '';
            data.actions.forEach(action => {
                const div = document.createElement('div');
                div.className = 'action-item p-2 mb-2 border rounded cursor-pointer';
                div.innerHTML = `
                    <i class="fas fa-play me-2"></i>
                    ${action.name}
                `;
                div.draggable = true;
                div.dataset.actionId = action.id;
                palette.appendChild(div);
            });
        });
}

// راه‌اندازی canvas گردش کار
function initWorkflowCanvas() {
    const canvas = document.getElementById('workflowCanvas');
    // پیاده‌سازی drag & drop
    canvas.addEventListener('dragover', function(e) {
        e.preventDefault();
    });
    
    canvas.addEventListener('drop', function(e) {
        e.preventDefault();
        const data = e.dataTransfer.getData('text/plain');
        // اضافه کردن المان به canvas
    });
}

// ذخیره گردش کار
function saveWorkflow() {
    // جمع‌آوری داده‌های گردش کار
    const workflowData = {
        name: prompt('نام گردش کار:'),
        description: prompt('توضیحات:'),
        // سایر داده‌ها
    };
    
    // ارسال به سرور
    fetch('/workflow-management/templates/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(workflowData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('خطا در ذخیره گردش کار: ' + data.message);
        }
    });
}

// فرم وضعیت
$('#statusForm').submit(function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/workflow-management/api/statuses/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('خطا در ایجاد وضعیت: ' + data.message);
        }
    });
});

// فرم اقدام
$('#actionForm').submit(function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/workflow-management/api/actions/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('خطا در ایجاد اقدام: ' + data.message);
        }
    });
});

// نمودار آمار
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('workflowStatsChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['تمپلیت‌ها', 'وضعیت‌ها', 'اقدامات', 'انتقال‌ها'],
            datasets: [{
                data: [{{ templates_count }}, {{ statuses_count }}, {{ actions_count }}, {{ transitions_count }}],
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
});
</script>
{% endblock %}