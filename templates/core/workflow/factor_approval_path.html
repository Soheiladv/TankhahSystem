{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .main-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        margin: 20px;
        padding: 30px;
    }

    .header-section {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: var(--primary-gradient);
        border-radius: 20px;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .header-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .header-section h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .stat-card h3 {
        color: #667eea;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .stat-card p {
        color: #6c757d;
        margin: 0;
        font-weight: 500;
    }

    .stat-card i {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 2rem;
        color: rgba(102, 126, 234, 0.3);
    }

    .approval-path {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .path-step {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 15px;
        transition: all 0.3s ease;
        position: relative;
    }

    .path-step:hover {
        transform: translateX(10px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .path-step.current {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border: 2px solid #667eea;
    }

    .path-step.completed {
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
        border: 2px solid #4facfe;
    }

    .path-step.pending {
        background: linear-gradient(135deg, rgba(250, 112, 154, 0.1) 0%, rgba(254, 225, 64, 0.1) 100%);
        border: 2px solid #fa709a;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 20px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .step-number.current {
        background: var(--primary-gradient);
        animation: pulse 2s infinite;
    }

    .step-number.completed {
        background: var(--success-gradient);
    }

    .step-number.pending {
        background: var(--warning-gradient);
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .step-content {
        flex: 1;
    }

    .step-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .step-action {
        font-size: 1.1rem;
        color: #667eea;
        margin-bottom: 15px;
        font-weight: 500;
    }

    .step-status {
        font-size: 1rem;
        margin-bottom: 15px;
    }

    .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .status-current {
        background: rgba(102, 126, 234, 0.2);
        color: #667eea;
    }

    .status-completed {
        background: rgba(79, 172, 254, 0.2);
        color: #4facfe;
    }

    .status-pending {
        background: rgba(250, 112, 154, 0.2);
        color: #fa709a;
    }

    .posts-section {
        margin-top: 15px;
    }

    .posts-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
    }

    .post-item {
        display: inline-block;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 8px 15px;
        margin: 5px 5px 5px 0;
        font-size: 0.9rem;
        color: #495057;
    }

    .users-section {
        margin-top: 15px;
    }

    .users-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
    }

    .user-item {
        display: inline-block;
        background: linear-gradient(135deg, rgba(168, 237, 234, 0.3) 0%, rgba(254, 214, 227, 0.3) 100%);
        border: 1px solid rgba(168, 237, 234, 0.5);
        border-radius: 10px;
        padding: 8px 15px;
        margin: 5px 5px 5px 0;
        font-size: 0.9rem;
        color: #2c3e50;
    }

    .approval-history {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .history-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }

    .history-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--success-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.1rem;
    }

    .history-content {
        flex: 1;
    }

    .history-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #2c3e50;
    }

    .history-details {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .btn {
        border-radius: 25px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
        background: var(--success-gradient);
        color: white;
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
    }

    .btn:hover {
        transform: translateY(-3px);
    }

    .progress-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--success-gradient);
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    @media (max-width: 768px) {
        .main-container {
            margin: 10px;
            padding: 20px;
        }
        
        .header-section {
            padding: 20px 15px;
        }
        
        .header-section h1 {
            font-size: 1.8rem;
        }
        
        .stats-cards {
            grid-template-columns: 1fr;
        }
        
        .path-step {
            flex-direction: column;
            text-align: center;
        }
        
        .step-number {
            margin-right: 0;
            margin-bottom: 15px;
        }
    }
</style>
{% endblock %}

{% block title %}
    {% trans "مسیر تأیید فاکتور" %} - {{ factor.tankhah.number }}
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- هدر اصلی -->
    <div class="header-section">
        <h1>
            <i class="fas fa-route me-3"></i>
            {% trans "مسیر تأیید فاکتور" %}
        </h1>
        <p>{% trans "نمایش کامل مراحل تأیید و افراد مسئول" %}</p>
        <div class="mt-3">
            <span class="badge bg-light text-dark me-2">
                <i class="fas fa-file-invoice me-1"></i>
                {{ factor.tankhah.number }}
            </span>
            <span class="badge bg-light text-dark me-2">
                <i class="fas fa-building me-1"></i>
                {{ factor.tankhah.organization.name }}
            </span>
            <span class="badge bg-light text-dark">
                <i class="fas fa-info-circle me-1"></i>
                {% trans "وضعیت فعلی" %}: {{ factor.status.name }}
            </span>
        </div>
    </div>

    <!-- آمار کلی -->
    <div class="stats-cards">
        <div class="stat-card">
            <i class="fas fa-list-ol"></i>
            <h3>{{ path_stats.total_steps }}</h3>
            <p>{% trans "کل مراحل" %}</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-check-circle"></i>
            <h3>{{ path_stats.completed_steps }}</h3>
            <p>{% trans "مراحل تکمیل شده" %}</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-clock"></i>
            <h3>{{ path_stats.remaining_steps }}</h3>
            <p>{% trans "مراحل باقی‌مانده" %}</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-percentage"></i>
            <h3>{{ path_stats.completion_percentage|floatformat:1 }}%</h3>
            <p>{% trans "درصد پیشرفت" %}</p>
        </div>
    </div>

    <!-- نوار پیشرفت -->
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ path_stats.completion_percentage }}%"></div>
    </div>

    <!-- مسیر تأیید -->
    <div class="approval-path">
        <h3 class="mb-4">
            <i class="fas fa-route me-2"></i>
            {% trans "مسیر کامل تأیید" %}
        </h3>
        
        {% for step in approval_path %}
        <div class="path-step {{ step.is_current|yesno:'current,' }}{{ step.is_completed|yesno:'completed,' }}{{ step.is_pending|yesno:'pending,' }}">
            <div class="step-number {{ step.is_current|yesno:'current,' }}{{ step.is_completed|yesno:'completed,' }}{{ step.is_pending|yesno:'pending,' }}">
                {{ step.step_number }}
            </div>
            <div class="step-content">
                <div class="step-title">
                    {% if step.action %}
                        {{ step.action.name }}
                    {% else %}
                        {% trans "وضعیت فعلی" %}
                    {% endif %}
                </div>
                
                {% if step.action %}
                <div class="step-action">
                    <i class="fas fa-arrow-right me-2"></i>
                    {% trans "از" %} "{{ step.from_status.name }}" {% trans "به" %} "{{ step.to_status.name }}"
                </div>
                {% endif %}
                
                <div class="step-status">
                    {% if step.is_current %}
                        <span class="status-badge status-current">
                            <i class="fas fa-play me-1"></i>
                            {% trans "در حال انجام" %}
                        </span>
                    {% elif step.is_completed %}
                        <span class="status-badge status-completed">
                            <i class="fas fa-check me-1"></i>
                            {% trans "تکمیل شده" %}
                        </span>
                    {% else %}
                        <span class="status-badge status-pending">
                            <i class="fas fa-clock me-1"></i>
                            {% trans "در انتظار" %}
                        </span>
                    {% endif %}
                </div>
                
                {% if step.posts %}
                <div class="posts-section">
                    <div class="posts-title">
                        <i class="fas fa-user-tie me-1"></i>
                        {% trans "پست‌های مسئول" %}:
                    </div>
                    {% for post in step.posts %}
                        <span class="post-item">
                            {{ post.name }} (سطح {{ post.level }})
                        </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if step.users %}
                <div class="users-section">
                    <div class="users-title">
                        <i class="fas fa-users me-1"></i>
                        {% trans "کاربران فعال" %}:
                    </div>
                    {% for user_info in step.users %}
                        <span class="user-item">
                            {{ user_info.user.get_full_name|default:user_info.user.username }}
                            ({{ user_info.post.name }})
                        </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- تاریخچه تأییدات -->
    {% if approval_history %}
    <div class="approval-history">
        <h3 class="mb-4">
            <i class="fas fa-history me-2"></i>
            {% trans "تاریخچه تأییدات" %}
        </h3>
        
        {% for log in approval_history %}
        <div class="history-item">
            <div class="history-icon">
                {% if log.action.code == 'APPROVE' %}
                    <i class="fas fa-check"></i>
                {% elif log.action.code == 'REJECT' %}
                    <i class="fas fa-times"></i>
                {% else %}
                    <i class="fas fa-arrow-right"></i>
                {% endif %}
            </div>
            <div class="history-content">
                <div class="history-title">
                    {{ log.action.name }} - {{ log.to_status.name }}
                </div>
                <div class="history-details">
                    <i class="fas fa-user me-1"></i>
                    {{ log.user.get_full_name|default:log.user.username }}
                    {% if log.post %}
                        ({{ log.post.name }})
                    {% endif %}
                    <br>
                    <i class="fas fa-clock me-1"></i>
                    {{ log.timestamp|date:"Y/m/d H:i" }}
                    {% if log.comment %}
                        <br>
                        <i class="fas fa-comment me-1"></i>
                        {{ log.comment }}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- دکمه‌های عملیات -->
    <div class="text-center mt-4">
        <a href="{% url 'detail_factor' factor.pk %}" class="btn btn-primary me-3">
            <i class="fas fa-eye me-2"></i>
            {% trans "مشاهده جزئیات فاکتور" %}
        </a>
        <a href="{% url 'factor_list' %}" class="btn btn-success">
            <i class="fas fa-list me-2"></i>
            {% trans "بازگشت به لیست فاکتورها" %}
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // انیمیشن نوار پیشرفت
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        setTimeout(() => {
            progressFill.style.width = '{{ path_stats.completion_percentage }}%';
        }, 500);
    }
    
    // انیمیشن کارت‌های آمار
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 100);
    });
    
    // انیمیشن مراحل مسیر
    const pathSteps = document.querySelectorAll('.path-step');
    pathSteps.forEach((step, index) => {
        setTimeout(() => {
            step.style.opacity = '0';
            step.style.transform = 'translateX(-20px)';
            step.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                step.style.opacity = '1';
                step.style.transform = 'translateX(0)';
            }, 100);
        }, index * 150);
    });
});
</script>
{% endblock %}
