*** چشم‌انداز معماری جدید: سیستم دسترسی دوگانه (Dual-Mode Access System)
دسترسی‌های گردش کار (Workflow Permissions):
ماهیت: ترتیبی، مرحله‌ای، بر اساس سطح (level).
اقدامات: APPROVE, REJECT, FINAL_APPROVE, SUBMIT.
پیاده‌سازی:  (گروه‌بندی بر اساس Post.level و تعریف نام مرحله برای هر سطح).
دسترسی‌های عمومی/ثابت (Static Permissions):
ماهیت: غیرترتیبی، باینری (دارد یا ندارد)، مستقل از سطح و مرحله.
اقدامات: VIEW, EDIT, CREATE, DELETE, SIGN_PAYMENT.
پیاده‌سازی: برای هر پست، یک سری چک‌باکس ساده برای این اقدامات وجود خواهد داشت، بدون نیاز به تعریف مرحله یا ترتیب.
دسترسی سلسله مراتبی (Hierarchical Access):
این یک منطق در بک‌اند است. هر زمان که سیستم در حال بررسی یک مجوز است (مثلاً user.has_perm('tankhah.factor_edit', factor_object)), تابع بررسی‌کننده باید نه تنها قوانین سازمان خود فاکتور، بلکه قوانین سازمان‌های والد آن را نیز در نظر بگیرد.

***
راه حل استراتژیک: تفکیک نگرانی‌ها (Separation of Concerns)
ما باید دو نوع دسترسی را به طور کامل از هم جدا کنیم:
دسترسی‌های عمومی (General Permissions): مانند VIEW, EDIT, CREATE, DELETE. اینها معمولاً به نقش کاربر (Role) یا پرمیشن‌های استاندارد جنگو مرتبط هستند و به مرحله گردش کار ربطی ندارند. PermissionBaseView شما در حال حاضر این بخش را به خوبی مدیریت می‌کند. ما باید این بخش را تقویت کنیم.
دسترسی‌های گردش کار (Workflow Permissions): مانند APPROVE, REJECT, SUBMIT. اینها مختص مراحل یک فرآیند هستند و باید توسط یک سیستم مدیریت گردش کار مجزا تعریف شوند.

طرح جدید:
برای دسترسی‌های عمومی: ما به طور کامل به سیستم پرمیشن داخلی جنگو و گروه‌ها (Roles) تکیه می‌کنیم. این روش استاندارد، امن و قابل نگهداری است.
برای دسترسی‌های گردش کار: ما یک سیستم مدیریت گردش کار ساده و بصری (مانند آنچه در پاسخ‌های قبلی طراحی کردیم) ایجاد می‌کنیم که فقط و فقط مسئول تعریف مراحل تایید است.
بازطراحی عملی: دو پنل مدیریت مجزا
ما دو صفحه مدیریت کاملاً مجزا برای ادمین سیستم ایجاد می‌کنیم:
۱. پنل مدیریت نقش‌ها و دسترسی‌های عمومی (استفاده از ادمین جنگو):
قدم اول: به ادمین جنگو بروید و گروه‌هایی (Groups) با نام‌های معنادار ایجاد کنید:
کارشناسان ثبت فاکتور
مدیران مالی
مشاهده‌کنندگان گزارشات
قدم دوم: به هر گروه، پرمیشن‌های عمومی لازم را تخصیص دهید. مثلا به گروه کارشناسان ثبت فاکتور:
tankhah | factor | Can add factor
tankhah | factor | Can change factor (فقط برای فاکتورهای خودشان)
tankhah | factor | Can view factor
قدم سوم: هر کاربر را به گروه(های) مربوطه اضافه کنید.
مزایا: شما از سیستم امن و تست‌شده جنگو برای مدیریت دسترسی‌های CRUD (Create, Read, Update, Delete) استفاده می‌کنید. PermissionBaseView شما با چک کردن user.has_perm() این قوانین را به صورت خودکار اعمال خواهد کرد.
۲. پنل مدیریت گردش کار تأییدات (ویو و فرم جدید و ساده‌شده):
این همان ویویی است که ما روی آن کار می‌کردیم، اما حالا با یک هدف بسیار مشخص‌تر: فقط تعریف مراحل تأیید.



سناریوی گام به گام برای مدیر سیستم:
ورود به داشبورد گردش کار:
شما به عنوان ادمین به آدرس /workflow/ (یا هر آدرسی که برای WorkflowDashboardView تنظیم کرده‌اید) می‌روید.
شما چهار کارت اصلی را می‌بینید: مدیریت وضعیت‌ها، اقدامات، گذارها و مجوزها.
تعریف آجرها (یک بار برای همیشه):
ورود به بخش "مدیریت وضعیت‌ها":
شما تمام وضعیت‌های لازم را ایجاد می‌کنید:
code='DRAFT', name='پیش‌نویس', is_initial=True
code='PENDING_APPROVAL', name='در انتظار تایید'
code='APPROVED_FINAL', name='تایید نهایی', is_final_approve=True
code='REJECTED', name='رد شده', is_final_reject=True
ورود به بخش "مدیریت اقدامات":
شما تمام اقدامات لازم را ایجاد می‌کنید:
code='SUBMIT', name='ارسال برای تایید'
code='APPROVE', name='تایید'
code='REJECT', name='رد'
طراحی نقشه راه (تعریف Transition ها):
ورود به بخش "مدیریت گذارها": شما مسیرهای ممکن در فرآیند را "نقاشی" می‌کنید.
گذار اول (شروع فرآیند):
name: "ارسال فاکتور توسط کارشناس"
entity_type: FACTORITEM
from_status: "پیش‌نویس"
action: "ارسال برای تایید"
to_status: "در انتظار تایید"
گذار دوم (مسیر موفقیت):
name: "تایید فاکتور توسط مدیر"
entity_type: FACTORITEM
from_status: "در انتظار تایید"
action: "تایید"
to_status: "تایید نهایی"
گذار سوم (مسیر شکست):
name: "رد فاکتور توسط مدیر"
entity_type: FACTORITEM
from_status: "در انتظار تایید"
action: "رد"
to_status: "رد شده"
شما با این کار، منطق کامل گردش کار را در دیتابیس تعریف کرده‌اید.
تخصیص مجوزها (مرحله نهایی):
ورود به بخش "مدیریت مجوزها" (PermissionCreateView): این همان صفحه‌ای است که در حال ساخت آن هستیم.
مجوز اول (برای کارشناس):
organization: "شعبه اصفهان"
entity_type: FACTORITEM
on_status: "پیش‌نویس"
allowed_posts: شما پست "کارشناس مالی" را تیک می‌زنید.
allowed_actions: شما اقدام "ارسال برای تایید" را تیک می‌زنید.
مجوز دوم (برای مدیر):
organization: "شعبه اصفهان"
entity_type: FACTORITEM
on_status: "در انتظار تایید"
allowed_posts: شما پست "مدیر شعبه اصفهان" را تیک می‌زنید.
allowed_actions: شما اقدامات "تایید" و "رد" را تیک می‌زنید.

	