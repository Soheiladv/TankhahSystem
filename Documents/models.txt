
class BudgetPeriod(models.Model):

    organization = models.ForeignKey('core.Organization', on_delete=models.CASCADE, verbose_name=_("Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ"),related_name='budget_periods')
    name = models.CharField(max_length=100, unique=True, verbose_name=_("Ù†Ø§Ù… Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡"))
    start_date = models.DateField(verbose_name=_("ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹"))
    end_date = models.DateField(verbose_name=_("ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†"))
    total_amount = models.DecimalField(max_digits=25, decimal_places=0, verbose_name=_("Ù…Ø¨Ù„Øº Ú©Ù„"))
    total_allocated = models.DecimalField(max_digits=25, decimal_places=2, default=0, verbose_name=_("Ù…Ø¬Ù…ÙˆØ¹ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§"))
    returned_amount = models.DecimalField(max_digits=25, decimal_places=2, default=0,verbose_name=_("Ù…Ø¬Ù…ÙˆØ¹ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø±Ú¯Ø´ØªÛŒ"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))
    is_archived = models.BooleanField(default=False, verbose_name=_("Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø´Ø¯Ù‡"))
    is_completed = models.BooleanField(default=False, verbose_name=_("ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True,related_name='budget_periods_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    locked_percentage = models.IntegerField(default=0, verbose_name=_("Ø¯Ø±ØµØ¯ Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡"),help_text=_("Ø¯Ø±ØµØ¯ Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù‡ Ù‚ÙÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (0-100)"))
    warning_threshold = models.DecimalField(max_digits=5, decimal_places=2, default=10, verbose_name=_("Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø®Ø·Ø§Ø±"),help_text=_("Ø¯Ø±ØµØ¯ÛŒ Ú©Ù‡ Ù‡Ø´Ø¯Ø§Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (0-100)"))
    warning_action = models.CharField(max_length=50,choices=[('NOTIFY', _("ÙÙ‚Ø· Ø§Ø¹Ù„Ø§Ù†")), ('LOCK', _("Ù‚ÙÙ„ Ú©Ø±Ø¯Ù†")),('RESTRICT', _("Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø«Ø¨Øª"))],default='NOTIFY',verbose_name=_("Ø§Ù‚Ø¯Ø§Ù… Ù‡Ø´Ø¯Ø§Ø±") ,
                                      help_text=_("Ø±ÙØªØ§Ø± Ø³ÛŒØ³ØªÙ… Ù‡Ù†Ú¯Ø§Ù… Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ Ù‡Ø´Ø¯Ø§Ø±"))
    allocation_phase = models.CharField(max_length=50, blank=True, verbose_name=_("ÙØ§Ø² ØªØ®ØµÛŒØµ"))
    description = models.TextField(blank=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))

    lock_condition = models.CharField(max_length=50,choices=[('AFTER_DATE', _("Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†")), ('MANUAL', _("Ø¯Ø³ØªÛŒ")),
                                               ('ZERO_REMAINING', _("Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØµÙØ±")), ], default='AFTER_DATE',verbose_name=_("Ø´Ø±Ø· Ù‚ÙÙ„"))

    is_locked = models.BooleanField(default=False, verbose_name=_("Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡"))  # ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯

    class Meta:
        verbose_name = _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")
        verbose_name_plural = _("Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡")
        default_permissions = ()
        permissions = [
            ('budgetperiod_add', _("Ø§ÙØ²ÙˆØ¯Ù† Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetperiod_update', _("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetperiod_view', _("Ù†Ù…Ø§ÛŒØ´ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetperiod_delete', _("Ø­Ø°Ù Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetperiod_archive', _("Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")),
        ]

    def __str__(self):
        return f"{self.name} ({self.organization.code})"

    def clean(self):
        # super().clean()
        # if self.total_allocated > self.total_amount:
        #     raise ValidationError(_("Ù…Ø¬Ù…ÙˆØ¹ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§Ø² Ù…Ø¨Ù„Øº Ú©Ù„ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯."))
        if not self.start_date or not self.end_date:
            raise ValidationError(_("ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯."))
        if self.end_date <= self.start_date:
            raise ValidationError(_("ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯."))
        if not (0 <= self.locked_percentage <= 100):
            raise ValidationError(_("Ø¯Ø±ØµØ¯ Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 100 Ø¨Ø§Ø´Ø¯."))
        if not (0 <= self.warning_threshold <= 100):
            raise ValidationError(_("Ø¢Ø³ØªØ§Ù†Ù‡ Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 100 Ø¨Ø§Ø´Ø¯."))
        if self.is_completed and self.is_active:
            raise ValidationError(_("Ø¯ÙˆØ±Ù‡ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯."))

    def validate_allocation(self, allocation_amount):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ®ØµÛŒØµ Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ø¯Ø±ØµØ¯ Ù‚ÙÙ„"""
        remaining = self.get_remaining_amount()
        locked_amount = self.get_locked_amount()
        available_for_allocation = remaining - locked_amount

        if allocation_amount > available_for_allocation:
            raise ValidationError(
                _(
                    f"Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯. Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ ({allocation_amount:,.0f} Ø±ÛŒØ§Ù„) Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¬Ø§Ø² ({available_for_allocation:,.0f} Ø±ÛŒØ§Ù„) Ø§Ø³Øª."
                    f"Ø­Ø¯Ø§Ù‚Ù„ {self.locked_percentage}% Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§ÛŒØ¯ Ù‚ÙÙ„ Ø¨Ù…Ø§Ù†Ø¯."
                )
            )

    def update_lock_status(self):
        """Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‚ÙÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÛŒØ²Ø§Ù† Ø¨ÙˆØ¯Ø¬Ù‡"""
        remaining_amount = self.get_remaining_amount()
        locked_amount = self.get_locked_amount()
        now_date = timezone.now().date()

        if self.lock_condition == 'ZERO_REMAINING' and remaining_amount <= locked_amount:
            self.is_locked = True
            self.is_active = False
            # Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ù‚ÙÙ„
        elif self.lock_condition == 'AFTER_DATE' and self.end_date < now_date:
            self.is_locked = True
            self.is_active = False
        elif self.lock_condition == 'MANUAL':
        # Ù‚ÙÙ„ Ø¯Ø³ØªÛŒ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            pass
        elif self.lock_condition == 'COMBINED':
            # ØªØ±Ú©ÛŒØ¨ÛŒ: Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ú¯Ø°Ø´ØªÙ‡ ÛŒØ§ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØµÙØ± Ø¨Ø§Ø´Ø¯
            self.is_locked = (self.end_date < now_date) or (remaining_amount <= 0)
        else:
            self.is_locked = False

        self.save(update_fields=['is_locked', 'is_active'])

        # Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† ØªÙ†Ø®ÙˆØ§Ù‡â€ŒÙ‡Ø§ Ùˆ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§
        if self.is_locked:
            self.allocations.update(is_locked=True, is_active=False)
            Tankhah.objects.filter(allocation__budget_period=self).update(is_active=False)

    def get_lock_message(self):
        """Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‚ÙÙ„"""
        if self.lock_condition == 'AFTER_DATE' and self.is_locked:
            return _("ØªØ§Ø±ÛŒØ® Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ùˆ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        elif self.lock_condition == 'ZERO_REMAINING' and self.is_locked:
            return _("Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯ÙˆØ±Ù‡ ØµÙØ± ÛŒØ§ Ú©Ù…ØªØ± Ø§Ø³Øª Ùˆ Ø¯ÙˆØ±Ù‡ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        elif self.lock_condition == 'COMBINED' and self.is_locked:
            return _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù¾Ø§ÛŒØ§Ù† ØªØ§Ø±ÛŒØ® ÛŒØ§ Ø§ØªÙ…Ø§Ù… Ø¨ÙˆØ¯Ø¬Ù‡ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        elif self.lock_condition == 'MANUAL' and self.is_locked:
            return _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        return _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ ÙØ¹Ø§Ù„ Ùˆ Ø¨Ø§Ø² Ø§Ø³Øª.")

    def get_remaining_amount(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯ÙˆØ±Ù‡"""
        """Ù…Ù†Ø·Ù‚ Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª (Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ Ùˆ Ù†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)."""
        from django.db.models import Sum
        from decimal import Decimal
        total_allocated = self.allocations.aggregate(
            total=Sum('allocated_amount')
        )['total'] or Decimal('0')
        return max(self.total_amount - total_allocated + self.returned_amount, Decimal('0'))

    def send_notification(self, status, message):
        recipients = CustomUser.objects.filter(
            organizations=self.organization,
            roles__name__in=['Financial Manager', 'Budget Manager']
        ).distinct()
        send_notification(self, status, message, recipients)

    def get_locked_amount(self):
        """    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ (Ø¨Ø±Ø§ÛŒ Ù‚ÙÙ„ ÛŒØ§ Ù‡Ø´Ø¯Ø§Ø±)."""
        return calculate_threshold_amount(self.total_amount, self.locked_percentage)

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)
        status, message = check_budget_status(self)

        # self.budget_period.total_allocated = BudgetAllocation.objects.filter(
        #     budget_period=self
        # ).aggregate(Sum('allocated_amount'))['allocated_amount__sum'] or Decimal('0')
        # self.budget_period.save(update_fields=['total_allocated'])

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø®Ø·Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ø°Ø®ÛŒØ±Ù‡
        self.check_warning_threshold()

        # """Ø§Ø¬Ø±Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ù‡Ø´Ø¯Ø§Ø±"""
        self.apply_warning_action()

        if status in ('warning', 'locked', 'completed'):
            self.send_notification(status, message)

    def check_warning_threshold(self):
        """Checks if the remaining budget has reached the warning threshold."""
        if self.warning_threshold <= 0 or self.total_amount <= 0: # No warning if threshold or total is zero
            return False, None

        remaining_percentage = (self.get_remaining_amount() / self.total_amount) * Decimal('100')
        if remaining_percentage <= self.warning_threshold:
            warning_message = _("Ù‡Ø´Ø¯Ø§Ø±: Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ {}% Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª (Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡: {:,}).").format(
                self.warning_threshold, self.get_remaining_amount()
            )
            return True, warning_message
        return False, None

    def get_warning_amount(self):
        """    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ (Ø¨Ø±Ø§ÛŒ Ù‚ÙÙ„ ÛŒØ§ Ù‡Ø´Ø¯Ø§Ø±)."""
        return calculate_threshold_amount(self.total_amount, self.warning_threshold)

    @property # Use property for easy access like a field
    def is_period_locked(self):
        """Checks if the budget period is currently locked based on conditions."""
        now_date = timezone.now().date()

        # Condition 1: Manual Lock (Assuming you add an 'is_manually_locked' field)
        # if self.is_manually_locked:
        #    return True, _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")

        # Condition 2: After End Date
        if self.lock_condition == 'AFTER_DATE' and self.end_date < now_date:
            # Optionally update is_active here if not done elsewhere
            # if self.is_active:
            #     self.is_active = False
            #     self.save(update_fields=['is_active'])
            return True, _("ØªØ§Ø±ÛŒØ® Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ùˆ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")

        # Condition 3: Zero Remaining (or below zero)
        # We need the *actual* remaining amount here
        if self.lock_condition == 'ZERO_REMAINING' and self.get_remaining_amount() <= 0:
             # Optionally update is_completed/is_active here
             # if not self.is_completed:
             #    self.is_completed = True
             #    self.is_active = False
             #    self.save(update_fields=['is_completed', 'is_active'])
            return True, _("Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯ÙˆØ±Ù‡ ØµÙØ± ÛŒØ§ Ú©Ù…ØªØ± Ø§Ø³Øª Ùˆ Ø¯ÙˆØ±Ù‡ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.")

        # Condition 4: Locked Percentage (Based on *allocated* amount, not remaining)
        # This interpretation means you cannot allocate more than (100 - locked_percentage)%
        # It usually doesn't prevent spending the allocated amount.
        # If the intention is to lock *spending* when remaining is below locked percentage:
        # remaining = self.get_remaining_amount()
        # locked_threshold_amount = (self.total_amount * self.locked_percentage) / Decimal('100')
        # if remaining <= locked_threshold_amount:
        #     return True, _("Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ù‡ Ø­Ø¯ Ø¯Ø±ØµØ¯ Ù‚ÙÙ„ Ø´Ø¯Ù‡ ({}) Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.").format(self.locked_percentage)

        return False, _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ ÙØ¹Ø§Ù„ Ùˆ Ø¨Ø§Ø² Ø§Ø³Øª.")

    def apply_warning_action(self):
        """Ø§Ø¬Ø±Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ù‡Ø´Ø¯Ø§Ø±"""
        is_warning, message = self.check_warning_threshold()
        if not is_warning:
            return

        if self.warning_action == 'NOTIFY':
            self.log_action("WARNING", message)
        elif self.warning_action == 'LOCK':
            self.is_locked = True
            self.is_active = False
            self.save(update_fields=['is_locked', 'is_active'])
            self.log_action("LOCK", _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø®Ø·Ø§Ø± Ù‚ÙÙ„ Ø´Ø¯."))
            self.send_notification("locked", _("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø®Ø·Ø§Ø± Ù‚ÙÙ„ Ø´Ø¯."))
        elif self.warning_action == 'RESTRICT':
            self.is_active = False
            self.save(update_fields=['is_active'])
            self.log_action("RESTRICT", _("Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯."))
            self.send_notification("restricted", _("Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯."))

    def log_action(self, action, message):
        BudgetHistory.objects.create(
            content_type=ContentType.objects.get_for_model(self),
            object_id=self.id,
            action=action,
            created_by=self.created_by,
            details=message,
            transaction_type='SYSTEM',
            transaction_id=f"SYS-{timezone.now().strftime('%Y%m%d%H%M%S%f')}"
        )
# ------------------------------------
# ------------------------------------
""" BudgetAllocation (ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡):"""
class BudgetAllocation(models.Model):
    """
    ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ (Ø´Ø¹Ø¨Ø§Øª ÛŒØ§ Ø§Ø¯Ø§Ø±Ø§Øª) Ùˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§.
    Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§: ØªØ®ØµÛŒØµ Ú†Ù†Ø¯Ø¨Ø§Ø±Ù‡ØŒ ØªÙˆÙ‚Ù Ø¨ÙˆØ¯Ø¬Ù‡ØŒ Ùˆ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§.
    """
    budget_period = models.ForeignKey('BudgetPeriod', on_delete=models.CASCADE, related_name='allocations',
                                      verbose_name=_("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡"))
    organization = models.ForeignKey('core.Organization', on_delete=models.CASCADE, related_name='budget_allocations',
                                     verbose_name=_("Ø³Ø§Ø²Ù…Ø§Ù† Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡"))
    budget_item = models.ForeignKey('BudgetItem', on_delete=models.PROTECT, related_name='allocations',
                                    verbose_name=_("Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡"))
    project = models.ForeignKey('core.Project', on_delete=models.CASCADE, related_name='allocations',
                                verbose_name=_("Ù¾Ø±ÙˆÚ˜Ù‡"), null=True, blank=True)  # Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡
    allocated_amount = models.DecimalField(max_digits=25, decimal_places=2, verbose_name=_("Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ"))
    allocation_date = models.DateField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ® ØªØ®ØµÛŒØµ"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True,
                                   related_name='budget_allocations_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    description = models.TextField(blank=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))
    is_stopped = models.BooleanField(default=False, verbose_name=_("Ù…ØªÙˆÙ‚Ùâ€ŒØ´Ø¯Ù‡"))

    ALLOCATION_TYPES = (('amount', _("Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª")), ('percent', _("Ø¯Ø±ØµØ¯")), ('returned', _("Ø¨Ø±Ú¯Ø´ØªÛŒ")),)
    allocation_type = models.CharField(max_length=20, choices=ALLOCATION_TYPES, default='amount',
                                       verbose_name=_("Ù†ÙˆØ¹ ØªØ®ØµÛŒØµ"))
    locked_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0, verbose_name=_("Ø¯Ø±ØµØ¯ Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡"),
                                            help_text=_("Ø¯Ø±ØµØ¯ ØªØ®ØµÛŒØµ Ú©Ù‡ Ù‚ÙÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (0-100)"))
    warning_threshold = models.DecimalField(max_digits=5, decimal_places=2, default=10, verbose_name=_("Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø®Ø·Ø§Ø±"),
                                            help_text=_("Ø¯Ø±ØµØ¯ÛŒ Ú©Ù‡ Ù‡Ø´Ø¯Ø§Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (0-100)"))
    warning_action = models.CharField(
        max_length=50,
        choices=[('NOTIFY', _("ÙÙ‚Ø· Ø§Ø¹Ù„Ø§Ù†")), ('LOCK', _("Ù‚ÙÙ„ Ú©Ø±Ø¯Ù†")), ('RESTRICT', _("Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø«Ø¨Øª")), ],
        default='NOTIFY',
        verbose_name=_("Ø§Ù‚Ø¯Ø§Ù… Ù‡Ø´Ø¯Ø§Ø±"),
        help_text=_("Ø±ÙØªØ§Ø± Ø³ÛŒØ³ØªÙ… Ù‡Ù†Ú¯Ø§Ù… Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ Ù‡Ø´Ø¯Ø§Ø±")
    )
    allocation_number = models.IntegerField(default=1, verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ ØªØ®ØµÛŒØµ"))

    returned_amount = models.DecimalField(max_digits=25, decimal_places=2, default=0,verbose_name=_("Ù…Ø¬Ù…ÙˆØ¹ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø±Ú¯Ø´ØªÛŒ"))

    class Meta:
        verbose_name = _("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")
        verbose_name_plural = _("ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡")
        default_permissions = ()
        permissions = [
            ('budgetallocation_add', _("Ø§ÙØ²ÙˆØ¯Ù† ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetallocation_view', _("Ù†Ù…Ø§ÛŒØ´ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetallocation_update', _("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetallocation_delete', _("Ø­Ø°Ù ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetallocation_adjust', _("ØªÙ†Ø¸ÛŒÙ… ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ (Ø§ÙØ²Ø§ÛŒØ´/Ú©Ø§Ù‡Ø´)")),
            ('budgetallocation_stop', _("ØªÙˆÙ‚Ù ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")),
            ('budgetallocation_return', _("Ø¨Ø±Ú¯Ø´Øª ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡")),  # Ø¬Ø¯ÛŒØ¯
            ('BudgetAllocation_approve', 'Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†Ø¯'),
            ('BudgetAllocation_reject', 'Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ø±Ø§ Ø±Ø¯ Ú©Ù†Ø¯'),

        ]
        indexes = [
            models.Index(fields=['budget_period', 'allocation_date']),
            models.Index(fields=['organization', 'allocated_amount']),
        ]

    def __str__(self):
        try:
            jalali_date = jdatetime.date.fromgregorian(date=self.allocation_date).strftime('%Y/%m/%d')
            if jalali_date:
                org_name = self.organization.name if self.organization else 'Ø¨Ø¯ÙˆÙ† Ø³Ø§Ø²Ù…Ø§Ù†/Ø¨Ø¯ÙˆÙ† Ø´Ø¹Ø¨Ù‡'
                item_name = self.budget_item.name if self.budget_item else 'Ø¨Ø¯ÙˆÙ† Ø±Ø¯ÛŒÙ'
                return f"{org_name} - {item_name} - {jalali_date} - {self.allocated_amount:,.0f} Ø±ÛŒØ§Ù„"
            else:
                 return f"{self.budget_period.name} - {self.allocated_amount:,} Ø±ÛŒØ§Ù„ ({jalali_date})"
        except (AttributeError, TypeError) as e:
            logger.error(f"Error in BudgetAllocation.__str__: {str(e)}")
            return f"ØªØ®ØµÛŒØµ {self.organization.name}:{self.allocated_amount}{self.project.name} "

    def get_percentage(self):
        if self.budget_item.total_amount and self.budget_item.total_amount != 0:
            return (self.allocated_amount / self.budget_item.total_amount) * 100
        return Decimal('0')

    def clean(self):
        super().clean()
        logger.debug(f"Cleaning BudgetAllocation: allocated_amount={self.allocated_amount}, allocation_type={self.allocation_type}")

        if not self.budget_item:
            raise ValidationError(_("Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª."))

        if self.allocated_amount is None:
            raise ValidationError(_("Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯."))
        if self.allocated_amount <= 0:
            raise ValidationError(_("Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯."))

        # Ú†Ú© Ú©Ø±Ø¯Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡
        remaining_budget = self.budget_period.get_remaining_amount()
        if self.pk:  # Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ ØªØ®ØµÛŒØµ ÙØ¹Ù„ÛŒ Ø±Ùˆ Ø­Ø³Ø§Ø¨ Ù†Ú©Ù†
            current_allocation = BudgetAllocation.objects.filter(pk=self.pk).aggregate(
                total=Sum('allocated_amount')
            )['total'] or Decimal('0')
            remaining_budget += current_allocation
        if self.allocated_amount > remaining_budget:
            raise ValidationError(_(
                f"Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ ({self.allocated_amount:,.0f} Ø±ÛŒØ§Ù„) Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ ({remaining_budget:,.0f} Ø±ÛŒØ§Ù„) Ø§Ø³Øª."
            ))

        if self.budget_period and self.budget_item:
            if self.budget_item.budget_period != self.budget_period:
                raise ValidationError(_("Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§ÛŒØ¯ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯."))

        if self.budget_period and self.allocation_date:
            allocation_date = self.allocation_date
            if hasattr(allocation_date, "date"):
                allocation_date = allocation_date.date()
            if not (self.budget_period.start_date <= allocation_date <= self.budget_period.end_date):
                raise ValidationError(_("ØªØ§Ø±ÛŒØ® ØªØ®ØµÛŒØµ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ø´Ø¯."))

        if self.warning_threshold is not None and not (0 <= self.warning_threshold <= 100):
            raise ValidationError(_("Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø®Ø·Ø§Ø± Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û° ØªØ§ Û±Û°Û° Ø¨Ø§Ø´Ø¯."))

        logger.debug("Clean validation passed")
    #
    # def get_remaining_amount(self):
    #     return max(self.allocated_amount -
    #                self.transactions.filter(transaction_type='CONSUMPTION').aggregate(total=Sum('amount'))['total'] or Decimal('0') +
    #                self.returned_amount, Decimal('0'))

        # Ú†Ú© Ú©Ø±Ø¯Ù† Ø¯Ø±ØµØ¯ Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡
        self.budget_period.validate_allocation(self.allocated_amount)
    # def get_remaining_amount(self):
    #     """
    #     Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ®ØµÛŒØµ Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ù Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª.
    #     Returns:
    #          Decimal: Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (ØºÛŒØ±Ù…Ù†ÙÛŒ)
    #     """
    #     # Import BudgetTransaction inside the method to avoid potential circular imports
    #
    #     try:
    #         # Ø¬Ù…Ø¹ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ù (CONSUMPTION) Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§ÛŒÙ† ØªØ®ØµÛŒØµ
    #         consumed_qs = BudgetTransaction.objects.filter(allocation=self, transaction_type='CONSUMPTION')
    #         consumed = consumed_qs.aggregate(total=Coalesce(Sum('amount'), Decimal('0.00')))['total']
    #         # Ø¬Ù…Ø¹ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª (RETURN) Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§ÛŒÙ† ØªØ®ØµÛŒØµ
    #         returned_qs = BudgetTransaction.objects.filter(allocation=self, transaction_type='RETURN')
    #         returned = returned_qs.aggregate(total=Coalesce(Sum('amount'), Decimal('0.00')))['total']
    #         # **Ù†Ù‚Ø·Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ø§ØµÙ„Ø§Ø­:** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÛŒÙ„Ø¯ ØµØ­ÛŒØ­ Ù…Ø¯Ù„
    #         initial_allocation = self.allocated_amount if self.allocated_amount is not None else Decimal('0.00')
    #         # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
    #         remaining = initial_allocation - consumed + returned
    #         # Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
    #         logger.debug(f"BudgetAllocation {self.pk}: Initial Allocated={initial_allocation}, Consumed={consumed}, Returned={returned}, Calculated Remaining={remaining}")
    #         # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØºÛŒØ±Ù…Ù†ÙÛŒ Ø¨ÙˆØ¯Ù†
    #         return max(remaining, Decimal('0.00'))
    #     except Exception as e:
    #         logger.error(
    #             f"Error calculating remaining amount for BudgetAllocation {self.pk}: {str(e)}",
    #             exc_info=True
    #         )
    #         return Decimal('0.00') # Ø¨Ø§Ø²Ú¯Ø´Øª Ù…Ù‚Ø¯Ø§Ø± Ø§Ù…Ù† Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

    def get_remaining_amount(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ®ØµÛŒØµ Ù¾Ø±ÙˆÚ˜Ù‡"""
        return calculate_remaining_amount(self, amount_field='allocated_amount', model_name='BudgetAllocation')

    def get_locked_amount(self):
        """    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ (Ø¨Ø±Ø§ÛŒ Ù‚ÙÙ„ ÛŒØ§ Ù‡Ø´Ø¯Ø§Ø±)."""
        return calculate_threshold_amount(self.allocated_amount, self.locked_percentage)

    def get_actual_remaining_amount(self):
        # Ø§ÛŒÙ† Ù…ØªØ¯ Ø¨Ø§ÛŒØ¯ Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø®ÙˆØ§Ù†Ø¯ Ùˆ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÙÛŒÙ„Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ ØªÚ©ÛŒÙ‡ Ú©Ù†Ø¯
        # Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ ÙÛŒÙ„Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¯Ù‚Øª Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§ Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆØ¯
        transactions_sum = self.transactions.aggregate(
            consumption=Sum('amount', filter=Q(transaction_type='CONSUMPTION')),
            adjustment_decrease=Sum('amount', filter=Q(transaction_type='ADJUSTMENT_DECREASE')),
            returns=Sum('amount', filter=Q(transaction_type='RETURN')),
            adjustment_increase=Sum('amount', filter=Q(transaction_type='ADJUSTMENT_INCREASE')),
            # ALLOCATION Ø§ÙˆÙ„ÛŒÙ‡ Ø¬Ø²Ùˆ allocated_amount Ø§Ø³Øª Ùˆ Ù†Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯
        )
        consumed = (transactions_sum['consumption'] or Decimal('0')) + \
                   (transactions_sum['adjustment_decrease'] or Decimal('0'))
        added_back = (transactions_sum['returns'] or Decimal('0')) + \
                     (transactions_sum['adjustment_increase'] or Decimal('0'))

        # remaining = self.allocated_amount - consumed + added_back
        # **Ø§ØµÙ„Ø§Ø­ Ù…Ù‡Ù…:** allocated_amount Ø¨Ø§ Ø¨Ø±Ú¯Ø´Øª Ú©Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ù¾Ø³ Ù…Ø¨Ù†Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ remaining
        # Ø¨Ø§ÛŒØ¯ allocated_amount ÙØ¹Ù„ÛŒ Ø¨Ø§Ø´Ø¯ Ùˆ ÙÙ‚Ø· Ù…ØµØ±Ùâ€ŒÙ‡Ø§ Ø§Ø² Ø¢Ù† Ú©Ù… Ø´ÙˆÙ†Ø¯.
        # ÛŒØ§: Ù…Ø¨Ù†Ø§ allocated_amount Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§Ø´Ø¯ Ùˆ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯.
        # Ø±ÙˆØ´ ØµØ­ÛŒØ­â€ŒØªØ±: ØªÚ©ÛŒÙ‡ Ø¨Ø± ÙÛŒÙ„Ø¯ remaining_amount Ú©Ù‡ ØªÙˆØ³Ø· ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        # Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ø§ÛŒÙ† Ù…ØªØ¯ Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ Ú†Ú© Ú©Ø±Ø¯Ù† Ø§Ø³Øª:
        return self.remaining_amount  # ØªÚ©ÛŒÙ‡ Ø¨Ø± ÙÛŒÙ„Ø¯ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù‡

    def get_warning_amount(self):
        """    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ (Ø¨Ø±Ø§ÛŒ Ù‚ÙÙ„ ÛŒØ§ Ù‡Ø´Ø¯Ø§Ø±)."""
        return calculate_threshold_amount(self.allocated_amount, self.warning_threshold)

    def check_allocation_status(self):
        remaining = self.get_remaining_amount()
        locked = self.get_locked_amount()
        warning = self.get_warning_amount()
        if not self.is_active:
            return 'inactive', _('ØªØ®ØµÛŒØµ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.')
        if self.is_stopped:
            return 'stopped', _('ØªØ®ØµÛŒØµ Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡ Ø§Ø³Øª.')
        if remaining <= 0:
            return 'completed', _('ØªØ®ØµÛŒØµ ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø§Ø³Øª.')
        if remaining <= locked:
            return 'locked', _('ØªØ®ØµÛŒØµ Ø¨Ù‡ Ø­Ø¯ Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡ Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.')
        if remaining <= warning:
            return 'warning', _('ØªØ®ØµÛŒØµ Ø¨Ù‡ Ø¢Ø³ØªØ§Ù†Ù‡ Ù‡Ø´Ø¯Ø§Ø± Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.')
        return 'normal', _('ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯ÛŒ')

    def send_notification(self, status, message):
        recipients = CustomUser.objects.filter(
            Q(userpost__post__organization=self.organization) |
            Q(userpost__post__organization__parent=self.organization),
            is_active=True
        ).distinct()
        send_notification(self, status, message, recipients)

    @property
    def project_allocations(self):
        return ProjectBudgetAllocation.objects.filter(budget_allocation=self)

    def update_lock_status(self):
        """Ù‚ÙÙ„ Ø´Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ùˆ ØªÙ†Ø¸ÛŒÙ… ÙÙ„Ú¯â€ŒÙ‡Ø§"""
        remaining_amount = self.get_remaining_amount()
        locked_amount = self.get_locked_amount()
        if remaining_amount <= locked_amount:
            self.is_locked = True
            self.is_active = False
            Tankhah.objects.filter(allocation=self).update(is_active=False)
        return self.is_locked, self.is_active

    def save(self, *args, **kwargs):
        logger.debug(f"Starting save for BudgetAllocation (pk={self.pk}, allocated_amount={self.allocated_amount})")
        try:
            with transaction.atomic():
                self.clean()
                if not self.pk:
                    self.remaining_amount = self.allocated_amount
                    logger.debug(f"New instance, set remaining_amount={self.remaining_amount}")

                # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªÙ†Ø¸ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª Ù‚ÙÙ„
                is_locked, is_active = self.update_lock_status()
                self.is_locked = is_locked
                self.is_active = is_active

                super().save(*args, **kwargs)
                logger.info(f"BudgetAllocation saved with ID: {self.pk}")

                total_allocated = BudgetAllocation.objects.filter(
                    budget_period=self.budget_period
                ).aggregate(total=Sum('allocated_amount'))['total'] or Decimal('0')
                logger.debug(f"Calculated total_allocated={total_allocated} for BudgetPeriod {self.budget_period.id}")

                self.budget_period.total_allocated = total_allocated
                self.budget_period.save(update_fields=['total_allocated'])
                logger.info(f"Updated BudgetPeriod {self.budget_period.id} with total_allocated={total_allocated}")

                status, message = self.check_allocation_status()
                logger.debug(f"Allocation status: {status}, message: {message}")
                if status in ('warning', 'completed', 'stopped'):
                    self.send_notification(status, message)
                    logger.info(f"Sent notification for status: {status}")

        except Exception as e:
            logger.error(f"Error saving BudgetAllocation: {str(e)}", exc_info=True)
            raise



    # def save(self, *args, **kwargs):
    #     logger.debug(f"Starting save for BudgetAllocation (pk={self.pk}, allocated_amount={self.allocated_amount})")
    #     try:
    #         with transaction.atomic():
    #             self.clean()
    #             if not self.pk:
    #                 self.remaining_amount = self.allocated_amount
    #                 logger.debug(f"New instance, set remaining_amount={self.remaining_amount}")
    #
    #             self.update_lock_status()
    #             super().save(*args, **kwargs)
    #             logger.info(f"BudgetAllocation saved with ID: {self.pk}")
    #
    #             total_allocated = BudgetAllocation.objects.filter(
    #                 budget_period=self.budget_period
    #             ).aggregate(total=Sum('allocated_amount'))['total'] or Decimal('0')
    #             logger.debug(f"Calculated total_allocated={total_allocated} for BudgetPeriod {self.budget_period.id}")
    #
    #             self.budget_period.total_allocated = total_allocated
    #             self.budget_period.save(update_fields=['total_allocated'])
    #             logger.info(f"Updated BudgetPeriod {self.budget_period.id} with total_allocated={total_allocated}")
    #
    #             status, message = self.check_allocation_status()
    #             logger.debug(f"Allocation status: {status}, message: {message}")
    #             if status in ('warning', 'completed', 'stopped'):
    #                 self.send_notification(status, message)
    #                 logger.info(f"Sent notification for status: {status}")
    #
    #     except Exception as e:
    #         logger.error(f"Error saving BudgetAllocation: {str(e)}", exc_info=True)
    #         raise

""" BudgetItem (Ù†ÙˆØ¹ Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡):"""
class BudgetItem(models.Model):
    budget_period = models.ForeignKey('BudgetPeriod', on_delete=models.CASCADE, related_name='budget_items',
                                      verbose_name=_("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡"))
    organization = models.ForeignKey('core.Organization', on_delete=models.CASCADE, related_name='budget_items',
                                     verbose_name=_("Ø´Ø¹Ø¨Ù‡"))
    name = models.CharField(max_length=100, verbose_name=_("Ù†Ø§Ù… Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡"), null=True, blank=True)
    code = models.CharField(max_length=50, unique=True, verbose_name=_("Ú©Ø¯ Ø±Ø¯ÛŒÙ"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))
    create_at = models.DateTimeField(auto_now_add=True, verbose_name=_('ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª '), null=True, blank=True)

    class Meta:
        verbose_name = _("Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡")
        verbose_name_plural = _("Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡")
        unique_together = ('budget_period', 'organization', 'code')

    def __str__(self):
        if self.budget_period.name:
            return f"{self.budget_period.name} - {self.name} - {self.organization.name}"
        else:
            return f"{self.name} - {self.organization.name}-Ø¨Ø¯ÙˆÙ† Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡"

    def clean(self):
        super().clean()
        if not self.name:
            raise ValidationError(_("Ù†Ø§Ù… Ø±Ø¯ÛŒÙ Ø¨ÙˆØ¯Ø¬Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯."))

""" BudgetTransaction (ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡):"""
class BudgetTransaction(models.Model):
    TRANSACTION_TYPES = (
        ('ALLOCATION', _('ØªØ®ØµÛŒØµ Ø§ÙˆÙ„ÛŒÙ‡')),
        ('CONSUMPTION', _('Ù…ØµØ±Ù')),
        ('ADJUSTMENT_INCREASE', _('Ø§ÙØ²Ø§ÛŒØ´ ØªØ®ØµÛŒØµ')),
        ('ADJUSTMENT_DECREASE', _('Ú©Ø§Ù‡Ø´ ØªØ®ØµÛŒØµ')),
        ('RETURN', _('Ø¨Ø§Ø²Ú¯Ø´Øª')),
    )
    allocation = models.ForeignKey('BudgetAllocation', on_delete=models.CASCADE,
                                   related_name='transactions', verbose_name=_("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡"))
    transaction_type = models.CharField(max_length=20, choices=TRANSACTION_TYPES,
                                       verbose_name=_("Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´"))
    amount = models.DecimalField(max_digits=25, decimal_places=2, verbose_name=_("Ù…Ø¨Ù„Øº"))
    related_tankhah = models.ForeignKey('tankhah.Tankhah', on_delete=models.SET_NULL, null=True, blank=True,
                                        verbose_name=_("ØªÙ†Ø®ÙˆØ§Ù‡ Ù…Ø±ØªØ¨Ø·"))
    timestamp = models.DateTimeField(auto_now_add=True, verbose_name=_("Ø²Ù…Ø§Ù†"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True,
                                   verbose_name=_("Ú©Ø§Ø±Ø¨Ø±"))
    description = models.TextField(blank=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    transaction_id = models.CharField(max_length=50, unique=True, verbose_name=_("Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´"))

    class Meta:
        verbose_name = _("ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡")
        verbose_name_plural = _("ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡")
        default_permissions = ()
        permissions = [
            ('BudgetTransaction_add', 'Ø§ÙØ²ÙˆØ¯Ù† ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡'),
            ('BudgetTransaction_update', 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡'),
            ('BudgetTransaction_delete', 'Ø­Ù€Ù€Ø°Ù ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡'),
            ('BudgetTransaction_view', _('Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡')),
            ('BudgetTransaction_return', _('Ø¨Ø±Ú¯Ø´Øª ØªØ±Ø§Ú©Ù†Ø´ Ø¨ÙˆØ¯Ø¬Ù‡')),
        ]

    def validate_return(self):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª"""
        if self.transaction_type != 'RETURN':
            return True, None
        consumed = BudgetTransaction.objects.filter(
            allocation=self.allocation,
            transaction_type='CONSUMPTION'
        ).aggregate(total=Sum('amount'))['total'] or Decimal('0')
        returned = BudgetTransaction.objects.filter(
            allocation=self.allocation,
            transaction_type='RETURN'
        ).aggregate(total=Sum('amount'))['total'] or Decimal('0')
        total_consumed = consumed - returned
        if self.amount > total_consumed:
            return False, _(f"Ù…Ø¨Ù„Øº Ø¨Ø§Ø²Ú¯Ø´Øª ({self.amount:,.0f} Ø±ÛŒØ§Ù„) Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…ØµØ±Ù Ø®Ø§Ù„Øµ ({total_consumed:,.0f} Ø±ÛŒØ§Ù„) Ø¨Ø§Ø´Ø¯.")
        remaining_budget = self.allocation.get_remaining_amount()
        if self.amount > remaining_budget:
            return False, _(f"Ù…Ø¨Ù„Øº Ø¨Ø§Ø²Ú¯Ø´Øª ({self.amount:,.0f} Ø±ÛŒØ§Ù„) Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ({remaining_budget:,.0f} Ø±ÛŒØ§Ù„) Ø¨Ø§Ø´Ø¯.")
        return True, None

    def save(self, *args, **kwargs):
        from django.core.exceptions import ValidationError
        from django.contrib.contenttypes.models import ContentType
        from django.db import transaction

        # 1. Generate transaction ID if missing
        if not self.transaction_id:
            timestamp_str = timezone.now().strftime('%Y%m%d%H%M%S%f')
            self.transaction_id = f"TX-{self.transaction_type[:3]}-{self.allocation_id}-{timestamp_str}"
            logger.info(f"Generated transaction_id: {self.transaction_id}")

        # 2. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª
        if self.transaction_type == 'RETURN':
            is_valid, error_message = self.validate_return()
            if not is_valid:
                logger.error(f"Validation failed for RETURN transaction: {error_message}")
                raise ValidationError(error_message)

        # 3. Ø¨Ø±Ø±Ø³ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ CONSUMPTION
        if self.transaction_type == 'CONSUMPTION':
            remaining = self.allocation.get_remaining_amount()
            if self.amount > remaining:
                logger.error(f"CONSUMPTION transaction amount {self.amount} exceeds remaining {remaining}")
                raise ValidationError(_("Ù…Ø¨Ù„Øº Ù…ØµØ±Ù Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ®ØµÛŒØµ Ø§Ø³Øª."))

        try:
            with transaction.atomic():
                # 4. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ®ØµÛŒØµ Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ RETURN
                if self.transaction_type == 'RETURN':
                    if not self.allocation.budget_period.is_active:
                        logger.error(f"Cannot return from inactive budget period: {self.allocation.budget_period.id}")
                        raise ValidationError(_("Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø² Ø¯ÙˆØ±Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯."))

                    self.allocation.allocated_amount -= self.amount
                    self.allocation.returned_amount += self.amount
                    self.allocation.budget_period.total_allocated -= self.amount
                    self.allocation.budget_period.returned_amount += self.amount

                    self.allocation.save(update_fields=['allocated_amount', 'returned_amount'])
                    self.allocation.budget_period.save(update_fields=['total_allocated', 'returned_amount'])

                    BudgetHistory.objects.create(
                        content_type=ContentType.objects.get_for_model(BudgetAllocation),
                        object_id=self.allocation.id,
                        action='RETURN',
                        amount=self.amount,
                        created_by=self.created_by,
                        details=f"Ø¨Ø±Ú¯Ø´Øª {self.amount:,} Ø§Ø² ØªØ®ØµÛŒØµ {self.allocation.id} Ø¨Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ {self.allocation.budget_period.name}",
                        transaction_type='RETURN',
                        transaction_id=f"RET-{self.transaction_id}"
                    )

                    self.allocation.send_notification(
                        'return',
                        f"Ù…Ø¨Ù„Øº {self.amount:,.0f} Ø±ÛŒØ§Ù„ Ø§Ø² ØªØ®ØµÛŒØµ {self.allocation.id} Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯."
                    )

                # 5. Ø°Ø®ÛŒØ±Ù‡ ØªØ±Ø§Ú©Ù†Ø´
                super().save(*args, **kwargs)
                logger.debug(f"BudgetTransaction {self.pk} ({self.transaction_id}) saved.")

                # 6. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù†
                status, message = check_budget_status(self.allocation.budget_period)
                if status in ('warning', 'locked', 'completed', 'stopped'):
                    self.allocation.send_notification(status, message)

        except Exception as e:
            logger.error(f"Error saving BudgetTransaction {self.transaction_id}: {str(e)}", exc_info=True)
            raise

    def clean(self):
        super().clean()
        # Ø§Ú¯Ø± Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø´ÙˆØ¯
        if self.allocation.budget_period.warning_action == 'RESTRICT' and self.allocation.budget_period.is_active == False:
            raise ValidationError(_("Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª."))

    def __str__(self):
        return f"{self.get_transaction_type_display()} - {self.amount:,.0f} - {self.timestamp.strftime('%Y/%m/%d')}"

"""ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ùˆ Ø²ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ """
class ProjectBudgetAllocation(models.Model):
    """
    ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ø§Ø² BudgetAllocation Ø´Ø¹Ø¨Ù‡ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ ÛŒØ§ Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡.
    ØªÙˆØ¶ÛŒØ­: Ø§ÛŒÙ† Ù…Ø¯Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ Ø´Ø¹Ø¨Ù‡ Ø±Ùˆ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ ÛŒØ§ Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ®ØµÛŒØµ Ø±Ùˆ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ù‡.
    """
    budget_allocation = models.ForeignKey('budgets.BudgetAllocation', on_delete=models.CASCADE, related_name='project_allocations', verbose_name=_("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ø´Ø¹Ø¨Ù‡"))
    project = models.ForeignKey('core.Project', on_delete=models.CASCADE, related_name='budget_allocations', verbose_name=_("Ù¾Ø±ÙˆÚ˜Ù‡"))
    subproject = models.ForeignKey('core.SubProject', on_delete=models.CASCADE, null=True, blank=True, related_name='budget_allocations', verbose_name=_("Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡"))
    allocated_amount = models.DecimalField(max_digits=25, decimal_places=2, verbose_name=_("Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ"))
    allocation_date = models.DateField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ® ØªØ®ØµÛŒØµ"))
    returned_amount = models.DecimalField(max_digits=25, decimal_places=2, default=0, verbose_name=_("Ù…Ø¬Ù…ÙˆØ¹ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø±Ú¯Ø´ØªÛŒ"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True, related_name='project_budget_allocations_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    description = models.TextField(blank=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    is_active = models.BooleanField(default=True, verbose_name=_('ÙØ¹Ø§Ù„'))
    is_locked = models.BooleanField(default=False, verbose_name=_("Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡"))
    locked_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0, verbose_name=_("Ø¯Ø±ØµØ¯ Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡"))

    def __str__(self):
        target = self.subproject.name if self.subproject else self.project.name
        jalali_date = jdatetime.date.fromgregorian(date=self.allocation_date).strftime('%Y/%m/%d')
        return f"{target} - {self.allocated_amount:,} ({jalali_date})"

    class Meta:
        verbose_name = _("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡")
        verbose_name_plural = _("ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡")
        default_permissions = ()
        permissions = [
            ('ProjectBudgetAllocation_add', _('Ø§ÙØ²ÙˆØ¯Ù† ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡')),
            ('ProjectBudgetAllocation_view', _('Ù†Ù…Ø§ÛŒØ´ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡')),
            ('ProjectBudgetAllocation_update', _('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡')),
            ('ProjectBudgetAllocation_delete', _('Ø­Ø°Ù ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡')),
            ('ProjectBudgetAllocation_Head_Office', 'ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡(Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ)ğŸ '),
            ('ProjectBudgetAllocation_Branch', 'ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡(Ø´Ø¹Ø¨Ù‡)ğŸ '),
        ]
        indexes = [
            models.Index(fields=['project']),
            models.Index(fields=['subproject']),
        ]

    def get_remaining_amount(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ®ØµÛŒØµ Ù¾Ø±ÙˆÚ˜Ù‡"""
        return calculate_remaining_amount(self, amount_field='allocated_amount', model_name='BudgetAllocation')

    def get_locked_amount(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù‚ÙÙ„â€ŒØ´Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯"""
        return calculate_threshold_amount(self.allocated_amount, self.locked_percentage)

    def update_lock_status(self):
        """Ù‚ÙÙ„ Ø´Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡"""
        remaining_amount = self.get_remaining_amount()
        locked_amount = self.get_locked_amount()
        logger.debug(
            f"Checking lock status for ProjectBudgetAllocation {self.pk}: remaining={remaining_amount}, locked={locked_amount}"
        )
        if remaining_amount <= locked_amount:
            self.is_locked = True
            self.is_active = False
            if self.pk:  # ÙÙ‚Ø· Ø§Ú¯Ø± Ø´ÛŒØ¡ Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ save Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†
                self.save(update_fields=['is_locked', 'is_active'], skip_lock_status_update=True)
                Tankhah.objects.filter(project_allocation=self).update(is_active=False)
            else:
                logger.debug(f"New object (pk=None), setting is_locked={self.is_locked}, is_active={self.is_active} without saving")

    def get_free_budget(self):
        cache_key = f"free_budget_{self.pk}"
        from django.core import cache
        free_budget = cache.get(cache_key)
        if free_budget is None:
            transactions = BudgetTransaction.objects.filter(
                allocation=self.budget_allocation
            ).aggregate(
                consumed=Sum('amount', filter=Q(transaction_type='CONSUMPTION')),
                returned=Sum('amount', filter=Q(transaction_type='RETURN'))
            )
            consumed = transactions['consumed'] or Decimal('0')
            returned = transactions['returned'] or Decimal('0')
            # tankhah_consumed = Tankhah.objects.filter(
            #     project_budget_allocation=self
            # ).aggregate(total=Sum('amount'))['total'] or Decimal('0')
            # free_budget = self.allocated_amount - consumed + returned - tankhah_consumed
            # cache.set(cache_key, free_budget, timeout=300)
            tankhah_consumed = Tankhah.objects.filter(
                project_budget_allocation=self,
                status='APPROVED'
            ).aggregate(total=Sum('amount'))['total'] or Decimal('0')
            free_budget = self.allocated_amount - consumed + returned - tankhah_consumed
            cache.set(cache_key, free_budget, timeout=300)
        return free_budget


    def clean(self):
        remaining = self.budget_allocation.get_remaining_amount()
        if self.allocated_amount > remaining:
            raise ValidationError(_("Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø´Ø¹Ø¨Ù‡ Ø§Ø³Øª"))
        if self.subproject and self.subproject.project != self.project:
            raise ValidationError(_("Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ ØªØ¹Ù„Ù‚ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯"))
        if self.allocated_amount < 0:
            raise ValidationError(_("Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯"))
        if self.budget_allocation and self.allocation_date:
            start_date = self.budget_allocation.budget_period.start_date
            end_date = self.budget_allocation.budget_period.end_date
            logger.info(
                f"start_date: {start_date} ({type(start_date)}), end_date: {end_date} ({type(end_date)}), allocation_date: {self.allocation_date} ({type(self.allocation_date)})"
            )
            # Ø§Ø² Ø¢Ù†Ø¬Ø§ Ú©Ù‡ allocation_date ÛŒÚ© DateField Ø§Ø³ØªØŒ Ø¨Ø§ÛŒØ¯ Ù‡Ù…ÛŒØ´Ù‡ datetime.date Ø¨Ø§Ø´Ø¯
            allocation_date = self.allocation_date
            if not isinstance(allocation_date, date):
                raise ValidationError(_("ØªØ§Ø±ÛŒØ® ØªØ®ØµÛŒØµ Ø¨Ø§ÛŒØ¯ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯"))
            if not (start_date <= allocation_date <= end_date):
                raise ValidationError(_("ØªØ§Ø±ÛŒØ® ØªØ®ØµÛŒØµ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ø´Ø¯"))

    def save(self, *args, **kwargs):
        self.clean()
        self.full_clean()
        if not kwargs.get('skip_lock_status_update', False):
            self.update_lock_status()
        kwargs.pop('skip_lock_status_update', None)
        super().save(*args, **kwargs)
        if self.subproject:
            self.subproject.save()  # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡
        logger.info(f"ProjectBudgetAllocation {self.pk} saved successfully")

"""PaymentOrder (Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª):"""
class PaymentOrder(models.Model):
    """ØªÙˆØ¶ÛŒØ­: Ù…Ø¯Ù„ Ø¬Ø¯Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø¨Ù‡ ØªÙ†Ø®ÙˆØ§Ù‡ Ùˆ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§. min_signatures Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ ØªØ¹Ø¯Ø§Ø¯ Ø§Ù…Ø¶Ø§ Ùˆ Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾ÙˆÛŒØ§ Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ."""
    STATUS_CHOICES = (
        ('DRAFT', _('Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³')),
        ('PENDING_SIGNATURES', _('Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù…Ø¶Ø§')),
        ('ISSUED', _('ØµØ§Ø¯Ø± Ø´Ø¯Ù‡')),
        ('PAID', _('Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡')),
        ('CANCELED', _('Ù„ØºÙˆ Ø´Ø¯Ù‡')),
    )
    tankhah = models.ForeignKey('tankhah.Tankhah', on_delete=models.CASCADE,
                                related_name='payment_orders', verbose_name=_("ØªÙ†Ø®ÙˆØ§Ù‡"))
    order_number = models.CharField(max_length=50, unique=True, blank=True,
                                    verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª"))
    issue_date = models.DateField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±"))
    amount = models.DecimalField(max_digits=25, decimal_places=2, verbose_name=_("Ù…Ø¨Ù„Øº"))
    payee = models.ForeignKey('Payee', on_delete=models.SET_NULL, null=True,
                              verbose_name=_("Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡"))
    description = models.TextField(verbose_name=_("Ø´Ø±Ø­ Ù¾Ø±Ø¯Ø§Ø®Øª"))
    related_factors = models.ManyToManyField('tankhah.Factor', blank=True,
                                             verbose_name=_("ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·"))
    payment_id = models.CharField(max_length=50, blank=True, null=True,
                                  verbose_name=_("Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª"))
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='DRAFT',
                              verbose_name=_("ÙˆØ¶Ø¹ÛŒØª"))
    created_by_post = models.ForeignKey('core.Post', on_delete=models.SET_NULL, null=True,
                                        verbose_name=_("Ù¾Ø³Øª Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    min_signatures = models.IntegerField(default=1, verbose_name=_("Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ø§Ù…Ø¶Ø§"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True,
                                   related_name='payment_orders_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))

    payment_date = models.DateField(null=True, blank=True, verbose_name=_("ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª"))
    def generate_order_number(self):
        sep = "-"
        date_str = jdatetime.date.fromgregorian(date=self.issue_date).strftime('%Y%m%d')
        serial = PaymentOrder.objects.filter(issue_date=self.issue_date).count() + 1
        return f"PO{sep}{date_str}{sep}{serial:03d}"

    def save(self, *args, **kwargs):
        if not self.order_number:
            self.order_number = self.generate_order_number()
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.order_number} - {self.amount}"

    class Meta:
        verbose_name = _("Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª")
        verbose_name_plural = _("Ø¯Ø³ØªÙˆØ±Ù‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª")
        default_permissions = ()
        permissions = [
            ('PaymentOrder_add', _('Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
            ('PaymentOrder_view', _('Ù†Ù…Ø§ÛŒØ´ Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
            ('PaymentOrder_update', _('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
            ('PaymentOrder_delete', _('Ø­Ø°Ù Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
            ('PaymentOrder_sign', _('Ø§Ù…Ø¶Ø§ÛŒ Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
            ('PaymentOrder_issue', _('ØµØ¯ÙˆØ± Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
        ]

"""Payee (Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡):"""
class Payee(models.Model):
    """ØªÙˆØ¶ÛŒØ­: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù†ÙˆØ¹ Ù…Ø´Ø®Øµ (ÙØ±ÙˆØ´Ù†Ø¯Ù‡ØŒ Ú©Ø§Ø±Ù…Ù†Ø¯ØŒ Ø¯ÛŒÚ¯Ø±)."""
    PAYEE_TYPES = (
        ('VENDOR', _('ÙØ±ÙˆØ´Ù†Ø¯Ù‡')),
        ('EMPLOYEE', _('Ú©Ø§Ø±Ù…Ù†Ø¯')),
        ('OTHER', _('Ø¯ÛŒÚ¯Ø±')),
    )
    name = models.CharField(max_length=100, verbose_name=_("Ù†Ø§Ù…"))
    family = models.CharField(max_length=100, verbose_name=_("Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ"))
    payee_type = models.CharField(max_length=20, choices=PAYEE_TYPES, verbose_name=_("Ù†ÙˆØ¹"))
    national_id = models.CharField(max_length=20, blank=True, null=True,
                                   verbose_name=_("Ú©Ø¯ Ù…Ù„ÛŒ/Ø§Ù‚ØªØµØ§Ø¯ÛŒ"))
    account_number = models.CharField(max_length=50, blank=True, null=True,
                                      verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨"))
    iban = models.CharField(max_length=34, blank=True, null=True, verbose_name=_("Ø´Ø¨Ø§"))
    address = models.TextField(blank=True, null=True, verbose_name=_("Ø¢Ø¯Ø±Ø³"))
    phone = models.CharField(max_length=20, blank=True, null=True, verbose_name=_("ØªÙ„ÙÙ†"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True,
                                   related_name='payees_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    is_active= models.BooleanField(verbose_name=_('ÙØ¹Ø§Ù„'))
    def __str__(self):
        return f"{self.name} ({self.payee_type})"

    class Meta:
        verbose_name = _("Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡")
        verbose_name_plural = _("Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†")
        default_permissions = ()
        permissions = [
            ('Payee_add', _('Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡')),
            ('Payee_view', _('Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡')),
            ('Payee_update', _('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡')),
            ('Payee_delete', _('Ø­Ø°Ù Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡')),
        ]

"""TransactionType (Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´):"""
class TransactionType(models.Model):
    """ØªÙˆØ¶ÛŒØ­: ØªØ¹Ø±ÛŒÙ Ù¾ÙˆÛŒØ§ Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ù…Ø«Ù„ Ø¨ÛŒÙ…Ù‡ØŒ Ø¬Ø±ÛŒÙ…Ù‡) Ø¨Ø§ Ø§Ù…Ú©Ø§Ù† Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯ Ø§Ø¶Ø§ÙÛŒ."""
    name = models.CharField(max_length=250, unique=True, verbose_name=_("Ù†Ø§Ù…"))
    description = models.TextField(blank=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    requires_extra_approval = models.BooleanField(default=False,
                                                  verbose_name=_("Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯ Ø§Ø¶Ø§ÙÛŒ"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True,
                                   related_name='transaction_types_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    category = models.CharField(max_length=50, blank=True, null=True,verbose_name=_('Ú¯Ø±ÙˆÙ‡ Ø¨Ù†Ø¯ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ '))

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = _("Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´")
        verbose_name_plural = _("Ø§Ù†ÙˆØ§Ø¹ ØªØ±Ø§Ú©Ù†Ø´")
        default_permissions = ()
        permissions = [
            ('TransactionType_add', _('Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´')),
            ('TransactionType_view', _('Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´')),
            ('TransactionType_update', _('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´')),
            ('TransactionType_delete', _('Ø­Ø°Ù Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´')),
        ]

"""Ù…Ø¯Ù„ BudgetReallocation Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…ØªÙˆÙ‚Ùâ€ŒØ´Ø¯Ù‡."""
class BudgetReallocation(models.Model):
    source_allocation = models.ForeignKey('BudgetAllocation', on_delete=models.CASCADE, related_name='reallocations_from')
    target_allocation = models.ForeignKey('BudgetAllocation', on_delete=models.CASCADE, null=True, related_name='reallocations_to')
    amount = models.DecimalField(max_digits=25, decimal_places=2)
    reallocation_date = models.DateField(default=timezone.now)
    reason = models.TextField()
    created_by = models.ForeignKey(CustomUser, on_delete=models.SET_NULL, null=True)

"""ÛŒÙ‡ Ø¬Ø¯ÙˆÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (BudgetSettings) Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÙÙ„ Ùˆ Ù‡Ø´Ø¯Ø§Ø± Ø¯Ø± Ø³Ø·ÙˆØ­ Ù…Ø®ØªÙ„Ù:"""
class BudgetSettings(models.Model):
    level = models.CharField(max_length=50, choices=[('PERIOD', 'Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡'), ('ALLOCATION', 'ØªØ®ØµÛŒØµ'), ('PROJECT', 'Ù¾Ø±ÙˆÚ˜Ù‡')])
    locked_percentage = models.DecimalField(max_digits=5, decimal_places=2)
    warning_threshold = models.DecimalField(max_digits=5, decimal_places=2)
    warning_action = models.CharField(max_length=50, choices=[('NOTIFY', 'Ø§Ø¹Ù„Ø§Ù†'), ('LOCK', 'Ù‚ÙÙ„'), ('RESTRICT', 'Ù…Ø­Ø¯ÙˆØ¯')])
    organization = models.ForeignKey('core.Organization', on_delete=models.CASCADE, null=True)
    budget_period = models.ForeignKey('BudgetPeriod', on_delete=models.CASCADE, null=True, verbose_name=_("Ø¯ÙˆØ±Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡"))

    # Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù…Ø¯Ù„
    # content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    # object_id = models.PositiveIntegerField()
    # content_object = GenericForeignKey('content_type', 'object_id')

"""Ù…Ø¯Ù„ BudgetHistory Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ùˆ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§:"""
# ------------------------------------
"""ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„Ø§Ù†"""
class BudgetHistory(models.Model):
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    object_id = models.PositiveIntegerField()
    # content_object = GenericForeignKey('content_type', 'object_id')
    action = models.CharField(max_length=50, choices=[
        ('CREATE', _('Ø§ÛŒØ¬Ø§Ø¯')),
        ('UPDATE', _('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ')),
        ('STOP', _('ØªÙˆÙ‚Ù')),
        ('REALLOCATE', _('Ø§Ù†ØªÙ‚Ø§Ù„')),
        ('RETURN', _('Ø¨Ø±Ú¯Ø´Øª'))  # Ø¬Ø¯ÛŒØ¯
    ])
    amount = models.DecimalField(max_digits=25, decimal_places=2, null=True, verbose_name=_('Ø±Ù‚Ù… Ø¹Ø¯Ø¯'))
    created_by = models.ForeignKey(CustomUser, on_delete=models.SET_NULL, null=True, verbose_name=_('Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ú©Ù†Ù†Ø¯Ù‡'))
    created_at = models.DateTimeField(auto_now_add=True, verbose_name=_('Ø§Ú©Ø´Ù† Ø¯Ø± ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª'))
    details = models.TextField(blank=True, verbose_name=_('Ø¬Ø²Ø¦ÛŒØ§Øª'))
    transaction_type = models.CharField(max_length=20, choices=[('ALLOCATION', _('ØªØ®ØµÛŒØµ')), ('CONSUMPTION', _('Ù…ØµØ±Ù')), ('RETURN', _('Ø¨Ø±Ú¯Ø´Øª'))],verbose_name=_("Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´"))
    transaction_id = models.CharField(max_length=50, unique=True, verbose_name=_("Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´"))


    def __str__(self):
        return f"{self.action} - {self.amount:,} ({self.created_at})"

    class Meta:
        verbose_name = _("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡")
        verbose_name_plural = _("ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡")
        default_permissions = ()
        permissions = [
            ('BudgetHistory_add','Ø§ÙØ²ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„Ø§Ù†'),
            ('BudgetHistory_view',' Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ø± Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„Ø§Ù†'),
            ('BudgetHistory_update','Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„Ø§Ù†'),
            ('BudgetHistory_delete',' Ø­Ù€Ù€Ø°Ù ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„Ø§Ù†'),
        ]
class Factor(models.Model):
    STATUS_CHOICES = (
        ('DRAFT', _('Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³')),
        ('PENDING', _('Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯')),
        ('APPROVED', _('ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡')),
        ('REJECTED', _('Ø±Ø¯ Ø´Ø¯Ù‡')),
        ('PAID', _('Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡')),
    )

    number = models.CharField(max_length=60, blank=True, verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±"))
    tankhah = models.ForeignKey('Tankhah', on_delete=models.PROTECT, related_name='factors', verbose_name=_("ØªÙ†Ø®ÙˆØ§Ù‡"))
    date = models.DateField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ®"))
    amount = models.DecimalField(max_digits=20, decimal_places=2, verbose_name=_('Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±'), default=0)
    description = models.TextField(blank=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING', verbose_name=_("ÙˆØ¶Ø¹ÛŒØª"))
    approved_by = models.ManyToManyField(CustomUser, blank=True, verbose_name=_("ØªØ£ÛŒÛŒØ¯Ú©Ù†Ù†Ø¯Ú¯Ø§Ù†"))
    is_finalized = models.BooleanField(default=False, verbose_name=_("Ù†Ù‡Ø§ÛŒÛŒ Ø´Ø¯Ù‡"))
    locked = models.BooleanField(default=False, verbose_name="Ù‚ÙÙ„ Ø´Ø¯Ù‡")
    locked_by_stage = models.ForeignKey(WorkflowStage, null=True, blank=True, on_delete=models.SET_NULL, verbose_name=_("Ù‚ÙÙ„ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ù…Ø±Ø­Ù„Ù‡"))
    budget = models.DecimalField(max_digits=20, decimal_places=2, default=0, verbose_name=_("Ø¨ÙˆØ¯Ø¬Ù‡ ØªØ®ØµÛŒØµÛŒ"))
    remaining_budget = models.DecimalField(max_digits=20, decimal_places=2, default=0, verbose_name=_("Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡"))
    created_by = models.ForeignKey('accounts.CustomUser',related_name='CustomUser_related', on_delete=models.SET_NULL, null=True, verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    created_at = models.DateTimeField(auto_now_add=True, verbose_name=_("ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯"))
    is_emergency = models.BooleanField(default=False, verbose_name=_("Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ"))
    category = models.ForeignKey('ItemCategory', on_delete=models.SET_NULL, null=True, blank=False, verbose_name=_("Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"))

    def get_remaining_budget(self):
        return get_factor_remaining_budget(self)

    def get_items_total(self):
        if self.pk:
            total = self.items.aggregate(total=Sum('amount'))['total'] or Decimal('0')
            return total
        return Decimal('0')

    def total_amount(self):
        if self.pk:
            return self.get_items_total()
        return Decimal('0')
    #
    # def generate_number(self):
    #     from jdatetime import date as jdate
    #     date_str = jdate.fromgregorian(date=self.date).strftime('%Y%m%d')
    #     serial = Factor.objects.filter(date=self.date).count() + 1
    #     return f"FAC-{self.tankhah.number}-{date_str}-{serial:03d}"
    def generate_number(self):
        """ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ"""
        sep = '-'  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø«Ø§Ø¨Øª
        from jdatetime import date as jdate
        date_str = jdate.fromgregorian(date=self.date).strftime('%Y%m%d')
        org_code = self.tankhah.organization.code if self.tankhah and self.tankhah.organization else 'NOORG'
        tankhah_number = self.tankhah.number if self.tankhah else 'NOTNKH'

        with transaction.atomic():
            max_serial = Factor.objects.filter(
                tankhah__organization=self.tankhah.organization,
                date=self.date
            ).aggregate(models.Max('number'))['number__max']

            serial = 1
            if max_serial:
                last_number = max_serial.split(sep)[-1]
                try:
                    serial = int(last_number) + 1
                except ValueError:
                    pass

            new_number = f"FAC{sep}{tankhah_number}{sep}{date_str}{sep}{org_code}{sep}{serial:04d}"
            while Factor.objects.filter(number=new_number).exists():
                serial += 1
                new_number = f"FAC{sep}{tankhah_number}{sep}{date_str}{sep}{org_code}{sep}{serial:04d}"
            return new_number

    def clean(self):
        super().clean()
        if self.amount < 0:
            raise ValidationError(_("Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯."))
        if not self.category:
            raise ValidationError(_("Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª."))
        if self.tankhah and (
                self.tankhah.status not in ['DRAFT', 'PENDING'] ): #or not self.tankhah.workflow_stage.is_initial
            raise ValidationError(_("ØªÙ†Ø®ÙˆØ§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª ÛŒØ§ Ù…Ø±Ø­Ù„Ù‡ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª."))

        #
        # total = self.total_amount()
        # errors = {}
        # if self.pk and total <= 0:
        #     raise ValidationError(_("Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯."))
        #
        # if abs(self.amount - total) > 0.01:
        #     logger.warning(f"Factor {self.number}: amount ({self.amount}) != items total ({total})")
        #     raise ValidationError(_("Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…Ø¬Ù…ÙˆØ¹ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ù‡Ù…Ø®ÙˆØ§Ù†ÛŒ Ù†Ø¯Ø§Ø±Ø¯."))
        #
        # if self.tankhah:
        #     tankhah_remaining = get_tankhah_remaining_budget(self.tankhah)
        #     if total > tankhah_remaining:
        #         raise ValidationError(
        #             _(f"Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± ({total:,.0f} Ø±ÛŒØ§Ù„) Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªÙ†Ø®ÙˆØ§Ù‡ ({tankhah_remaining:,.0f} Ø±ÛŒØ§Ù„) Ø¨Ø§Ø´Ø¯.")
        #         )
        #
        # if not self.category:
        #     errors['category'] = ValidationError(_('Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'), code='category_required')
        # if errors:
        #     raise ValidationError(errors)

    def save(self, *args, **kwargs):
        """Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ØŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª"""
        from budgets.models import BudgetTransaction
        with transaction.atomic():
            if not self.number:
                self.number = self.generate_number()

            # ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø®Ø§Øµ Ù…Ø¯Ù„ØŒ clean Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†ÛŒØ¯
            original = None
            if self.pk:
                original = Factor.objects.get(pk=self.pk)

            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù‚ÙÙ„
            if original and self.status != original.status:
                if self.status == 'PAID' and not self.is_locked:
                    create_budget_transaction(
                        allocation=self.tankhah.budget_allocation,
                        transaction_type='CONSUMPTION',
                        amount=self.amount,  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² self.amount Ø¨Ù‡ Ø¬Ø§ÛŒ total_amount()
                        related_obj=self,
                        created_by=self.created_by,
                        description=f"Ù…ØµØ±Ù Ø¨ÙˆØ¯Ø¬Ù‡ ØªÙˆØ³Ø· ÙØ§Ú©ØªÙˆØ± {self.number}",
                        transaction_id=f"TX-FAC-{self.number}"
                    )
                    self.is_locked = True

                    # post = Post.objects.get(id=1)
                    # from Tanbakhsystem.view.views_notifications import send_notification
                    # send_notification(
                    #     sender=sender,
                    #     posts=post,
                    #     verb='ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ³Øª Ø¨Ø±Ø§ÛŒ Ù¾Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯',
                    #     description='Ø§ÛŒÙ† ÛŒÚ© Ø§Ø¹Ù„Ø§Ù† Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª.',
                    #     target=post
                    # )
                    # Notification.objects.create(
                    #     user=self.created_by,
                    #     message=f"ÙØ§Ú©ØªÙˆØ± {self.number} Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯.",
                    #     tankhah=self.tankhah
                    # )
                elif self.status == 'REJECTED' and original.status in ['APPROVED', 'PAID'] and self.is_locked:
                    create_budget_transaction(
                        allocation=self.tankhah.budget_allocation,
                        transaction_type='RETURN',
                        amount=self.amount,
                        related_obj=self,
                        created_by=self.created_by,
                        description=f"Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø¯ ÙØ§Ú©ØªÙˆØ± {self.number}",
                        transaction_id=f"TX-FAC-RET-{self.number}"
                    )
            super().save(*args, **kwargs)
            # Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù† ØªØ®ØµÛŒØµ ÛŒØ§ Ø¯ÙˆØ±Ù‡
            if self.transaction.allocation.is_locked or self.transaction.allocation.budget_period.is_locked:
                if self.status != 'PAID':
                    raise ValidationError(_("Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ø±Ø¯ØŒ ØªØ®ØµÛŒØµ ÛŒØ§ Ø¯ÙˆØ±Ù‡ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª."))
            # Ø«Ø¨Øª ApprovalLog ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ÛŒØ§ ÙÛŒÙ„Ø¯Ù‡Ø§
            if original:
                changed_fields = [field.name for field in self._meta.fields if
                                  getattr(original, field.name) != getattr(self, field.name)]
                if changed_fields or self.status != original.status:
                    from django.contrib.contenttypes.models import ContentType
                    user_post = self.created_by.userpost_set.filter(is_active=True).first()
                    if user_post:
                        ApprovalLog.objects.create(
                            factor=self,
                            action='STAGE_CHANGE' if changed_fields else (
                                'APPROVE' if self.status in ['APPROVED', 'PAID'] else 'REJECT'),
                            stage=self.tankhah.current_stage,
                            user=self.created_by,
                            post=user_post.post,
                            content_type=ContentType.objects.get_for_model(self),
                            object_id=self.id,
                            comment=f"ØªØºÛŒÛŒØ± {'ÙÛŒÙ„Ø¯Ù‡Ø§' if changed_fields else 'ÙˆØ¶Ø¹ÛŒØª'} ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ {self.get_status_display()}",
                            changed_field=', '.join(changed_fields) if changed_fields else None
                        )

                    # self.is_locked = False
                    # Notification.objects.create(
                    #     user=self.created_by,
                    #     message=f"ÙØ§Ú©ØªÙˆØ± {self.number} Ø±Ø¯ Ø´Ø¯.",
                    #     tankhah=self.tankhah
                    # )
            # if self.pk and self.status == 'PENDING':
            #     # from django.contrib.contenttypes.models import ContentType
            #     user_post = self.created_by.userpost_set.filter(is_active=True).first()
            #     if user_post:
            #         ApprovalLog.objects.create(
            #             factor=self,
            #             action='STAGE_CHANGE',
            #             stage=self.tankhah.current_stage,
            #             user=self.created_by,
            #             post=user_post.post,
            #             content_type=ContentType.objects.get_for_model(self),
            #             object_id=self.id
            #         )

            # Ø«Ø¨Øª Ù„Ø§Ú¯ ØªØ£ÛŒÛŒØ¯/Ø±Ø¯
            # if original and self.status != original.status:
            #     ApprovalLog.objects.create(
            #         factor=self,
            #         action='APPROVE' if self.status in ['APPROVED', 'PAID'] else 'REJECT',
            #         stage=self.locked_by_stage or self.tankhah.current_stage,
            #         user=self.created_by,
            #         comment=f"ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ {self.get_status_display()}",
            #         content_type=ContentType.objects.get_for_model(self),
            #         object_id=self.pk
            #     )

            # Ø«Ø¨Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
            # if original:
            #     changed_fields = []
            #     for field in self._meta.fields:
            #         field_name = field.name
            #         if getattr(original, field_name) != getattr(self, field_name):
            #             changed_fields.append(field_name)
            #     if changed_fields:
            #         ApprovalLog.objects.create(
            #             factor=self,
            #             action='STAGE_CHANGE',
            #             stage=self.locked_by_stage or self.tankhah.current_stage,
            #             user=self.created_by,
            #             comment=f"ØªØºÛŒÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ {', '.join(changed_fields)}",
            #             content_type=ContentType.objects.get_for_model(self),
            #             object_id=self.pk,
            #             changed_field=', '.join(changed_fields)
            #         )

    def __str__(self):
        # Ø§ØµÙ„Ø§Ø­ Ù…ØªØ¯ __str__ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª tankhah=None
        tankhah_number = self.tankhah.number if self.tankhah else "ØªÙ†Ø®ÙˆØ§Ù‡ Ù†Ø¯Ø§Ø±Ø¯"
        return f"{self.number} ({tankhah_number})"

    class Meta:
        verbose_name = _("ÙØ§Ú©ØªÙˆØ±")
        verbose_name_plural = _("ÙØ§Ú©ØªÙˆØ±Ù‡Ø§")
        indexes = [
            models.Index(fields=['number', 'date', 'status', 'tankhah']),
        ]
        default_permissions = ()
        permissions = [
            ('factor_add', _('Ø§ÙØ²ÙˆØ¯Ù† ÙØ§Ú©ØªÙˆØ±')),
            ('factor_view', _('Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±')),
            ('factor_update', _('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙØ§Ú©ØªÙˆØ±')),
            ('factor_delete', _('Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ±')),
            ('factor_approve', _('ØªØ£ÛŒÛŒØ¯ ÙØ§Ú©ØªÙˆØ±')),
            ('factor_reject', _('Ø±Ø¯ ÙØ§Ú©ØªÙˆØ±')),
            ('Factor_full_edit', _('Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±')),
        ]
class Tankhah(models.Model):
    """Ù…Ø¯Ù„ ØªÙ†Ø®ÙˆØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ"""
    STATUS_CHOICES = (
        ('DRAFT', _('Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³')),
        ('PENDING', _('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ')),
        ('APPROVED', _('ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡')),
        ('SENT_TO_HQ', _('Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡ Ø¨Ù‡ HQ')),
        ('HQ_OPS_PENDING', _('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ - Ø¨Ù‡Ø±Ù‡â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ')),
        ('HQ_OPS_APPROVED', _('ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡ - Ø¨Ù‡Ø±Ù‡â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ')),
        ('HQ_FIN_PENDING', _('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ - Ù…Ø§Ù„ÛŒ')),
        ('PAID', _('Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡')),
        ('REJECTED', _('Ø±Ø¯Ø´Ø¯Ù‡')),
    )
    number = models.CharField(max_length=50, unique=True, blank=True, verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ ØªÙ†Ø®ÙˆØ§Ù‡"))
    amount = models.DecimalField(max_digits=25, decimal_places=2, verbose_name=_("Ù…Ø¨Ù„Øº"))
    date = models.DateTimeField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ®"))
    due_date = models.DateTimeField(null=True, blank=True, verbose_name=_('Ù…Ù‡Ù„Øª Ø²Ù…Ø§Ù†ÛŒ'))
    created_at = models.DateTimeField(auto_now_add=True, verbose_name=_("ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯")) # Ø§Ø¬Ø¨Ø§Ø± Ø¯Ø± ØªÙˆÙ‚Ù
    organization = models.ForeignKey('core.Organization', on_delete=models.CASCADE, verbose_name=_('Ù…Ø¬Ù…ÙˆØ¹Ù‡/Ø´Ø¹Ø¨Ù‡'))
    # project = models.ForeignKey('core.Project', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=_('Ù¾Ø±ÙˆÚ˜Ù‡'))
    project = models.ForeignKey('core.Project', on_delete=models.SET_NULL, null=True, blank=True, related_name='tankhah_set', verbose_name=_('Ù¾Ø±ÙˆÚ˜Ù‡'))
    project_budget_allocation = models.ForeignKey('budgets.ProjectBudgetAllocation', on_delete=models.CASCADE,
                                                  related_name='tankhahs', verbose_name=_("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡"),
                                                  null=True, blank=True)
    subproject = models.ForeignKey('core.SubProject', on_delete=models.CASCADE, null=True, blank=True, verbose_name=_("Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡"))
    letter_number = models.CharField(max_length=50, blank=True, null=True, verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ Ù†Ø§Ù…Ù‡"))
    created_by = models.ForeignKey('accounts.CustomUser', on_delete=models.SET_NULL, null=True, related_name='tankhah_created', verbose_name=_("Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡"))
    approved_by = models.ManyToManyField('accounts.CustomUser', blank=True, verbose_name=_('ØªØ£ÛŒÛŒØ¯Ú©Ù†Ù†Ø¯Ú¯Ø§Ù†'))
    description = models.TextField(verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    current_stage = models.ForeignKey('core.WorkflowStage', on_delete=models.SET_NULL, null=True,
                                      default=get_default_workflow_stage, verbose_name="Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ù„ÛŒ")
    status = models.CharField(max_length=20, choices=STATUS_CHOICES,  default='DRAFT', verbose_name=_("ÙˆØ¶Ø¹ÛŒØª"))
    hq_status = models.CharField(max_length=20, default='PENDING',
                                 choices=STATUS_CHOICES, null=True, blank=True,
                                 verbose_name=_("ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± HQ"))
    last_stopped_post = models.ForeignKey('core.Post', null=True, blank=True, on_delete=models.SET_NULL, verbose_name=_("Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø³Øª Ù…ØªÙˆÙ‚Ùâ€ŒØ´Ø¯Ù‡"))

    is_archived = models.BooleanField(default=False, verbose_name=_("Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡"))

    payment_number = models.CharField(max_length=50, blank=True, null=True, verbose_name=_("Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª"))
    is_locked = models.BooleanField(default=False, verbose_name=_("Ù‚ÙÙ„ Ø´Ø¯Ù‡"))
    archived_at = models.DateTimeField(null=True, blank=True, verbose_name="Ø²Ù…Ø§Ù† Ø¢Ø±Ø´ÛŒÙˆ")
    canceled = models.BooleanField(default=False, verbose_name="Ù„ØºÙˆ Ø´Ø¯Ù‡")
    remaining_budget = models.DecimalField(max_digits=25, decimal_places=2, default=0, verbose_name=_("Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡"))

    budget_allocation = models.ForeignKey('budgets.BudgetAllocation', on_delete=models.SET_NULL, null=True,
                                          verbose_name=_("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡"))
    is_emergency = models.BooleanField(default=False, verbose_name=_("Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ"))
    """ØªÙˆØ¶ÛŒØ­: Ù„ÛŒÙ†Ú© Ø¨Ù‡ BudgetAllocation Ø¨Ø±Ø§ÛŒ Ù…ØµØ±Ù Ø¨ÙˆØ¯Ø¬Ù‡ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† is_emergency."""
    request_date = models.DateField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ® Ø¯Ø±Ø®ÙˆØ§Ø³Øª"))

    def generate_number(self):
        """ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡ Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ"""
        sep = NUMBER_SEPARATOR

        # ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
        import jdatetime
        jalali_date = jdatetime.datetime.fromgregorian(datetime=self.date)
        date_str = jalali_date.strftime('%Y%m%d')  # ÙØ±Ù…Øª YYYYMMDD Ø´Ù…Ø³ÛŒ

        org_code = self.organization.code
        project_code = self.project.code if self.project else 'NOPRJ'

        # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø²Ù…Ø§Ù†
        with transaction.atomic():
            max_serial = Tankhah.objects.filter(
                organization=self.organization,
                date__date=self.date.date()  # Ù‡Ù…Ú†Ù†Ø§Ù† Ø§Ø² ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            ).aggregate(Max('number'))['number__max']

            if max_serial:
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¬ÙˆØ¯
                last_number = max_serial.split(sep)[-1]
                serial = int(last_number) + 1
            else:
                serial = 1

            new_number = f"TNKH{sep}{date_str}{sep}{org_code}{sep}{project_code}{sep}{serial:03d}"
            # Ú†Ú© Ú©Ø±Ø¯Ù† ÛŒÚ©ØªØ§ÛŒÛŒ Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±ÛŒØ§Ù„ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
            while Tankhah.objects.filter(number=new_number).exists():
                serial += 1
                new_number = f"TNKH{sep}{date_str}{sep}{org_code}{sep}{project_code}{sep}{serial:03d}"
            return new_number

    def clean(self):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡"""
        super().clean()

        if self.amount <= 0:
            raise ValidationError(_("Ù…Ø¨Ù„Øº ØªÙ†Ø®ÙˆØ§Ù‡ Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯."))
        if self.subproject and self.subproject.project != self.project:
            raise ValidationError(_("Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ÛŒØ¯ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯."))

        remaining = self.get_remaining_budget()
        if self.amount > remaining:
            raise ValidationError(
                _(f"Ù…Ø¨Ù„Øº ØªÙ†Ø®ÙˆØ§Ù‡ ({self.amount:,.0f} Ø±ÛŒØ§Ù„) Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ({remaining:,.0f} Ø±ÛŒØ§Ù„) Ø§Ø³Øª.")
            )
            # Ø­Ø°Ù Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡ budget_allocation Ø§Ú¯Ø± Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª
        if not self.budget_allocation and not self.project_budget_allocation:
            logger.warning("Neither budget_allocation nor project_budget_allocation is set.")
            raise ValidationError({"budget_allocation": _("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ©ÛŒ Ø§Ø² ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§ÛŒØ¯ ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯.")})

        if self.subproject and self.subproject.project != self.project:
            raise ValidationError(_("Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ÛŒØ¯ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯."))

        if not self.budget_allocation:
            logger.warning("budget_allocation Ù…Ù‚Ø¯Ø§Ø± Ù†Ø¯Ø§Ø±Ø¯. Ø§ÛŒÙ† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ù…Ø´Ú©Ù„Ø§ØªÛŒ Ø¯Ø± Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ Ø´ÙˆØ¯.")
            # Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø®Ø·Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ù†ÛŒØ¯
            # Ø§Ú¯Ø± Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³ØªØŒ Ø®Ø·Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:
            raise ValidationError({"budget_allocation": _("Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.")})

    def get_remaining_budget(self):
            """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡"""
            if self.project_budget_allocation:
                return self.project_budget_allocation.get_remaining_amount()
            elif self.budget_allocation:
                return self.budget_allocation.get_remaining_amount()
            elif self.subproject:
                return get_subproject_remaining_budget(self.subproject)
            return Decimal('0')

    def save(self, *args, **kwargs):
        from budgets.models import ProjectBudgetAllocation
        with transaction.atomic():
            if not self.number:
                self.number = self.generate_number()
            self.full_clean()

            # Ø¯Ø±ÛŒØ§ÙØª ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡
            allocation = self.project_budget_allocation or ProjectBudgetAllocation.objects.filter(
                budget_allocation=self.budget_allocation,
                project=self.project,
                subproject=self.subproject
            ).first()
            if not allocation:
                raise ValidationError(_("ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡/Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯."))

            # Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± ØµÙˆØ±Øª Ø§ÛŒØ¬Ø§Ø¯ ÛŒØ§ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
            if self.status in ['APPROVED', 'REJECTED', 'PAID'] and not self.is_locked:
                if self.budget_allocation:  # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ budget_allocation
                    print('  Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ budget_allocation')
                    self.budget_allocation.send_notification(
                        self.status.lower(),
                        f"ØªÙ†Ø®ÙˆØ§Ù‡ {self.number} Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª {self.get_status_display()} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯."
                    )
                self.is_locked = True

            if not self.pk:  # ÙÙ‚Ø· Ù…ÙˆÙ‚Ø¹ Ø§ÛŒØ¬Ø§Ø¯
                # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡/Ø²ÛŒØ±Ù¾Ø±ÙˆÚ˜Ù‡
                if self.subproject:
                    allocation = ProjectBudgetAllocation.objects.filter(
                        budget_allocation=self.budget_allocation if self.budget_allocation else None,
                        subproject=self.subproject
                    ).first()
                    remaining = allocation.remaining_amount if allocation else self.subproject.get_remaining_budget()
                elif self.project:
                    allocation = ProjectBudgetAllocation.objects.filter(
                        budget_allocation=self.budget_allocation if self.budget_allocation else None,
                        project=self.project,
                        subproject__isnull=True
                    ).first()
                    remaining = allocation.remaining_amount if allocation else self.project.get_remaining_budget()
                else:
                    raise ValueError("ØªÙ†Ø®ÙˆØ§Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ ÛŒØ§ Ø³Ø§Ø¨â€ŒÙ¾Ø±ÙˆÚ˜Ù‡ ÙˆØµÙ„ Ø¨Ø§Ø´Ø¯.")

                if self.amount > remaining:
                    raise ValidationError(
                        _(f"Ù…Ø¨Ù„Øº ØªÙ†Ø®ÙˆØ§Ù‡ ({self.amount:,.0f} Ø±ÛŒØ§Ù„) Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ®ØµÛŒØµ ({remaining:,.0f} Ø±ÛŒØ§Ù„) Ø§Ø³Øª.")
                    )

            # Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾Ø³ Ø§Ø² Ø±Ø¯ Ø´Ø¯Ù†
            initial_stage = WorkflowStage.objects.order_by('order').first()
            if self.status == 'REJECTED' and self.current_stage == initial_stage:
                logger.info(f"ØªÙ†Ø®ÙˆØ§Ù‡ {self.number} Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ ({initial_stage.name}) Ø¨Ø§Ø²Ú¯Ø´ØªÙ‡ Ø§Ø³Øª.")
                # Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§Ø¶Ø§ÙÛŒ: Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù‚ÙÙ„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
                from tankhah.models import Factor
                factors = Factor.objects.filter(tankhah=self, is_finalized=True)
                updated = factors.update(is_finalized=False, locked=False)
                if updated:
                    logger.info(f"{updated} ÙØ§Ú©ØªÙˆØ± Ø¨Ø±Ø§ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡ {self.number} Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø§Ø² Ø´Ø¯Ù†Ø¯.")

            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
            if self.status == 'PAID':
                self.is_locked = True
                if self.budget_allocation:  # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ budget_allocation
                    self.budget_allocation.send_notification(
                        'paid',
                        f"ØªÙ†Ø®ÙˆØ§Ù‡ {self.number} Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯."
                    )
            elif self.status == 'REJECTED' and self.is_locked:
                if allocation and self.budget_allocation:
                    # Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ ØªØ®ØµÛŒØµ Ø¯ÛŒÚ¯Ø± (Ù…Ø«Ù„Ø§Ù‹ ØªØ®ØµÛŒØµ HQ)
                    from budgets.models import   BudgetAllocation
                    target_allocation = BudgetAllocation.objects.filter(organization__is_core=True).first()
                    if target_allocation:
                        create_budget_transaction(
                            allocation=self.budget_allocation,
                            transaction_type='TRANSFER',
                            amount=self.amount,
                            related_obj=self,
                            created_by=self.created_by,
                            description=f"Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡ {self.number}",
                            transaction_id=f"TX-TNK-XFER-{self.number}",
                            target_allocation=target_allocation
                        )
                    else:
                        # Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ ØªØ®ØµÛŒØµ ÙØ¹Ù„ÛŒ
                        allocation.remaining_amount += self.amount
                        allocation.save()
                        from budgets.models import  BudgetTransaction
                        BudgetTransaction.objects.create(
                            allocation=self.budget_allocation,
                            transaction_type='RETURN',
                            amount=self.amount,
                            related_tankhah=self,
                            created_by=self.created_by,
                            description=f"Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡ {self.number}",
                            transaction_id=f"TX-TNK-RET-{self.number}"
                        )
                self.is_locked = False
                # Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø±Ø¯ Ø´Ø¯Ù†
                # if allocation and self.budget_allocation:
                #     allocation.remaining_amount += self.amount
                #     allocation.save()
                #     from budgets.models import BudgetTransaction
                #     BudgetTransaction.objects.create(
                #         allocation=self.budget_allocation,
                #         transaction_type='RETURN',
                #         amount=self.amount,
                #         related_tankhah=self,
                #         created_by=self.created_by,
                #         description=f"Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡ {self.number}",
                #         transaction_id=f"TX-TNK-RET-{self.number}"
                #     )
                # self.is_locked = False

        super().save(*args, **kwargs)
        # Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù† ØªØ®ØµÛŒØµ ÛŒØ§ Ø¯ÙˆØ±Ù‡
        if self.allocation.is_locked or self.allocation.budget_period.is_locked:
            self.is_active = False
            self.save(update_fields=['is_active'])

    def __str__(self):
        project_str = self.project.name if self.project else 'Ø¨Ø¯ÙˆÙ† Ù¾Ø±ÙˆÚ˜Ù‡'
        subproject_str = f" ({self.subproject.name})" if self.subproject else ''
        return f"{self.number} - {project_str}{subproject_str} - {self.amount:,.0f} ({self.get_status_display()})"

    class Meta:
        verbose_name = _("ØªÙ†Ø®ÙˆØ§Ù‡")
        verbose_name_plural = _("ØªÙ†Ø®ÙˆØ§Ù‡â€ŒÙ‡Ø§")
        indexes = [
            models.Index(fields=['number', 'date', 'status' ,'organization'])]
        default_permissions =()
        permissions = [
            ('Tankhah_add', _(' + Ø§ÙØ²ÙˆØ¯Ù† ØªÙ†Ø®ÙˆØ§Ù‡')),
            ('Tankhah_view', _('Ù†Ù…Ø§ÛŒØ´ ØªÙ†Ø®ÙˆØ§Ù‡')),
            ('Tankhah_update', _('ğŸ†™Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡')),
            ('Tankhah_delete', _('â›”Ø­Ø°Ù ØªÙ†Ø®ÙˆØ§Ù‡')),
            ('Tankhah_approve', _('ğŸ‘ØªØ£ÛŒÛŒØ¯ ØªÙ†Ø®ÙˆØ§Ù‡')),
            ('Tankhah_reject', _('Ø±Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡ğŸ‘')),

            ('Tankhah_part_approve', 'ğŸ‘ØªØ£ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³ Ù‚Ø³Ù…Øª'),

            ('Tankhah_hq_view', 'Ø±ØµØ¯ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ'),
            ('Tankhah_hq_approve', 'ğŸ‘ØªØ£ÛŒÛŒØ¯ Ø±Ø¯Ù‡ Ø¨Ø§Ù„Ø§ Ø¯Ø± Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ'),

            ('Tankhah_HQ_OPS_PENDING', _('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ - Ø¨Ù‡Ø±Ù‡â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ')),
            ('Tankhah_HQ_OPS_APPROVED', _('ğŸ‘ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡ - Ø¨Ù‡Ø±Ù‡â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ')),
            ('Tankhah_HQ_FIN_PENDING', _('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ - Ù…Ø§Ù„ÛŒ')),
            ('Tankhah_PAID', _('Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡')),

            ("FactorItem_approve", "ğŸ‘ØªØ§ÛŒÛŒØ¯/Ø±Ø¯ Ø±Ø¯ÛŒÙ ÙØ§Ú©ØªÙˆØ± (ØªØ§ÛŒÛŒØ¯ Ø±Ø¯ÛŒÙ ÙØ§Ú©ØªÙˆØ±*Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ù…Ø±Ø§Ø­Ù„ ØªØ§ÛŒÛŒØ¯*)"),
            ('edit_full_tankhah','ğŸ‘ğŸ˜ŠØªØºÛŒÛŒØ±Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ± /ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ø±Ø¯ÛŒÙ Ù‡Ø§ '),

            ('Dashboard_Core_view', 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Core Ù¾Ø§ÛŒÙ‡'),
            ('DashboardView_flows_view', 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø±ÙˆÙ†Ø¯ ØªÙ†Ø®ÙˆØ§Ù‡ Ú¯Ø±Ø¯Ø§Ù†ÛŒ'),
            ('Dashboard__view', 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ ğŸ’»'),

            ('Dashboard_Stats_view', 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ğŸ’²'),
        ]
 #-------- ÙØ±Ù…Øª Ù†Ù…Ø§ÛŒØ´ÛŒ Ø®Ø§Øµ
    def get_project_total_budget_display(self):
        return f"{self.project_total_budget:,.0f}" if hasattr(self,
                                                              'project_total_budget') and self.project_total_budget else '-'

    def get_project_remaining_budget_display(self):
        return f"{self.project_remaining_budget:,.0f}" if hasattr(self,
                                                                  'project_remaining_budget') and self.project_remaining_budget else '-'

    def get_branch_total_budget_display(self):
        return f"{self.branch_total_budget:,.0f}" if hasattr(self,
                                                             'branch_total_budget') and self.branch_total_budget else '-'

    def get_tankhah_used_budget_display(self):
        return f"{self.tankhah_used_budget:,.0f}" if hasattr(self,
                                                             'tankhah_used_budget') and self.tankhah_used_budget else '-'

    def get_factor_used_budget_display(self):
        return f"{self.factor_used_budget:,.0f}" if hasattr(self, 'factor_used_budget') and self.factor_used_budget else '-'


class OrganizationType(models.Model):
    fname = models.CharField(max_length=100, unique=True, null=True, blank=True, verbose_name=_('Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡/Ù…Ø¬ØªÙ…Ø¹/Ø§Ø¯Ø§Ø±Ù‡'))
    org_type = models.CharField(max_length=100, unique=True, null=True, blank=True, verbose_name=_('Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡/Ù…Ø¬ØªÙ…Ø¹/Ø§Ø¯Ø§Ø±Ù‡'))
    is_budget_allocatable = models.BooleanField(default=False, verbose_name=_("Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡"))
    def __str__(self):
        return f"{self.fname} - {self.org_type} "or _("Ù†Ø§Ù…Ø´Ø®Øµ")

    class Meta:
        verbose_name = _('Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ú©Ø²/Ø´Ø¹Ø¨Ù‡/Ø§Ø¯Ø§Ø±Ù‡/Ø³Ø§Ø²Ù…Ø§Ù†')
        verbose_name_plural = _('Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ú©Ø²/Ø´Ø¹Ø¨Ù‡/Ø§Ø¯Ø§Ø±Ù‡/Ø³Ø§Ø²Ù…Ø§Ù†')
        default_permissions = ()
        permissions = [
            ('OrganizationType_add', 'Ø§ÙØ²ÙˆØ¯Ù† Ø´Ø¹Ø¨Ù‡/Ø§Ø¯Ø§Ø±Ù‡/Ù…Ø¬ØªÙ…Ø¹/Ø³Ø§Ø²Ù…Ø§Ù†'),
            ('OrganizationType_view', 'Ù†Ù…Ø§ÛŒØ´ Ø´Ø¹Ø¨Ù‡/Ø§Ø¯Ø§Ø±Ù‡/Ù…Ø¬ØªÙ…Ø¹/Ø³Ø§Ø²Ù…Ø§Ù†'),
            ('OrganizationType_update', 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¹Ø¨Ù‡/Ø§Ø¯Ø§Ø±Ù‡/Ù…Ø¬ØªÙ…Ø¹/Ø³Ø§Ø²Ù…Ø§Ù†'),
            ('OrganizationType_delete', 'Ø­Ù€Ù€Ø°Ù Ø´Ø¹Ø¨Ù‡/Ø§Ø¯Ø§Ø±Ù‡/Ù…Ø¬ØªÙ…Ø¹/Ø³Ø§Ø²Ù…Ø§Ù†'),
         ]
class Organization(models.Model):
    """Ù…Ø¯Ù„ Ø³Ø§Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ù…Ø¬ØªÙ…Ø¹â€ŒÙ‡Ø§ Ùˆ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ"""
    code = models.CharField(max_length=10, unique=True, verbose_name=_("Ú©Ø¯ Ø³Ø§Ø²Ù…Ø§Ù†"))
    name = models.CharField(max_length=100, verbose_name=_("Ù†Ø§Ù… Ø³Ø§Ø²Ù…Ø§Ù†"))
    org_type = models.ForeignKey('OrganizationType', on_delete=models.SET_NULL, null=True, blank=True,
                                 verbose_name=_("Ù†ÙˆØ¹ Ø³Ø§Ø²Ù…Ø§Ù†"),
                                 related_name='organizations')  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† related_name Ø¨Ø±Ø§ÛŒ ÙˆØ¶ÙˆØ­

    description = models.TextField(blank=True, null=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    parent_organization = models.ForeignKey('self', on_delete=models.SET_NULL, null=True, blank=True,
                                            verbose_name=_("Ø³Ø§Ø²Ù…Ø§Ù† ÙˆØ§Ù„Ø¯"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))
    is_core = models.BooleanField(default=False, verbose_name=_("Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†"))  # ØªØºÛŒÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ù‡ False

    def clean(self):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ù†Ø·Ù‚ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ"""
        from django.core.exceptions import ValidationError
        if self.is_core and self.parent_organization:
            raise ValidationError(_('Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø³Ø§Ø²Ù…Ø§Ù† ÙˆØ§Ù„Ø¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.'))
        if self.is_core:
            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ØªÙ†Ù‡Ø§ ÛŒÚ© Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ ÙØ¹Ø§Ù„
            existing_core = Organization.objects.filter(is_core=True, is_active=True).exclude(pk=self.pk)
            if existing_core.exists():
                raise ValidationError(_('ÙÙ‚Ø· ÛŒÚ© Ø³Ø§Ø²Ù…Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯.'))

    def __str__(self):
        org_type_str = self.org_type.fname if self.org_type else _("Ù†Ø§Ù…Ø´Ø®Øµ")
        return f"{self.code} - {self.name} ({org_type_str})"

    @property
    def org_type_code(self):
        return self.org_type.fname if self.org_type else None

    @property
    def budget_allocations(self):
        from budgets.models import BudgetAllocation
        return BudgetAllocation.objects.filter(organization=self)


    def save(self, *args, **kwargs):
        """Ø§Ø¬Ø±Ø§ÛŒ clean Ù‚Ø¨Ù„ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡"""
        self.full_clean()  # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        # Assuming you have a URL pattern named 'organization_detail'
        # that takes organization's pk or code
        from django.urls import reverse
        return reverse('organization_detail', kwargs={'pk': self.pk})


    class Meta:
        verbose_name = _("Ø³Ø§Ø²Ù…Ø§Ù†")
        verbose_name_plural = _("Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§")
        default_permissions = ()
        permissions = [
            ('Organization_add', 'Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø§Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ù…Ø¬ØªÙ…Ø¹â€ŒÙ‡Ø§ Ùˆ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ'),
            ('Organization_update', 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø§Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ù…Ø¬ØªÙ…Ø¹â€ŒÙ‡Ø§ Ùˆ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ'),
            ('Organization_delete', 'Ø­Ù€Ù€Ø°Ù Ø³Ø§Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ù…Ø¬ØªÙ…Ø¹â€ŒÙ‡Ø§ Ùˆ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ'),
            ('Organization_view', 'Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ù…Ø¬ØªÙ…Ø¹â€ŒÙ‡Ø§ Ùˆ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ'),
        ]
        indexes = [
            models.Index(fields=['code', 'org_type']),
        ]
class Project(models.Model):
    name = models.CharField(max_length=100, verbose_name=_("Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡"))
    code = models.CharField(max_length=80, unique=True, verbose_name=_("Ú©Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡"))
    # organizations = models.ManyToManyField(Organization, limit_choices_to={'org_type': 'COMPLEX'}, verbose_name=_("Ù…Ø¬ØªÙ…Ø¹â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·"))
    organizations = models.ManyToManyField(
        Organization,
        limit_choices_to={'org_type__is_budget_allocatable': True},  # Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯
        verbose_name=_("Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·")
    )
    # allocations = models.ManyToManyField('budgets.BudgetAllocation', blank=True, verbose_name=_("ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø±ØªØ¨Ø·"))
    start_date = models.DateField(verbose_name=_("ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹"))
    end_date = models.DateField(null=True, blank=True, verbose_name=_("ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†"))
    description = models.TextField(blank=True, null=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    is_active = models.BooleanField(default=True, verbose_name="ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„")
    PRIORITY_CHOICES = (('LOW', _('Ú©Ù…')), ('MEDIUM', _('Ù…ØªÙˆØ³Ø·')), ('HIGH', _('Ø²ÛŒØ§Ø¯')),)
    priority = models.CharField(max_length=20, choices=PRIORITY_CHOICES, default='MEDIUM', verbose_name=_("Ø§ÙˆÙ„ÙˆÛŒØª"))
    # total_budget = models.DecimalField(max_digits=25, decimal_places=2, default=0, verbose_name=_("Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„ ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡"))  # ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯

    def get_total_budget(self):
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡"""
        return get_project_total_budget(self)

    def get_remaining_budget(self):
        return get_project_remaining_budget(self)

    def __str__(self):
        status = "ÙØ¹Ø§Ù„" if self.is_active else "ØºÛŒØ±ÙØ¹Ø§Ù„"
        return f"{self.code} - {self.name} ({status})"

    class Meta:
        verbose_name = _("Ù¾Ø±ÙˆÚ˜Ù‡")
        verbose_name_plural = _("Ù¾Ø±ÙˆÚ˜Ù‡")
        default_permissions = ()
        permissions = [
            ('Project_add', 'Ø§ÙØ²ÙˆØ¯Ù†  Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('Project_update', 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('Project_view', 'Ù†Ù…Ø§ÛŒØ´ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('Project_delete', 'Ø­Ù€Ù€Ø°Ù Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            # ('Project_Budget_allocation_Head_Office', 'ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡(Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ)'),
            # ('Project_Budget_allocation_Branch', 'ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡(Ø´Ø¹Ø¨Ù‡)'),
        ]
class SubProject(models.Model):
    project = models.ForeignKey(Project, on_delete=models.CASCADE, related_name='subprojects', verbose_name=_("Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ØµÙ„ÛŒ"))
    name = models.CharField(max_length=200, verbose_name=_("Ù†Ø§Ù… Ø³Ø§Ø¨â€ŒÙ¾Ø±ÙˆÚ˜Ù‡"))
    description = models.TextField(blank=True, null=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    allocated_budget = models.DecimalField(max_digits=25, decimal_places=2, default=0,
                                           verbose_name=_("Ø¨ÙˆØ¯Ø¬Ù‡ ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡"))
    # allocations = models.ManyToManyField('budgets.ProjectBudgetAllocation',
    #                                     related_name='budget_allocations_set' ,blank=True, verbose_name=_("ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø±ØªØ¨Ø·"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))

    def get_remaining_budget(self):
        return get_subproject_remaining_budget(self)

    # def get_remaining_budget(self):
    #     total_allocated = self.budget_allocations.aggregate(total=Sum('allocated_amount'))['total'] or Decimal('0')
    #     consumed = BudgetTransaction.objects.filter(
    #         allocation__in=self.budget_allocations.all(),
    #         transaction_type='CONSUMPTION'
    #     ).aggregate(total=Sum('amount'))['total'] or Decimal('0')
    #     returned = BudgetTransaction.objects.filter(
    #         allocation__in=self.budget_allocations.all(),
    #         transaction_type='RETURN'
    #     ).aggregate(total=Sum('amount'))['total'] or Decimal('0')
    #     return total_allocated - consumed + returned
    #
    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡
        total_allocated = self.budget_allocations.aggregate(total=Sum('allocated_amount'))['total'] or Decimal('0')
        self.allocated_budget = total_allocated
        super().save(update_fields=['allocated_budget'])
        if not self.pk:
            total_allocated = sum([alloc.amount for alloc in self.allocations.all()])
            if total_allocated > self.project.get_remaining_budget():
                raise ValueError("Ø¨ÙˆØ¯Ø¬Ù‡ ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø³Øª.")


    def __str__(self):
        return f"{self.name} ({self.project.name})"

    class Meta:
        verbose_name = _("Ø³Ø§Ø¨â€ŒÙ¾Ø±ÙˆÚ˜Ù‡")
        verbose_name_plural = _("Ø³Ø§Ø¨â€ŒÙ¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§")
        default_permissions =()
        permissions = [
            ('SubProject_add','Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('SubProject_update','ÙˆÛŒØ±Ø§ÛŒØ´ Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('SubProject_view','Ù†Ù…Ø§ÛŒØ´ Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('SubProject_delete','Ø­Ù€Ù€Ø°Ù Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡'),
            ('SubProject_Head_Office','ØªØ®ØµÛŒØµ Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡(Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ)ğŸ '),
            ('SubProject_Branch','ØªØ®ØµÛŒØµ  Ø²ÛŒØ± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡(Ø´Ø¹Ø¨Ù‡)ğŸ '),
        ]
class Post(models.Model):
    """Ù…Ø¯Ù„ Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨"""
    BRANCH_CHOICES = (
        ('OPS', _('Ø¨Ù‡Ø±Ù‡â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ')),
        ('FIN', _('Ù…Ø§Ù„ÛŒ Ùˆ Ø§Ø¯Ø§Ø±ÛŒ')),
        (None, _('Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø®Ù‡')),
    )
    name = models.CharField(max_length=100, verbose_name=_("Ù†Ø§Ù… Ù¾Ø³Øª"))
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, verbose_name=_("Ø³Ø§Ø²Ù…Ø§Ù†"))
    parent = models.ForeignKey('self', null=True, blank=True, on_delete=models.SET_NULL, verbose_name=_("Ù¾Ø³Øª ÙˆØ§Ù„Ø¯"))
    level = models.IntegerField(default=1, verbose_name=_("Ø³Ø·Ø­"))
    branch = models.CharField(max_length=3, choices=BRANCH_CHOICES, null=True, blank=True, verbose_name=_("Ø´Ø§Ø®Ù‡"))
    description = models.TextField(blank=True, null=True, verbose_name=_("ØªÙˆØ¶ÛŒØ­Ø§Øª"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„"))
    max_change_level = models.IntegerField(default=1, verbose_name=_("Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ø·Ø­ ØªØºÛŒÛŒØ±(Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ ØªØ±)"), help_text=_("Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ù¾Ø³Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯"))

    is_payment_order_signer = models.BooleanField(default=False,
                                                  verbose_name=_("Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ù…Ø¶Ø§ÛŒ Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª"))


    def __str__(self):
        branch = self.branch or "Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø®Ù‡"
        return f"{self.name} ({self.organization.code}) - {branch}"

    def save(self, *args, **kwargs):
        if self.parent:
            self.level = self.parent.level + 1
        else:
            self.level = 1
        # Ù…Ø·Ù…Ø¦Ù† Ù…ÛŒâ€ŒØ´ÛŒÙ… max_change_level Ø§Ø² level Ú©Ù…ØªØ± Ù†Ø¨Ø§Ø´Ù‡
        if self.max_change_level < self.level:
            self.max_change_level = self.level
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        return reverse('post_detail', kwargs={'pk': self.pk})

    class Meta:
        verbose_name = _("Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ")
        verbose_name_plural = _("Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ")
        default_permissions =()
        permissions = [
            ('Post_add','Ø§ÙØ²ÙˆØ¯Ù†  Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨'),
            ('Post_update','Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨'),
            ('Post_view','Ù†Ù…Ø§ÛŒØ´  Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨'),
            ('Post_delete','Ø­Ù€Ù€Ø°Ù  Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨'),
            ]
class UserPost(models.Model):
    """Ù…Ø¯Ù„ Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øª"""
    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE, verbose_name=_("Ú©Ø§Ø±Ø¨Ø±"))
    post = models.ForeignKey(Post, on_delete=models.CASCADE, verbose_name=_("Ù¾Ø³Øª"))
    # Ø±Ø¯ÛŒØ§Ø¨ÛŒ ØªØ§Ø±ÛŒØ®
    start_date = models.DateField(default=timezone.now, verbose_name=_("ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹"))
    end_date = models.DateField(null=True, blank=True, verbose_name=_("ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))

    class Meta:
        unique_together = ('user', 'post')
        verbose_name = _("Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øª")
        verbose_name_plural = _("Ø§ØªØµØ§Ù„Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§")

        default_permissions = ()
        permissions = [
            ('UserPost_add', 'Ø§ÙØ²ÙˆØ¯Ù†  Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øª'),
            ('UserPost_update', 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ  Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øª'),
            ('UserPost_view', 'Ù†Ù…Ø§ÛŒØ´   Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øª'),
            ('UserPost_delete', 'Ø­Ù€Ù€Ø°Ù  Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù¾Ø³Øª'),
        ]

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        from channels.layers import get_channel_layer
        from asgiref.sync import async_to_sync
        channel_layer = get_channel_layer()
        async_to_sync(channel_layer.group_send)(
            'chart_updates', {
                'type': 'chart_update',
                'message': 'UserPost updated, reload chart'
            }
        )

    def __str__(self):
        return f"{self.user.username} - {self.post.name} (Ø§Ø² {self.start_date})"
class PostHistory(models.Model):
    """
    Ù…Ø¯Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ
    Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„â€ŒØ´Ø¯Ù‡ Ø±ÙˆÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§ (Ù…Ø«Ù„ ØªØºÛŒÛŒØ± Ù†Ø§Ù…ØŒ ÙˆØ§Ù„Ø¯ ÛŒØ§ Ø´Ø§Ø®Ù‡)
    """
    post = models.ForeignKey(
        Post,
        on_delete=models.CASCADE,
        verbose_name=_("Ù¾Ø³Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ"),
        help_text=_("Ù¾Ø³ØªÛŒ Ú©Ù‡ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª")
    )
    changed_field = models.CharField(
        max_length=50,
        verbose_name=_("ÙÛŒÙ„Ø¯ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡"),
        help_text=_("Ù†Ø§Ù… ÙÛŒÙ„Ø¯ÛŒ Ú©Ù‡ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ (Ù…Ø«Ù„ name ÛŒØ§ parent)")
    )
    old_value = models.TextField(
        null=True,
        blank=True,
        verbose_name=_("Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ"),
        help_text=_("Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ ÙÛŒÙ„Ø¯ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±")
    )
    new_value = models.TextField(
        null=True,
        blank=True,
        verbose_name=_("Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯"),
        help_text=_("Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ ÙÛŒÙ„Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ±")
    )
    changed_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name=_("ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ±"),
        help_text=_("Ø²Ù…Ø§Ù† Ø«Ø¨Øª ØªØºÛŒÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø±")
    )
    changed_by = models.ForeignKey(
        CustomUser,
        on_delete=models.SET_NULL,
        null=True,
        verbose_name=_("ØªØºÛŒÛŒØ± Ø¯Ù‡Ù†Ø¯Ù‡"),
        help_text=_("Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ø±Ø¯Ù‡")
    )

    # ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (add, change, delete, view)
    default_permissions = ()
    # ØªØ¹Ø±ÛŒÙ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ
    permissions = [
        ("view_posthistory", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯")),
        ("add_posthistory", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ø¯")),
        ("delete_posthistory", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†Ø¯")),
    ]

    def __str__(self):
        return f"{self.post} - {self.changed_field} ({self.changed_at})"

    class Meta:
        verbose_name = _("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øª")
        verbose_name_plural = _("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§")
        # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ± (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
        ordering = ['-changed_at']
        # Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø³ØªØ¬Ùˆ
        permissions = [
            ("posthistory_view", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯")),
            ("posthistory_add", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ø¯")),
            ("posthistory_update", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†Ø¯")),
            ("posthistory_delete", _("Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†Ø¯")),
        ]

        indexes = [
            models.Index(fields=['post', 'changed_at']),
        ]
#--
class WorkflowStage(models.Model):
    name = models.CharField(max_length=100, verbose_name=_('Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡'))
    order = models.IntegerField(verbose_name=_('ØªØ±ØªÛŒØ¨'))
    description = models.TextField(blank=True, verbose_name=_('ØªÙˆØ¶ÛŒØ­Ø§Øª'))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„"))
    is_final_stage = models.BooleanField(default=False, help_text="Ø¢ÛŒØ§ Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ ØªÙ†Ø®ÙˆØ§Ù‡ Ø§Ø³ØªØŸ", verbose_name=_("ØªØ¹ÛŒÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¢Ø®Ø±"))

    def save(self, *args, **kwargs):
        if WorkflowStage.objects.exclude(pk=self.pk).filter(order=self.order).exists():
            raise ValueError("ØªØ±ØªÛŒØ¨ Ù…Ø±Ø­Ù„Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯")
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.name} (Ù…Ø±Ø­Ù„Ù‡ {self.order})"

    class Meta:
        verbose_name = _('Ù…Ø±Ø­Ù„Ù‡ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±')
        verbose_name_plural = _('Ù…Ø±Ø§Ø­Ù„ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±')
        ordering = ['order']
        default_permissions = ()
        permissions = [
            ('WorkflowStage_view','Ù†Ù…Ø§ÛŒØ´ Ù…Ø±Ø­Ù„Ù‡ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±'),
            ('WorkflowStage_add','Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø±Ø­Ù„Ù‡ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±'),
            ('WorkflowStage_update','Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø±Ø­Ù„Ù‡ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±'),
            ('WorkflowStage_delete','Ø­Ù€Ù€Ø°Ù Ù…Ø±Ø­Ù„Ù‡ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±'),
        ]
#--- New Bugde
class PostAction(models.Model):
    ACTION_TYPES = (
        ('APPROVE', _('ØªØ£ÛŒÛŒØ¯')),
        ('REJECT', _('Ø±Ø¯')),
        ('FINALIZE', _('Ø§ØªÙ…Ø§Ù…')),
        ('STAGE_CHANGE', _('ØªØºÛŒÛŒØ±ÙˆØ¶Ø¹ÛŒØª')),
        ('CUSTOM', _('Ø³ÙØ§Ø±Ø´ÛŒ')),
    )
    ENTITY_TYPES = (
        ('FACTOR',  _('ÙØ§Ú©ØªÙˆØ±')),
        ('TANKHAH', _('ØªÙ†Ø®ÙˆØ§Ù‡')),
        ('BUDGET_ALLOCATION', _('ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡')),
        ('BUDGET_RETURN', _('ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡')),
        ('ISSUE_PAYMENT_ORDER', _('ØµØ¯ÙˆØ± Ø¯Ø³ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª')),
    )

    post = models.ForeignKey(Post, on_delete=models.CASCADE, verbose_name=_("Ù¾Ø³Øª"))
    stage = models.ForeignKey(WorkflowStage, on_delete=models.CASCADE, verbose_name=_("Ù…Ø±Ø­Ù„Ù‡"))
    action_type = models.CharField(max_length=50, choices=ACTION_TYPES, verbose_name=_("Ù†ÙˆØ¹ Ø§Ù‚Ø¯Ø§Ù…"))
    entity_type = models.CharField(max_length=50, choices=ENTITY_TYPES, default='TANKHAH', verbose_name=_("Ù†ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯ÛŒØª"))
    is_active = models.BooleanField(default=True, verbose_name=_("ÙØ¹Ø§Ù„"))


    def __str__(self):
        return f"{self.post} - {self.action_type} Ø¨Ø±Ø§ÛŒ {self.get_entity_type_display()} Ø¯Ø± {self.stage}"
        # return f"{self.post} - {self.action_type} Ø¯Ø± {self.stage}"

    class Meta:
        verbose_name = _("Ø§Ù‚Ø¯Ø§Ù… Ù…Ø¬Ø§Ø² Ù¾Ø³Øª")
        verbose_name_plural = _("Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…Ø¬Ø§Ø² Ù¾Ø³Øªâ€ŒÙ‡Ø§")
        unique_together = ('post', 'stage', 'action_type', 'entity_type')  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† entity_type Ø¨Ù‡ unique_together
        permissions = [
            ('PostAction_view', 'Ù†Ù…Ø§ÛŒØ´ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…Ø¬Ø§Ø² Ù¾Ø³Øª'),
            ('PostAction_add', 'Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…Ø¬Ø§Ø² Ù¾Ø³Øª'),
            ('PostAction_update', 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…Ø¬Ø§Ø² Ù¾Ø³Øª'),
            ('PostAction_delete', 'Ø­Ø°Ù Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…Ø¬Ø§Ø² Ù¾Ø³Øª'),
        ]
